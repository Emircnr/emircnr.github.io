<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Küresel Fetih - Çevrimiçi</title>

  <!-- Google Fontları: Cinzel + Roboto (Sohbet için) -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <!-- FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- Animate.css -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
  />

  <style>
    /******************************************************************
     * GENEL SIFIRLAMA & GLOBAL AYARLAR
     ******************************************************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Cinzel", serif;
      color: #eee;
      overflow-x: hidden;
      transition: background 0.5s;
    }
    a {
      text-decoration: none;
      color: inherit;
    }

    /************************************************************
     * LOBİ SAYFASI TASARIMI (OKYANUS TEMASI)
     *************************************************************/
    body.lobby {
      /* Su altı / okyanus hissi veren bir arka plan */
      background: linear-gradient(
        180deg,
        #0a1f44 0%,
        #0b2a63 35%,
        #0b3553 100%
      );
      background-attachment: fixed;
      background-size: cover;
    }
    #lobby-container {
      max-width: 500px;
      margin: 60px auto;
      padding: 30px;
      background: rgba(0, 0, 0, 0.65);
      border: 2px solid #1abc9c;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      animation: fadeInLobby 1s forwards ease;
    }
    @keyframes fadeInLobby {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    #lobby-container h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #1abc9c;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: 38px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
      animation: animateTitle 1s ease;
    }
    @keyframes animateTitle {
      0% {
        letter-spacing: 8px;
        opacity: 0;
      }
      100% {
        letter-spacing: 3px;
        opacity: 1;
      }
    }
    #lobby-container h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #aef7f2;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 24px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
    }
    #lobby-container input[type="text"],
    #lobby-container input[type="number"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #1abc9c;
      border-radius: 4px;
      font-size: 16px;
      outline: none;
      color: #333;
      transition: box-shadow 0.3s;
    }
    #lobby-container input[type="text"]:focus,
    #lobby-container input[type="number"]:focus {
      box-shadow: 0 0 8px #1abc9c;
    }
    #lobby-container button {
      width: 100%;
      padding: 14px;
      margin-bottom: 15px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: 1px solid #16a085;
      border-radius: 6px;
      font-size: 18px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.7);
      transition: background 0.3s, transform 0.3s;
    }
    #lobby-container button:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
      transform: scale(1.02);
    }
    .color-options {
      margin-bottom: 15px;
      text-align: center;
    }
    .global-color-seçeneği {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      display: inline-block;
      margin: 0 5px;
      transition: transform 0.3s, border-color 0.3s;
    }
    .global-color-seçeneği:hover {
      transform: scale(1.2);
      border-color: #fff;
    }
    .global-color-seçeneği.selected {
      border-color: #f1c40f;
    }

    /************************************************************
     * BİLDİRİM ALANI (POPUP)
     *************************************************************/
    #notification-area {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      display: none;
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
      font-size: 16px;
      max-width: 300px;
      line-height: 1.4;
    }

    /************************************************************
     * OYUN EKRAN STİLLERİ
     *************************************************************/
    #game-container {
      display: none;
      height: 100vh;
      background: linear-gradient(180deg, #0b2a63 0%, #0a1f44 100%);
    }
    #main-content {
      display: flex;
      height: 100%;
    }

    /***************************************************************
     * HARİTA ALANI
     **************************************************************/
    #map-container {
      flex: 7;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
      background-color: #0e2740;
    }
    .toggle-info-cards {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1100;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
    }

    /************************************************************
     * SAĞ PANEL
     *************************************************************/
    #side-panel {
      flex: 2.3;
      max-width: 350px;
      background: rgba(0, 0, 0, 0.75);
      padding: 20px;
      overflow-y: auto;
      box-shadow: -4px 0 10px rgba(0, 0, 0, 0.4);
    }
    #exit-room-btn {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      background: linear-gradient(45deg, #c0392b, #e74c3c);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    #exit-room-btn:hover {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
    }

    /***************************************************************
     * OYUN BİLGİLERİ (TUR, ODA KODU, BENZİN)
     **************************************************************/
    #game-info {
      margin-bottom: 20px;
      background: rgba(0, 0, 0, 0.6);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    #game-info h2 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #1abc9c;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    #game-info p {
      font-size: 14px;
      margin: 6px 0;
      color: #ddd;
    }

    /***************************************************************
     * OYUNCU BİLGİLERİ
     **************************************************************/
    #player-info-section {
      margin-bottom: 20px;
    }
    #player-info-section h2 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #1abc9c;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    .player-info {
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      font-size: 14px;
    }
    .player-info p {
      margin: 4px 0;
      color: #ddd;
    }

    /***************************************************************
     * SEÇİLİ ÜLKE BİLGİLERİ
     **************************************************************/
    #country-info-section {
      margin-bottom: 20px;
    }
    #country-info-section h2 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #1abc9c;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    #country-info p {
      font-size: 14px;
      margin: 6px 0;
      color: #ddd;
    }
    #country-info p span {
      font-weight: 600;
      color: #f39c12;
    }

    /************************************************************
     * PAZAR & İŞLEMLER
     *************************************************************/
    #market-section {
      margin-bottom: 20px;
    }
    #market-section h2 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #1abc9c;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    .action-group {
      margin-bottom: 15px;
      background: rgba(0, 0, 0, 0.4);
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
    }
    .action-group h3 {
      font-size: 16px;
      color: #ccc;
      margin-bottom: 8px;
    }
    .action-group input[type="number"],
    .action-group select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #1abc9c;
      border-radius: 4px;
      font-size: 14px;
      color: #333;
    }
    .action-group button {
      width: 100%;
      padding: 10px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      border-radius: 4px;
      font-size: 14px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .action-group button:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }
    .turn-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #ddd;
      margin-bottom: 10px;
    }
    .turn-info span {
      font-weight: 600;
      color: #f39c12;
    }

    /***************************************************************
     * BROŞÜR İPUCU VE ÜLKE AÇILIR PENCERE
     **************************************************************/
    .leaflet-tooltip {
      background: transparent;
      border: none;
    }
    .country-popup-tooltip {
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /************************************************************
     * GELİŞTİRİLMİŞ SOHBET AÇILIR PENCERESİ
     *************************************************************/
    /* Sohbet açılır penceresini daha güzel yapalım, farklı font kullanacağız (Roboto) */
    .chat-popup {
      position: fixed;
      bottom: 70px;
      right: 20px;
      width: 320px;
      max-height: 500px;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #444;
      border-radius: 8px;
      display: none;
      flex-direction: column;
      z-index: 3000;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      font-family: "Roboto", sans-serif !important;
    }
    .chat-header {
      background: rgba(0, 0, 0, 0.9);
      padding: 10px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      color: #1abc9c;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-header button {
      background: transparent;
      border: none;
      color: #1abc9c;
      font-size: 20px;
      cursor: pointer;
    }
    .chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.8);
    }
    /* Tek tek mesaj stilleri */
    .chat-message {
      margin-bottom: 8px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    /* Oyuncu rengiyle mesaj yazmak için bu class'a inline style vereceğiz */
    .chat-message-player {
      font-weight: 500;
    }
    /* Sistem veya bildirim mesajları farklı renk/yazı tipi */
    .chat-message-system {
      color: #ffcc00; /* Sarımsı */
      font-style: italic;
    }

    .chat-input-container {
      display: flex;
      border-top: 1px solid #444;
    }
    .chat-input-container input[type="text"] {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
      background: #1e1e2f;
      color: #eee;
      font-family: "Roboto", sans-serif !important;
    }
    .chat-input-container button {
      padding: 10px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      cursor: pointer;
      color: #fff;
    }
    .chat-input-container button:hover {
      filter: brightness(0.9);
    }

    .open-chat-btn {
      position: fixed;
      bottom: 20px;
      right: 80px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      z-index: 3000;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      font-family: "Roboto", sans-serif;
    }
    /* Sohbet butonundaki okunmamış mesaj sayısı */
    .chat-unread-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #e74c3c;
      color: #fff;
      font-size: 12px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    /************************************************************
     * PAKT AÇILIR PENCERE
     *************************************************************/
    .pact-popup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      max-height: 450px;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #444;
      border-radius: 8px;
      display: none;
      flex-direction: column;
      z-index: 3001;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
    .pact-header {
      background: rgba(0, 0, 0, 0.9);
      padding: 10px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      color: #1abc9c;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pact-header button {
      background: transparent;
      border: none;
      color: #1abc9c;
      font-size: 20px;
      cursor: pointer;
    }
    .pact-content {
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #eee;
      font-size: 14px;
    }
    .pact-content h4 {
      margin-bottom: 8px;
      color: #1abc9c;
    }
    .pact-content input[type="number"],
    .pact-content select {
      width: 90%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #1abc9c;
      border-radius: 4px;
      font-size: 14px;
      color: #333;
    }
    .pact-content button {
      padding: 8px 12px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      cursor: pointer;
      color: #fff;
      border-radius: 4px;
    }
    .pact-content button:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }
    #pact-offers-container {
      padding: 10px;
      background: rgba(0, 0, 0, 0.4);
      color: #eee;
      font-size: 14px;
    }
    #pact-offers-container h3 {
      color: #1abc9c;
      margin-bottom: 10px;
    }
    .pact-offer-item {
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .pact-offer-item p {
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .pact-offer-item button {
      margin-right: 8px;
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      color: #fff;
    }
    .pact-offer-item button.accept-btn {
      background: linear-gradient(45deg, #27ae60, #2ecc71);
    }
    .pact-offer-item button.reject-btn {
      background: linear-gradient(45deg, #c0392b, #e74c3c);
    }
    .pact-offer-item button:hover {
      filter: brightness(0.9);
    }
    .open-pact-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(45deg, #2980b9, #2ecc71);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      z-index: 3002;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body class="lobby">
  <!-- ======================= LOBİ (Oda Oluşturma ve Katılma) ====================== -->
  <div id="lobby-container" class="animate__animated animate__fadeIn">
    <h1>KÜRESEL FETH</h1>

    <!-- Oda Oluşturma -->
    <div id="create-room-section">
      <h2>Oda Oluştur</h2>
      <input type="text" id="creator-player-name" placeholder="Adınız"/>
      <div class="color-options" id="creator-color-options"></div>
      <input type="number" id="max-players" placeholder="Oyuncu Sayısı (2-5)" min="2" max="5" />
      <button id="create-room-btn">Oda Oluştur</button>
    </div>

    <hr/>

    <!-- Odaya Katılma -->
    <div id="join-room-section">
      <h2>Odaya Katıl</h2>
      <input type="text" id="join-player-name" placeholder="Adınız"/>
      <div class="color-options" id="join-color-options"></div>
      <input type="text" id="room-code" placeholder="Oda Kodu (Örn: AB12CD)" />
      <button id="join-room-btn">Odaya Katıl</button>
    </div>
  </div>

  <!-- ==================== BILDIRIM ALANI ===================== -->
  <div id="notification-area"></div>

  <!-- ======================= OYUN EKRANLARI ======================= -->
  <div id="game-container">
    <div id="main-content">
      <!-- Harita Bölgesi -->
      <div id="map-container">
        <div id="map"></div>
        <!-- Bilgi Kartları Toggle Butonu -->
        <button id="toggle-info-cards" class="toggle-info-cards">
          <i class="fas fa-eye-slash"></i>
        </button>
      </div>

      <!-- Sağ Panel -->
      <div id="side-panel">
        <button id="exit-room-btn">Odadan Çık</button>

        <section id="game-info">
          <h2>Oyun Bilgileri</h2>
          <p>Oda Kodu: <span id="display-room-code">-</span></p>
          <p>Tur: <span id="current-round">1</span></p>
          <p>Toplam Benzin: <span id="total-petrol">0</span> varil</p>
        </section>

        <section id="player-info-section">
          <h2>Oyuncular</h2>
          <div id="players-info"></div>
        </section>

        <section id="country-info-section">
          <h2>Ülke Detayları</h2>
          <div id="country-info">
            <p>Ülke: <span id="selected-country-name">Yok</span></p>
            <p>Sahip: <span id="selected-country-owner">Yok</span></p>
            <p>Asker: <span id="selected-country-soldiers">0</span></p>
            <p>Gelir: <span id="selected-country-income">0</span>$</p>
            <p>Kış: <span id="selected-country-barracks">0</span></p>
            <p>Fabrika: <span id="selected-country-factories">0</span></p>
            <p>Rafin: <span id="selected-country-refineries">0</span></p>
            <p>Üretim Kapasitesi: <span id="selected-country-oilProduction">0</span> varil</p>
          </div>
        </section>

        <section id="market-section">
          <h2>İşlemler</h2>
          <!-- Saldırı -->
          <div class="action-group">
            <h3>Saldırı</h3>
            <input type="number" id="attack-soldiers" placeholder="Asker sayısı" min="1" />
            <button id="attack-btn">
              <i class="fas fa-crosshairs"></i> Saldırı Yap
            </button>
          </div>

          <!-- Asker Satın Alma -->
          <div class="action-group">
            <h3>Asker Satın Alma</h3>
            <input type="number" id="soldiers-to-buy" placeholder="Adet" min="1" />
            <button id="buy-soldiers-btn">
              <i class="fas fa-user-plus"></i> Satın Al (10$/adet)
            </button>
          </div>

          <!-- Kışla -->
          <div class="action-group">
            <h3>Asker Kışlası Kur</h3>
            <button id="buy-barracks-btn">
              <i class="fas fa-fort-awesome"></i> Kışla Kur (130$ + 100 varil)
            </button>
          </div>

          <!-- Fabrika -->
          <div class="action-group">
            <h3>Fabrika Kur</h3>
            <button id="build-factory-btn">
              <i class="fas fa-industry"></i> Fabrika Kur (500$ + 400 varil)
            </button>
          </div>

          <!-- Rafine -->
          <div class="action-group">
            <h3>Rafine Kur</h3>
            <button id="build-refinery-btn">
              <i class="fas fa-oil-can"></i> Rafine Kur (800$ + 400 varil)
            </button>
          </div>

          <!-- Asker Çek -->
          <div class="action-group">
            <h3>Asker Çek</h3>
            <input type="number" id="pull-soldiers-count" placeholder="Asker sayısı" min="1" />
            <button id="pull-soldiers-btn">
              <i class="fas fa-running"></i> Asker Çek
            </button>
          </div>

          <!-- Para Gönder -->
          <div class="action-group">
            <h3>Para Gönder</h3>
            <input type="number" id="money-to-send" placeholder="Miktar" min="1" />
            <select id="recipient-player"></select>
            <button id="send-money-btn">
              <i class="fas fa-hand-holding-usd"></i> Para Gönder
            </button>
          </div>

          <!-- Benzin Gönder -->
          <div class="action-group">
            <h3>Benzin Gönder</h3>
            <input type="number" id="petrol-to-send" placeholder="Varil" min="1" />
            <select id="recipient-player-petrol"></select>
            <button id="send-petrol-btn">
              <i class="fas fa-gas-pump"></i> Benzin Gönder
            </button>
          </div>

          <!-- Tur -->
          <div class="action-group">
            <h3>Tur</h3>
            <div class="turn-info">
              <p>Sıra: <span id="current-player">Oyuncu Adı</span></p>
              <button id="end-turn-btn">
                <i class="fas fa-forward"></i> Sonu
              </button>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- ======================= SOHBET AÇILIR PENCERE ====================== -->
  <div id="chat-popup" class="chat-popup">
    <div class="chat-header">
      <span>Sohbet</span>
      <button id="close-chat-btn">×</button>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Mesajınızı yazın..." />
      <button id="send-chat-btn">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
  <button id="open-chat-btn" class="open-chat-btn">
    <i class="fas fa-comments"></i>
    <!-- Sohbet butonu üzerindeki bildirim sayısı -->
    <div id="chat-unread-count" class="chat-unread-count" style="display:none;">0</div>
  </button>

  <!-- ====================== PAKT POPUP ===================== -->
  <div id="pact-popup" class="pact-popup">
    <div class="pact-header">
      <span>Saldırmazlık Pakti</span>
      <button id="close-pact-btn">×</button>
    </div>
    <div class="pact-content">
      <h4>Pakt Teklifi Oluştur</h4>
      <input type="number" id="pact-turns" placeholder="Tur" min="1"/>
      <input type="number" id="pact-cost" placeholder="Ücret" min="1"/>
      <select id="pact-recipient"></select>
      <button id="send-pact-btn">Teklif Gönder</button>
    </div>
    <div id="pact-offers-container">
      <h3>Gelen Teklifler</h3>
      <div id="pact-offers-list"></div>
    </div>
  </div>
  <button id="open-pact-btn" class="open-pact-btn">
    <i class="fas fa-handshake"></i>
  </button>

  <!-- Firebase ve Diğer JS Kütüphaneleri -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <!-- OYUN JS Kodları -->
  <script>
  /********************************************************************
   * Firebase Başlatma
   ********************************************************************/
  const firebaseConfig = {
    apiKey: "AIzaSyCINihMNGs-qRYIIBLzXyeaLnM_Lhp-iwg",
    authDomain: "warmapg-77acb.firebaseapp.com",
    databaseURL: "https://warmapg-77acb-default-rtdb.firebaseio.com",
    projectId: "warmapg-77acb",
    storageBucket: "warmapg-77acb.appspot.com",
    messagingSenderId: "895613631339",
    appId: "1:895613631339:web:a7ecc0cfd8ab3ae7e02a2e",
    measurementId: "G-6SJVLLVDCF"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  /******************************************************************
   * GLOBAL DEĞİŞKENLER ve Yardımcı Fonksiyonlar
   *******************************************************************/
  let localPlayerId = null;
  let currentRoomCode = null;
  let roomRef = null;
  let roomData = null;
  let selectedCountry = null;
  let map, geoJsonLayer = null;

  const availableColors = ["red", "blue", "green", "yellow", "purple"];
  let localPlayerColor = null;
  let chatListenerAdded = false;

  // Kartların ilk açılışta görünmemesini istiyoruz:
  let infoCardsPermanent = false;

  // Sohbet okunmamış mesaj sayısı
  let unreadMessages = 0;
  let chatOpen = false;

  // Bildirimi hem pop-up alanına hem sohbete yansıtan yardımcı fonksiyon
  function showNotification(message, duration = 3000, senderColor = "#ffcc00", isSystem = true) {
    // 1) Kısa süreli ekran bildirimi
    const notificationArea = document.getElementById("notification-area");
    notificationArea.innerHTML = '<div class="popup">' + message + '</div>';
    notificationArea.style.display = "flex";
    notificationArea.style.opacity = 0;
    notificationArea.style.transform = "translateY(-20px)";
    setTimeout(() => {
      notificationArea.style.transition = "opacity 0.5s, transform 0.5s";
      notificationArea.style.opacity = 1;
      notificationArea.style.transform = "translateY(0)";
    }, 10);
    setTimeout(() => {
      notificationArea.style.opacity = 0;
      notificationArea.style.transform = "translateY(-20px)";
      setTimeout(() => {
        notificationArea.style.display = "none";
      }, 500);
    }, duration);

    // 2) Sohbet alanına da ekleyelim (sistem mesajı olarak)
    // Eğer bir oyuncuya aitse rengi parametreden alabiliriz
    if (isSystem) {
      appendChatMessage({ 
        sender: "SİSTEM", 
        text: message, 
        color: senderColor, 
        system: true 
      });
    } else {
      // Normal kullanıcı bildirimi
      appendChatMessage({
        sender: "",
        text: message,
        color: senderColor,
        system: false
      });
    }
  }

  function generateRoomCode() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let code = "";
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  function isMyTurn() {
    if (!roomData || !roomData.playerOrder) return false;
    const currentTurnIndex = roomData.currentTurnIndex || 0;
    return roomData.playerOrder[currentTurnIndex] === localPlayerId;
  }

  function hasActivePact(playerA, playerB) {
    if (!roomData || !roomData.pacts) return false;
    const currentRound = roomData.round || 1;
    for (let pactId in roomData.pacts) {
      const pact = roomData.pacts[pactId];
      if (pact.players && pact.players.includes(playerA) && pact.players.includes(playerB)) {
        if (currentRound <= pact.endRound) {
          return true;
        }
      }
    }
    return false;
  }

  /*********************************************************************
   * DOMContentLoaded – Lobi Girişi ve Otomatik Bağlanma
   ********************************************************************/
  document.addEventListener("DOMContentLoaded", () => {
    // Player ID (localStorage)
    if (!localStorage.getItem("playerId")) {
      localStorage.setItem("playerId", Math.random().toString(36).substr(2, 9));
    }
    localPlayerId = localStorage.getItem("playerId");

    // Renk düğmeleri (Oda Kur)
    const creatorColorDiv = document.getElementById("creator-color-options");
    availableColors.forEach((color) => {
      const btn = document.createElement("button");
      btn.className = "global-color-seçeneği";
      btn.style.background = color;
      btn.dataset.color = color;
      btn.addEventListener("click", function () {
        creatorColorDiv
          .querySelectorAll(".global-color-seçeneği")
          .forEach((s) => s.classList.remove("selected"));
        btn.classList.add("selected");
        localPlayerColor = color;
      });
      creatorColorDiv.appendChild(btn);
    });

    // Renk düğmeleri (Odaya Katıl)
    const joinColorDiv = document.getElementById("join-color-options");
    availableColors.forEach((color) => {
      const btn = document.createElement("button");
      btn.className = "global-color-seçeneği";
      btn.style.background = color;
      btn.dataset.color = color;
      btn.addEventListener("click", function () {
        joinColorDiv
          .querySelectorAll(".global-color-seçeneği")
          .forEach((s) => s.classList.remove("selected"));
        btn.classList.add("selected");
        localPlayerColor = color;
      });
      joinColorDiv.appendChild(btn);
    });

    // Oda Oluşturma
    document.getElementById("create-room-btn").addEventListener("click", () => {
      const playerName = document
        .getElementById("creator-player-name")
        .value.trim();
      const maxPlayers = parseInt(
        document.getElementById("max-players").value
      );
      if (!playerName) {
        showNotification("Lütfen adınızı girin!");
        return;
      }
      if (!localPlayerColor) {
        showNotification("Lütfen bir renk seçin!");
        return;
      }
      if (isNaN(maxPlayers) || maxPlayers < 2 || maxPlayers > 5) {
        showNotification("Oyuncu sayısı 2 ile 5 arasında olmalıdır!");
        return;
      }

      const roomCode = generateRoomCode();
      currentRoomCode = roomCode;
      roomRef = db.ref("rooms/" + roomCode);

      const newRoomData = {
        roomCode: roomCode,
        maxPlayers: maxPlayers,
        gameState: "waiting",
        currentTurnIndex: 0,
        round: 1,
        playerOrder: [localPlayerId],
        players: {},
        countryData: {},
        createdAt: firebase.database.ServerValue.TIMESTAMP
      };

      newRoomData.players[localPlayerId] = {
        name: playerName,
        color: localPlayerColor,
        money: 1000,
        soldiers: 0,
        countries: [],
        petrol: 0,
        joinedAt: firebase.database.ServerValue.TIMESTAMP
      };

      roomRef.set(newRoomData, (error) => {
        if (error) {
          showNotification("Oda oluşturulurken hata oluştu!");
        } else {
          showNotification("Oda oluşturuldu. Oda Kodu: " + roomCode);
          localStorage.setItem("roomCode", roomCode);
          loadAndInitializeGeoJson();
          joinRoomAndListen();
          document.body.classList.remove("lobby");
          document.getElementById("lobby-container").style.display = "none";
          document.getElementById("game-container").style.display = "block";
          document.getElementById("display-room-code").textContent = roomCode;
        }
      });
    });

    // Odaya Katılma
    document.getElementById("join-room-btn").addEventListener("click", () => {
      const playerName = document
        .getElementById("join-player-name")
        .value.trim();
      const roomCodeInput = document
        .getElementById("room-code")
        .value.trim()
        .toUpperCase();
      if (!playerName) {
        showNotification("Lütfen adınızı girin!");
        return;
      }
      if (!localPlayerColor) {
        showNotification("Lütfen bir renk seçin!");
        return;
      }
      if (!roomCodeInput) {
        showNotification("Lütfen oda kodunu girin!");
        return;
      }

      currentRoomCode = roomCodeInput;
      roomRef = db.ref("rooms/" + roomCodeInput);

      roomRef.once("value", (snapshot) => {
        if (!snapshot.exists()) {
          showNotification("Böyle bir oda bulunamadı!");
          return;
        }
        const room = snapshot.val();
        if (room.gameState !== "waiting") {
          showNotification("Oyun zaten başladı!");
          return;
        }
        const playerCount = Object.keys(room.players || {}).length;
        if (playerCount >= room.maxPlayers) {
          showNotification("Oda dolu!");
          return;
        }
        const updates = {};
        updates["players/" + localPlayerId] = {
          name: playerName,
          color: localPlayerColor,
          money: 1000,
          soldiers: 0,
          countries: [],
          petrol: 0,
          joinedAt: firebase.database.ServerValue.TIMESTAMP
        };
        if (!room.playerOrder) room.playerOrder = [];
        room.playerOrder.push(localPlayerId);
        updates["playerOrder"] = room.playerOrder;

        roomRef.update(updates, (err) => {
          if (err) {
            showNotification("Odaya katılırken hata oluştu!");
          } else {
            showNotification("Odaya katıldınız!");
            localStorage.setItem("roomCode", roomCodeInput);
            joinRoomAndListen();
            document.body.classList.remove("lobby");
            document.getElementById("lobby-container").style.display = "none";
            document.getElementById("game-container").style.display = "block";
            document.getElementById("display-room-code").textContent =
              roomCodeInput;
          }
        });
      });
    });

    autoReconnect();

    // Bilgi kartları toggle
    const toggleInfoButton = document.getElementById("toggle-info-cards");
    const icon = toggleInfoButton.querySelector("i");
    toggleInfoButton.addEventListener("click", () => {
      infoCardsPermanent = !infoCardsPermanent;
      updateTooltipsPermanent();
      icon.className = infoCardsPermanent ? "fas fa-eye" : "fas fa-eye-slash";
    });
  });

  function autoReconnect() {
    const savedRoomCode = localStorage.getItem("roomCode");
    if (savedRoomCode) {
      const refCheck = db.ref("rooms/" + savedRoomCode);
      refCheck.once("value", (snapshot) => {
        if (!snapshot.exists()) return;
        const savedRoomData = snapshot.val();
        if (!savedRoomData.players || !savedRoomData.players[localPlayerId])
          return;
        currentRoomCode = savedRoomCode;
        roomRef = refCheck;
        joinRoomAndListen();
        document.body.classList.remove("lobby");
        document.getElementById("lobby-container").style.display = "none";
        document.getElementById("game-container").style.display = "block";
        document.getElementById("display-room-code").textContent = savedRoomCode;
      });
    }
  }

  /******************************************************************
   * GeoJSON ve Ülke Verilerini Yükleme (Sadece Oda Kurucusu)
   *****************************************************************/
  function loadAndInitializeGeoJson() {
    fetch(
      "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json"
    )
      .then((response) => response.json())
      .then((geoJsonData) => {
        const features = geoJsonData.features;

        // 43 rastgele petrol kapasitesi atayalım
        let oilIndexes = [];
        if (features.length > 43) {
          while (oilIndexes.length < 43) {
            const randIdx = Math.floor(Math.random() * features.length);
            if (!oilIndexes.includes(randIdx)) {
              oilIndexes.push(randIdx);
            }
          }
        }

        features.forEach((feature, idx) => {
          feature.properties._index = idx;
        });

        const countryDataInit = {};
        features.forEach((feature) => {
          const countryName = feature.properties.name;
          let oilProduction = 0;
          if (oilIndexes.includes(feature.properties._index)) {
            oilProduction =
              Math.floor(Math.random() * (1000 - 250 + 1)) + 250;
          }
          countryDataInit[countryName] = {
            income: Math.floor(Math.random() * 500) + 100,
            soldiers: 0,
            owner: null,
            barracksCount: 0,
            factories: 0,
            refineries: 0,
            oilProduction: oilProduction
          };
        });

        roomRef.child("countryData").set(countryDataInit);
      });
  }

  /******************************************************************
   * Oda Verilerini Dinleme ve UI Güncelleme
   *****************************************************************/
  function joinRoomAndListen() {
    if (!roomRef) return;
    roomRef.on("value", (snapshot) => {
      roomData = snapshot.val();
      updateGameUI();
      displayPendingPactOffers();
    });

    // Sohbet
    if (!chatListenerAdded) {
      roomRef.child("chat").on("child_added", (snapshot) => {
        const message = snapshot.val();
        appendChatMessage(message, true); // Gerçek zamanlı ekle
      });
      chatListenerAdded = true;
    }
  }

  function updateGameUI() {
    if (!roomData) return;

    // Tur & Toplam Petrol
    document.getElementById("current-round").textContent = roomData.round || 1;
    let totalPetrol = 0;
    if (roomData.players) {
      Object.values(roomData.players).forEach((p) => {
        totalPetrol += p.petrol || 0;
      });
    }
    document.getElementById("total-petrol").textContent = totalPetrol;

    // Sıra
    if (roomData.playerOrder && roomData.players) {
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      if (roomData.players[currentPlayerId]) {
        document.getElementById("current-player").textContent =
          roomData.players[currentPlayerId].name;
      }
    }

    // Oyuncu Listesi
    const playersInfoDiv = document.getElementById("players-info");
    playersInfoDiv.innerHTML = "";
    if (roomData.playerOrder) {
      roomData.playerOrder.forEach((pid) => {
        const player = roomData.players[pid];
        const playerDiv = document.createElement("div");
        playerDiv.className = "player-info";
        playerDiv.id = "player-info-" + pid;
        playerDiv.innerHTML =
          "<p><strong>" +
          player.name +
          "</strong></p>" +
          '<p>Para: <span id="money-' +
          pid +
          '">' +
          player.money +
          "</span>$</p>" +
          '<p>Asker: <span id="soldiers-' +
          pid +
          '">' +
          player.soldiers +
          "</span></p>" +
          '<p>Ülkeler: <span id="countries-' +
          pid +
          '">' +
          ((player.countries && player.countries.length) || 0) +
          "</span></p>" +
          '<p>Benzin: <span id="petrol-' +
          pid +
          '">' +
          player.petrol +
          "</span> varil</p>";
        playersInfoDiv.appendChild(playerDiv);
      });
    }

    // Harita & Ülkeler
    if (map && roomData.countryData && geoJsonLayer) {
      geoJsonLayer.eachLayer((layer) => {
        const countryName = layer.feature.properties.name;
        const country = roomData.countryData[countryName];
        if (country) {
          if (
            country.owner &&
            roomData.players &&
            roomData.players[country.owner]
          ) {
            layer.setStyle({
              fillColor: roomData.players[country.owner].color || "#ccc",
              fillOpacity: 0.7
            });
          } else {
            layer.setStyle({
              fillColor: "#ccc",
              fillOpacity: 0.7
            });
          }
          layer.setTooltipContent(
            getCountryPopupContent(countryName, country)
          );
        }
      });
    }

    updateSelectedCountryInfo();
    updateRecipientSelects();
    updatePactRecipientSelect();
  }

  function updateSelectedCountryInfo() {
    const infoElements = {
      name: document.getElementById("selected-country-name"),
      owner: document.getElementById("selected-country-owner"),
      soldiers: document.getElementById("selected-country-soldiers"),
      income: document.getElementById("selected-country-income"),
      barracks: document.getElementById("selected-country-barracks"),
      factories: document.getElementById("selected-country-factories"),
      refineries: document.getElementById("selected-country-refineries"),
      oilProduction: document.getElementById("selected-country-oilProduction")
    };

    if (
      selectedCountry &&
      roomData &&
      roomData.countryData &&
      roomData.countryData[selectedCountry]
    ) {
      const c = roomData.countryData[selectedCountry];
      infoElements.name.textContent = selectedCountry;
      infoElements.owner.textContent =
        c.owner && roomData.players && roomData.players[c.owner]
          ? roomData.players[c.owner].name
          : "Yok";
      infoElements.soldiers.textContent = c.soldiers || 0;

      // Fabrika: her biri +%20
      let effectiveIncome = c.income || 0;
      if (c.factories) {
        effectiveIncome = Math.floor(
          effectiveIncome * (1 + 0.2 * c.factories)
        );
      }
      infoElements.income.textContent = effectiveIncome;

      infoElements.barracks.textContent = c.barracksCount || 0;
      infoElements.factories.textContent = c.factories || 0;
      infoElements.refineries.textContent = c.refineries || 0;

      // Rafine: her biri +%15
      const effectiveProduction = c.oilProduction
        ? Math.floor(
            c.oilProduction * (1 + 0.15 * (c.refineries || 0))
          )
        : 0;
      infoElements.oilProduction.textContent = effectiveProduction;
    } else {
      infoElements.name.textContent = "Yok";
      infoElements.owner.textContent = "Yok";
      infoElements.soldiers.textContent = 0;
      infoElements.income.textContent = 0;
      infoElements.barracks.textContent = 0;
      infoElements.factories.textContent = 0;
      infoElements.refineries.textContent = 0;
      infoElements.oilProduction.textContent = 0;
    }
  }

  function getCountryPopupContent(countryName, country) {
    if (!country) country = {};

    const ownerText =
      country.owner &&
      roomData &&
      roomData.players &&
      roomData.players[country.owner]
        ? roomData.players[country.owner].name
        : "Yok";

    // Fabrika
    let effectiveIncome = country.income || 0;
    if (country.factories) {
      effectiveIncome = Math.floor(
        effectiveIncome * (1 + 0.2 * country.factories)
      );
    }

    // Rafine
    const effectiveProduction = country.oilProduction
      ? Math.floor(
          country.oilProduction * (1 + 0.15 * (country.refineries || 0))
        )
      : 0;

    return (
      '<div class="country-popup">' +
      '<p><i class="fas fa-money-bill-wave"></i> Gelir: ' + effectiveIncome + '$</p>' +
      '<p><i class="fas fa-users"></i> Asker: ' + (country.soldiers || 0) + "</p>" +
      '<p><i class="fas fa-fort-awesome"></i> Kışla: ' + (country.barracksCount || 0) + "</p>" +
      '<p><i class="fas fa-industry"></i> Fabrika: ' + (country.factories || 0) + "</p>" +
      '<p><i class="fas fa-oil-can"></i> Rafine: ' + (country.refineries || 0) + "</p>" +
      '<p><i class="fas fa-gas-pump"></i> Üretim: ' + effectiveProduction + " varil</p>" +
      '<p><i class="fas fa-crown"></i> Sahip: ' + ownerText + "</p>" +
      "</div>"
    );
  }

  function updateRecipientSelects() {
    const moneySelect = document.getElementById("recipient-player");
    const petrolSelect = document.getElementById("recipient-player-petrol");

    moneySelect.innerHTML = "";
    petrolSelect.innerHTML = "";

    if (roomData && roomData.playerOrder) {
      roomData.playerOrder.forEach((pid) => {
        const option = document.createElement("option");
        option.value = pid;
        option.textContent = roomData.players[pid].name;
        moneySelect.appendChild(option);

        const option2 = document.createElement("option");
        option2.value = pid;
        option2.textContent = roomData.players[pid].name;
        petrolSelect.appendChild(option2);
      });
    }
  }

  function updatePactRecipientSelect() {
    const pactRecipientSelect = document.getElementById("pact-recipient");
    pactRecipientSelect.innerHTML = "";

    if (roomData && roomData.playerOrder) {
      roomData.playerOrder.forEach((pid) => {
        if (pid !== localPlayerId) {
          const option = document.createElement("option");
          option.value = pid;
          option.textContent = roomData.players[pid].name;
          pactRecipientSelect.appendChild(option);
        }
      });
    }
  }

  /******************************************************************
   * PAKT TEKLİFLERİ
   *****************************************************************/
  function sendPactOffer() {
    if (!isMyTurn()) {
      showNotification("Sıranız değil!");
      return;
    }
    const turns = parseInt(document.getElementById("pact-turns").value);
    const cost = parseInt(document.getElementById("pact-cost").value);
    const receiver = document.getElementById("pact-recipient").value;
    if (isNaN(turns) || turns <= 0 || isNaN(cost) || cost <= 0) {
      showNotification("Geçerli tur ve ücret girin!");
      return;
    }
    if (!receiver || receiver === localPlayerId) {
      showNotification("Geçerli bir alıcı seçin!");
      return;
    }

    const currentTurnIndex = roomData.currentTurnIndex || 0;
    const currentPlayerId = roomData.playerOrder[currentTurnIndex];
    const senderData = roomData.players[currentPlayerId];

    if (senderData.money < cost) {
      showNotification("Bu teklifi yapmak için yeterli paranız yok!");
      return;
    }

    const pactOfferRef = roomRef.child("pactOffers").push();
    const newOffer = {
      offerId: pactOfferRef.key,
      senderId: currentPlayerId,
      senderName: senderData.name,
      receiverId: receiver,
      turns: turns,
      cost: cost,
      status: "pending",
      createdRound: roomData.round || 1
    };
    pactOfferRef.set(newOffer);

    // Sohbete mesaj düşelim
    const chatMessage = {
      sender: senderData.name,
      text:
        "Pakt Teklifi Gönderildi: " +
        senderData.name +
        " → " +
        roomData.players[receiver].name +
        " (" +
        turns +
        " tur, " +
        cost +
        "$)",
      color: senderData.color || "#fff",
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(chatMessage);

    showNotification("Pakt Teklifi Gönderildi.");
  }

  function displayPendingPactOffers() {
    if (!roomData || !roomData.pactOffers) {
      document.getElementById("pact-offers-container").style.display = "none";
      return;
    }
    const container = document.getElementById("pact-offers-list");
    container.innerHTML = "";
    let hasOffer = false;
    Object.values(roomData.pactOffers).forEach((offer) => {
      if (
        offer.receiverId === localPlayerId &&
        offer.status === "pending"
      ) {
        hasOffer = true;
        const div = document.createElement("div");
        div.className = "pact-offer-item";
        div.innerHTML =
          "<p><strong>" +
          offer.senderName +
          "</strong> tarafından " +
          offer.turns +
          " tur boyunca, " +
          offer.cost +
          "$ için saldırmazlık teklifi.</p>" +
          '<button class="accept-btn">Kabul</button>' +
          '<button class="reject-btn">Reddet</button>';
        div.querySelector(".accept-btn").addEventListener("click", () => {
          acceptPactOffer(offer.offerId);
        });
        div.querySelector(".reject-btn").addEventListener("click", () => {
          rejectPactOffer(offer.offerId);
        });
        container.appendChild(div);
      }
    });
    document.getElementById("pact-offers-container").style.display = hasOffer
      ? "block"
      : "none";
  }

  function acceptPactOffer(offerId) {
    const offer = roomData.pactOffers[offerId];
    if (!offer || offer.status !== "pending") return;

    const currentRound = roomData.round || 1;
    const endRound = currentRound + offer.turns - 1;
    const senderData = roomData.players[offer.senderId];
    const receiverData = roomData.players[offer.receiverId];
    if (!senderData || !receiverData) return;

    if (senderData.money < offer.cost) {
      showNotification(
        "Teklif yapanın yeterli parası kalmadı, teklif iptal."
      );
      roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
      return;
    }

    const updates = {};
    updates["pactOffers/" + offerId + "/status"] = "accepted";
    updates["players/" + offer.senderId + "/money"] =
      senderData.money - offer.cost;
    updates["players/" + offer.receiverId + "/money"] =
      receiverData.money + offer.cost;

    if (!roomData.pacts) {
      updates["pacts"] = {};
    }
    updates["pacts/" + offerId] = {
      players: [offer.senderId, offer.receiverId],
      endRound: endRound
    };
    roomRef.update(updates);

    // Sohbete yazalım
    const pactMessage = {
      sender: "SİSTEM",
      text:
        "Pakt Anlaşması: " +
        senderData.name +
        " ile " +
        receiverData.name +
        " arası " +
        offer.turns +
        " tur (Bedel: " +
        offer.cost +
        "$).",
      color: "#ffcc00",
      system: true,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(pactMessage);

    showNotification("Saldırmazlık pakti teklifini kabul ettiniz.");
  }

  function rejectPactOffer(offerId) {
    const offer = roomData.pactOffers[offerId];
    if (!offer || offer.status !== "pending") return;
    roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });

    const senderData = roomData.players[offer.senderId];
    const receiverData = roomData.players[offer.receiverId];

    // Sohbete yaz
    const rejectMsg = {
      sender: "SİSTEM",
      text:
        receiverData.name +
        ", " +
        senderData.name +
        " tarafından yapılan pakt teklifini reddetti.",
      color: "#ffcc00",
      system: true,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(rejectMsg);

    showNotification("Saldırmazlık pakti teklifi reddedildi.");
  }

  /****************************************************************
   * OYUN İŞLEVLERİ
   ****************************************************************/
  function attack() {
    if (!isMyTurn()) {
      showNotification("Sıranız değil!");
      return;
    }
    if (!selectedCountry) {
      showNotification("Bir ülkeyi seçin!");
      return;
    }
    const soldiersToSend = parseInt(
      document.getElementById("attack-soldiers").value
    );
    if (isNaN(soldiersToSend) || soldiersToSend <= 0) {
      showNotification("Geçerli bir asker sayısı girin!");
      return;
    }

    const currentTurnIndex = roomData.currentTurnIndex || 0;
    const currentPlayerId = roomData.playerOrder[currentTurnIndex];
    const currentPlayerData = roomData.players[currentPlayerId];
    if (soldiersToSend > currentPlayerData.soldiers) {
      showNotification("Yeterli askeriniz yok!");
      return;
    }

    const target = roomData.countryData[selectedCountry];
    if (!target) return;

    // Pakt kontrolü
    if (target.owner && target.owner !== currentPlayerId) {
      if (hasActivePact(currentPlayerId, target.owner)) {
        showNotification("Bu oyuncu ile saldırmazlık paktınız var!");
        return;
      }
    }

    const updates = {};

    // Eğer zaten bize aitse, yalnızca asker ekle
    if (target.owner === currentPlayerId) {
      updates["countryData/" + selectedCountry + "/soldiers"] =
        target.soldiers + soldiersToSend;
      updates["players/" + currentPlayerId + "/soldiers"] =
        currentPlayerData.soldiers - soldiersToSend;

      showNotification(
        selectedCountry + " ülkesine " + soldiersToSend + " asker gönderildi.",
        3000,
        currentPlayerData.color,
        false
      );
      // Sohbet mesajı (saldırı değil takviye)
      const chatMsg = {
        sender: currentPlayerData.name,
        text:
          "Kendi ülkesine " +
          soldiersToSend +
          " asker takviye etti: " +
          selectedCountry,
        color: currentPlayerData.color,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.child("chat").push(chatMsg);
    } else {
      // Saldırı
      updates["players/" + currentPlayerId + "/soldiers"] =
        currentPlayerData.soldiers - soldiersToSend;

      if (soldiersToSend > target.soldiers) {
        const remaining = soldiersToSend - target.soldiers;
        updates["countryData/" + selectedCountry + "/soldiers"] = remaining;
        updates["countryData/" + selectedCountry + "/owner"] = currentPlayerId;

        let currentCountries = currentPlayerData.countries || [];
        if (!currentCountries.includes(selectedCountry)) {
          currentCountries.push(selectedCountry);
        }
        updates["players/" + currentPlayerId + "/countries"] = currentCountries;

        if (target.owner && roomData.players[target.owner]) {
          let defenderCountries =
            roomData.players[target.owner].countries || [];
          defenderCountries = defenderCountries.filter(
            (c) => c !== selectedCountry
          );
          updates["players/" + target.owner + "/countries"] = defenderCountries;
        }

        showNotification(
          selectedCountry + " fethedildi!",
          3000,
          currentPlayerData.color,
          false
        );
        // Sohbet mesajı
        const chatMsg = {
          sender: currentPlayerData.name,
          text:
            selectedCountry +
            " ülkesini fethetti (Asker gönderilen: " +
            soldiersToSend +
            ").",
          color: currentPlayerData.color,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        roomRef.child("chat").push(chatMsg);
      } else {
        // Savunuldu
        updates["countryData/" + selectedCountry + "/soldiers"] =
          target.soldiers - soldiersToSend;

        showNotification(selectedCountry + " savunuldu!");
        // Sohbete yaz
        const chatMsg = {
          sender: "SİSTEM",
          text:
            currentPlayerData.name +
            " saldırdı, ancak " +
            selectedCountry +
            " savunuldu. (Gönderilen: " +
            soldiersToSend +
            " asker)",
          color: "#ffcc00",
          system: true,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        roomRef.child("chat").push(chatMsg);
      }
      nextTurn();
    }

    roomRef.update(updates);
  }

  function buySoldiers() {
    if (!isMyTurn()) {
      showNotification("Sıranız değil!");
      return;
    }
    const count = parseInt(document.getElementById("soldiers-to-buy").value);
    if (isNaN(count) || count <= 0) {
      showNotification("Geçerli bir asker sayısı girin!");
      return;
    }
    const cost = count * 10;
    const currentTurnIndex = roomData.currentTurnIndex || 0;
    const currentPlayerId = roomData.playerOrder[currentTurnIndex];
    const currentPlayerData = roomData.players[currentPlayerId];

    if (currentPlayerData.money < cost) {
      showNotification("Yeterli paranız yok!");
      return;
    }

    const updates = {};
    updates["players/" + currentPlayerId + "/money"] =
      currentPlayerData.money - cost;
    updates["players/" + currentPlayerId + "/soldiers"] =
      currentPlayerData.soldiers + count;
    roomRef.update(updates);

    showNotification(
      count + " asker satın alındı.",
      3000,
      currentPlayerData.color,
      false
    );
    // Sohbete de yaz
    const chatMsg = {
      sender: currentPlayerData.name,
      text: count + " asker satın aldı.",
      color: currentPlayerData.color,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(chatMsg);
  }

  function buyBarracks() {
    if (!isMyTurn()) {
      showNotification("Sıranız değil!");
      return;
    }
    if (!selectedCountry) {
      showNotification("Bir ülke seçin!");
      return;
    }
    const currentTurnIndex = roomData.currentTurnIndex || 0;
    const currentPlayerId = roomData.playerOrder[currentTurnIndex];
    const currentPlayerData = roomData.players[currentPlayerId];
    const target = roomData.countryData[selectedCountry];

    if (target.owner !== currentPlayerId) {
      showNotification("Bu ülke size ait değil!");
      return;
    }
    // Yeni maliyet: 130$ + 100 varil
    if (currentPlayerData.money < 130) {
      showNotification("Yeterli paranız yok!");
      return;
    }
    if (currentPlayerData.petrol < 100) {
      showNotification("Yeterli petrolünüz yok!");
      return;
    }

    const updates = {};
    updates["players/" + currentPlayerId + "/money"] =
      currentPlayerData.money - 130;
    updates["players/" + currentPlayerId + "/petrol"] =
      currentPlayerData.petrol - 100;
    updates["countryData/" + selectedCountry + "/barracksCount"] =
      (target.barracksCount || 0) + 1;
    roomRef.update(updates);

    showNotification("Asker kışlası kuruldu.", 3000, currentPlayerData.color);
    // Sohbet
    const chatMsg = {
      sender: currentPlayerData.name,
      text: selectedCountry + " ülkesine kışla kurdu.",
      color: currentPlayerData.color,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(chatMsg);
  }

  function buildFactory() {
    if (!isMyTurn()) {
      showNotification("Sıranız değil!");
      return;
    }
    if (!selectedCountry) {
      showNotification("Bir ülkeyi seçin!");
      return;
    }
    const currentTurnIndex = roomData.currentTurnIndex || 0;
    const currentPlayerId = roomData.playerOrder[currentTurnIndex];
    const currentPlayerData = roomData.players[currentPlayerId];
    const target = roomData.countryData[selectedCountry];

    if (target.owner !== currentPlayerId) {
      showNotification("Bu ülke size ait değil!");
      return;
    }

    // Fabrika: 500$ + 400 varil
    if (currentPlayerData.money < 500) {
      showNotification("Yeterli paranız yok!");
      return;
    }
    if (currentPlayerData.petrol < 400) {
      showNotification("Yeterli petrolünüz yok!");
      return;
    }

    const updates = {};
    updates["players/" + currentPlayerId + "/money"] =
      currentPlayerData.money - 500;
    updates["players/" + currentPlayerId + "/petrol"] =
      currentPlayerData.petrol - 400;
    updates["countryData/" + selectedCountry + "/factories"] =
      (target.factories || 0) + 1;
    roomRef.update(updates);

    showNotification("Fabrika kuruldu.", 3000, currentPlayerData.color);
    // Sohbet
    const chatMsg = {
      sender: currentPlayerData.name,
      text: selectedCountry + " ülkesine fabrika kurdu.",
      color: currentPlayerData.color,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(chatMsg);
  }

  function buildRefinery() {
    if (!isMyTurn()) {
      showNotification("Sıranız değil!");
      return;
    }
    if (!selectedCountry) {
      showNotification("Bir ülke seçin!");
      return;
    }
    const currentTurnIndex = roomData.currentTurnIndex || 0;
    const currentPlayerId = roomData.playerOrder[currentTurnIndex];
    const currentPlayerData = roomData.players[currentPlayerId];
    const target = roomData.countryData[selectedCountry];

    if (!target.oilProduction) {
      showNotification("Bu ülkenin petrol üretim kapasitesi yok!");
      return;
    }
    // Rafine: 800$ + 400 varil
    if (currentPlayerData.money < 800) {
      showNotification("Yeterli paranız yok!");
      return;
    }
    if (currentPlayerData.petrol < 400) {
      showNotification("Yeterli petrolünüz yok!");
      return;
    }

    const updates = {};
    updates["players/" + currentPlayerId + "/money"] =
      currentPlayerData.money - 800;
    updates["players/" + currentPlayerId + "/petrol"] =
      currentPlayerData.petrol - 400;
    updates["countryData/" + selectedCountry + "/refineries"] =
      (target.refineries || 0) + 1;
    roomRef.update(updates);

    showNotification("Rafine kuruldu. Üretim kapasitesi arttı.", 3000, currentPlayerData.color);
    // Sohbet
    const chatMsg = {
      sender: currentPlayerData.name,
      text: selectedCountry + " ülkesine rafineri kurdu.",
      color: currentPlayerData.color,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(chatMsg);
  }

  function pullSoldiers() {
    if (!isMyTurn()) {
      showNotification("Sıranız değil!");
      return;
    }
    if (!selectedCountry) {
      showNotification("Bir ülke seçin!");
      return;
    }
    const currentTurnIndex = roomData.currentTurnIndex || 0;
    const currentPlayerId = roomData.playerOrder[currentTurnIndex];
    const target = roomData.countryData[selectedCountry];

    if (target.owner !== currentPlayerId) {
      showNotification("Bu ülke size ait değil!");
      return;
    }

    const count = parseInt(
      document.getElementById("pull-soldiers-count").value
    );
    if (isNaN(count) || count <= 0) {
      showNotification("Geçerli bir asker sayısı girin!");
      return;
    }
    if (target.soldiers < count) {
      showNotification("Bu ülkede yeterli asker yok!");
      return;
    }

    const updates = {};
    updates["countryData/" + selectedCountry + "/soldiers"] =
      target.soldiers - count;
    updates["players/" + currentPlayerId + "/soldiers"] =
      roomData.players[currentPlayerId].soldiers + count;
    roomRef.update(updates);

    const currentPlayerData = roomData.players[currentPlayerId];
    showNotification(
      selectedCountry + " ülkesinden " + count + " asker çekildi.",
      3000,
      currentPlayerData.color
    );
    // Sohbet
    const chatMsg = {
      sender: currentPlayerData.name,
      text:
        selectedCountry + " ülkesinden " + count + " askerini geri çekti.",
      color: currentPlayerData.color,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(chatMsg);
  }

  function sendMoney() {
    if (!isMyTurn()) {
      showNotification("Sıranız değil!");
      return;
    }
    const amount = parseInt(document.getElementById("money-to-send").value);
    const receiverId = document.getElementById("recipient-player").value;
    if (isNaN(amount) || amount <= 0) {
      showNotification("Geçerli bir miktar girin!");
      return;
    }

    const currentTurnIndex = roomData.currentTurnIndex || 0;
    const currentPlayerId = roomData.playerOrder[currentTurnIndex];
    const currentPlayerData = roomData.players[currentPlayerId];

    if (currentPlayerData.money < amount) {
      showNotification("Yeterli paranız yok!");
      return;
    }
    if (receiverId === currentPlayerId) {
      showNotification("Kendinize para gönderemezsiniz!");
      return;
    }

    const updates = {};
    updates["players/" + currentPlayerId + "/money"] =
      currentPlayerData.money - amount;
    updates["players/" + receiverId + "/money"] =
      roomData.players[receiverId].money + amount;
    roomRef.update(updates);

    showNotification(
      amount +
        "$, " +
        roomData.players[receiverId].name +
        " adlı oyuncuya gönderildi.",
      3000,
      currentPlayerData.color
    );
    // Sohbet
    const chatMsg = {
      sender: currentPlayerData.name,
      text:
        currentPlayerData.name +
        " → " +
        roomData.players[receiverId].name +
        ": " +
        amount +
        "$ gönderildi.",
      color: currentPlayerData.color,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(chatMsg);
  }

  function sendPetrol() {
    if (!isMyTurn()) {
      showNotification("Sıranız değil!");
      return;
    }
    const amount = parseInt(document.getElementById("petrol-to-send").value);
    const receiverId = document.getElementById("recipient-player-petrol")
      .value;
    if (isNaN(amount) || amount <= 0) {
      showNotification("Geçerli bir miktar girin!");
      return;
    }

    const currentTurnIndex = roomData.currentTurnIndex || 0;
    const currentPlayerId = roomData.playerOrder[currentTurnIndex];
    const currentPlayerData = roomData.players[currentPlayerId];

    if (currentPlayerData.petrol < amount) {
      showNotification("Yeterli benzininiz yok!");
      return;
    }
    if (receiverId === currentPlayerId) {
      showNotification("Kendinize benzin gönderemezsiniz!");
      return;
    }

    const updates = {};
    updates["players/" + currentPlayerId + "/petrol"] =
      currentPlayerData.petrol - amount;
    updates["players/" + receiverId + "/petrol"] =
      roomData.players[receiverId].petrol + amount;
    roomRef.update(updates);

    showNotification(
      amount +
        " varil, " +
        roomData.players[receiverId].name +
        " adlı oyuncuya gönderildi.",
      3000,
      currentPlayerData.color
    );
    // Sohbet
    const chatMsg = {
      sender: currentPlayerData.name,
      text:
        currentPlayerData.name +
        " → " +
        roomData.players[receiverId].name +
        ": " +
        amount +
        " varil benzin gönderildi.",
      color: currentPlayerData.color,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(chatMsg);
  }

  function nextTurn() {
    if (!isMyTurn()) {
      showNotification("Sıranız değil!");
      return;
    }
    const currentTurnIndex = roomData.currentTurnIndex || 0;
    const currentPlayerId = roomData.playerOrder[currentTurnIndex];
    const player = roomData.players[currentPlayerId];
    const updates = {};

    // Tur bitişinde gelir ve petrol kazanır
    if (player.countries && roomData.countryData) {
      let totalMoneyGained = 0;
      let totalPetrolGained = 0;
      player.countries.forEach((cName) => {
        const country = roomData.countryData[cName];
        if (country) {
          // Kışla -> +5 asker
          if (country.barracksCount) {
            updates["countryData/" + cName + "/soldiers"] =
              (country.soldiers || 0) + 5 * country.barracksCount;
          }
          // Fabrika -> +%20
          let effectiveIncome = country.income || 0;
          if (country.factories) {
            effectiveIncome = Math.floor(
              effectiveIncome * (1 + 0.2 * country.factories)
            );
          }
          totalMoneyGained += effectiveIncome;

          // Rafine -> +%15
          if (country.oilProduction) {
            const effectiveProduction = Math.floor(
              country.oilProduction *
                (1 + 0.15 * (country.refineries || 0))
            );
            totalPetrolGained += effectiveProduction;
          }
        }
      });
      updates["players/" + currentPlayerId + "/money"] =
        (player.money || 0) + totalMoneyGained;
      updates["players/" + currentPlayerId + "/petrol"] =
        (player.petrol || 0) + totalPetrolGained;
    }

    let newTurnIndex = currentTurnIndex + 1;
    if (newTurnIndex >= roomData.playerOrder.length) {
      newTurnIndex = 0;
      updates["round"] = (roomData.round || 1) + 1;
    }
    updates["currentTurnIndex"] = newTurnIndex;

    // Sohbet mesajı (tur geçti)
    const nextPlayerId = roomData.playerOrder[newTurnIndex];
    const chatMsg = {
      sender: "SİSTEM",
      text:
        player.name +
        " turunu bitirdi. Sıra: " +
        roomData.players[nextPlayerId].name,
      color: "#ffcc00",
      system: true,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(chatMsg);

    roomRef.update(updates);

    showNotification(
      "Sıra " + roomData.players[nextPlayerId].name + " adlı oyuncuya geçti.",
      1500
    );
  }

  /******************************************************************
   * SOHBET SİSTEMİ
   ******************************************************************/
  function toggleChat(show) {
    const chatPopup = document.getElementById("chat-popup");
    chatOpen = show;
    if (show) {
      chatPopup.style.display = "flex";
      // Okunmamış mesaj sayısını sıfırla
      unreadMessages = 0;
      updateChatUnreadCount();
    } else {
      chatPopup.style.display = "none";
    }
  }

  document.getElementById("open-chat-btn").addEventListener("click", () => {
    toggleChat(true);
  });

  document.getElementById("close-chat-btn").addEventListener("click", () => {
    toggleChat(false);
  });

  document.getElementById("send-chat-btn").addEventListener("click", () => {
    sendChatMessage();
  });

  document.getElementById("chat-input").addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      sendChatMessage();
    }
  });

  function sendChatMessage() {
    const input = document.getElementById("chat-input");
    const messageText = input.value.trim();
    if (!messageText) return;
    if (!roomRef) {
      showNotification("Oda yok veya bağlanılmadı!");
      return;
    }
    let senderName = "Anon";
    let senderColor = "#fff";
    let isSystem = false;
    if (roomData && roomData.players && roomData.players[localPlayerId]) {
      senderName = roomData.players[localPlayerId].name;
      senderColor = roomData.players[localPlayerId].color || "#fff";
    }
    const chatMessage = {
      sender: senderName,
      text: messageText,
      color: senderColor,
      system: isSystem,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(chatMessage, (error) => {
      if (!error) {
        input.value = "";
      }
    });
  }

  // Sohbet mesajlarını ekrana yansıtma
  function appendChatMessage(msg, realTime = false) {
    const chatMessagesDiv = document.getElementById("chat-messages");

    const messageDiv = document.createElement("div");
    // Sistem mesajı mı?
    if (msg.system) {
      messageDiv.classList.add("chat-message-system", "chat-message");
      messageDiv.textContent = "[SİSTEM] " + msg.text;
    } else {
      messageDiv.classList.add("chat-message-player", "chat-message");
      messageDiv.style.color = msg.color || "#fff";
      messageDiv.textContent = msg.sender + ": " + msg.text;
    }

    chatMessagesDiv.appendChild(messageDiv);
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

    // Eğer sohbet kapalıysa unreadMessages++
    if (!chatOpen && realTime) {
      unreadMessages++;
      updateChatUnreadCount();
    }
  }

  function updateChatUnreadCount() {
    const countSpan = document.getElementById("chat-unread-count");
    if (unreadMessages > 0) {
      countSpan.style.display = "flex";
      countSpan.textContent = unreadMessages;
    } else {
      countSpan.style.display = "none";
      countSpan.textContent = "0";
    }
  }

  /******************************************************************
   * PAKT AÇILIR PENCERESİ
   *****************************************************************/
  function togglePactPopup(show) {
    const pactPopup = document.getElementById("pact-popup");
    pactPopup.style.display = show ? "flex" : "none";
  }

  document.getElementById("open-pact-btn").addEventListener("click", () => {
    togglePactPopup(true);
  });

  document.getElementById("close-pact-btn").addEventListener("click", () => {
    togglePactPopup(false);
  });

  document.getElementById("send-pact-btn").addEventListener("click", sendPactOffer);

  /*********************************************************************
   * OLAY DİNLEYİCİLER
   *********************************************************************/
  document.getElementById("attack-btn").addEventListener("click", attack);
  document.getElementById("buy-soldiers-btn").addEventListener("click", buySoldiers);
  document.getElementById("buy-barracks-btn").addEventListener("click", buyBarracks);
  document.getElementById("build-factory-btn").addEventListener("click", buildFactory);
  document.getElementById("build-refinery-btn").addEventListener("click", buildRefinery);
  document.getElementById("pull-soldiers-btn").addEventListener("click", pullSoldiers);
  document.getElementById("send-money-btn").addEventListener("click", sendMoney);
  document.getElementById("send-petrol-btn").addEventListener("click", sendPetrol);
  document.getElementById("end-turn-btn").addEventListener("click", nextTurn);

  document.getElementById("exit-room-btn").addEventListener("click", () => {
    document.getElementById("game-container").style.display = "none";
    document.getElementById("lobby-container").style.display = "block";
    document.body.classList.add("lobby");
  });

  /*********************************************************************
   * HARİTA (Leaflet) KURULUMU
   *********************************************************************/
  function initializeMap() {
    if (map) return;
    map = L.map("map").setView([20, 0], 2);

    // Esri World Ocean (daha mavi ve canlı denizler)
    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 12,
        attribution:
          "Esri &mdash; Kaynak: Esri, GEBCO, NOAA, National Geographic, DeLorme, HERE, Geonames.org ve diğer katkıda bulunanlar"
      }
    ).addTo(map);

    fetch(
      "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json"
    )
      .then((response) => response.json())
      .then((geoJsonData) => {
        geoJsonLayer = L.geoJson(geoJsonData, {
          style: () => ({
            color: "#555",
            weight: 1,
            fillColor: "#ccc",
            fillOpacity: 0.7
          }),
          onEachFeature: (feature, layer) => {
            const countryName = feature.properties.name;
            layer.bindTooltip(
              getCountryPopupContent(
                countryName,
                roomData && roomData.countryData
                  ? roomData.countryData[countryName]
                  : {}
              ),
              {
                permanent: infoCardsPermanent,
                direction: "center",
                className: "country-popup-tooltip"
              }
            );
            layer.on("click", () => selectCountry(countryName, layer));
          }
        }).addTo(map);
      });
  }

  function updateTooltipsPermanent() {
    if (!geoJsonLayer) return;
    geoJsonLayer.eachLayer((layer) => {
      layer.unbindTooltip();
      const countryName = layer.feature.properties.name;
      const tooltipContent = getCountryPopupContent(
        countryName,
        roomData && roomData.countryData
          ? roomData.countryData[countryName]
          : {}
      );
      layer.bindTooltip(tooltipContent, {
        permanent: infoCardsPermanent,
        direction: "center",
        className: "country-popup-tooltip"
      });
    });
  }

  function selectCountry(countryName, layer) {
    selectedCountry = countryName;
    showNotification("Seçilen ülke: " + countryName, 1500);

    layer.setStyle({ weight: 4, color: "#FF4500" });
    setTimeout(() => {
      const country = roomData.countryData
        ? roomData.countryData[countryName]
        : null;
      if (country && country.owner && roomData.players && roomData.players[country.owner]) {
        layer.setStyle({
          fillColor: roomData.players[country.owner].color || "#ccc",
          fillOpacity: 0.7,
          weight: 1,
          color: "#555"
        });
      } else {
        layer.setStyle({
          fillColor: "#ccc",
          fillOpacity: 0.7,
          weight: 1,
          color: "#555"
        });
      }
    }, 800);

    updateSelectedCountryInfo();
  }

  const gameContainerObserver = new MutationObserver(() => {
    const gameContainer = document.getElementById("game-container");
    if (gameContainer.style.display !== "none") {
      initializeMap();
    }
  });
  gameContainerObserver.observe(document.getElementById("game-container"), {
    attributes: true,
    attributeFilter: ["style"]
  });
  </script>
</body>
</html>
