<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Global Conquest - Online</title>
  <!-- Viewport Ayarı -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap"
    rel="stylesheet"
  />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <!-- FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    /********************************************************************
     * GENEL SIFIRLAMA
     ********************************************************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Cinzel", serif;
      background: linear-gradient(120deg, #5d4037, #4e342e 40%, #3e2723);
      color: #eee;
      overflow-x: hidden;
      transition: background 0.5s;
    }
    a {
      color: inherit;
      text-decoration: none;
    }

    /********************************************************************
     * LOBI (ODA OLUŞTUR / KATIL) TASARIMI
     ********************************************************************/
    body.lobby {
      background: linear-gradient(120deg, #5d4037, #4e342e 40%, #3e2723);
    }
    #lobby-container {
      max-width: 500px;
      margin: 60px auto;
      padding: 30px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #ffab91;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
    }
    #lobby-container h1 {
      text-align: center;
      margin-bottom: 15px;
      color: #ffccbc;
      font-size: 36px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    #lobby-container h2 {
      color: #ffd180;
      text-transform: uppercase;
      font-size: 20px;
      margin: 20px 0 10px;
      text-align: center;
    }
    #lobby-container input[type="text"],
    #lobby-container input[type="number"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid #ffab91;
      border-radius: 4px;
      font-size: 15px;
      outline: none;
      color: #333;
      transition: box-shadow 0.3s;
    }
    #lobby-container input[type="text"]:focus,
    #lobby-container input[type="number"]:focus {
      box-shadow: 0 0 8px #ffab91;
    }
    #lobby-container button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      background: linear-gradient(45deg, #ff8a65, #ff7043);
      border: 1px solid #ff7043;
      border-radius: 6px;
      font-size: 18px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.6);
      transition: background 0.3s, transform 0.3s;
    }
    #lobby-container button:hover {
      background: linear-gradient(45deg, #ff7043, #ff8a65);
      transform: scale(1.02);
    }
    #lobby-container hr {
      border: none;
      border-top: 1px solid #ccc;
      margin: 20px 0;
    }
    .color-options {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .color-options .global-color-option {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: transform 0.3s, border-color 0.3s;
    }
    .color-options .global-color-option:hover {
      transform: scale(1.2);
      border-color: #fff;
    }
    .color-options .global-color-option.selected {
      border-color: #ffd54f;
    }

    /********************************************************************
     * KISA SÜRELİ (EPHEMERAL) BİLDİRİM ALANI (SAĞ ÜST)
     ********************************************************************/
    #notification-area {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .notification-item {
      min-width: 200px;
      max-width: 350px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
      font-size: 16px;
      line-height: 1.4;
      opacity: 0;
      transform: translateX(100%);
      animation: slideIn 0.5s forwards, fadeOut 0.5s 5.5s forwards;
    }
    @keyframes slideIn {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /********************************************************************
     * OYUN ANA KONTEYNER
     ********************************************************************/
    #game-container {
      display: none;
      height: 100vh;
      background: linear-gradient(140deg, #4e342e, #3e2723);
      position: relative;
    }
    /* Harita Alanı */
    #map-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
    }

    /********************************************************************
     * ÜST BİLGİ (ODA KODU, SIRA, TUR, vb.)
     ********************************************************************/
    #top-info {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3100;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }
    #top-info p {
      margin: 0;
      font-size: 16px;
      color: #ffd180;
    }
    #top-info p span {
      font-weight: 600;
      color: #ffb74d;
    }

    /* Tur Sonu Butonu */
    #end-turn-btn {
      background: linear-gradient(45deg, #ff8a65, #ff7043);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #end-turn-btn:hover {
      background: linear-gradient(45deg, #ff7043, #ff8a65);
    }
    /* Sayaç */
    #turn-timer {
      font-size: 14px;
      color: #ffd54f;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* OYUNU BAŞLAT BUTONU */
    #start-game-btn {
      background: linear-gradient(45deg, #ffd54f, #ffc107);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.3s;
      display: none; /* Sadece Host görecek */
    }
    #start-game-btn:hover {
      background: linear-gradient(45deg, #ffc107, #ffd54f);
    }
    #start-countdown {
      font-size: 16px;
      color: #fff176;
      display: none;
    }

    /********************************************************************
     * SAĞ ÜSTTEKİ "PAKTLAR" BUTONU & PAKT GÖRÜNTÜLEME PANELİ
     ********************************************************************/
    #pacts-container {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 3101;
    }
    #pacts-bell {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 24px;
      color: #fff;
      position: relative;
      transition: transform 0.3s;
    }
    #pacts-bell:hover {
      transform: scale(1.1);
    }
    /* Pakt Paneli */
    #pacts-panel {
      display: none;
      position: absolute;
      top: 35px;
      right: 0;
      width: 260px;
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
    }
    #pacts-panel h3 {
      font-size: 16px;
      color: #ffcc80;
      margin-bottom: 10px;
      text-align: center;
    }
    #pacts-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #pacts-list li {
      color: #fff;
      font-size: 14px;
      border-bottom: 1px solid #444;
      padding: 6px 0;
    }
    #pacts-list li:last-child {
      border-bottom: none;
    }

    /********************************************************************
     * ALT İKONLAR (Chat, Market, Asker, vb.)
     ********************************************************************/
    #bottom-icons {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 3200;
    }
    .bottom-icon-btn {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(45deg, #ff8a65, #ff7043);
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
      transition: transform 0.3s, background 0.3s;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .bottom-icon-btn:hover {
      transform: scale(1.05);
      background: linear-gradient(45deg, #ff7043, #ff8a65);
    }
    /* Chat Badge (okunmamış mesaj sayısı) */
    .bottom-icon-btn[data-badge]:after {
      content: attr(data-badge);
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      border-radius: 50%;
      min-width: 20px;
      min-height: 20px;
      padding: 2px 6px;
      text-align: center;
      font-size: 12px;
      pointer-events: none;
    }

    /* Odadan Çık Butonu */
    #exit-room-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(45deg, #d84315, #e64a19);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.3s;
      z-index: 3300;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
    #exit-room-btn:hover {
      background: linear-gradient(45deg, #e64a19, #d84315);
    }

    /********************************************************************
     * LEAFLET TOOLTIP TASARIMI
     ********************************************************************/
    .leaflet-tooltip {
      background: transparent;
      border: none;
    }
    .country-popup-tooltip {
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /********************************************************************
     * POPUP GENEL STİL
     ********************************************************************/
    .modern-popup {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 450px;
      max-height: 70vh;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: none;
      flex-direction: column;
      z-index: 4000;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      animation: fadeInPopup 0.5s ease forwards;
    }
    @keyframes fadeInPopup {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modern-popup .popup-header {
      background: linear-gradient(45deg, #4e342e, #3e2723);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      cursor: pointer;
    }
    .modern-popup .popup-header button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .modern-popup .popup-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      font-size: 15px;
    }
    .modern-popup .popup-content h3 {
      font-size: 18px;
      color: #ffcc80;
      margin-bottom: 10px;
    }
    .modern-popup .popup-content input[type="number"],
    .modern-popup .popup-content select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ffab91;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
      outline: none;
    }
    .modern-popup .popup-content button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(45deg, #ff8a65, #ff7043);
      border: none;
      border-radius: 6px;
      font-size: 16px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }
    .modern-popup .popup-content button:hover {
      background: linear-gradient(45deg, #ff7043, #ff8a65);
    }

    /********************************************************************
     * CHAT POPUP
     ********************************************************************/
    .chat-popup {
      width: 450px;
      max-height: 70vh;
      display: none;
      flex-direction: column;
      z-index: 4001;
    }
    .chat-header {
      background: linear-gradient(45deg, #4e342e, #3e2723);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      cursor: pointer;
    }
    .chat-header button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.3);
      color: #eee;
      font-size: 15px;
    }
    .chat-input-container {
      display: flex;
      border-top: 1px solid #444;
    }
    .chat-input-container input[type="text"] {
      flex: 1;
      padding: 15px;
      border: none;
      outline: none;
      background: #1e1e2f;
      color: #eee;
      font-size: 15px;
    }
    .chat-input-container button {
      padding: 15px;
      background: linear-gradient(45deg, #ff8a65, #ff7043);
      border: none;
      cursor: pointer;
      color: #fff;
      font-size: 18px;
    }
    .chat-private-container {
      border-top: 1px solid #444;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chat-private-container select,
    .chat-private-container input[type="text"] {
      padding: 10px;
      border: 1px solid #ffab91;
      border-radius: 6px;
      outline: none;
      background: #1e1e2f;
      color: #eee;
      font-size: 15px;
    }
    .chat-private-container button {
      padding: 10px;
      background: linear-gradient(45deg, #ff8a65, #ff7043);
      border: none;
      cursor: pointer;
      color: #fff;
      align-self: flex-end;
      font-size: 16px;
    }

    /********************************************************************
     * PAKT POPUP
     ********************************************************************/
    #pact-popup {
      width: 450px;
      max-height: 70vh;
      display: none;
      flex-direction: column;
      z-index: 4002;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      animation: fadeInPopup 0.5s ease forwards;
    }
    #pact-popup-header {
      background: linear-gradient(45deg, #4e342e, #3e2723);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      cursor: pointer;
    }
    #pact-popup .popup-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      font-size: 15px;
      background: rgba(0, 0, 0, 0.3);
    }
    #pact-popup .popup-content h3 {
      margin-bottom: 10px;
      color: #ffcc80;
    }
    .pact-offer-item {
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .pact-offer-item button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .pact-offer-item .accept-btn {
      background: linear-gradient(45deg, #388e3c, #43a047);
      color: #fff;
    }
    .pact-offer-item .reject-btn {
      background: linear-gradient(45deg, #c62828, #e53935);
      color: #fff;
    }

    /********************************************************************
     * MARKET POPUP
     ********************************************************************/
    .market-popup {
      width: 500px;
      max-height: 70vh;
      display: none;
      flex-direction: column;
      z-index: 4002;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      animation: fadeInPopup 0.5s ease forwards;
    }
    .market-header {
      background: linear-gradient(45deg, #4e342e, #3e2723);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
    }
    .market-header button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .market-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      background: rgba(0, 0, 0, 0.3);
    }
    .market-section {
      margin-bottom: 20px;
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    .market-section h3 {
      font-size: 17px;
      margin-bottom: 10px;
      color: #ffcc80;
    }
    .offer-item {
      background: rgba(0, 0, 0, 0.4);
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /********************************************************************
     * OYUNCULAR POPUP (SOLDA)
     ********************************************************************/
    #players-popup {
      position: fixed;
      bottom: 80px;
      left: 20px;
      width: 450px;
      max-height: 70vh;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: none;
      flex-direction: column;
      z-index: 4002;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      animation: fadeInPopup 0.5s ease forwards;
    }
    #players-popup .popup-header {
      background: linear-gradient(45deg, #4e342e, #3e2723);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
    }
    #players-popup .popup-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      font-size: 15px;
      background: rgba(0, 0, 0, 0.3);
    }
    #players-popup .popup-content .player-info {
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      font-size: 15px;
    }
    #players-popup .popup-content .player-info p {
      margin: 4px 0;
      color: #ddd;
    }

    /********************************************************************
     * RESPONSIVE AYARLAR
     ********************************************************************/
    @media screen and (max-width: 768px) {
      #lobby-container {
        width: 90%;
        margin: 20px auto;
        padding: 20px;
      }
      #lobby-container h1 {
        font-size: 28px;
      }
      #lobby-container h2 {
        font-size: 18px;
      }

      #top-info {
        width: 90%;
        padding: 8px 10px;
        gap: 5px;
        left: 50%;
        transform: translateX(-50%);
        flex-direction: column;
      }
      #top-info p {
        font-size: 14px;
      }
      #bottom-icons {
        gap: 10px;
      }
      .bottom-icon-btn {
        width: 44px;
        height: 44px;
        font-size: 16px;
      }
      #exit-room-btn {
        bottom: 80px;
        right: 20px;
        font-size: 13px;
        padding: 8px 12px;
      }
      .modern-popup,
      .chat-popup,
      .market-popup,
      #pact-popup,
      #players-popup {
        width: 90% !important;
        right: 5% !important;
        left: auto !important;
        bottom: 90px;
      }
    }
  </style>
</head>

<body class="lobby">
  <!-- LOBI KONTEYNER -->
  <div id="lobby-container">
    <h1>GLOBAL CONQUEST</h1>
    <!-- Oda Oluşturma -->
    <div id="create-room-section">
      <h2>Oda Oluştur</h2>
      <input type="text" id="creator-player-name" placeholder="Adınız"/>
      <div class="color-options" id="creator-color-options"></div>
      <input
        type="number"
        id="max-players"
        placeholder="Oyuncu Sayısı (2-8)"
        min="2"
        max="8"
      />
      <button id="create-room-btn">Oda Oluştur</button>
    </div>
    <hr/>
    <!-- Odaya Katılma -->
    <div id="join-room-section">
      <h2>Odaya Katıl</h2>
      <input type="text" id="join-player-name" placeholder="Adınız"/>
      <div class="color-options" id="join-color-options"></div>
      <input
        type="text"
        id="room-code"
        placeholder="Oda Kodu (Örn: AB12CD)"
      />
      <button id="join-room-btn">Odaya Katıl</button>
    </div>
  </div>

  <!-- Kısa Süreli Ephemeral Bildirim Alanı (Sağ Üst) -->
  <div id="notification-area"></div>

  <!-- Pakt Gösterme Butonu (Sağ Üst) -->
  <div id="pacts-container">
    <button id="pacts-bell" title="Aktif Paktlar">
      <i class="fas fa-handshake"></i>
    </button>
    <div id="pacts-panel">
      <h3>Aktif Paktlar</h3>
      <ul id="pacts-list"></ul>
    </div>
  </div>

  <!-- OYUN KONTEYNER -->
  <div id="game-container">
    <!-- Üst Bilgi -->
    <div id="top-info">
      <p>
        Oda Kodu: <span id="display-room-code">-</span> |
        Tur: <span id="current-round">1</span> |
        Sıra: <span id="current-player">-</span>
      </p>
      <button id="end-turn-btn">
        <i class="fas fa-forward"></i> Tur Sonu
        <span id="turn-timer">60s</span>
      </button>
      <button id="start-game-btn">Oyunu Başlat</button>
      <span id="start-countdown">30</span>
    </div>

    <!-- Harita Alanı -->
    <div id="map-container">
      <div id="map"></div>
    </div>

    <!-- Odadan Çık Butonu -->
    <button id="exit-room-btn">Odadan Çık</button>

    <!-- Alt İkonlar -->
    <div id="bottom-icons">
      <!-- Oyuncu Bilgileri -->
      <button id="open-players-btn" class="bottom-icon-btn" title="Oyuncular">
        <i class="fas fa-users"></i>
      </button>
      <!-- Asker İşlemleri -->
      <button id="open-military-btn" class="bottom-icon-btn" title="Asker İşlemleri">
        <i class="fas fa-shield-alt"></i>
      </button>
      <!-- Bina Kurma -->
      <button id="open-building-btn" class="bottom-icon-btn" title="Bina Kurma">
        <i class="fas fa-building"></i>
      </button>
      <!-- Kaynak Gönderme -->
      <button id="open-resource-btn" class="bottom-icon-btn" title="Kaynak Gönderme">
        <i class="fas fa-hand-holding-usd"></i>
      </button>
      <!-- Market -->
      <button id="open-market-btn" class="bottom-icon-btn" data-badge="" title="Ticaret Merkezi">
        <i class="fas fa-store"></i>
      </button>
      <!-- Pakt -->
      <button id="open-pact-btn" class="bottom-icon-btn" title="Saldırmazlık Pakti">
        <i class="fas fa-handshake"></i>
      </button>
      <!-- Chat -->
      <button id="open-chat-btn" class="bottom-icon-btn" data-badge="" title="Sohbet">
        <i class="fas fa-comments"></i>
      </button>
    </div>
  </div>

  <!-- ASKER İŞLEMLERİ POPUP -->
  <div id="military-popup" class="modern-popup">
    <div class="popup-header" id="military-popup-header">
      <span>Asker İşlemleri</span>
      <button id="close-military-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Saldırı (Kendi Sıranızda)</h3>
      <input
        type="number"
        id="attack-soldiers"
        placeholder="Asker sayısı"
        min="1"
      />
      <button id="attack-btn">
        <i class="fas fa-crosshairs"></i> Saldırı Yap
      </button>

      <h3>Asker Satın Alma (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">1 Asker = 10$ + 25 Buğday</p>
      <input
        type="number"
        id="soldiers-to-buy"
        placeholder="Adet"
        min="1"
      />
      <button id="buy-soldiers-btn">
        <i class="fas fa-user-plus"></i> Satın Al
      </button>

      <h3>Asker Çek</h3>
      <p style="font-size:14px; color:#ccc;">Sahibi olduğunuz veya destek verdiğiniz ülkeden asker geri çekme</p>
      <input
        type="number"
        id="pull-soldiers-count"
        placeholder="Asker sayısı"
        min="1"
      />
      <button id="pull-soldiers-btn">
        <i class="fas fa-running"></i> Asker Çek
      </button>

      <h3>Askeri Destek Gönder</h3>
      <p style="font-size:14px; color:#ccc;">Bir oyuncunun ülkesine asker desteği</p>
      <select id="support-recipient"></select>
      <select id="support-recipient-country"></select>
      <input
        type="number"
        id="support-soldiers"
        placeholder="Asker sayısı"
        min="1"
      />
      <button id="send-support-btn">
        <i class="fas fa-hands-helping"></i> Destek Gönder
      </button>
    </div>
  </div>

  <!-- BİNA KURMA POPUP -->
  <div id="building-popup" class="modern-popup">
    <div class="popup-header" id="building-popup-header">
      <span>Bina Kurma</span>
      <button id="close-building-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Kışla Kur</h3>
      <p style="font-size:14px; color:#ccc;">1 Kışla = 140$ + 40 Varil + 90 Buğday</p>
      <input
        type="number"
        id="barracks-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="buy-barracks-btn">
        <i class="fas fa-fort-awesome"></i> Kışla Kur
      </button>

      <h3>Fabrika Kur</h3>
      <p style="font-size:14px; color:#ccc;">1 Fabrika = 500$ + 100 Varil Petrol</p>
      <input
        type="number"
        id="factory-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="build-factory-btn">
        <i class="fas fa-industry"></i> Fabrika Kur
      </button>

      <h3>Rafine Kur</h3>
      <p style="font-size:14px; color:#ccc;">1 Rafine = 800$ + 250 Varil Petrol</p>
      <input
        type="number"
        id="refinery-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="build-refinery-btn">
        <i class="fas fa-oil-can"></i> Rafine Kur
      </button>

      <h3>Değirmen Kur</h3>
      <p style="font-size:14px; color:#ccc;">1 Değirmen = 200$ + 100 Varil Petrol</p>
      <input
        type="number"
        id="grainmill-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="build-grainmill-btn">
        <i class="fas fa-wheat-awn"></i> Değirmen Kur
      </button>
    </div>
  </div>

  <!-- KAYNAK GÖNDERME POPUP -->
  <div id="resource-popup" class="modern-popup">
    <div class="popup-header" id="resource-popup-header">
      <span>Kaynak Gönderme</span>
      <button id="close-resource-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Para Gönder</h3>
      <input
        type="number"
        id="money-to-send"
        placeholder="Miktar ($)"
        min="1"
      />
      <select id="recipient-player"></select>
      <button id="send-money-btn">
        <i class="fas fa-hand-holding-usd"></i> Para Gönder
      </button>

      <h3>Petrol Gönder</h3>
      <input
        type="number"
        id="petrol-to-send"
        placeholder="Varil"
        min="1"
      />
      <select id="recipient-player-petrol"></select>
      <button id="send-petrol-btn">
        <i class="fas fa-gas-pump"></i> Petrol Gönder
      </button>

      <h3>Buğday Gönder</h3>
      <input
        type="number"
        id="wheat-to-send"
        placeholder="Buğday"
        min="1"
      />
      <select id="recipient-player-wheat"></select>
      <button id="send-wheat-btn">
        <i class="fas fa-wheat-awn"></i> Buğday Gönder
      </button>
    </div>
  </div>

  <!-- OYUNCULAR POPUP (SOL) -->
  <div id="players-popup">
    <div class="popup-header" id="players-popup-header">
      <span>Oyuncu Bilgileri</span>
      <button id="close-players-btn">&times;</button>
    </div>
    <div class="popup-content" id="players-info">
      <!-- Oyuncu bilgileri dinamik eklenecek -->
    </div>
  </div>

  <!-- CHAT POPUP -->
  <div id="chat-popup" class="chat-popup modern-popup">
    <div class="chat-header" id="chat-popup-header">
      <span>Sohbet</span>
      <button id="close-chat-btn">&times;</button>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Mesajınızı yazın..." />
      <button id="send-chat-btn">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    <div class="chat-private-container">
      <h4>Özel Mesaj</h4>
      <select id="private-message-recipient"></select>
      <input type="text" id="private-message-input" placeholder="Özel mesajınız..." />
      <button id="send-private-message-btn">
        <i class="fas fa-user-secret"></i> Gönder
      </button>
    </div>
  </div>

  <!-- SALDIRMAZLIK PAKTI POPUP -->
  <div id="pact-popup" class="modern-popup">
    <div id="pact-popup-header" class="popup-header">
      <span>Saldırmazlık Pakti</span>
      <button id="close-pact-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Yeni Pakt Teklifi Gönder</h3>
      <select id="pact-offer-recipient"></select>
      <input type="number" id="pact-duration" placeholder="Tur sayısı (örn: 3)"/>
      <input type="number" id="pact-cost" placeholder="Tek seferlik para ($)"/>
      <button id="send-pact-offer-btn" style="margin-bottom: 15px;">Teklif Gönder</button>

      <h3>Gelen Teklifler</h3>
      <div id="pact-pending-offers"></div>
    </div>
  </div>

  <!-- MARKET POPUP -->
  <div id="market-popup" class="market-popup modern-popup">
    <div class="market-header" id="market-popup-header">
      <h2>Ticaret Merkezi</h2>
      <button id="close-market-btn">&times;</button>
    </div>
    <div class="market-content">
      <!-- Teklif Oluşturma -->
      <div class="market-section">
        <h3>Yeni Teklif Oluştur</h3>
        <label style="font-size:14px;color:#ccc;">Satmak istediğiniz ürün:</label><br/>
        <select id="trade-item-type">
          <!-- Kışla, Rafine, Değirmen kaldırıldı, sadece Petrol, Fabrika, Buğday -->
          <option value="petrol">Petrol</option>
          <option value="factory">Fabrika</option>
          <option value="wheat">Buğday</option>
        </select>
        <br/><br/>

        <label style="font-size:14px;color:#ccc;">Ülke (bina satıyorsanız seçin):</label><br/>
        <select id="trade-country" style="display:none;"></select>

        <br/><br/>
        <label style="font-size:14px;color:#ccc;">Miktar (adet/varil/buğday):</label>
        <input type="number" id="trade-quantity" placeholder="Miktar" min="1"/>

        <label style="font-size:14px;color:#ccc;">Birim Fiyat ($):</label>
        <input type="number" id="trade-price" placeholder="Birim Fiyat" min="1"/>

        <label style="font-size:14px;color:#ccc;">Ambargo (Oyuncular):</label><br/>
        <select id="embargo-players" multiple style="width:100%;min-height:50px;"></select>
        <small style="color:#ccc;">(Bu oyuncular bu teklifi satın alamaz)</small>
        <br/><br/>

        <button id="create-trade-offer-btn" style="font-size:15px;">
          Teklifi Oluştur
        </button>
      </div>
      <!-- Mevcut Teklifler -->
      <div class="market-section offer-list">
        <h3>Mevcut Teklifler</h3>
        <div id="trade-offers-list"></div>
      </div>
    </div>
  </div>

  <!-- Firebase + Leaflet + Kendi JS Kodumuz -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <script>
    /**********************************************************************
     * Firebase BAŞLATMA
     **********************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyCINihMNGs-qRYIIBLzXyeaLnM_Lhp-iwg",
      authDomain: "warmapg-77acb.firebaseapp.com",
      databaseURL: "https://warmapg-77acb-default-rtdb.firebaseio.com",
      projectId: "warmapg-77acb",
      storageBucket: "warmapg-77acb.appspot.com",
      messagingSenderId: "895613631339",
      appId: "1:895613631339:web:a7ecc0cfd8ab3ae7e02a2e",
      measurementId: "G-6SJVLLVDCF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /**********************************************************************
     * GLOBAL DEĞİŞKENLER
     **********************************************************************/
    let localPlayerId = null;
    let currentRoomCode = null;
    let roomRef = null;
    let roomData = null;
    let selectedCountry = null;
    let map, geoJsonLayer = null;

    const availableColors = [
      "red",
      "blue",
      "green",
      "yellow",
      "purple",
      "orange",
      "brown",
      "pink"
    ];
    let localPlayerColor = null;
    let chatListenerAdded = false;
    let infoCardsPermanent = false; // İstersek ülke isimlerini kalıcı göstermek
    let unreadMessages = 0;
    let chatOpen = false;

    // Popup açık/kapalı durumları
    const popupStates = {
      "military": false,
      "building": false,
      "resource": false,
      "players": false,
      "chat": false,
      "pact": false,
      "market": false
    };

    // Tur Sayaç
    let turnTimeRemaining = 60;
    let turnTimerInterval = null;

    // Oyun Başlat Geri Sayım
    let startInterval = null;

    /**********************************************************************
     * Yardımcı Fonksiyonlar
     **********************************************************************/
    function showNotification(message, duration = 3000) {
      // Kısa Ephemeral Bildirim
      const notifArea = document.getElementById("notification-area");
      if (!notifArea) return;

      const item = document.createElement("div");
      item.className = "notification-item";
      item.textContent = message;
      notifArea.appendChild(item);

      setTimeout(() => {
        if (notifArea.contains(item)) {
          notifArea.removeChild(item);
        }
      }, duration + 800);
    }
    function broadcastNotification(text) {
      if (!roomRef) return;
      roomRef.child("notifications").push({
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }
    function displayGlobalNotification(text) {
      // Ephemeral
      showNotification(text, 6000);
    }
    // Basit Oda Kodu Üretimi
    function generateRoomCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }
    function hasActivePact(playerA, playerB) {
      if (!roomData || !roomData.pacts) return false;
      for (let pactId in roomData.pacts) {
        const pact = roomData.pacts[pactId];
        if (pact.active && roomData.round <= pact.expirationRound) {
          if (
            (pact.playerA === playerA && pact.playerB === playerB) ||
            (pact.playerA === playerB && pact.playerB === playerA)
          ) {
            return true;
          }
        }
      }
      return false;
    }
    function isMyTurn() {
      if (!roomData || !roomData.playerOrder) return false;
      if (roomData.gameState !== "started") return false;
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      return roomData.playerOrder[currentTurnIndex] === localPlayerId;
    }

    /**********************************************************************
     * TUR SAYAÇ
     **********************************************************************/
    function startTurnTimer() {
      const timerEl = document.getElementById("turn-timer");
      turnTimeRemaining = 60;
      if (turnTimerInterval) clearInterval(turnTimerInterval);
      timerEl.textContent = turnTimeRemaining + "s";

      turnTimerInterval = setInterval(() => {
        turnTimeRemaining--;
        if (turnTimeRemaining <= 0) {
          clearInterval(turnTimerInterval);
          turnTimeRemaining = 0;
          timerEl.textContent = "0s";
          // Süre doldu, tur sonu
          if (roomData && roomData.gameState === "started" && isMyTurn()) {
            nextTurn(true);
          }
        } else {
          timerEl.textContent = turnTimeRemaining + "s";
        }
      }, 1000);
    }
    function stopTurnTimer() {
      if (turnTimerInterval) {
        clearInterval(turnTimerInterval);
      }
      const timerEl = document.getElementById("turn-timer");
      if (timerEl) {
        timerEl.textContent = "60s";
      }
    }

    /**********************************************************************
     * LOBI OLAYLARI
     **********************************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      // Local Player ID
      if (!localStorage.getItem("playerId")) {
        localStorage.setItem("playerId", Math.random().toString(36).substr(2, 9));
      }
      localPlayerId = localStorage.getItem("playerId");

      // Renk Seçenekleri (Oda Oluşturma)
      const creatorColorDiv = document.getElementById("creator-color-options");
      availableColors.forEach((color) => {
        const btn = document.createElement("button");
        btn.className = "global-color-option";
        btn.style.background = color;
        btn.dataset.color = color;
        btn.addEventListener("click", function () {
          creatorColorDiv.querySelectorAll(".global-color-option").forEach((s) => s.classList.remove("selected"));
          btn.classList.add("selected");
          localPlayerColor = color;
        });
        creatorColorDiv.appendChild(btn);
      });

      // Renk Seçenekleri (Odaya Katılma)
      const joinColorDiv = document.getElementById("join-color-options");
      availableColors.forEach((color) => {
        const btn = document.createElement("button");
        btn.className = "global-color-option";
        btn.style.background = color;
        btn.dataset.color = color;
        btn.addEventListener("click", function () {
          joinColorDiv.querySelectorAll(".global-color-option").forEach((s) => s.classList.remove("selected"));
          btn.classList.add("selected");
          localPlayerColor = color;
        });
        joinColorDiv.appendChild(btn);
      });

      // Oda Oluştur
      document.getElementById("create-room-btn").addEventListener("click", () => {
        const playerName = document.getElementById("creator-player-name").value.trim();
        const maxPlayers = parseInt(document.getElementById("max-players").value);
        if (!playerName) {
          showNotification("Lütfen adınızı girin!");
          return;
        }
        if (!localPlayerColor) {
          showNotification("Lütfen bir renk seçin!");
          return;
        }
        if (isNaN(maxPlayers) || maxPlayers < 2 || maxPlayers > 8) {
          showNotification("Oyuncu sayısı 2 ile 8 arasında olmalı!");
          return;
        }

        const roomCode = generateRoomCode();
        currentRoomCode = roomCode;
        roomRef = db.ref("rooms/" + roomCode);

        const newRoomData = {
          roomCode: roomCode,
          maxPlayers: maxPlayers,
          gameState: "waiting",
          currentTurnIndex: 0,
          round: 1,
          playerOrder: [localPlayerId],
          players: {},
          countryData: {},
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        newRoomData.players[localPlayerId] = {
          name: playerName,
          color: localPlayerColor,
          money: 1000,
          soldiers: 0,
          countries: [],
          petrol: 0,
          wheat: 400,
          joinedAt: firebase.database.ServerValue.TIMESTAMP,
          isHost: true
        };

        roomRef.set(newRoomData, (error) => {
          if (error) {
            showNotification("Oda oluştururken hata oluştu!");
          } else {
            showNotification("Oda oluşturuldu: " + roomCode);
            localStorage.setItem("roomCode", roomCode);
            loadAndInitializeGeoJson();
            joinRoomAndListen();
            document.body.classList.remove("lobby");
            document.getElementById("lobby-container").style.display = "none";
            document.getElementById("game-container").style.display = "block";
            document.getElementById("display-room-code").textContent = roomCode;
          }
        });
      });

      // Odaya Katıl
      document.getElementById("join-room-btn").addEventListener("click", () => {
        const playerName = document.getElementById("join-player-name").value.trim();
        const roomCodeInput = document.getElementById("room-code").value.trim().toUpperCase();
        if (!playerName) {
          showNotification("Lütfen adınızı girin!");
          return;
        }
        if (!localPlayerColor) {
          showNotification("Lütfen bir renk seçin!");
          return;
        }
        if (!roomCodeInput) {
          showNotification("Lütfen oda kodu girin!");
          return;
        }
        currentRoomCode = roomCodeInput;
        roomRef = db.ref("rooms/" + roomCodeInput);

        roomRef.once("value", (snapshot) => {
          if (!snapshot.exists()) {
            showNotification("Böyle bir oda bulunamadı!");
            return;
          }
          const room = snapshot.val();
          if (room.gameState !== "waiting") {
            showNotification("Oyun çoktan başladı veya başlamak üzere!");
            return;
          }
          const playerCount = Object.keys(room.players || {}).length;
          if (playerCount >= room.maxPlayers) {
            showNotification("Oda dolu!");
            return;
          }
          const updates = {};
          updates["players/" + localPlayerId] = {
            name: playerName,
            color: localPlayerColor,
            money: 1000,
            soldiers: 0,
            countries: [],
            petrol: 0,
            wheat: 400,
            joinedAt: firebase.database.ServerValue.TIMESTAMP,
            isHost: false
          };
          if (!room.playerOrder) room.playerOrder = [];
          room.playerOrder.push(localPlayerId);
          updates["playerOrder"] = room.playerOrder;

          roomRef.update(updates, (error) => {
            if (error) {
              showNotification("Odaya katılırken hata oluştu!");
            } else {
              showNotification("Odaya katıldınız!");
              localStorage.setItem("roomCode", roomCodeInput);
              joinRoomAndListen();
              document.body.classList.remove("lobby");
              document.getElementById("lobby-container").style.display = "none";
              document.getElementById("game-container").style.display = "block";
              document.getElementById("display-room-code").textContent = roomCodeInput;
            }
          });
        });
      });

      autoReconnect();
    });

    // Otomatik yeniden bağlanma
    function autoReconnect() {
      const savedRoomCode = localStorage.getItem("roomCode");
      if (savedRoomCode) {
        const refCheck = db.ref("rooms/" + savedRoomCode);
        refCheck.once("value", (snapshot) => {
          if (!snapshot.exists()) return;
          const savedRoomData = snapshot.val();
          if (!savedRoomData.players || !savedRoomData.players[localPlayerId]) return;
          currentRoomCode = savedRoomCode;
          roomRef = refCheck;
          joinRoomAndListen();
          document.body.classList.remove("lobby");
          document.getElementById("lobby-container").style.display = "none";
          document.getElementById("game-container").style.display = "block";
          document.getElementById("display-room-code").textContent = savedRoomCode;
        });
      }
    }

    /**********************************************************************
     * GEOJSON HARİTA VERİSİ YÜKLEME (SADECE HOST)
     **********************************************************************/
    function loadAndInitializeGeoJson() {
      fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
        .then((response) => response.json())
        .then((geoJsonData) => {
          const features = geoJsonData.features;

          // Rastgele 43 ülkeye petrol, 60 ülkeye buğday
          let oilIndexes = [];
          if (features.length > 43) {
            while (oilIndexes.length < 43) {
              const randIdx = Math.floor(Math.random() * features.length);
              if (!oilIndexes.includes(randIdx)) {
                oilIndexes.push(randIdx);
              }
            }
          }
          let wheatIndexes = [];
          if (features.length > 60) {
            while (wheatIndexes.length < 60) {
              const randIdx = Math.floor(Math.random() * features.length);
              if (!wheatIndexes.includes(randIdx)) {
                wheatIndexes.push(randIdx);
              }
            }
          }
          features.forEach((f, idx) => {
            f.properties._index = idx;
          });

          const countryDataInit = {};
          features.forEach((feature) => {
            const cname = feature.properties.name;
            let oilProduction = 0;
            if (oilIndexes.includes(feature.properties._index)) {
              oilProduction = Math.floor(Math.random() * (500 - 150 + 1)) + 150;
            }
            let wheatProduction = 0;
            if (wheatIndexes.includes(feature.properties._index)) {
              wheatProduction = Math.floor(Math.random() * (700 - 200 + 1)) + 200;
            }
            countryDataInit[cname] = {
              income: Math.floor(Math.random() * 500) + 100,
              soldiers: 0,
              owner: null,
              barracksCount: 0,
              factories: 0,
              refineries: 0,
              oilProduction: oilProduction,
              wheatProduction: wheatProduction,
              grainMills: 0,
              supporters: {}
            };
          });
          roomRef.child("countryData").set(countryDataInit);
        });
    }

    /**********************************************************************
     * ODA DİNLEME & UI GÜNCELLEME
     **********************************************************************/
    function joinRoomAndListen() {
      if (!roomRef) return;

      roomRef.on("value", (snapshot) => {
        roomData = snapshot.val();
        updateGameUI();
        displayPendingPactOffers();
        displayTradeOffers();
        updatePactPanel(); // Pakt panelini her seferinde güncelle
      });

      if (!chatListenerAdded) {
        // Chat
        roomRef.child("chat").on("child_added", (snap) => {
          const message = snap.val();
          appendChatMessage(message);
        });
        // Global Bildirimler
        roomRef.child("notifications").on("child_added", (snap) => {
          const data = snap.val();
          if (data && data.text) {
            displayGlobalNotification(data.text);
          }
        });
        chatListenerAdded = true;
      }
    }

    function updateGameUI() {
      if (!roomData) return;
      // Tur
      document.getElementById("current-round").textContent = roomData.round || 1;
      // Sıra
      if (roomData.playerOrder && roomData.players) {
        const idx = roomData.currentTurnIndex || 0;
        const pid = roomData.playerOrder[idx];
        if (roomData.players[pid]) {
          document.getElementById("current-player").textContent = roomData.players[pid].name;
        }
      }
      // Oyun durumu
      handleGameState(roomData.gameState);

      // Oyuncu Listesi
      const playersInfoDiv = document.getElementById("players-info");
      if (playersInfoDiv) {
        playersInfoDiv.innerHTML = "";
        if (roomData.playerOrder) {
          roomData.playerOrder.forEach((pid) => {
            if (roomData.players[pid]) {
              const player = roomData.players[pid];
              const div = document.createElement("div");
              div.className = "player-info";
              div.id = "player-info-" + pid;
              div.innerHTML =
                `<p><strong>${player.name}</strong></p>` +
                `<p>Para: <span>${player.money}</span>$</p>` +
                `<p>Asker: <span>${player.soldiers}</span></p>` +
                `<p>Ülkeler: <span>${(player.countries && player.countries.length) || 0}</span></p>` +
                `<p>Petrol: <span>${player.petrol}</span> varil</p>` +
                `<p>Buğday: <span>${player.wheat}</span></p>`;
              playersInfoDiv.appendChild(div);
            }
          });
        }
      }

      // Harita
      if (map && roomData.countryData && geoJsonLayer) {
        geoJsonLayer.eachLayer((layer) => {
          const cname = layer.feature.properties.name;
          const cdata = roomData.countryData[cname];
          if (!cdata) return;
          if (cdata.owner && roomData.players && roomData.players[cdata.owner]) {
            layer.setStyle({
              fillColor: roomData.players[cdata.owner].color,
              fillOpacity: 0.7
            });
          } else {
            layer.setStyle({ fillColor: "#ccc", fillOpacity: 0.7 });
          }
          layer.setTooltipContent(getCountryPopupContent(cname, cdata));
        });
      }

      updateRecipientSelects();
      updatePactRecipientSelect();
      updateTradeCountrySelect();
      updatePrivateMessageRecipientSelect();
      updateEmbargoPlayersSelect();
      updateSupportRecipientSelect();

      // Tur Sayaç Kontrol
      if (roomData.gameState === "started") {
        if (isMyTurn()) {
          startTurnTimer();
        } else {
          stopTurnTimer();
        }
      } else {
        stopTurnTimer();
      }
    }

    function handleGameState(state) {
      const startBtn = document.getElementById("start-game-btn");
      const countdownSpan = document.getElementById("start-countdown");
      if (!state) return;

      if (state === "waiting") {
        if (roomData.players[localPlayerId] && roomData.players[localPlayerId].isHost) {
          startBtn.style.display = "block";
        } else {
          startBtn.style.display = "none";
        }
        countdownSpan.style.display = "none";
      } else if (state === "starting") {
        startBtn.style.display = "none";
        countdownSpan.style.display = "inline";
        startCountdownListener();
      } else if (state === "started") {
        startBtn.style.display = "none";
        countdownSpan.style.display = "none";
        clearInterval(startInterval);
        startInterval = null;
      }
    }

    // Oyunu Başlat (Sadece Host)
    document.getElementById("start-game-btn").addEventListener("click", () => {
      if (!roomData || !roomData.players[localPlayerId].isHost) return;
      if (roomData.gameState !== "waiting") return;
      const now = Date.now();
      const startTime = now + 30000; // 30sn
      roomRef.update({
        gameState: "starting",
        startTime: startTime
      });
    });
    function startCountdownListener() {
      if (!roomData || !roomData.startTime) return;
      const countdownSpan = document.getElementById("start-countdown");
      if (startInterval) clearInterval(startInterval);

      startInterval = setInterval(() => {
        if (!roomData) return;
        const now = Date.now();
        const diff = roomData.startTime - now;
        if (diff <= 0) {
          clearInterval(startInterval);
          startInterval = null;
          roomRef.update({ gameState: "started" });
          return;
        }
        const sec = Math.floor(diff / 1000);
        countdownSpan.textContent = sec;
      }, 1000);
    }

    function getCountryPopupContent(name, country) {
      if (!country) country = {};
      const ownerName = country.owner && roomData.players[country.owner]
        ? roomData.players[country.owner].name
        : "Yok";

      let effectiveIncome = country.income || 0;
      if (country.factories) {
        effectiveIncome = Math.floor(effectiveIncome * (1 + 0.20 * country.factories));
      }
      const effectiveOil = country.oilProduction
        ? Math.floor(country.oilProduction * (1 + 0.15 * (country.refineries || 0)))
        : 0;
      const effectiveWheat = country.wheatProduction
        ? Math.floor(country.wheatProduction * (1 + 0.20 * (country.grainMills || 0)))
        : 0;

      return `
        <div class="country-popup">
          <p><i class="fas fa-money-bill-wave"></i> Gelir: ${effectiveIncome}$</p>
          <p><i class="fas fa-users"></i> Asker: ${country.soldiers || 0}</p>
          <p><i class="fas fa-fort-awesome"></i> Kışla: ${country.barracksCount || 0}</p>
          <p><i class="fas fa-industry"></i> Fabrika: ${country.factories || 0}</p>
          <p><i class="fas fa-oil-can"></i> Rafine: ${country.refineries || 0}</p>
          <p><i class="fas fa-oil-can"></i> Petrol Üretimi: ${effectiveOil} varil</p>
          <p><i class="fas fa-wheat-awn"></i> Değirmen: ${country.grainMills || 0}</p>
          <p><i class="fas fa-wheat-awn"></i> Buğday Üretimi: ${effectiveWheat}</p>
          <p><i class="fas fa-crown"></i> Sahip: ${ownerName}</p>
        </div>
      `;
    }

    function selectCountry(countryName, layer) {
      selectedCountry = countryName;
      showNotification("Seçilen Ülke: " + countryName, 1500);
      layer.setStyle({ weight: 4, color: "#FF4500" });
      setTimeout(() => {
        // Eski haline dön
        const c = roomData.countryData[countryName];
        if (c && c.owner && roomData.players[c.owner]) {
          layer.setStyle({
            fillColor: roomData.players[c.owner].color,
            fillOpacity: 0.7,
            weight: 1,
            color: "#555"
          });
        } else {
          layer.setStyle({
            fillColor: "#ccc",
            fillOpacity: 0.7,
            weight: 1,
            color: "#555"
          });
        }
      }, 800);
    }

    function updateTooltipsPermanent() {
      if (!geoJsonLayer) return;
      geoJsonLayer.eachLayer((layer) => {
        layer.unbindTooltip();
        const cname = layer.feature.properties.name;
        const cdata = roomData && roomData.countryData ? roomData.countryData[cname] : {};
        layer.bindTooltip(getCountryPopupContent(cname, cdata), {
          permanent: infoCardsPermanent,
          direction: "center",
          className: "country-popup-tooltip"
        });
      });
    }

    /**********************************************************************
     * SEÇİCİLER (KAYNAK GÖNDERME, ÖZEL MESAJ, vs.)
     **********************************************************************/
    function updateRecipientSelects() {
      const moneySelect = document.getElementById("recipient-player");
      const petrolSelect = document.getElementById("recipient-player-petrol");
      const wheatSelect = document.getElementById("recipient-player-wheat");
      if (!moneySelect || !petrolSelect || !wheatSelect) return;

      moneySelect.innerHTML = "";
      petrolSelect.innerHTML = "";
      wheatSelect.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (roomData.players[pid]) {
            const op1 = document.createElement("option");
            op1.value = pid;
            op1.textContent = roomData.players[pid].name;
            moneySelect.appendChild(op1);

            const op2 = document.createElement("option");
            op2.value = pid;
            op2.textContent = roomData.players[pid].name;
            petrolSelect.appendChild(op2);

            const op3 = document.createElement("option");
            op3.value = pid;
            op3.textContent = roomData.players[pid].name;
            wheatSelect.appendChild(op3);
          }
        });
      }
    }
    function updatePrivateMessageRecipientSelect() {
      const sel = document.getElementById("private-message-recipient");
      if (!sel) return;
      sel.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (pid !== localPlayerId && roomData.players[pid]) {
            const op = document.createElement("option");
            op.value = pid;
            op.textContent = roomData.players[pid].name;
            sel.appendChild(op);
          }
        });
      }
    }
    function updateEmbargoPlayersSelect() {
      const embargoSelect = document.getElementById("embargo-players");
      if (!embargoSelect) return;
      embargoSelect.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (pid !== localPlayerId && roomData.players[pid]) {
            const op = document.createElement("option");
            op.value = pid;
            op.textContent = roomData.players[pid].name;
            embargoSelect.appendChild(op);
          }
        });
      }
    }
    function updateSupportRecipientSelect() {
      const rSel = document.getElementById("support-recipient");
      const cSel = document.getElementById("support-recipient-country");
      if (!rSel || !cSel) return;
      rSel.innerHTML = "";
      cSel.innerHTML = "";

      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (pid !== localPlayerId && roomData.players[pid]) {
            const op = document.createElement("option");
            op.value = pid;
            op.textContent = roomData.players[pid].name;
            rSel.appendChild(op);
          }
        });
        cSel.innerHTML = "<option value=''>--Ülke Seç--</option>";
        if (roomData.countryData) {
          Object.keys(roomData.countryData).forEach((cn) => {
            const c = roomData.countryData[cn];
            const o = document.createElement("option");
            o.value = cn;
            o.textContent = cn;
            cSel.appendChild(o);
          });
        }
      }
    }
    function updatePactRecipientSelect() {
      const pactRecSel = document.getElementById("pact-offer-recipient");
      if (!pactRecSel) return;
      pactRecSel.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (pid !== localPlayerId && roomData.players[pid]) {
            const op = document.createElement("option");
            op.value = pid;
            op.textContent = roomData.players[pid].name;
            pactRecSel.appendChild(op);
          }
        });
      }
    }

    /**********************************************************************
     * SALDIRMAZLIK PAKTI (Teklif, Kabul, Reddet) + Pakt Paneli
     **********************************************************************/
    document.getElementById("send-pact-offer-btn").addEventListener("click", () => {
      if (!isMyTurn()) {
        showNotification("Pakt teklifini sadece kendi sıranızda gönderebilirsiniz!");
        return;
      }
      const recipient = document.getElementById("pact-offer-recipient").value;
      const duration = parseInt(document.getElementById("pact-duration").value);
      const cost = parseInt(document.getElementById("pact-cost").value);

      if (!recipient || recipient === localPlayerId) {
        showNotification("Geçerli bir oyuncu seçin!");
        return;
      }
      if (isNaN(duration) || duration <= 0) {
        showNotification("Geçerli bir tur sayısı girin!");
        return;
      }
      if (isNaN(cost) || cost < 0) {
        showNotification("Geçerli bir para miktarı girin (0 veya üzeri)!");
        return;
      }
      if (hasActivePact(localPlayerId, recipient)) {
        showNotification("Bu oyuncu ile zaten aktif bir paktınız var!");
        return;
      }
      const senderData = roomData.players[localPlayerId];
      if (!senderData) return;

      const ref = roomRef.child("pactOffers").push();
      const newOffer = {
        offerId: ref.key,
        senderId: localPlayerId,
        senderName: senderData.name,
        recipientId: recipient,
        duration: duration,
        cost: cost,
        status: "pending"
      };
      ref.set(newOffer);
      broadcastNotification(
        `Saldırmazlık Paktı Teklifi: ${senderData.name} → ${roomData.players[recipient].name} (Tur: ${duration}, Para: ${cost}$)`
      );
      showNotification("Pakt teklifi gönderildi!");
    });

    function displayPendingPactOffers() {
      const container = document.getElementById("pact-pending-offers");
      if (!container) return;
      container.innerHTML = "";
      if (!roomData || !roomData.pactOffers) return;

      Object.values(roomData.pactOffers).forEach((offer) => {
        if (
          offer.status === "pending" &&
          offer.recipientId === localPlayerId
        ) {
          const div = document.createElement("div");
          div.className = "pact-offer-item";
          div.setAttribute("data-offer-id", offer.offerId);
          div.innerHTML = `
            <p><strong>${offer.senderName}</strong> size bir saldırmazlık pakti teklif ediyor.</p>
            <p>Tur sayısı: <strong>${offer.duration}</strong></p>
            <p>Para talebi: <strong>${offer.cost}$</strong> (Gönderen ödeyecek - siz alacaksınız)</p>
            <button class="accept-btn" data-offer-id="${offer.offerId}">Kabul Et</button>
            <button class="reject-btn" data-offer-id="${offer.offerId}">Reddet</button>
          `;
          container.appendChild(div);
        }
      });
    }

    document.getElementById("pact-pending-offers").addEventListener("click", (e) => {
      if (e.target.classList.contains("accept-btn")) {
        const offerId = e.target.getAttribute("data-offer-id");
        acceptPactOffer(offerId);
      } else if (e.target.classList.contains("reject-btn")) {
        const offerId = e.target.getAttribute("data-offer-id");
        rejectPactOffer(offerId);
      }
    });

    function acceptPactOffer(offerId) {
      const offer = roomData.pactOffers[offerId];
      if (!offer || offer.status !== "pending") return;
      if (hasActivePact(offer.senderId, offer.recipientId)) {
        showNotification("Zaten aktif bir paktınız var!");
        roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
        return;
      }
      const sender = roomData.players[offer.senderId];
      const recipient = roomData.players[offer.recipientId];
      if (!sender || !recipient) {
        showNotification("Oyuncu verisi bulunamadı!");
        return;
      }
      if (sender.money < offer.cost) {
        showNotification("Teklifi gönderenin parası kalmamış. Teklif geçersiz!");
        roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
        return;
      }

      const pactId = db.ref().push().key;
      const expirationRound = (roomData.round || 1) + offer.duration;
      const updates = {};

      updates[`pactOffers/${offerId}/status`] = "accepted";
      updates[`players/${offer.senderId}/money`] = sender.money - offer.cost;
      updates[`players/${offer.recipientId}/money`] = recipient.money + offer.cost;
      updates[`pacts/${pactId}`] = {
        playerA: offer.senderId,
        playerB: offer.recipientId,
        active: true,
        cost: offer.cost,
        duration: offer.duration,
        expirationRound: expirationRound
      };

      roomRef.update(updates);
      broadcastNotification(
        `Pakt Anlaşması: ${sender.name} & ${recipient.name} (Tur: ${offer.duration}, Para: ${offer.cost}$)`
      );
      showNotification("Pakt teklifi kabul edildi!");
    }
    function rejectPactOffer(offerId) {
      const offer = roomData.pactOffers[offerId];
      if (!offer || offer.status !== "pending") return;
      roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
      broadcastNotification(
        `Pakt Reddedildi: ${offer.senderName} => Teklif reddedildi.`
      );
      showNotification("Pakt teklifi reddedildi.");
    }

    // Üstteki "Paktlar" Butonu -> Aktif paktları gösteren panel
    const pactsBell = document.getElementById("pacts-bell");
    const pactsPanel = document.getElementById("pacts-panel");
    pactsBell.addEventListener("click", () => {
      if (pactsPanel.style.display === "none" || !pactsPanel.style.display) {
        pactsPanel.style.display = "block";
      } else {
        pactsPanel.style.display = "none";
      }
    });
    // Aktif paktları listele
    function updatePactPanel() {
      if (!pactsPanel) return;
      const list = document.getElementById("pacts-list");
      if (!list) return;
      list.innerHTML = "";

      if (!roomData || !roomData.pacts) return;
      const round = roomData.round || 1;
      Object.values(roomData.pacts).forEach((pact) => {
        if (pact.active && round <= pact.expirationRound) {
          // Bu pakt, localPlayer'ı ilgilendiriyor mu?
          if (pact.playerA === localPlayerId || pact.playerB === localPlayerId) {
            const otherId = (pact.playerA === localPlayerId) ? pact.playerB : pact.playerA;
            const otherName = roomData.players[otherId]?.name || "???";
            const turnsLeft = pact.expirationRound - round + 1; // Bu tur dahil
            const li = document.createElement("li");
            li.textContent = `Pakt: ${otherName} (Kalan Tur: ${turnsLeft})`;
            list.appendChild(li);
          }
        }
      });
    }

    /**********************************************************************
     * OYUN FONKSİYONLARI
     **********************************************************************/
    // SALDIRI
    document.getElementById("attack-btn").addEventListener("click", attack);
    function attack() {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const soldiersToSend = parseInt(document.getElementById("attack-soldiers").value);
      if (isNaN(soldiersToSend) || soldiersToSend <= 0) {
        showNotification("Geçerli asker sayısı girin!");
        return;
      }
      const idx = roomData.currentTurnIndex || 0;
      const pid = roomData.playerOrder[idx];
      const pData = roomData.players[pid];
      if (soldiersToSend > pData.soldiers) {
        showNotification("Yeterli askeriniz yok!");
        return;
      }
      const target = roomData.countryData[selectedCountry];
      if (!target) return;

      // İlk 3 tur sadece sahipsiz topraklara saldırılabilir
      if (roomData.round < 4) {
        if (target.owner) {
          showNotification("İlk 3 tur sadece sahipsiz ülkelere saldırabilirsiniz!");
          return;
        }
      }
      // Pakt kontrol
      if (target.owner && target.owner !== pid) {
        if (hasActivePact(pid, target.owner)) {
          showNotification("Bu oyuncu ile saldırmazlık paktınız var. Saldıramazsınız!");
          return;
        }
      }

      const updates = {};
      let resultText = "";
      // Kendimize aitse sadece asker yerleştir
      if (target.owner === pid) {
        updates[`countryData/${selectedCountry}/soldiers`] = target.soldiers + soldiersToSend;
        updates[`players/${pid}/soldiers`] = pData.soldiers - soldiersToSend;
        resultText = `${selectedCountry} ülkesine ${soldiersToSend} asker yerleştirildi.`;
      } else {
        // Saldırı
        updates[`players/${pid}/soldiers`] = pData.soldiers - soldiersToSend;
        if (soldiersToSend > target.soldiers) {
          // Fethedildi
          const remaining = soldiersToSend - target.soldiers;
          updates[`countryData/${selectedCountry}/soldiers`] = remaining;
          updates[`countryData/${selectedCountry}/owner`] = pid;
          updates[`countryData/${selectedCountry}/supporters`] = {};
          let myCountries = pData.countries || [];
          if (!myCountries.includes(selectedCountry)) {
            myCountries.push(selectedCountry);
          }
          updates[`players/${pid}/countries`] = myCountries;
          // Savunanın listesinden sil
          if (target.owner && roomData.players[target.owner]) {
            let defCountries = roomData.players[target.owner].countries || [];
            defCountries = defCountries.filter((c) => c !== selectedCountry);
            updates[`players/${target.owner}/countries`] = defCountries;
          }
          resultText = `${selectedCountry} fethedildi! (${soldiersToSend} vs ${target.soldiers})`;
        } else {
          // Savunuldu
          updates[`countryData/${selectedCountry}/soldiers`] = target.soldiers - soldiersToSend;
          resultText = `${selectedCountry} savunuldu! (${soldiersToSend} vs ${target.soldiers})`;
        }
        nextTurn();
      }
      roomRef.update(updates);
      broadcastNotification(`Saldırı: ${pData.name} -> ${selectedCountry}. ${resultText}`);
      showNotification(resultText);
    }

    // ASKER SATIN AL
    document.getElementById("buy-soldiers-btn").addEventListener("click", buySoldiers);
    function buySoldiers() {
      const count = parseInt(document.getElementById("soldiers-to-buy").value);
      if (isNaN(count) || count <= 0) {
        showNotification("Geçerli asker sayısı girin!");
        return;
      }
      const costMoney = 10 * count;
      const costWheat = 25 * count;
      const pData = roomData.players[localPlayerId];
      if (pData.money < costMoney) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (pData.wheat < costWheat) {
        showNotification("Yeterli buğdayınız yok!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = pData.money - costMoney;
      updates[`players/${localPlayerId}/wheat`] = pData.wheat - costWheat;
      updates[`players/${localPlayerId}/soldiers`] = pData.soldiers + count;
      roomRef.update(updates);
      broadcastNotification(`${pData.name} ${count} asker satın aldı.`);
      showNotification(`${count} asker satın alındı.`);
    }

    // ASKER ÇEK
    document.getElementById("pull-soldiers-btn").addEventListener("click", pullSoldiers);
    function pullSoldiers() {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const target = roomData.countryData[selectedCountry];
      if (!target) return;
      const count = parseInt(document.getElementById("pull-soldiers-count").value);
      if (isNaN(count) || count <= 0) {
        showNotification("Geçerli bir asker sayısı girin!");
        return;
      }
      const pData = roomData.players[localPlayerId];
      if (!pData) return;

      const updates = {};
      // Eğer ülke sahibiysek
      if (target.owner === localPlayerId) {
        let totalSupporters = 0;
        if (target.supporters) {
          for (let supId in target.supporters) {
            totalSupporters += target.supporters[supId];
          }
        }
        const occupant = target.soldiers - totalSupporters; // Bizim asker
        if (occupant < count) {
          showNotification("Bu ülkede çekebileceğiniz kadar kendi askeriniz yok!");
          return;
        }
        updates[`countryData/${selectedCountry}/soldiers`] = target.soldiers - count;
        updates[`players/${localPlayerId}/soldiers`] = pData.soldiers + count;
        broadcastNotification(`${pData.name} ${selectedCountry} ülkesinden ${count} asker çekti.`);
      } else {
        // Destek verdiğimiz askerleri çekiyoruz
        const sup = target.supporters && target.supporters[localPlayerId]
          ? target.supporters[localPlayerId]
          : 0;
        if (sup < count) {
          showNotification("Bu ülkede bu kadar destek askeriniz yok!");
          return;
        }
        if (target.soldiers < count) {
          showNotification("Ülkedeki asker sayısı verisi tutarsız!");
          return;
        }
        updates[`countryData/${selectedCountry}/soldiers`] = target.soldiers - count;
        const newSup = sup - count;
        if (newSup <= 0) {
          updates[`countryData/${selectedCountry}/supporters/${localPlayerId}`] = null;
        } else {
          updates[`countryData/${selectedCountry}/supporters/${localPlayerId}`] = newSup;
        }
        updates[`players/${localPlayerId}/soldiers`] = pData.soldiers + count;
        broadcastNotification(`${pData.name}, ${selectedCountry} ülkesine verdiği ${count} askeri geri çekti.`);
      }
      roomRef.update(updates);
      showNotification(`${selectedCountry} ülkesinden ${count} asker çekildi.`);
    }

    // ASKERİ DESTEK
    document.getElementById("send-support-btn").addEventListener("click", sendSupport);
    function sendSupport() {
      const rec = document.getElementById("support-recipient").value;
      const cName = document.getElementById("support-recipient-country").value;
      const num = parseInt(document.getElementById("support-soldiers").value);
      if (!rec || !cName) {
        showNotification("Hedef oyuncu ve ülke seçin!");
        return;
      }
      if (isNaN(num) || num <= 0) {
        showNotification("Geçerli asker sayısı girin!");
        return;
      }
      const pData = roomData.players[localPlayerId];
      if (pData.soldiers < num) {
        showNotification("Yeterli askeriniz yok!");
        return;
      }
      const country = roomData.countryData[cName];
      if (!country) {
        showNotification("Seçilen ülke bulunamadı!");
        return;
      }
      if (country.owner !== rec) {
        showNotification("Bu ülke, seçtiğiniz oyuncuya ait değil!");
        return;
      }

      const updates = {};
      updates[`players/${localPlayerId}/soldiers`] = pData.soldiers - num;
      updates[`countryData/${cName}/soldiers`] = country.soldiers + num;
      const oldSup = country.supporters && country.supporters[localPlayerId]
        ? country.supporters[localPlayerId]
        : 0;
      updates[`countryData/${cName}/supporters/${localPlayerId}`] = oldSup + num;
      roomRef.update(updates);
      broadcastNotification(`${pData.name}, ${roomData.players[rec].name} (${cName}) ülkesine ${num} asker destek gönderdi.`);
      showNotification("Asker desteği gönderildi!");
    }

    // BİNA KURMA
    document.getElementById("buy-barracks-btn").addEventListener("click", buyBarracks);
    function buyBarracks() {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const q = parseInt(document.getElementById("barracks-quantity").value);
      if (isNaN(q) || q <= 0) {
        showNotification("Geçerli kışla adedi girin!");
        return;
      }
      const pData = roomData.players[localPlayerId];
      const cData = roomData.countryData[selectedCountry];
      if (cData.owner !== localPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      const totalM = 140 * q;
      const totalOil = 40 * q;
      const totalW = 90 * q;
      if (pData.money < totalM) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (pData.petrol < totalOil) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      if (pData.wheat < totalW) {
        showNotification("Yeterli buğdayınız yok!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = pData.money - totalM;
      updates[`players/${localPlayerId}/petrol`] = pData.petrol - totalOil;
      updates[`players/${localPlayerId}/wheat`] = pData.wheat - totalW;
      updates[`countryData/${selectedCountry}/barracksCount`] =
        (cData.barracksCount || 0) + q;
      roomRef.update(updates);
      broadcastNotification(`${pData.name}, ${selectedCountry} ülkesine ${q} kışla kurdu.`);
      showNotification(`${q} kışla kuruldu.`);
    }

    document.getElementById("build-factory-btn").addEventListener("click", buildFactory);
    function buildFactory() {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const q = parseInt(document.getElementById("factory-quantity").value);
      if (isNaN(q) || q <= 0) {
        showNotification("Geçerli fabrika adedi girin!");
        return;
      }
      const pData = roomData.players[localPlayerId];
      const cData = roomData.countryData[selectedCountry];
      if (cData.owner !== localPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      // Fabrika maliyeti 500$ + 100 varil
      const totalM = 500 * q;
      const totalOil = 100 * q;
      if (pData.money < totalM) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (pData.petrol < totalOil) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = pData.money - totalM;
      updates[`players/${localPlayerId}/petrol`] = pData.petrol - totalOil;
      updates[`countryData/${selectedCountry}/factories`] = (cData.factories || 0) + q;
      roomRef.update(updates);
      broadcastNotification(`${pData.name}, ${selectedCountry} ülkesine ${q} fabrika kurdu.`);
      showNotification(`${q} fabrika kuruldu.`);
    }

    document.getElementById("build-refinery-btn").addEventListener("click", buildRefinery);
    function buildRefinery() {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const q = parseInt(document.getElementById("refinery-quantity").value);
      if (isNaN(q) || q <= 0) {
        showNotification("Geçerli rafine adedi girin!");
        return;
      }
      const pData = roomData.players[localPlayerId];
      const cData = roomData.countryData[selectedCountry];
      if (!cData.oilProduction) {
        showNotification("Bu ülkede petrol üretimi yok!");
        return;
      }
      const totalM = 800 * q;
      const totalO = 250 * q;
      if (pData.money < totalM) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (pData.petrol < totalO) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = pData.money - totalM;
      updates[`players/${localPlayerId}/petrol`] = pData.petrol - totalO;
      updates[`countryData/${selectedCountry}/refineries`] =
        (cData.refineries || 0) + q;
      roomRef.update(updates);
      broadcastNotification(`${pData.name}, ${selectedCountry} ülkesine ${q} rafine kurdu.`);
      showNotification(`${q} rafine kuruldu.`);
    }

    document.getElementById("build-grainmill-btn").addEventListener("click", buildGrainMill);
    function buildGrainMill() {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const q = parseInt(document.getElementById("grainmill-quantity").value);
      if (isNaN(q) || q <= 0) {
        showNotification("Geçerli değirmen adedi girin!");
        return;
      }
      const pData = roomData.players[localPlayerId];
      const cData = roomData.countryData[selectedCountry];
      if (!cData.wheatProduction) {
        showNotification("Bu ülkede buğday üretimi yok!");
        return;
      }
      const totalM = 200 * q;
      const totalO = 100 * q;
      if (pData.money < totalM) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (pData.petrol < totalO) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = pData.money - totalM;
      updates[`players/${localPlayerId}/petrol`] = pData.petrol - totalO;
      updates[`countryData/${selectedCountry}/grainMills`] =
        (cData.grainMills || 0) + q;
      roomRef.update(updates);
      broadcastNotification(`${pData.name}, ${selectedCountry} ülkesine ${q} değirmen kurdu.`);
      showNotification(`${q} değirmen kuruldu.`);
    }

    // KAYNAK GÖNDERME
    document.getElementById("send-money-btn").addEventListener("click", sendMoney);
    function sendMoney() {
      const amt = parseInt(document.getElementById("money-to-send").value);
      const rec = document.getElementById("recipient-player").value;
      if (isNaN(amt) || amt <= 0) {
        showNotification("Geçerli miktar girin!");
        return;
      }
      const pData = roomData.players[localPlayerId];
      if (pData.money < amt) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (rec === localPlayerId) {
        showNotification("Kendinize para gönderemezsiniz!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = pData.money - amt;
      updates[`players/${rec}/money`] = roomData.players[rec].money + amt;
      roomRef.update(updates);
      broadcastNotification(`${pData.name} -> ${roomData.players[rec].name} için ${amt}$ gönderdi.`);
      showNotification(`${amt}$ gönderildi.`);
    }

    document.getElementById("send-petrol-btn").addEventListener("click", sendPetrol);
    function sendPetrol() {
      const amt = parseInt(document.getElementById("petrol-to-send").value);
      const rec = document.getElementById("recipient-player-petrol").value;
      if (isNaN(amt) || amt <= 0) {
        showNotification("Geçerli miktar girin!");
        return;
      }
      const pData = roomData.players[localPlayerId];
      if (pData.petrol < amt) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      if (rec === localPlayerId) {
        showNotification("Kendinize petrol gönderemezsiniz!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/petrol`] = pData.petrol - amt;
      updates[`players/${rec}/petrol`] = roomData.players[rec].petrol + amt;
      roomRef.update(updates);
      broadcastNotification(`${pData.name} -> ${roomData.players[rec].name} için ${amt} varil petrol gönderdi.`);
      showNotification(`${amt} varil petrol gönderildi.`);
    }

    document.getElementById("send-wheat-btn").addEventListener("click", sendWheat);
    function sendWheat() {
      const amt = parseInt(document.getElementById("wheat-to-send").value);
      const rec = document.getElementById("recipient-player-wheat").value;
      if (isNaN(amt) || amt <= 0) {
        showNotification("Geçerli miktar girin!");
        return;
      }
      const pData = roomData.players[localPlayerId];
      if (pData.wheat < amt) {
        showNotification("Yeterli buğdayınız yok!");
        return;
      }
      if (rec === localPlayerId) {
        showNotification("Kendinize buğday gönderemezsiniz!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/wheat`] = pData.wheat - amt;
      updates[`players/${rec}/wheat`] = roomData.players[rec].wheat + amt;
      roomRef.update(updates);
      broadcastNotification(`${pData.name} -> ${roomData.players[rec].name} için ${amt} buğday gönderdi.`);
      showNotification(`${amt} buğday gönderildi.`);
    }

    // TUR BİTİR
    document.getElementById("end-turn-btn").addEventListener("click", () => nextTurn(false));
    function nextTurn(autoEnd = false) {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      stopTurnTimer();

      const idx = roomData.currentTurnIndex || 0;
      const pid = roomData.playerOrder[idx];
      const player = roomData.players[pid];
      if (!player) return;

      const updates = {};

      // Gelir & Üretim
      if (player.countries && roomData.countryData) {
        let totalMoney = 0;
        let totalOil = 0;
        let totalWheat = 0;
        player.countries.forEach((cName) => {
          const c = roomData.countryData[cName];
          if (!c) return;
          // Kışla -> Asker üretimi
          if (c.barracksCount) {
            updates[`countryData/${cName}/soldiers`] = (c.soldiers || 0) + (5 * c.barracksCount);
          }
          // Gelir
          let inc = c.income || 0;
          if (c.factories) {
            inc = Math.floor(inc * (1 + 0.20 * c.factories));
          }
          totalMoney += inc;
          // Petrol
          if (c.oilProduction) {
            const effOil = Math.floor(c.oilProduction * (1 + 0.15 * (c.refineries || 0)));
            totalOil += effOil;
          }
          // Buğday
          if (c.wheatProduction) {
            const effWheat = Math.floor(c.wheatProduction * (1 + 0.20 * (c.grainMills || 0)));
            totalWheat += effWheat;
          }
        });
        updates[`players/${pid}/money`] = player.money + totalMoney;
        updates[`players/${pid}/petrol`] = player.petrol + totalOil;
        updates[`players/${pid}/wheat`] = player.wheat + totalWheat;
      }

      let newTurnIndex = idx + 1;
      let newRound = roomData.round || 1;
      if (newTurnIndex >= roomData.playerOrder.length) {
        newTurnIndex = 0;
        newRound++;
        updates["round"] = newRound;
      }
      updates["currentTurnIndex"] = newTurnIndex;
      roomRef.update(updates);

      const nextPid = roomData.playerOrder[newTurnIndex];
      let text = `Sıra ${roomData.players[nextPid]?.name || "???"} adlı oyuncuya geçti.`;
      if (autoEnd) {
        text = `${player.name} süresini doldurdu! ` + text;
      }
      broadcastNotification(text);
      showNotification(text, 1500);
    }

    // ODADAN ÇIKIŞ
    document.getElementById("exit-room-btn").addEventListener("click", () => {
      if (!roomRef || !roomData) return;

      // Eğer tur sırası bizdeyse turu pas geç
      if (isMyTurn()) {
        forceNextTurnOnExit();
      }

      // Bizi sil
      roomRef.child(`players/${localPlayerId}`).remove();
      // Order'dan da çıkar
      const newOrder = (roomData.playerOrder || []).filter((id) => id !== localPlayerId);
      roomRef.update({ playerOrder: newOrder });

      document.getElementById("game-container").style.display = "none";
      document.getElementById("lobby-container").style.display = "block";
      document.body.classList.add("lobby");

      localStorage.removeItem("roomCode");
      stopTurnTimer();
      clearInterval(startInterval);
      showNotification("Odadan çıktınız. Artık oyunda yoksunuz.");
    });

    // Tur pas geçme (odadan çıkarken)
    function forceNextTurnOnExit() {
      stopTurnTimer();
      let idx = roomData.currentTurnIndex || 0;
      // Tek oyuncu kalabilir, vs.
      let newOrder = (roomData.playerOrder || []).filter((id) => id !== localPlayerId);
      if (newOrder.length === 0) {
        // Kimse kalmadı, bir şey yapmaya gerek yok
        return;
      }
      if (idx >= newOrder.length) {
        idx = 0;
        let r = (roomData.round || 1) + 1;
        roomRef.update({ round: r });
      }
      roomRef.update({ currentTurnIndex: idx });
    }

    /**********************************************************************
     * POPUP AÇ/KAPA
     **********************************************************************/
    // Asker İşlemleri Popup
    const militaryPopup = document.getElementById("military-popup");
    document.getElementById("open-military-btn").addEventListener("click", () => {
      popupStates.military = !popupStates.military;
      militaryPopup.style.display = popupStates.military ? "flex" : "none";
    });
    document.getElementById("military-popup-header").addEventListener("click", (e) => {
      if (e.target.id === "military-popup-header") {
        popupStates.military = false;
        militaryPopup.style.display = "none";
      }
    });
    document.getElementById("close-military-btn").addEventListener("click", () => {
      popupStates.military = false;
      militaryPopup.style.display = "none";
    });

    // Bina Kurma Popup
    const buildingPopup = document.getElementById("building-popup");
    document.getElementById("open-building-btn").addEventListener("click", () => {
      popupStates.building = !popupStates.building;
      buildingPopup.style.display = popupStates.building ? "flex" : "none";
    });
    document.getElementById("building-popup-header").addEventListener("click", (e) => {
      if (e.target.id === "building-popup-header") {
        popupStates.building = false;
        buildingPopup.style.display = "none";
      }
    });
    document.getElementById("close-building-btn").addEventListener("click", () => {
      popupStates.building = false;
      buildingPopup.style.display = "none";
    });

    // Kaynak Gönderme Popup
    const resourcePopup = document.getElementById("resource-popup");
    document.getElementById("open-resource-btn").addEventListener("click", () => {
      popupStates.resource = !popupStates.resource;
      resourcePopup.style.display = popupStates.resource ? "flex" : "none";
    });
    document.getElementById("resource-popup-header").addEventListener("click", (e) => {
      if (e.target.id === "resource-popup-header") {
        popupStates.resource = false;
        resourcePopup.style.display = "none";
      }
    });
    document.getElementById("close-resource-btn").addEventListener("click", () => {
      popupStates.resource = false;
      resourcePopup.style.display = "none";
    });

    // Oyuncular Popup
    const playersPopup = document.getElementById("players-popup");
    document.getElementById("open-players-btn").addEventListener("click", () => {
      popupStates.players = !popupStates.players;
      playersPopup.style.display = popupStates.players ? "flex" : "none";
    });
    document.getElementById("players-popup-header").addEventListener("click", (e) => {
      if (e.target.id === "players-popup-header") {
        popupStates.players = false;
        playersPopup.style.display = "none";
      }
    });
    document.getElementById("close-players-btn").addEventListener("click", () => {
      popupStates.players = false;
      playersPopup.style.display = "none";
    });

    // Pakt Popup
    document.getElementById("open-pact-btn").addEventListener("click", () => {
      popupStates.pact = !popupStates.pact;
      const pactPopup = document.getElementById("pact-popup");
      pactPopup.style.display = popupStates.pact ? "flex" : "none";
    });
    document.getElementById("pact-popup-header").addEventListener("click", (e) => {
      if (e.target.id === "pact-popup-header") {
        popupStates.pact = false;
        document.getElementById("pact-popup").style.display = "none";
      }
    });
    document.getElementById("close-pact-btn").addEventListener("click", () => {
      popupStates.pact = false;
      document.getElementById("pact-popup").style.display = "none";
    });

    // Market Popup
    const marketPopup = document.getElementById("market-popup");
    document.getElementById("open-market-btn").addEventListener("click", () => {
      popupStates.market = !popupStates.market;
      marketPopup.style.display = popupStates.market ? "flex" : "none";
    });
    document.getElementById("market-popup-header").addEventListener("click", (e) => {
      if (e.target.id === "market-popup-header") {
        popupStates.market = false;
        marketPopup.style.display = "none";
      }
    });
    document.getElementById("close-market-btn").addEventListener("click", () => {
      popupStates.market = false;
      marketPopup.style.display = "none";
    });

    /**********************************************************************
     * CHAT (GENEL + ÖZEL)
     **********************************************************************/
    const chatPopup = document.getElementById("chat-popup");
    document.getElementById("open-chat-btn").addEventListener("click", () => {
      popupStates.chat = !popupStates.chat;
      toggleChat(popupStates.chat);
    });
    function toggleChat(show) {
      chatPopup.style.display = show ? "flex" : "none";
      chatOpen = show;
      if (chatOpen) {
        unreadMessages = 0;
        updateChatBadge();
      }
    }
    document.getElementById("chat-popup-header").addEventListener("click", (e) => {
      if (e.target.id === "chat-popup-header") {
        popupStates.chat = false;
        chatPopup.style.display = "none";
      }
    });
    document.getElementById("close-chat-btn").addEventListener("click", () => {
      popupStates.chat = false;
      chatPopup.style.display = "none";
    });
    document.getElementById("send-chat-btn").addEventListener("click", sendChatMessage);
    document.getElementById("chat-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendChatMessage();
      }
    });
    function sendChatMessage() {
      const input = document.getElementById("chat-input");
      const msg = input.value.trim();
      if (!msg) return;
      if (!roomRef) {
        showNotification("Oda verisi yüklenmedi.");
        return;
      }
      let senderName = "Anon";
      if (roomData && roomData.players[localPlayerId]) {
        senderName = roomData.players[localPlayerId].name;
      }
      const chatObj = {
        sender: senderName,
        senderId: localPlayerId,
        text: msg,
        recipientId: "",
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.child("chat").push(chatObj, (err) => {
        if (!err) {
          input.value = "";
        }
      });
    }

    document.getElementById("send-private-message-btn").addEventListener("click", () => {
      const input = document.getElementById("private-message-input");
      const rec = document.getElementById("private-message-recipient");
      const msg = input.value.trim();
      const rid = rec.value;
      if (!msg || !rid) return;
      let senderName = "Anon";
      if (roomData && roomData.players[localPlayerId]) {
        senderName = roomData.players[localPlayerId].name;
      }
      const chatObj = {
        sender: senderName,
        senderId: localPlayerId,
        text: msg,
        recipientId: rid,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.child("chat").push(chatObj, (err) => {
        if (!err) {
          input.value = "";
          showNotification("Özel mesaj gönderildi!");
        }
      });
    });

    function appendChatMessage(message) {
      // Özel mesaj
      if (message.recipientId && message.recipientId !== "") {
        if (message.senderId !== localPlayerId && message.recipientId !== localPlayerId) {
          return;
        }
      }
      const cmsgDiv = document.getElementById("chat-messages");
      const div = document.createElement("div");
      if (message.recipientId && message.recipientId !== "") {
        const targetName = roomData.players[message.recipientId]?.name || "???";
        if (message.senderId === localPlayerId) {
          div.innerHTML = `<strong>[PM to ${targetName}]:</strong> ${message.text}`;
        } else {
          div.innerHTML = `<strong>[PM from ${message.sender}]:</strong> ${message.text}`;
        }
        div.style.color = "#ffa726";
      } else {
        div.textContent = `${message.sender}: ${message.text}`;
      }
      cmsgDiv.appendChild(div);
      cmsgDiv.scrollTop = cmsgDiv.scrollHeight;

      if (!chatOpen && message.senderId !== localPlayerId) {
        unreadMessages++;
        updateChatBadge();
      }
    }
    function updateChatBadge() {
      const openChatBtn = document.getElementById("open-chat-btn");
      if (unreadMessages > 0) {
        openChatBtn.dataset.badge = unreadMessages;
      } else {
        openChatBtn.dataset.badge = "";
      }
    }

    /**********************************************************************
     * MARKET (TİCARET) SİSTEMİ
     **********************************************************************/
    const itemTypeSelect = document.getElementById("trade-item-type");
    const tradeCountrySelect = document.getElementById("trade-country");
    itemTypeSelect.addEventListener("change", () => {
      const val = itemTypeSelect.value;
      if (val === "petrol" || val === "wheat") {
        tradeCountrySelect.style.display = "none";
      } else {
        tradeCountrySelect.style.display = "block"; // factory ise
      }
    });
    document.getElementById("create-trade-offer-btn").addEventListener("click", createTradeOffer);

    function updateTradeCountrySelect() {
      if (!tradeCountrySelect) return;
      tradeCountrySelect.innerHTML = "<option value=''>--Ülke Seç--</option>";
      if (!roomData || !roomData.countryData || !roomData.players[localPlayerId]) return;
      Object.keys(roomData.countryData).forEach((cName) => {
        const c = roomData.countryData[cName];
        if (c.owner === localPlayerId) {
          const op = document.createElement("option");
          op.value = cName;
          op.textContent = cName;
          tradeCountrySelect.appendChild(op);
        }
      });
    }
    function createTradeOffer() {
      if (!roomData || !roomData.players[localPlayerId]) {
        showNotification("Veri yüklenmedi veya geçersiz oyuncu!");
        return;
      }
      const itemType = itemTypeSelect.value;
      const quantity = parseInt(document.getElementById("trade-quantity").value);
      const price = parseInt(document.getElementById("trade-price").value);
      let countryName = null;
      if (itemType === "factory") {
        countryName = tradeCountrySelect.value;
      }
      if (isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
        showNotification("Geçerli miktar ve fiyat girin!");
        return;
      }
      const seller = roomData.players[localPlayerId];
      let enough = false;

      if (itemType === "petrol") {
        if (seller.petrol >= quantity) {
          enough = true;
        }
      } else if (itemType === "wheat") {
        if (seller.wheat >= quantity) {
          enough = true;
        }
      } else if (itemType === "factory") {
        if (!countryName) {
          showNotification("Fabrika satmak için bir ülke seçmelisiniz!");
          return;
        }
        const c = roomData.countryData[countryName];
        if (!c || c.owner !== localPlayerId) {
          showNotification("Seçilen ülke size ait değil!");
          return;
        }
        if (c.factories >= quantity) {
          enough = true;
        }
      }
      if (!enough) {
        showNotification("Satacak yeterli miktarınız yok!");
        return;
      }
      const embargoSelect = document.getElementById("embargo-players");
      let embargoList = [];
      for (let i = 0; i < embargoSelect.options.length; i++) {
        if (embargoSelect.options[i].selected) {
          embargoList.push(embargoSelect.options[i].value);
        }
      }

      const offerRef = roomRef.child("tradeOffers").push();
      const newOffer = {
        offerId: offerRef.key,
        sellerId: localPlayerId,
        sellerName: seller.name,
        itemType: itemType,
        countryName: countryName || null,
        quantity: quantity,
        price: price,
        status: "pending",
        embargo: embargoList
      };
      offerRef.set(newOffer);
      broadcastNotification(`${seller.name} bir ticaret teklifi oluşturdu (${itemType}, adet: ${quantity}, fiyat: ${price}$)`);
      showNotification("Ticaret teklifi oluşturuldu.");
    }
    function displayTradeOffers() {
      const listDiv = document.getElementById("trade-offers-list");
      if (!listDiv) return;
      listDiv.innerHTML = "";
      if (!roomData || !roomData.tradeOffers) return;

      Object.values(roomData.tradeOffers).forEach((offer) => {
        if (offer.status === "pending") {
          if (offer.embargo && offer.embargo.includes(localPlayerId)) {
            return;
          }
          const div = document.createElement("div");
          div.className = "offer-item";
          let label = "";
          if (offer.itemType === "petrol") label = "Petrol";
          if (offer.itemType === "factory") label = "Fabrika";
          if (offer.itemType === "wheat") label = "Buğday";

          let html = `<p><strong>Satıcı:</strong> ${offer.sellerName}</p>`;
          html += `<p><strong>Ürün:</strong> ${label}</p>`;
          html += `<p><strong>Mevcut Miktar:</strong> ${offer.quantity}</p>`;
          html += `<p><strong>Birim Fiyat:</strong> ${offer.price} $</p>`;
          if (offer.countryName) {
            html += `<p><strong>Ülke (Satıcının):</strong> ${offer.countryName}</p>`;
          }
          if (offer.embargo && offer.embargo.length > 0) {
            const emb = offer.embargo.map(e => roomData.players[e]?.name || "???").join(", ");
            html += `<p style="color:red;"><strong>Ambargo:</strong> ${emb}</p>`;
          }
          // Eğer satıcı ben değilsem alım butonu
          if (offer.sellerId !== localPlayerId) {
            html += `
              <label style="font-size:14px;color:#ccc;">Almak istediğiniz miktar:</label>
              <input type="number" class="partial-buy-quantity" placeholder="Miktar" min="1" max="${offer.quantity}"/>
            `;
            if (offer.itemType === "factory") {
              html += `
                <label style="font-size:14px;color:#ccc;">Hangi ülkenize kurulacak?</label>
                <select class="buyer-country-select">${getBuyerCountriesOptionsHTML()}</select>
              `;
            }
            html += `<button class="partial-buy-btn">Satın Al</button>`;
          } else {
            // Satıcı isek iptal butonu
            html += `
              <button class="cancel-offer-btn" style="background: linear-gradient(45deg, #e53935, #c62828); margin-top:10px;">İptal</button>
            `;
          }
          div.innerHTML = html;
          // Buton event
          const buyBtn = div.querySelector(".partial-buy-btn");
          if (buyBtn) {
            buyBtn.addEventListener("click", () => {
              const input = div.querySelector(".partial-buy-quantity");
              const amt = parseInt(input.value);
              let chosenCountry = null;
              if (offer.itemType === "factory") {
                const bcSel = div.querySelector(".buyer-country-select");
                chosenCountry = bcSel.value;
              }
              acceptTradeOffer(offer.offerId, amt, chosenCountry);
            });
          }
          const cancelBtn = div.querySelector(".cancel-offer-btn");
          if (cancelBtn) {
            cancelBtn.addEventListener("click", () => {
              cancelTradeOffer(offer.offerId);
            });
          }

          listDiv.appendChild(div);
        }
      });
    }
    function getBuyerCountriesOptionsHTML() {
      if (!roomData || !roomData.players[localPlayerId]) return "";
      const player = roomData.players[localPlayerId];
      let html = "";
      if (player.countries && roomData.countryData) {
        player.countries.forEach((cName) => {
          html += `<option value="${cName}">${cName}</option>`;
        });
      }
      return html;
    }
    function acceptTradeOffer(offerId, buyAmt, buyerCountry) {
      if (!roomData || !roomData.tradeOffers || !roomData.tradeOffers[offerId]) {
        showNotification("Teklif bulunamadı!");
        return;
      }
      const offer = roomData.tradeOffers[offerId];
      if (offer.status !== "pending") {
        showNotification("Bu teklif artık geçerli değil!");
        return;
      }
      if (buyAmt > offer.quantity) {
        showNotification("Teklifte bu kadar miktar yok!");
        return;
      }
      const seller = roomData.players[offer.sellerId];
      const buyer = roomData.players[localPlayerId];
      if (!seller || !buyer) {
        showNotification("Geçersiz satıcı/alıcı!");
        return;
      }
      const totalCost = offer.price * buyAmt;
      if (buyer.money < totalCost) {
        showNotification("Yeterli paranız yok!");
        return;
      }

      const updates = {};
      let hasEnough = false;

      if (offer.itemType === "petrol") {
        if (seller.petrol >= buyAmt) {
          hasEnough = true;
          updates[`players/${offer.sellerId}/petrol`] = seller.petrol - buyAmt;
          updates[`players/${localPlayerId}/petrol`] = buyer.petrol + buyAmt;
        }
      } else if (offer.itemType === "wheat") {
        if (seller.wheat >= buyAmt) {
          hasEnough = true;
          updates[`players/${offer.sellerId}/wheat`] = seller.wheat - buyAmt;
          updates[`players/${localPlayerId}/wheat`] = buyer.wheat + buyAmt;
        }
      } else if (offer.itemType === "factory") {
        const c = roomData.countryData[offer.countryName];
        if (!c || c.owner !== offer.sellerId) {
          showNotification("Satıcının bu ülke hakkı yok!");
          return;
        }
        if (c.factories >= buyAmt) {
          hasEnough = true;
          updates[`countryData/${offer.countryName}/factories`] = c.factories - buyAmt;
        }
        if (hasEnough) {
          if (!buyerCountry || !roomData.countryData[buyerCountry]) {
            showNotification("Fabrikayı kuracağınız ülkeyi seçin!");
            return;
          }
          if (!buyer.countries.includes(buyerCountry)) {
            showNotification("Seçtiğiniz ülke size ait değil!");
            return;
          }
          updates[`countryData/${buyerCountry}/factories`] =
            (roomData.countryData[buyerCountry].factories || 0) + buyAmt;
        }
      }
      if (!hasEnough) {
        showNotification("Satıcının yeterli ürünü/binası kalmamış!");
        return;
      }

      // Para transferi
      updates[`players/${localPlayerId}/money`] = buyer.money - totalCost;
      updates[`players/${offer.sellerId}/money`] = seller.money + totalCost;

      let newQty = offer.quantity - buyAmt;
      if (newQty <= 0) {
        updates[`tradeOffers/${offerId}/status`] = "completed";
      }
      updates[`tradeOffers/${offerId}/quantity`] = newQty;

      roomRef.update(updates, (error) => {
        if (!error) {
          broadcastNotification(
            `Ticaret Onaylandı: ${seller.name} -> ${buyer.name} (${buyAmt} x ${offer.itemType})`
          );
          showNotification("Ticaret gerçekleşti!");
          // Chat'e de yansıt
          const chatMsg = {
            sender: "Sistem",
            senderId: "system",
            text: `Ticaret Onaylandı: ${seller.name} -> ${buyer.name}, ${buyAmt} x ${offer.itemType}`,
            recipientId: "",
            timestamp: firebase.database.ServerValue.TIMESTAMP
          };
          roomRef.child("chat").push(chatMsg);
        }
      });
    }
    function cancelTradeOffer(offerId) {
      const offer = roomData.tradeOffers[offerId];
      if (!offer || offer.sellerId !== localPlayerId) {
        showNotification("Sadece kendi teklifinizi iptal edebilirsiniz!");
        return;
      }
      if (offer.status !== "pending") {
        showNotification("Teklif zaten geçerli değil!");
        return;
      }
      roomRef.child("tradeOffers").child(offerId).update({ status: "cancelled" });
      broadcastNotification(`Ticaret teklifi iptal edildi: ${offer.sellerName}`);
      showNotification("Teklif iptal edildi.");
    }

    /**********************************************************************
     * HARİTA (Leaflet) KURULUMU
     **********************************************************************/
    function initializeMap() {
      if (map) return;
      map = L.map("map").setView([20, 0], 2);

      // Daha güzel bir tileLayer örneği (CartoDB)
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          maxZoom: 12,
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> & Contributors,' +
            ' <a href="https://carto.com/attributions">CARTO</a>'
        }
      ).addTo(map);

      fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
        .then((response) => response.json())
        .then((geoJsonData) => {
          geoJsonLayer = L.geoJson(geoJsonData, {
            style: () => ({
              color: "#555",
              weight: 1,
              fillColor: "#ccc",
              fillOpacity: 0.7
            }),
            onEachFeature: (feature, layer) => {
              const cname = feature.properties.name;
              layer.bindTooltip(
                getCountryPopupContent(
                  cname,
                  roomData && roomData.countryData ? roomData.countryData[cname] : {}
                ),
                {
                  permanent: infoCardsPermanent,
                  direction: "center",
                  className: "country-popup-tooltip"
                }
              );
              layer.on("click", () => selectCountry(cname, layer));
            }
          }).addTo(map);
        });
    }

    // Map'i gösterecek container açılınca başlat
    const gameContainerObserver = new MutationObserver(() => {
      const gc = document.getElementById("game-container");
      if (gc.style.display !== "none") {
        initializeMap();
      }
    });
    gameContainerObserver.observe(document.getElementById("game-container"), {
      attributes: true,
      attributeFilter: ["style"]
    });
  </script>
</body>
</html>
