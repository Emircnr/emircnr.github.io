<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <!-- Mobil cihazlarda uygun ölçeklendirme -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Global Conquest - Online</title>

  <!-- Google Fonts: Cinzel (askeri, dramatik his için) -->
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap"
    rel="stylesheet"
  />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <!-- FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <!-- Animate.css -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
  />

  <style>
    /**********************************************************
     * GENEL RESET & VÜCUT
     **********************************************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Cinzel", serif;
      color: #eee;
      overflow-x: hidden;
      transition: background 0.5s;
    }
    a {
      text-decoration: none;
      color: inherit;
    }

    /**********************************************************
     * LOBI SAYFASI (ARKA PLAN ve KUTU)
     **********************************************************/
    body.lobby {
      background: linear-gradient(180deg, #0a1f44 0%, #0b2a63 35%, #0b3553 100%);
      background-attachment: fixed;
      background-size: cover;
    }
    #lobby-container {
      max-width: 500px;
      margin: 60px auto;
      padding: 30px;
      background: rgba(0, 0, 0, 0.65);
      border: 2px solid #1abc9c;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      animation: fadeInLobby 1s ease forwards;
    }
    @keyframes fadeInLobby {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    #lobby-container h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #1abc9c;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: 38px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
      animation: animateTitle 1s ease;
    }
    @keyframes animateTitle {
      0% {
        letter-spacing: 8px;
        opacity: 0;
      }
      100% {
        letter-spacing: 3px;
        opacity: 1;
      }
    }
    #lobby-container h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #aef7f2;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 24px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
    }
    #lobby-container input[type="text"],
    #lobby-container input[type="number"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #1abc9c;
      border-radius: 4px;
      font-size: 16px;
      outline: none;
      color: #333;
      transition: box-shadow 0.3s;
    }
    #lobby-container input[type="text"]:focus,
    #lobby-container input[type="number"]:focus {
      box-shadow: 0 0 8px #1abc9c;
    }
    #lobby-container button {
      width: 100%;
      padding: 14px;
      margin-bottom: 15px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: 1px solid #16a085;
      border-radius: 6px;
      font-size: 18px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.7);
      transition: background 0.3s, transform 0.3s;
    }
    #lobby-container button:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
      transform: scale(1.02);
    }
    .color-options {
      margin-bottom: 15px;
      text-align: center;
    }
    .global-color-option {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      display: inline-block;
      margin: 0 5px;
      transition: transform 0.3s, border-color 0.3s;
    }
    .global-color-option:hover {
      transform: scale(1.2);
      border-color: #fff;
    }
    .global-color-option.selected {
      border-color: #f1c40f;
    }

    /**********************************************************
     * OYUN EKRANI
     **********************************************************/
    #game-container {
      display: none;
      height: 100vh;
      background: linear-gradient(180deg, #0b2a63 0%, #0a1f44 100%);
      position: relative;
    }

    /**********************************************************
     * BILDIRIM ALANI (POPUP)
     * --> Bu localNotification idi, ama now user wants top-right
     **********************************************************/
    #notification-area {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 5000;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .notification-popup {
      margin-bottom: 5px;
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
      font-size: 16px;
      line-height: 1.4;
      opacity: 0;
      transform: translateX(100px);
      transition: opacity 0.5s, transform 0.5s;
      max-width: 300px;
    }
    .notification-popup.show {
      opacity: 1;
      transform: translateX(0);
    }

    /**********************************************************
     * ÜST BİLGİ (TUR, ODA KODU, SIRA)
     **********************************************************/
    #top-info {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3000;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    #top-info p {
      margin: 0;
      font-size: 16px;
    }
    #top-info p span {
      font-weight: 600;
      color: #f39c12;
    }
    #end-turn-btn {
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #end-turn-btn:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }

    /**********************************************************
     * HARITA
     **********************************************************/
    #map-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
      background-color: #0e2740;
    }
    .toggle-info-cards {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1100;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
    }

    /**********************************************************
     * ALT İKONLAR (CHAT, PAKT, MARKET, vs.)
     **********************************************************/
    #bottom-icons {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 3000;
    }
    .bottom-icon-btn {
      width: 60px;
      height: 60px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      transition: transform 0.3s, background 0.3s;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .bottom-icon-btn:hover {
      transform: scale(1.05);
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }
    .bottom-icon-btn[data-badge]:after {
      content: attr(data-badge);
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      border-radius: 50%;
      min-width: 20px;
      min-height: 20px;
      padding: 2px 6px;
      text-align: center;
      font-size: 12px;
      pointer-events: none;
    }

    /* Odadan Çık Butonu (Sağ Alt) */
    #exit-room-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(45deg, #c0392b, #e74c3c);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.3s;
      z-index: 3000;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
    #exit-room-btn:hover {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
    }

    /**********************************************************
     * LEAFLET TOOLTIP & ÜLKE POPUP
     **********************************************************/
    .leaflet-tooltip {
      background: transparent;
      border: none;
    }
    .country-popup-tooltip {
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /**********************************************************
     * POPUPLAR (CHAT, PACT, MARKET, vb.)
     **********************************************************/
    .chat-popup {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 400px;
      max-height: 600px;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #444;
      border-radius: 8px;
      display: none;
      flex-direction: column;
      z-index: 3001;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
    .chat-header {
      background: rgba(0, 0, 0, 0.9);
      padding: 10px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      color: #1abc9c;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-header button {
      background: transparent;
      border: none;
      color: #1abc9c;
      font-size: 20px;
      cursor: pointer;
    }
    .chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.8);
      color: #eee;
      font-size: 14px;
    }
    .chat-input-container {
      display: flex;
      border-top: 1px solid #444;
    }
    .chat-input-container select {
      width: 35%;
      background: #1e1e2f;
      border: none;
      outline: none;
      color: #eee;
      font-size: 14px;
    }
    .chat-input-container input[type="text"] {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
      background: #1e1e2f;
      color: #eee;
    }
    .chat-input-container button {
      padding: 10px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      cursor: pointer;
      color: #fff;
    }

    .pact-popup {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 400px;
      max-height: 600px;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #444;
      border-radius: 8px;
      display: none;
      flex-direction: column;
      z-index: 3001;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
    .market-popup {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 450px;
      max-height: 650px;
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #2ecc71;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      z-index: 3002;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.7);
      animation: fadeInMarket 0.5s ease forwards;
    }
    @keyframes fadeInMarket {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /**********************************************************
     * GENEL POPUP PANELLER (ASKER, BİNA, KAYNAK, OYUNCULAR)
     **********************************************************/
    .popup-panel {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 450px;
      max-height: 650px;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid #444;
      border-radius: 8px;
      display: none;
      flex-direction: column;
      z-index: 3002;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
    .popup-header {
      background: rgba(0, 0, 0, 0.9);
      padding: 10px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      color: #1abc9c;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .popup-header button {
      background: transparent;
      border: none;
      color: #1abc9c;
      font-size: 20px;
      cursor: pointer;
    }
    .popup-content {
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: #eee;
      font-size: 14px;
      overflow-y: auto;
      flex: 1;
    }
    .popup-content h3 {
      font-size: 16px;
      color: #ccc;
      margin-bottom: 8px;
    }
    .popup-content input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid #1abc9c;
      border-radius: 4px;
      font-size: 14px;
      color: #333;
    }
    .popup-content select {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid #1abc9c;
      border-radius: 4px;
      font-size: 14px;
      color: #333;
    }
    .popup-content button {
      width: 100%;
      padding: 10px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      border-radius: 4px;
      font-size: 14px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
      margin-bottom: 15px;
    }
    .popup-content button:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }

    /* Oyuncu Bilgileri Pop-up */
    #players-popup .player-info {
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      font-size: 14px;
    }
    #players-popup .player-info p {
      margin: 4px 0;
      color: #ddd;
    }
  </style>
</head>
<body class="lobby">
  <!-- ===================== LOBBY (Oda Oluşturma & Katılma) ===================== -->
  <div id="lobby-container" class="animate__animated animate__fadeIn">
    <h1>GLOBAL CONQUEST</h1>
    <!-- Oda Oluşturma -->
    <div id="create-room-section">
      <h2>Oda Oluştur</h2>
      <input type="text" id="creator-player-name" placeholder="Adınız"/>
      <div class="color-options" id="creator-color-options"></div>
      <input
        type="number"
        id="max-players"
        placeholder="Oyuncu Sayısı (2-5)"
        min="2"
        max="5"
      />
      <button id="create-room-btn">Oda Oluştur</button>
    </div>
    <hr/>
    <!-- Odaya Katılma -->
    <div id="join-room-section">
      <h2>Odaya Katıl</h2>
      <input type="text" id="join-player-name" placeholder="Adınız"/>
      <div class="color-options" id="join-color-options"></div>
      <input
        type="text"
        id="room-code"
        placeholder="Oda Kodu (Örn: AB12CD)"
      />
      <button id="join-room-btn">Odaya Katıl</button>
    </div>
  </div>

  <!-- ===================== GLOBAL BILDIRIM ALANI (TOP-RIGHT) ===================== -->
  <div id="notification-area"></div>

  <!-- ===================== OYUN EKRANI ===================== -->
  <div id="game-container">
    <!-- Üst Bilgi (Tur, Sıra, Oda Kodu) -->
    <div id="top-info">
      <p>
        Oda Kodu: <span id="display-room-code">-</span> |
        Tur: <span id="current-round">1</span> |
        Sıra: <span id="current-player">Oyuncu Adı</span>
      </p>
      <button id="end-turn-btn"><i class="fas fa-forward"></i> Tur Sonu</button>
    </div>

    <!-- Harita Alanı -->
    <div id="map-container">
      <div id="map"></div>
      <!-- Bilgi Kartları Toggle Butonu -->
      <button id="toggle-info-cards" class="toggle-info-cards">
        <i class="fas fa-eye-slash"></i>
      </button>
    </div>

    <!-- Odadan Çık Butonu (Sağ Alt) -->
    <button id="exit-room-btn">Odadan Çık</button>

    <!-- Alt İkonlar (Chat, Pakt, Market, vs.) -->
    <div id="bottom-icons">
      <!-- Oyuncu Bilgileri -->
      <button id="open-players-btn" class="bottom-icon-btn" title="Oyuncular">
        <i class="fas fa-users"></i>
      </button>
      <!-- Asker İşlemleri -->
      <button id="open-military-btn" class="bottom-icon-btn" title="Asker İşlemleri">
        <i class="fas fa-shield-alt"></i>
      </button>
      <!-- Bina Kurma -->
      <button id="open-building-btn" class="bottom-icon-btn" title="Bina Kurma">
        <i class="fas fa-building"></i>
      </button>
      <!-- Kaynak Gönderme -->
      <button id="open-resource-btn" class="bottom-icon-btn" title="Kaynak Gönderme">
        <i class="fas fa-hand-holding-usd"></i>
      </button>
      <!-- Market -->
      <button id="open-market-btn" class="bottom-icon-btn" data-badge="" title="Ticaret Merkezi">
        <i class="fas fa-store"></i>
      </button>
      <!-- Pakt -->
      <button id="open-pact-btn" class="bottom-icon-btn" title="Saldırmazlık Pakti">
        <i class="fas fa-handshake"></i>
      </button>
      <!-- Chat -->
      <button id="open-chat-btn" class="bottom-icon-btn" data-badge="" title="Sohbet">
        <i class="fas fa-comments"></i>
      </button>
    </div>
  </div>

  <!-- ===================== POPUP: ASKER İŞLEMLERİ ===================== -->
  <div id="military-popup" class="popup-panel">
    <div class="popup-header">
      <span>Asker İşlemleri</span>
      <button id="close-military-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Saldırı</h3>
      <input
        type="number"
        id="attack-soldiers"
        placeholder="Asker sayısı"
        min="1"
      />
      <button id="attack-btn">
        <i class="fas fa-crosshairs"></i> Saldırı Yap
      </button>

      <h3>Asker Satın Alma</h3>
      <input
        type="number"
        id="soldiers-to-buy"
        placeholder="Adet (10$ / adet)"
        min="1"
      />
      <button id="buy-soldiers-btn">
        <i class="fas fa-user-plus"></i> Satın Al
      </button>

      <h3>Asker Çek</h3>
      <input
        type="number"
        id="pull-soldiers-count"
        placeholder="Asker sayısı"
        min="1"
      />
      <button id="pull-soldiers-btn">
        <i class="fas fa-running"></i> Asker Çek
      </button>
    </div>
  </div>

  <!-- ===================== POPUP: BİNA KURMA ===================== -->
  <div id="building-popup" class="popup-panel">
    <div class="popup-header">
      <span>Bina Kurma</span>
      <button id="close-building-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Kışla Kur</h3>
      <input
        type="number"
        id="barracks-quantity"
        placeholder="Adet (130$ + 40 varil / adet)"
        min="1"
      />
      <button id="buy-barracks-btn">
        <i class="fas fa-fort-awesome"></i> Kışla Kur
      </button>

      <h3>Fabrika Kur</h3>
      <input
        type="number"
        id="factory-quantity"
        placeholder="Adet (250$ + 90 varil / adet)"
        min="1"
      />
      <button id="build-factory-btn">
        <i class="fas fa-industry"></i> Fabrika Kur
      </button>

      <h3>Rafine Kur</h3>
      <input
        type="number"
        id="refinery-quantity"
        placeholder="Adet (800$ + 250 varil / adet)"
        min="1"
      />
      <button id="build-refinery-btn">
        <i class="fas fa-oil-can"></i> Rafine Kur
      </button>
    </div>
  </div>

  <!-- ===================== POPUP: KAYNAK GÖNDERME ===================== -->
  <div id="resource-popup" class="popup-panel">
    <div class="popup-header">
      <span>Kaynak Gönderme</span>
      <button id="close-resource-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Para Gönder</h3>
      <input
        type="number"
        id="money-to-send"
        placeholder="Miktar ($)"
        min="1"
      />
      <select id="recipient-player"></select>
      <button id="send-money-btn">
        <i class="fas fa-hand-holding-usd"></i> Para Gönder
      </button>

      <h3>Petrol Gönder</h3>
      <input
        type="number"
        id="petrol-to-send"
        placeholder="Varil"
        min="1"
      />
      <select id="recipient-player-petrol"></select>
      <button id="send-petrol-btn">
        <i class="fas fa-gas-pump"></i> Petrol Gönder
      </button>
    </div>
  </div>

  <!-- ===================== POPUP: OYUNCULAR ===================== -->
  <div id="players-popup" class="popup-panel">
    <div class="popup-header">
      <span>Oyuncu Bilgileri</span>
      <button id="close-players-btn">&times;</button>
    </div>
    <div class="popup-content" id="players-info">
      <!-- Oyuncu listesi burada güncellenir -->
    </div>
  </div>

  <!-- ===================== CHAT POPUP (ÖZEL MESAJ EKLENDİ) ===================== -->
  <div id="chat-popup" class="chat-popup">
    <div class="chat-header">
      <span>Sohbet</span>
      <button id="close-chat-btn">&times;</button>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-container">
      <!-- Özel mesaj için alıcı seçimi: "all" veya bir playerId -->
      <select id="chat-recipient">
        <!-- "all" => herkese, yoksa spesifik playerId -->
      </select>
      <input type="text" id="chat-input" placeholder="Mesajınızı yazın..." />
      <button id="send-chat-btn">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <!-- ===================== PAKT POPUP ===================== -->
  <div id="pact-popup" class="pact-popup">
    <div class="pact-header">
      <span>Saldırmazlık Pakti</span>
      <button id="close-pact-btn">&times;</button>
    </div>
    <div class="pact-content">
      <h4>Pakt Teklifi Oluştur</h4>
      <input type="number" id="pact-turns" placeholder="Tur" min="1"/>
      <input type="number" id="pact-cost" placeholder="Ücret" min="1"/>
      <select id="pact-recipient"></select>
      <button id="send-pact-btn">Teklif Gönder</button>
    </div>
    <div id="pact-offers-container">
      <h3>Gelen Anlaşmazlık Pakti Teklifleri</h3>
      <div id="pact-offers-list"></div>
    </div>
  </div>

  <!-- ===================== TİCARET POPUP ===================== -->
  <div id="market-popup" class="market-popup">
    <div class="market-header">
      <h2>Ticaret Merkezi</h2>
      <button id="close-market-btn">&times;</button>
    </div>
    <div class="market-content">
      <!-- Teklif Oluşturma -->
      <div class="market-section">
        <h3>Teklif Oluştur</h3>
        <select id="trade-item-type">
          <option value="petrol">Petrol</option>
          <option value="barracks">Kışla</option>
          <option value="factory">Fabrika</option>
          <option value="refinery">Rafine</option>
        </select>
        <select id="trade-country" style="display:none;"></select>
        <input type="number" id="trade-quantity" placeholder="Adet/Varil" min="1"/>
        <input type="number" id="trade-price" placeholder="Birim Fiyat ($)" min="1"/>
        <button id="create-trade-offer-btn">Teklifi Yükle</button>
      </div>
      <!-- Mevcut Teklifler -->
      <div class="market-section offer-list">
        <h3>Piyasadaki Teklifler</h3>
        <div id="trade-offers-list"></div>
      </div>
    </div>
  </div>

  <!-- Firebase & Diğer JS Kütüphaneleri -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <script>
    /*****************************************************************
     * Firebase Başlatma
     *****************************************************************/
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MSG_ID",
      appId: "YOUR_APP_ID",
      measurementId: "YOUR_MEASURE_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /*****************************************************************
     * GLOBAL DEĞİŞKENLER
     *****************************************************************/
    let localPlayerId = null;
    let currentRoomCode = null;
    let roomRef = null;
    let roomData = null;
    let selectedCountry = null;
    let map, geoJsonLayer = null;
    const availableColors = ["red", "blue", "green", "yellow", "purple"];
    let localPlayerColor = null;

    // Bilgi kartları sabit görünüm
    let infoCardsPermanent = false;
    // Chat
    let chatListenerAdded = false;
    let unreadMessages = 0;
    let chatOpen = false;

    // Bildirim queue
    let notificationQueue = [];

    /*****************************************************************
     * OYUN BAŞLANGIÇ / LOBI İŞLEMLERİ
     *****************************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      // Player ID
      if (!localStorage.getItem("playerId")) {
        localStorage.setItem("playerId", Math.random().toString(36).substr(2, 9));
      }
      localPlayerId = localStorage.getItem("playerId");

      // Renk Seçimi
      const creatorColorDiv = document.getElementById("creator-color-options");
      availableColors.forEach((color) => {
        const btn = document.createElement("button");
        btn.className = "global-color-option";
        btn.style.background = color;
        btn.dataset.color = color;
        btn.addEventListener("click", function () {
          creatorColorDiv
            .querySelectorAll(".global-color-option")
            .forEach((s) => s.classList.remove("selected"));
          btn.classList.add("selected");
          localPlayerColor = color;
        });
        creatorColorDiv.appendChild(btn);
      });
      const joinColorDiv = document.getElementById("join-color-options");
      availableColors.forEach((color) => {
        const btn = document.createElement("button");
        btn.className = "global-color-option";
        btn.style.background = color;
        btn.dataset.color = color;
        btn.addEventListener("click", function () {
          joinColorDiv
            .querySelectorAll(".global-color-option")
            .forEach((s) => s.classList.remove("selected"));
          btn.classList.add("selected");
          localPlayerColor = color;
        });
        joinColorDiv.appendChild(btn);
      });

      // Oda Oluştur
      document.getElementById("create-room-btn").addEventListener("click", createRoom);
      // Odaya Katıl
      document.getElementById("join-room-btn").addEventListener("click", joinRoom);

      // Bilgi Kartı Toggle
      document.getElementById("toggle-info-cards").addEventListener("click", toggleInfoCards);

      autoReconnect();
    });

    function createRoom() {
      const playerName = document.getElementById("creator-player-name").value.trim();
      const maxPlayers = parseInt(document.getElementById("max-players").value);
      if (!playerName) {
        showLocalNotification("Lütfen adınızı girin!");
        return;
      }
      if (!localPlayerColor) {
        showLocalNotification("Lütfen bir renk seçin!");
        return;
      }
      if (isNaN(maxPlayers) || maxPlayers < 2 || maxPlayers > 5) {
        showLocalNotification("Oyuncu sayısı 2 ile 5 arasında olmalıdır!");
        return;
      }
      const roomCode = generateRoomCode();
      currentRoomCode = roomCode;
      roomRef = db.ref("rooms/" + roomCode);

      const newRoomData = {
        roomCode,
        maxPlayers,
        gameState: "waiting",
        currentTurnIndex: 0,
        round: 1,
        playerOrder: [localPlayerId],
        players: {},
        countryData: {},
        createdAt: firebase.database.ServerValue.TIMESTAMP
      };
      newRoomData.players[localPlayerId] = {
        name: playerName,
        color: localPlayerColor,
        money: 1000,
        soldiers: 0,
        countries: [],
        petrol: 0,
        joinedAt: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.set(newRoomData, (error) => {
        if (error) {
          showLocalNotification("Oda oluşturulurken hata oluştu!");
        } else {
          showLocalNotification("Oda oluşturuldu. Oda Kodu: " + roomCode);
          localStorage.setItem("roomCode", roomCode);
          loadAndInitializeGeoJson();
          joinRoomAndListen();
          document.body.classList.remove("lobby");
          document.getElementById("lobby-container").style.display = "none";
          document.getElementById("game-container").style.display = "block";
          document.getElementById("display-room-code").textContent = roomCode;
        }
      });
    }

    function joinRoom() {
      const playerName = document.getElementById("join-player-name").value.trim();
      const roomCodeInput = document.getElementById("room-code").value.trim().toUpperCase();
      if (!playerName) {
        showLocalNotification("Lütfen adınızı girin!");
        return;
      }
      if (!localPlayerColor) {
        showLocalNotification("Lütfen bir renk seçin!");
        return;
      }
      if (!roomCodeInput) {
        showLocalNotification("Lütfen oda kodu girin!");
        return;
      }
      currentRoomCode = roomCodeInput;
      roomRef = db.ref("rooms/" + roomCodeInput);

      roomRef.once("value", (snapshot) => {
        if (!snapshot.exists()) {
          showLocalNotification("Böyle bir oda bulunamadı!");
          return;
        }
        const room = snapshot.val();
        if (room.gameState !== "waiting") {
          showLocalNotification("Oyun zaten başladı!");
          return;
        }
        const playerCount = Object.keys(room.players || {}).length;
        if (playerCount >= room.maxPlayers) {
          showLocalNotification("Oda dolu!");
          return;
        }
        const updates = {};
        updates["players/" + localPlayerId] = {
          name: playerName,
          color: localPlayerColor,
          money: 1000,
          soldiers: 0,
          countries: [],
          petrol: 0,
          joinedAt: firebase.database.ServerValue.TIMESTAMP
        };
        if (!room.playerOrder) room.playerOrder = [];
        room.playerOrder.push(localPlayerId);
        updates["playerOrder"] = room.playerOrder;
        roomRef.update(updates, (error) => {
          if (error) {
            showLocalNotification("Odaya katılırken hata oluştu!");
          } else {
            showLocalNotification("Odaya katıldınız!");
            localStorage.setItem("roomCode", roomCodeInput);
            joinRoomAndListen();
            document.body.classList.remove("lobby");
            document.getElementById("lobby-container").style.display = "none";
            document.getElementById("game-container").style.display = "block";
            document.getElementById("display-room-code").textContent = roomCodeInput;
          }
        });
      });
    }

    function autoReconnect() {
      const savedRoomCode = localStorage.getItem("roomCode");
      if (savedRoomCode) {
        const refCheck = db.ref("rooms/" + savedRoomCode);
        refCheck.once("value", (snapshot) => {
          if (!snapshot.exists()) return;
          const savedRoomData = snapshot.val();
          if (!savedRoomData.players || !savedRoomData.players[localPlayerId]) return;
          currentRoomCode = savedRoomCode;
          roomRef = refCheck;
          joinRoomAndListen();
          document.body.classList.remove("lobby");
          document.getElementById("lobby-container").style.display = "none";
          document.getElementById("game-container").style.display = "block";
          document.getElementById("display-room-code").textContent = savedRoomCode;
        });
      }
    }

    /*****************************************************************
     * GeoJSON & Ülke Verileri
     *****************************************************************/
    function loadAndInitializeGeoJson() {
      fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
        .then((r) => r.json())
        .then((geoJsonData) => {
          const features = geoJsonData.features;
          // Rastgele 43 ülkeye petrol
          let oilIndexes = [];
          if (features.length > 43) {
            while (oilIndexes.length < 43) {
              const randIdx = Math.floor(Math.random() * features.length);
              if (!oilIndexes.includes(randIdx)) {
                oilIndexes.push(randIdx);
              }
            }
          }
          features.forEach((f, i) => (f.properties._index = i));

          const countryDataInit = {};
          features.forEach((f) => {
            const name = f.properties.name;
            let oilProduction = 0;
            if (oilIndexes.includes(f.properties._index)) {
              oilProduction = Math.floor(Math.random() * (500 - 150 + 1)) + 150;
            }
            countryDataInit[name] = {
              income: Math.floor(Math.random() * 500) + 100,
              soldiers: 0,
              owner: null,
              barracksCount: 0,
              factories: 0,
              refineries: 0,
              oilProduction
            };
          });
          roomRef.child("countryData").set(countryDataInit);
        });
    }

    /*****************************************************************
     * Oda Verilerini Dinleme & Chat/Pakt/Ticaret
     *****************************************************************/
    function joinRoomAndListen() {
      if (!roomRef) return;

      roomRef.on("value", (snap) => {
        roomData = snap.val() || {};
        updateGameUI();
        displayPendingPactOffers();
        displayTradeOffers();
        updateChatRecipientList(); // Özel mesaj
      });

      // Chat dinleme (public + private)
      if (!chatListenerAdded) {
        roomRef.child("chat").on("child_added", (snap) => {
          const msg = snap.val();
          appendChatMessage(msg);
        });
        chatListenerAdded = true;
      }

      // Global Notifications -> Tüm oyuncular görsün
      db.ref("notifications").on("child_added", (snap) => {
        const note = snap.val();
        if (!note) return;
        // Sadece bu odaya ait mi kontrol edin
        if (note.roomCode === currentRoomCode) {
          showTopRightNotification(note.text);
        }
      });
    }

    function updateGameUI() {
      if (!roomData) return;
      // Round
      document.getElementById("current-round").textContent = roomData.round || 1;
      // Current Player
      if (roomData.playerOrder && roomData.players) {
        const cti = roomData.currentTurnIndex || 0;
        const cpid = roomData.playerOrder[cti];
        if (roomData.players[cpid]) {
          document.getElementById("current-player").textContent =
            roomData.players[cpid].name;
        }
      }
      // Oyuncu Bilgileri
      const playersInfoDiv = document.getElementById("players-info");
      if (playersInfoDiv) {
        playersInfoDiv.innerHTML = "";
        if (roomData.playerOrder) {
          roomData.playerOrder.forEach((pid) => {
            const p = roomData.players[pid];
            const div = document.createElement("div");
            div.className = "player-info";
            div.innerHTML = `
              <p><strong>${p.name}</strong></p>
              <p>Para: ${p.money}$</p>
              <p>Asker: ${p.soldiers}</p>
              <p>Ülkeler: ${(p.countries && p.countries.length) || 0}</p>
              <p>Petrol: ${p.petrol} varil</p>
            `;
            playersInfoDiv.appendChild(div);
          });
        }
      }
      // Harita
      if (map && roomData.countryData && geoJsonLayer) {
        geoJsonLayer.eachLayer((layer) => {
          const cname = layer.feature.properties.name;
          const c = roomData.countryData[cname];
          if (c) {
            if (c.owner && roomData.players && roomData.players[c.owner]) {
              layer.setStyle({
                fillColor: roomData.players[c.owner].color || "#ccc",
                fillOpacity: 0.7
              });
            } else {
              layer.setStyle({ fillColor: "#ccc", fillOpacity: 0.7 });
            }
            layer.setTooltipContent(getCountryPopupContent(cname, c));
          }
        });
      }
      updateRecipientSelects();
      updatePactRecipientSelect();
      updateTradeCountrySelect();
    }

    /*****************************************************************
     * BILDIRIM GÖSTERME (TOP-RIGHT, 6 saniye)
     *****************************************************************/
    function showTopRightNotification(message) {
      // Herkesin görebileceği
      const container = document.getElementById("notification-area");
      const div = document.createElement("div");
      div.className = "notification-popup";
      div.textContent = message;
      container.appendChild(div);

      // animasyon
      setTimeout(() => {
        div.classList.add("show");
      }, 10);

      // 6 saniye sonra kaybolsun
      setTimeout(() => {
        div.classList.remove("show");
        setTimeout(() => {
          container.removeChild(div);
        }, 500);
      }, 6000);
    }

    // Lokalde sadece kullanıcıya kısa mesaj gösterme (Lobi)
    function showLocalNotification(msg) {
      alert(msg); // Basit
    }

    /*****************************************************************
     * Info Cards Toggle
     *****************************************************************/
    function toggleInfoCards() {
      infoCardsPermanent = !infoCardsPermanent;
      updateTooltipsPermanent();
      const icon = document.querySelector("#toggle-info-cards i");
      icon.className = infoCardsPermanent ? "fas fa-eye" : "fas fa-eye-slash";
    }

    /*****************************************************************
     * ÜLKE BILGILERI
     *****************************************************************/
    function getCountryPopupContent(countryName, country) {
      if (!country) return "";
      const ownerText = country.owner && roomData.players[country.owner]
        ? roomData.players[country.owner].name
        : "Yok";

      let effectiveIncome = country.income || 0;
      if (country.factories) {
        effectiveIncome = Math.floor(effectiveIncome * (1 + 0.20 * country.factories));
      }
      const effProd = country.oilProduction
        ? Math.floor(country.oilProduction * (1 + 0.15 * (country.refineries || 0)))
        : 0;

      return `
        <div class="country-popup">
          <p><i class="fas fa-money-bill-wave"></i> Gelir: ${effectiveIncome}$</p>
          <p><i class="fas fa-users"></i> Asker: ${country.soldiers || 0}</p>
          <p><i class="fas fa-fort-awesome"></i> Kışla: ${country.barracksCount || 0}</p>
          <p><i class="fas fa-industry"></i> Fabrika: ${country.factories || 0}</p>
          <p><i class="fas fa-oil-can"></i> Rafine: ${country.refineries || 0}</p>
          <p><i class="fas fa-gas-pump"></i> Üretim: ${effProd} varil</p>
          <p><i class="fas fa-crown"></i> Sahip: ${ownerText}</p>
        </div>
      `;
    }

    function selectCountry(countryName, layer) {
      selectedCountry = countryName;
      showTopRightNotification("Seçilen ülke: " + countryName);

      layer.setStyle({ weight: 4, color: "#FF4500" });
      setTimeout(() => {
        const c = roomData.countryData && roomData.countryData[countryName];
        if (c && c.owner && roomData.players[c.owner]) {
          layer.setStyle({
            fillColor: roomData.players[c.owner].color || "#ccc",
            fillOpacity: 0.7,
            weight: 1,
            color: "#555"
          });
        } else {
          layer.setStyle({
            fillColor: "#ccc",
            fillOpacity: 0.7,
            weight: 1,
            color: "#555"
          });
        }
      }, 800);
    }

    function updateTooltipsPermanent() {
      if (!geoJsonLayer) return;
      geoJsonLayer.eachLayer((layer) => {
        layer.unbindTooltip();
        const cname = layer.feature.properties.name;
        const c = roomData.countryData ? roomData.countryData[cname] : null;
        const tooltip = getCountryPopupContent(cname, c);
        layer.bindTooltip(tooltip, {
          permanent: infoCardsPermanent,
          direction: "center",
          className: "country-popup-tooltip"
        });
      });
    }

    /*****************************************************************
     * RECIPIENT SEÇİMİ
     *****************************************************************/
    function updateRecipientSelects() {
      const moneySelect = document.getElementById("recipient-player");
      const petrolSelect = document.getElementById("recipient-player-petrol");
      if (!moneySelect || !petrolSelect) return;
      moneySelect.innerHTML = "";
      petrolSelect.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          const p = roomData.players[pid];
          const opt1 = document.createElement("option");
          opt1.value = pid;
          opt1.textContent = p.name;
          moneySelect.appendChild(opt1);

          const opt2 = document.createElement("option");
          opt2.value = pid;
          opt2.textContent = p.name;
          petrolSelect.appendChild(opt2);
        });
      }
    }

    function updatePactRecipientSelect() {
      const pactRecipientSelect = document.getElementById("pact-recipient");
      if (!pactRecipientSelect) return;
      pactRecipientSelect.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (pid !== localPlayerId) {
            const p = roomData.players[pid];
            const opt = document.createElement("option");
            opt.value = pid;
            opt.textContent = p.name;
            pactRecipientSelect.appendChild(opt);
          }
        });
      }
    }

    function updateTradeCountrySelect() {
      const tradeCountry = document.getElementById("trade-country");
      if (!tradeCountry) return;
      tradeCountry.innerHTML = "";
      if (!roomData || !roomData.players || !roomData.players[localPlayerId]) return;
      const myCountries = roomData.players[localPlayerId].countries || [];
      myCountries.forEach((cName) => {
        const opt = document.createElement("option");
        opt.value = cName;
        opt.textContent = cName;
        tradeCountry.appendChild(opt);
      });
    }

    /*****************************************************************
     * CHAT - ÖZEL MESAJ
     *****************************************************************/
    function updateChatRecipientList() {
      const chatRecipient = document.getElementById("chat-recipient");
      if (!chatRecipient) return;
      chatRecipient.innerHTML = "";

      // "all" => herkese açık
      const optAll = document.createElement("option");
      optAll.value = "all";
      optAll.textContent = "Herkese (Genel)";
      chatRecipient.appendChild(optAll);

      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (pid !== localPlayerId) {
            const p = roomData.players[pid];
            const opt = document.createElement("option");
            opt.value = pid;
            opt.textContent = p.name;
            chatRecipient.appendChild(opt);
          }
        });
      }
    }

    document.getElementById("open-chat-btn").addEventListener("click", () => {
      document.getElementById("chat-popup").style.display = "flex";
      chatOpen = true;
      // unreadMessages -> 0
      unreadMessages = 0;
      updateChatBadge();
    });
    document.getElementById("close-chat-btn").addEventListener("click", () => {
      document.getElementById("chat-popup").style.display = "none";
      chatOpen = false;
    });
    document.getElementById("send-chat-btn").addEventListener("click", sendChatMessage);
    document.getElementById("chat-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendChatMessage();
    });

    function sendChatMessage() {
      const input = document.getElementById("chat-input");
      const text = input.value.trim();
      if (!text || !roomRef) return;

      let senderName = "Anon";
      if (roomData && roomData.players && roomData.players[localPlayerId]) {
        senderName = roomData.players[localPlayerId].name;
      }
      const recipient = document.getElementById("chat-recipient").value; // "all" veya playerId

      const msg = {
        senderId: localPlayerId,
        senderName,
        recipientId: recipient,
        text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.child("chat").push(msg, (err) => {
        if (!err) input.value = "";
      });
    }

    function appendChatMessage(msg) {
      // Filtre -> eğer msg.recipientId === "all" ise herkes görebilir.
      // Veya msg.recipientId === localPlayerId, ya da msg.senderId === localPlayerId.
      const isPublic = msg.recipientId === "all";
      const isMe = msg.senderId === localPlayerId;
      const isMineOrAddressedToMe =
        isPublic || isMe || msg.recipientId === localPlayerId;

      if (!isMineOrAddressedToMe) return;

      const chatDiv = document.getElementById("chat-messages");
      const d = document.createElement("div");
      const prefix = msg.recipientId === "all"
        ? ""
        : `(Özel: ${msg.recipientId === localPlayerId ? "Bana" : "→ " + (roomData.players[msg.recipientId]?.name)}) `;
      d.textContent = `${msg.senderName}: ${prefix}${msg.text}`;
      chatDiv.appendChild(d);
      chatDiv.scrollTop = chatDiv.scrollHeight;

      if (!chatOpen && !isMe) {
        unreadMessages++;
        updateChatBadge();
      }
    }

    function updateChatBadge() {
      const btn = document.getElementById("open-chat-btn");
      if (unreadMessages > 0) {
        btn.dataset.badge = unreadMessages;
      } else {
        btn.dataset.badge = "";
      }
    }

    /*****************************************************************
     * GLOBAL NOTIFICATION (Firebase) GÖNDER
     *****************************************************************/
    function sendGlobalNotification(message) {
      // notifications altına bir obje
      db.ref("notifications").push({
        roomCode: currentRoomCode,
        text: message,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }

    /*****************************************************************
     * PAKT
     *****************************************************************/
    document.getElementById("send-pact-btn").addEventListener("click", sendPactOffer);
    function sendPactOffer() {
      if (!isMyTurn()) {
        sendGlobalNotification("Sıranız değil!");
        return;
      }
      const turns = parseInt(document.getElementById("pact-turns").value);
      const cost = parseInt(document.getElementById("pact-cost").value);
      const recipient = document.getElementById("pact-recipient").value;
      if (isNaN(turns) || turns <= 0 || isNaN(cost) || cost <= 0) {
        sendGlobalNotification("Geçerli tur ve ücret girin!");
        return;
      }
      if (!recipient || recipient === localPlayerId) {
        sendGlobalNotification("Geçerli bir alıcı seçin!");
        return;
      }
      const cti = roomData.currentTurnIndex || 0;
      const cpid = roomData.playerOrder[cti];
      const senderData = roomData.players[cpid];
      if (senderData.money < cost) {
        sendGlobalNotification("Bu teklifi yapmak için yeterli paranız yok!");
        return;
      }
      const refPact = roomRef.child("pactOffers").push();
      const offer = {
        offerId: refPact.key,
        senderId: cpid,
        senderName: senderData.name,
        recipientId: recipient,
        turns,
        cost,
        status: "pending",
        createdRound: roomData.round || 1
      };
      refPact.set(offer);

      // Chat veya Notification
      sendGlobalNotification(
        `Pakt Teklifi: ${senderData.name} -> ${roomData.players[recipient].name} (${turns} tur, ${cost} $)`
      );
    }

    function displayPendingPactOffers() {
      const cont = document.getElementById("pact-offers-list");
      if (!cont) return;
      cont.innerHTML = "";
      if (!roomData || !roomData.pactOffers) {
        document.getElementById("pact-offers-container").style.display = "none";
        return;
      }
      let hasOffer = false;
      Object.values(roomData.pactOffers).forEach((offer) => {
        if (offer.recipientId === localPlayerId && offer.status === "pending") {
          hasOffer = true;
          const div = document.createElement("div");
          div.className = "pact-offer-item";
          div.innerHTML = `
            <p><strong>${offer.senderName}</strong> (${offer.turns} tur, ${offer.cost} $)</p>
            <button class="accept-btn">Kabul</button>
            <button class="reject-btn">Reddet</button>
          `;
          div.querySelector(".accept-btn").addEventListener("click", () => {
            acceptPactOffer(offer.offerId);
          });
          div.querySelector(".reject-btn").addEventListener("click", () => {
            rejectPactOffer(offer.offerId);
          });
          cont.appendChild(div);
        }
      });
      document.getElementById("pact-offers-container").style.display = hasOffer
        ? "block"
        : "none";
    }

    function acceptPactOffer(offerId) {
      const offer = roomData.pactOffers[offerId];
      if (!offer || offer.status !== "pending") return;

      const cround = roomData.round || 1;
      const endRound = cround + offer.turns - 1;

      const senderData = roomData.players[offer.senderId];
      const recData = roomData.players[offer.recipientId];
      if (!senderData || !recData) return;
      if (senderData.money < offer.cost) {
        sendGlobalNotification("Teklifi yapanın yeterli parası kalmadı.");
        roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
        return;
      }
      const ups = {};
      ups[`pactOffers/${offerId}/status`] = "accepted";
      ups[`players/${offer.senderId}/money`] = senderData.money - offer.cost;
      ups[`players/${offer.recipientId}/money`] = recData.money + offer.cost;

      if (!roomData.pacts) ups["pacts"] = {};
      ups[`pacts/${offerId}`] = {
        players: [offer.senderId, offer.recipientId],
        endRound
      };
      roomRef.update(ups);

      sendGlobalNotification(
        `Pakt Kabul: ${senderData.name} + ${recData.name} (${offer.turns} tur, ${offer.cost} $)`
      );
    }

    function rejectPactOffer(offerId) {
      const offer = roomData.pactOffers[offerId];
      if (!offer || offer.status !== "pending") return;
      roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
      sendGlobalNotification("Pakt Reddedildi.");
    }

    /*****************************************************************
     * OYUN İŞLEVLERİ (Saldırı, Bina, Kaynak, vs.)
     * -> Her önemli olayda sendGlobalNotification
     *****************************************************************/
    document.getElementById("attack-btn").addEventListener("click", attack);
    function attack() {
      if (!isMyTurn()) {
        sendGlobalNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        sendGlobalNotification("Bir ülke seçin!");
        return;
      }
      const soldiersToSend = parseInt(document.getElementById("attack-soldiers").value);
      if (isNaN(soldiersToSend) || soldiersToSend <= 0) {
        sendGlobalNotification("Geçerli asker sayısı girin!");
        return;
      }
      const cti = roomData.currentTurnIndex || 0;
      const cpid = roomData.playerOrder[cti];
      const cpd = roomData.players[cpid];
      if (soldiersToSend > cpd.soldiers) {
        sendGlobalNotification("Yeterli askeriniz yok!");
        return;
      }
      const target = roomData.countryData[selectedCountry];
      if (!target) return;
      if (target.owner && target.owner !== cpid) {
        if (hasActivePact(cpid, target.owner)) {
          sendGlobalNotification("Bu oyuncu ile saldırmazlık paktınız var!");
          return;
        }
      }
      const ups = {};
      if (target.owner === cpid) {
        ups[`countryData/${selectedCountry}/soldiers`] = target.soldiers + soldiersToSend;
        ups[`players/${cpid}/soldiers`] = cpd.soldiers - soldiersToSend;
        sendGlobalNotification(`${selectedCountry} ülkesine ${soldiersToSend} asker gönderildi.`);
      } else {
        ups[`players/${cpid}/soldiers`] = cpd.soldiers - soldiersToSend;
        if (soldiersToSend > target.soldiers) {
          const rem = soldiersToSend - target.soldiers;
          ups[`countryData/${selectedCountry}/soldiers`] = rem;
          ups[`countryData/${selectedCountry}/owner`] = cpid;
          let cCountries = cpd.countries || [];
          if (!cCountries.includes(selectedCountry)) cCountries.push(selectedCountry);
          ups[`players/${cpid}/countries`] = cCountries;

          if (target.owner && roomData.players[target.owner]) {
            let defC = roomData.players[target.owner].countries || [];
            defC = defC.filter((c) => c !== selectedCountry);
            ups[`players/${target.owner}/countries`] = defC;
          }
          sendGlobalNotification(`${selectedCountry} fethedildi!`);
        } else {
          ups[`countryData/${selectedCountry}/soldiers`] = target.soldiers - soldiersToSend;
          sendGlobalNotification(`${selectedCountry} savunuldu!`);
        }
        nextTurn();
      }
      roomRef.update(ups);
    }

    document.getElementById("buy-soldiers-btn").addEventListener("click", buySoldiers);
    function buySoldiers() {
      if (!isMyTurn()) {
        sendGlobalNotification("Sıranız değil!");
        return;
      }
      const count = parseInt(document.getElementById("soldiers-to-buy").value);
      if (isNaN(count) || count <= 0) {
        sendGlobalNotification("Geçerli asker sayısı girin!");
        return;
      }
      const cost = count * 10;
      const cti = roomData.currentTurnIndex || 0;
      const cpid = roomData.playerOrder[cti];
      const cpd = roomData.players[cpid];
      if (cpd.money < cost) {
        sendGlobalNotification("Yeterli paranız yok!");
        return;
      }
      const ups = {};
      ups[`players/${cpid}/money`] = cpd.money - cost;
      ups[`players/${cpid}/soldiers`] = cpd.soldiers + count;
      roomRef.update(ups);
      sendGlobalNotification(`${count} asker satın alındı.`);
    }

    document.getElementById("pull-soldiers-btn").addEventListener("click", pullSoldiers);
    function pullSoldiers() {
      if (!isMyTurn()) {
        sendGlobalNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        sendGlobalNotification("Bir ülke seçin!");
        return;
      }
      const cti = roomData.currentTurnIndex || 0;
      const cpid = roomData.playerOrder[cti];
      const target = roomData.countryData[selectedCountry];
      if (!target || target.owner !== cpid) {
        sendGlobalNotification("Bu ülke size ait değil!");
        return;
      }
      const count = parseInt(document.getElementById("pull-soldiers-count").value);
      if (isNaN(count) || count <= 0) {
        sendGlobalNotification("Geçerli asker sayısı girin!");
        return;
      }
      if (target.soldiers < count) {
        sendGlobalNotification("Ülkede yeterli asker yok!");
        return;
      }
      const ups = {};
      ups[`countryData/${selectedCountry}/soldiers`] = target.soldiers - count;
      ups[`players/${cpid}/soldiers`] = roomData.players[cpid].soldiers + count;
      roomRef.update(ups);
      sendGlobalNotification(`${selectedCountry} ülkesinden ${count} asker çekildi.`);
    }

    document.getElementById("buy-barracks-btn").addEventListener("click", buyBarracks);
    function buyBarracks() {
      if (!isMyTurn()) {
        sendGlobalNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        sendGlobalNotification("Bir ülke seçin!");
        return;
      }
      const q = parseInt(document.getElementById("barracks-quantity").value);
      if (isNaN(q) || q <= 0) {
        sendGlobalNotification("Geçerli kışla adedi girin!");
        return;
      }
      const cti = roomData.currentTurnIndex || 0;
      const cpid = roomData.playerOrder[cti];
      const cpd = roomData.players[cpid];
      const t = roomData.countryData[selectedCountry];
      if (!t || t.owner !== cpid) {
        sendGlobalNotification("Bu ülke size ait değil!");
        return;
      }
      const totalMoney = 130 * q;
      const totalPetrol = 40 * q;
      if (cpd.money < totalMoney) {
        sendGlobalNotification("Yeterli paranız yok!");
        return;
      }
      if (cpd.petrol < totalPetrol) {
        sendGlobalNotification("Yeterli petrol yok!");
        return;
      }
      const ups = {};
      ups[`players/${cpid}/money`] = cpd.money - totalMoney;
      ups[`players/${cpid}/petrol`] = cpd.petrol - totalPetrol;
      ups[`countryData/${selectedCountry}/barracksCount`] = (t.barracksCount || 0) + q;
      roomRef.update(ups);
      sendGlobalNotification(`${q} adet kışla kuruldu.`);
    }

    document.getElementById("build-factory-btn").addEventListener("click", buildFactory);
    function buildFactory() {
      if (!isMyTurn()) {
        sendGlobalNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        sendGlobalNotification("Bir ülke seçin!");
        return;
      }
      const q = parseInt(document.getElementById("factory-quantity").value);
      if (isNaN(q) || q <= 0) {
        sendGlobalNotification("Geçerli fabrika adedi girin!");
        return;
      }
      const cti = roomData.currentTurnIndex || 0;
      const cpid = roomData.playerOrder[cti];
      const cpd = roomData.players[cpid];
      const t = roomData.countryData[selectedCountry];
      if (!t || t.owner !== cpid) {
        sendGlobalNotification("Bu ülke size ait değil!");
        return;
      }
      const totalMoney = 250 * q;
      const totalPetrol = 90 * q;
      if (cpd.money < totalMoney) {
        sendGlobalNotification("Yeterli paranız yok!");
        return;
      }
      if (cpd.petrol < totalPetrol) {
        sendGlobalNotification("Yeterli petrol yok!");
        return;
      }
      const ups = {};
      ups[`players/${cpid}/money`] = cpd.money - totalMoney;
      ups[`players/${cpid}/petrol`] = cpd.petrol - totalPetrol;
      ups[`countryData/${selectedCountry}/factories`] = (t.factories || 0) + q;
      roomRef.update(ups);
      sendGlobalNotification(`${q} adet fabrika kuruldu.`);
    }

    document.getElementById("build-refinery-btn").addEventListener("click", buildRefinery);
    function buildRefinery() {
      if (!isMyTurn()) {
        sendGlobalNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        sendGlobalNotification("Bir ülke seçin!");
        return;
      }
      const q = parseInt(document.getElementById("refinery-quantity").value);
      if (isNaN(q) || q <= 0) {
        sendGlobalNotification("Geçerli rafine adedi girin!");
        return;
      }
      const cti = roomData.currentTurnIndex || 0;
      const cpid = roomData.playerOrder[cti];
      const cpd = roomData.players[cpid];
      const t = roomData.countryData[selectedCountry];
      if (!t.oilProduction) {
        sendGlobalNotification("Bu ülkede petrol üretimi yok!");
        return;
      }
      const totalMoney = 800 * q;
      const totalPetrol = 250 * q;
      if (cpd.money < totalMoney) {
        sendGlobalNotification("Yeterli paranız yok!");
        return;
      }
      if (cpd.petrol < totalPetrol) {
        sendGlobalNotification("Yeterli petrol yok!");
        return;
      }
      const ups = {};
      ups[`players/${cpid}/money`] = cpd.money - totalMoney;
      ups[`players/${cpid}/petrol`] = cpd.petrol - totalPetrol;
      ups[`countryData/${selectedCountry}/refineries`] = (t.refineries || 0) + q;
      roomRef.update(ups);
      sendGlobalNotification(`${q} adet rafine kuruldu. Üretim kapasitesi arttı.`);
    }

    document.getElementById("send-money-btn").addEventListener("click", sendMoney);
    function sendMoney() {
      if (!isMyTurn()) {
        sendGlobalNotification("Sıranız değil!");
        return;
      }
      const amt = parseInt(document.getElementById("money-to-send").value);
      const rec = document.getElementById("recipient-player").value;
      if (isNaN(amt) || amt <= 0) {
        sendGlobalNotification("Geçerli miktar girin!");
        return;
      }
      const cti = roomData.currentTurnIndex || 0;
      const cpid = roomData.playerOrder[cti];
      const cpd = roomData.players[cpid];
      if (cpd.money < amt) {
        sendGlobalNotification("Yeterli paranız yok!");
        return;
      }
      if (rec === cpid) {
        sendGlobalNotification("Kendinize para gönderemezsiniz!");
        return;
      }
      const ups = {};
      ups[`players/${cpid}/money`] = cpd.money - amt;
      ups[`players/${rec}/money`] = roomData.players[rec].money + amt;
      roomRef.update(ups);
      sendGlobalNotification(`${amt}$, ${roomData.players[rec].name} adlı oyuncuya gönderildi.`);
    }

    document.getElementById("send-petrol-btn").addEventListener("click", sendPetrol);
    function sendPetrol() {
      if (!isMyTurn()) {
        sendGlobalNotification("Sıranız değil!");
        return;
      }
      const amt = parseInt(document.getElementById("petrol-to-send").value);
      const rec = document.getElementById("recipient-player-petrol").value;
      if (isNaN(amt) || amt <= 0) {
        sendGlobalNotification("Geçerli miktar girin!");
        return;
      }
      const cti = roomData.currentTurnIndex || 0;
      const cpid = roomData.playerOrder[cti];
      const cpd = roomData.players[cpid];
      if (cpd.petrol < amt) {
        sendGlobalNotification("Yeterli petrol yok!");
        return;
      }
      if (rec === cpid) {
        sendGlobalNotification("Kendinize petrol gönderemezsiniz!");
        return;
      }
      const ups = {};
      ups[`players/${cpid}/petrol`] = cpd.petrol - amt;
      ups[`players/${rec}/petrol`] = roomData.players[rec].petrol + amt;
      roomRef.update(ups);
      sendGlobalNotification(`${amt} varil petrol, ${roomData.players[rec].name} oyuncusuna gönderildi.`);
    }

    document.getElementById("end-turn-btn").addEventListener("click", nextTurn);
    function nextTurn() {
      if (!isMyTurn()) {
        sendGlobalNotification("Sıranız değil!");
        return;
      }
      const cti = roomData.currentTurnIndex || 0;
      const cpid = roomData.playerOrder[cti];
      const p = roomData.players[cpid];
      const ups = {};

      // Gelir & Petrol
      if (p.countries && roomData.countryData) {
        let totalMoney = 0;
        let totalPetrol = 0;
        p.countries.forEach((cName) => {
          const c = roomData.countryData[cName];
          if (c) {
            // Kışla => +5 asker
            if (c.barracksCount) {
              ups[`countryData/${cName}/soldiers`] = (c.soldiers || 0) + 5 * c.barracksCount;
            }
            // Fabrika => +%20
            let effInc = c.income || 0;
            if (c.factories) {
              effInc = Math.floor(effInc * (1 + 0.20 * c.factories));
            }
            totalMoney += effInc;

            // Rafine => +%15
            if (c.oilProduction) {
              const effProd = Math.floor(
                c.oilProduction * (1 + 0.15 * (c.refineries || 0))
              );
              totalPetrol += effProd;
            }
          }
        });
        ups[`players/${cpid}/money`] = p.money + totalMoney;
        ups[`players/${cpid}/petrol`] = p.petrol + totalPetrol;
      }

      let newIndex = cti + 1;
      if (newIndex >= roomData.playerOrder.length) {
        newIndex = 0;
        ups["round"] = (roomData.round || 1) + 1;
      }
      ups["currentTurnIndex"] = newIndex;
      roomRef.update(ups);

      const nextId = roomData.playerOrder[newIndex];
      sendGlobalNotification(`Sıra ${roomData.players[nextId].name} adlı oyuncuya geçti.`);
    }

    /*****************************************************************
     * TİCARET (MARKET)
     *****************************************************************/
    document.getElementById("create-trade-offer-btn").addEventListener("click", createTradeOffer);
    function createTradeOffer() {
      if (!roomData || !roomData.players[localPlayerId]) return;
      const itemType = document.getElementById("trade-item-type").value;
      const quantity = parseInt(document.getElementById("trade-quantity").value);
      const price = parseInt(document.getElementById("trade-price").value);
      const tradeCountry = document.getElementById("trade-country");
      let countryName = null;
      if (itemType !== "petrol") {
        countryName = tradeCountry.value;
      }
      if (isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
        sendGlobalNotification("Geçerli adet/fiyat girin!");
        return;
      }

      const seller = roomData.players[localPlayerId];
      if (itemType === "petrol") {
        if (seller.petrol < quantity) {
          sendGlobalNotification("Yeterli petrol yok!");
          return;
        }
      } else {
        if (!countryName) {
          sendGlobalNotification("Satmak istediğiniz ülkeyi seçin!");
          return;
        }
        const c = roomData.countryData[countryName];
        if (!c || c.owner !== localPlayerId) {
          sendGlobalNotification("Bu ülke size ait değil!");
          return;
        }
        let enough = false;
        if (itemType === "barracks" && c.barracksCount >= quantity) enough = true;
        else if (itemType === "factory" && c.factories >= quantity) enough = true;
        else if (itemType === "refinery" && c.refineries >= quantity) enough = true;
        if (!enough) {
          sendGlobalNotification("Yeterli miktarda yapı yok!");
          return;
        }
      }

      const refTrade = roomRef.child("tradeOffers").push();
      const newOffer = {
        offerId: refTrade.key,
        sellerId: localPlayerId,
        sellerName: seller.name,
        itemType,
        countryName,
        quantity,
        price,
        status: "pending"
      };
      refTrade.set(newOffer);
      sendGlobalNotification("Ticaret teklifi oluşturuldu.");
    }

    function displayTradeOffers() {
      const list = document.getElementById("trade-offers-list");
      if (!list) return;
      list.innerHTML = "";
      if (!roomData || !roomData.tradeOffers) return;

      Object.values(roomData.tradeOffers).forEach((offer) => {
        if (offer.status === "pending") {
          const div = document.createElement("div");
          div.className = "offer-item";
          let itemLabel = "";
          if (offer.itemType === "petrol") itemLabel = "Petrol";
          else if (offer.itemType === "barracks") itemLabel = "Kışla";
          else if (offer.itemType === "factory") itemLabel = "Fabrika";
          else if (offer.itemType === "refinery") itemLabel = "Rafine";

          let html = `
            <p><strong>Satıcı:</strong> ${offer.sellerName}</p>
            <p><strong>Ürün:</strong> ${itemLabel}</p>
            <p><strong>Adet/Varil:</strong> ${offer.quantity}</p>
            <p><strong>Birim Fiyat:</strong> ${offer.price} $</p>
          `;
          if (offer.countryName) {
            html += `<p><strong>Ülke:</strong> ${offer.countryName}</p>`;
          }
          div.innerHTML = html;

          if (offer.sellerId !== localPlayerId) {
            const btnAccept = document.createElement("button");
            btnAccept.textContent = "Kabul Et";
            btnAccept.addEventListener("click", () => acceptTradeOffer(offer.offerId));
            div.appendChild(btnAccept);
          } else {
            const btnCancel = document.createElement("button");
            btnCancel.style.background = "linear-gradient(45deg, #c0392b, #e74c3c)";
            btnCancel.textContent = "İptal";
            btnCancel.addEventListener("click", () => cancelTradeOffer(offer.offerId));
            div.appendChild(btnCancel);
          }
          list.appendChild(div);
        }
      });
    }

    function acceptTradeOffer(offerId) {
      if (!roomData || !roomData.tradeOffers || !roomData.tradeOffers[offerId]) return;
      const offer = roomData.tradeOffers[offerId];
      if (offer.status !== "pending") {
        sendGlobalNotification("Bu teklif geçerli değil!");
        return;
      }
      const seller = roomData.players[offer.sellerId];
      const buyer = roomData.players[localPlayerId];
      const totalCost = offer.price * offer.quantity;
      if (buyer.money < totalCost) {
        sendGlobalNotification("Yeterli paranız yok!");
        return;
      }
      // Kaynak kontrol
      if (offer.itemType === "petrol") {
        if (seller.petrol < offer.quantity) {
          sendGlobalNotification("Satıcının yeterli petrolü yok!");
          return;
        }
      } else {
        const c = roomData.countryData[offer.countryName];
        if (!c || c.owner !== offer.sellerId) {
          sendGlobalNotification("Satıcının bu ülke üzerinde hakkı yok!");
          return;
        }
        let enough = false;
        if (offer.itemType === "barracks" && c.barracksCount >= offer.quantity) enough = true;
        else if (offer.itemType === "factory" && c.factories >= offer.quantity) enough = true;
        else if (offer.itemType === "refinery" && c.refineries >= offer.quantity) enough = true;
        if (!enough) {
          sendGlobalNotification("Satıcının yeterli yapısı kalmadı!");
          return;
        }
      }
      const ups = {};
      ups[`players/${localPlayerId}/money`] = buyer.money - totalCost;
      ups[`players/${offer.sellerId}/money`] = seller.money + totalCost;
      if (offer.itemType === "petrol") {
        ups[`players/${offer.sellerId}/petrol`] = seller.petrol - offer.quantity;
        ups[`players/${localPlayerId}/petrol`] = buyer.petrol + offer.quantity;
      } else {
        const c = roomData.countryData[offer.countryName];
        if (offer.itemType === "barracks") {
          ups[`countryData/${offer.countryName}/barracksCount`] = c.barracksCount - offer.quantity;
        } else if (offer.itemType === "factory") {
          ups[`countryData/${offer.countryName}/factories`] = c.factories - offer.quantity;
        } else if (offer.itemType === "refinery") {
          ups[`countryData/${offer.countryName}/refineries`] = c.refineries - offer.quantity;
        }
      }
      ups[`tradeOffers/${offerId}/status`] = "completed";

      roomRef.update(ups, (err) => {
        if (!err) {
          sendGlobalNotification(`Ticaret Gerçekleşti: ${seller.name} -> ${buyer.name}, ${offer.quantity} x ${offer.itemType}`);
        }
      });
    }

    function cancelTradeOffer(offerId) {
      const offer = roomData.tradeOffers[offerId];
      if (!offer || offer.sellerId !== localPlayerId) return;
      if (offer.status !== "pending") return;
      roomRef.child("tradeOffers").child(offerId).update({ status: "cancelled" });
      sendGlobalNotification("Teklif iptal edildi.");
    }

    /*****************************************************************
     * DİĞER
     *****************************************************************/
    function isMyTurn() {
      if (!roomData || !roomData.playerOrder) return false;
      const cti = roomData.currentTurnIndex || 0;
      return roomData.playerOrder[cti] === localPlayerId;
    }
    function hasActivePact(a, b) {
      if (!roomData || !roomData.pacts) return false;
      const r = roomData.round || 1;
      for (let id in roomData.pacts) {
        const pk = roomData.pacts[id];
        if (pk.players && pk.players.includes(a) && pk.players.includes(b)) {
          if (r <= pk.endRound) return true;
        }
      }
      return false;
    }
    function generateRoomCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Odan Çık
    document.getElementById("exit-room-btn").addEventListener("click", () => {
      document.getElementById("game-container").style.display = "none";
      document.getElementById("lobby-container").style.display = "block";
      document.body.classList.add("lobby");
    });

    /*****************************************************************
     * HARİTA (Leaflet) KURULUM
     *****************************************************************/
    function initializeMap() {
      if (map) return;
      map = L.map("map").setView([20, 0], 2);
      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 12,
          attribution:
            'Tiles &copy; Esri &mdash; Source: Esri, GEBCO, NOAA, National Geographic, DeLorme, HERE, Geonames.org ' +
            'and other contributors'
        }
      ).addTo(map);

      fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
        .then((res) => res.json())
        .then((data) => {
          geoJsonLayer = L.geoJson(data, {
            style: () => ({
              color: "#555",
              weight: 1,
              fillColor: "#ccc",
              fillOpacity: 0.7
            }),
            onEachFeature: (f, layer) => {
              const cname = f.properties.name;
              layer.bindTooltip(
                getCountryPopupContent(
                  cname,
                  roomData && roomData.countryData ? roomData.countryData[cname] : {}
                ),
                {
                  permanent: infoCardsPermanent,
                  direction: "center",
                  className: "country-popup-tooltip"
                }
              );
              layer.on("click", () => selectCountry(cname, layer));
            }
          }).addTo(map);
        });
    }
    const observer = new MutationObserver(() => {
      const gc = document.getElementById("game-container");
      if (gc.style.display !== "none") {
        initializeMap();
      }
    });
    observer.observe(document.getElementById("game-container"), {
      attributes: true,
      attributeFilter: ["style"]
    });
  </script>
</body>
</html>
