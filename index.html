<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <!-- Mobil cihazlarda uygun ölçeklendirme ve görünüm için -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Global Conquest - Online</title>

  <!-- Google Fonts: Cinzel (askeri, dramatik his için) -->
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap"
    rel="stylesheet"
  />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <!-- FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- Animate.css -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
  />

  <style>
    /**********************************************************
     * GENEL SIFIRLAMA & GLOBAL AYARLAR
     **********************************************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Cinzel", serif;
      color: #eee;
      overflow-x: hidden;
      transition: background 0.5s;
    }
    a {
      text-decoration: none;
      color: inherit;
    }

    /**********************************************************
     * LOBI SAYFASI TASARIMI (OKYANUS TEMASI)
     **********************************************************/
    body.lobby {
      background: linear-gradient(180deg, #0a1f44 0%, #0b2a63 35%, #0b3553 100%);
      background-attachment: fixed;
      background-size: cover;
    }

    #lobby-container {
      max-width: 500px;
      margin: 60px auto;
      padding: 30px;
      background: rgba(0, 0, 0, 0.65);
      border: 2px solid #1abc9c;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      animation: fadeInLobby 1s ease forwards;
    }
    @keyframes fadeInLobby {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #lobby-container h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #1abc9c;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: 38px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
      animation: animateTitle 1s ease;
    }
    @keyframes animateTitle {
      0% {
        letter-spacing: 8px;
        opacity: 0;
      }
      100% {
        letter-spacing: 3px;
        opacity: 1;
      }
    }

    #lobby-container h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #aef7f2;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 24px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
    }

    #lobby-container input[type="text"],
    #lobby-container input[type="number"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #1abc9c;
      border-radius: 4px;
      font-size: 16px;
      outline: none;
      color: #333;
      transition: box-shadow 0.3s;
    }
    #lobby-container input[type="text"]:focus,
    #lobby-container input[type="number"]:focus {
      box-shadow: 0 0 8px #1abc9c;
    }

    #lobby-container button {
      width: 100%;
      padding: 14px;
      margin-bottom: 15px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: 1px solid #16a085;
      border-radius: 6px;
      font-size: 18px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.7);
      transition: background 0.3s, transform 0.3s;
    }
    #lobby-container button:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
      transform: scale(1.02);
    }

    .color-options {
      margin-bottom: 15px;
      text-align: center;
    }
    .global-color-option {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      display: inline-block;
      margin: 0 5px;
      transition: transform 0.3s, border-color 0.3s;
    }
    .global-color-option:hover {
      transform: scale(1.2);
      border-color: #fff;
    }
    .global-color-option.selected {
      border-color: #f1c40f;
    }

    /**********************************************************
     * BİLDİRİM ALANI (POPUP) - 6s EKRANDA KALAN
     **********************************************************/
    #notification-area {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .notification-item {
      min-width: 200px;
      max-width: 350px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
      font-size: 16px;
      line-height: 1.4;
      opacity: 0;
      transform: translateX(100%);
      animation: slideIn 0.5s forwards, fadeOut 0.5s 5.5s forwards;
    }
    @keyframes slideIn {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /**********************************************************
     * OYUN EKRANI STİLLERİ
     **********************************************************/
    #game-container {
      display: none;
      height: 100vh;
      background: linear-gradient(180deg, #0b2a63 0%, #0a1f44 100%);
      position: relative;
    }

    /* Harita Alanı */
    #map-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
      background-color: #0e2740;
    }

    /* Bilgi Kartları Toggle Butonu */
    .toggle-info-cards {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1100;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
    }

    /**********************************************************
     * ÜST BİLGİ (TUR, ODA KODU, SIRA) + BAŞLAT BUTONU
     **********************************************************/
    #top-info {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3000;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    #top-info p {
      margin: 0;
      font-size: 16px;
    }
    #top-info p span {
      font-weight: 600;
      color: #f39c12;
    }
    #end-turn-btn {
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #end-turn-btn:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }

    /* 60 saniyelik sayaç (estetik) */
    #turn-timer {
      font-size: 14px;
      color: #f39c12;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* OYUNU BAŞLAT BUTONU + SAYIM GÖSTERGELERİ */
    #start-game-btn {
      background: linear-gradient(45deg, #2ecc71, #27ae60);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.3s;
      display: none; /* Sadece host görecek */
    }
    #start-game-btn:hover {
      background: linear-gradient(45deg, #27ae60, #2ecc71);
    }
    #start-countdown {
      font-size: 16px;
      color: #f39c12;
      display: none;
    }

    /**********************************************************
     * ALT BİLDİRGELER (CHAT, MARKET, vs.) ve DİĞER İKONLAR
     **********************************************************/
    #bottom-icons {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 3000;
    }
    .bottom-icon-btn {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      transition: transform 0.3s, background 0.3s;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .bottom-icon-btn:hover {
      transform: scale(1.05);
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }
    /* Chat Badge (Bildirim sayısı) */
    .bottom-icon-btn[data-badge]:after {
      content: attr(data-badge);
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      border-radius: 50%;
      min-width: 20px;
      min-height: 20px;
      padding: 2px 6px;
      text-align: center;
      font-size: 12px;
      pointer-events: none;
    }

    /* Odadan Çık Butonu (Sağ Alt) */
    #exit-room-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(45deg, #c0392b, #e74c3c);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.3s;
      z-index: 3000;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
    #exit-room-btn:hover {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
    }

    /**********************************************************
     * LEAFLET TOOLTIP & ÜLKE POPUP
     **********************************************************/
    .leaflet-tooltip {
      background: transparent;
      border: none;
    }
    .country-popup-tooltip {
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /**********************************************************
     * GENEL POPUP TASARIMI (Modern & Daha Büyük)
     **********************************************************/
    .modern-popup {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 450px;
      max-height: 70vh;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: none;
      flex-direction: column;
      z-index: 3002;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      animation: fadeInPopup 0.5s ease forwards;
    }
    @keyframes fadeInPopup {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modern-popup .popup-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      cursor: pointer;
    }
    .modern-popup .popup-header button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .modern-popup .popup-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      font-size: 15px;
    }
    .modern-popup .popup-content h3 {
      font-size: 18px;
      color: #1abc9c;
      margin-bottom: 10px;
    }
    .modern-popup .popup-content input[type="number"],
    .modern-popup .popup-content select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #1abc9c;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
    }
    .modern-popup .popup-content button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      border-radius: 6px;
      font-size: 16px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }
    .modern-popup .popup-content button:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }

    /**********************************************************
     * CHAT POPUP (GENEL + ÖZEL)
     **********************************************************/
    .chat-popup {
      width: 450px;
      max-height: 70vh;
      display: none;
      flex-direction: column;
      z-index: 3001;
    }
    .chat-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      cursor: pointer;
    }
    .chat-header button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.3);
      color: #eee;
      font-size: 15px;
    }
    .chat-input-container {
      display: flex;
      border-top: 1px solid #444;
    }
    .chat-input-container input[type="text"] {
      flex: 1;
      padding: 15px;
      border: none;
      outline: none;
      background: #1e1e2f;
      color: #eee;
      font-size: 15px;
    }
    .chat-input-container button {
      padding: 15px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      cursor: pointer;
      color: #fff;
      font-size: 18px;
    }
    .chat-private-container {
      border-top: 1px solid #444;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chat-private-container select,
    .chat-private-container input[type="text"] {
      padding: 10px;
      border: 1px solid #1abc9c;
      border-radius: 6px;
      outline: none;
      background: #1e1e2f;
      color: #eee;
      font-size: 15px;
    }
    .chat-private-container button {
      padding: 10px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      cursor: pointer;
      color: #fff;
      align-self: flex-end;
      font-size: 16px;
    }

    /**********************************************************
     * PAKT POPUP
     **********************************************************/
    #pact-popup {
      width: 450px;
      max-height: 70vh;
      display: none;
      flex-direction: column;
      z-index: 3002;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      animation: fadeInPopup 0.5s ease forwards;
    }
    #pact-popup-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      cursor: pointer;
    }
    #pact-popup .popup-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      font-size: 15px;
      background: rgba(0, 0, 0, 0.3);
    }
    #pact-popup .popup-content h3 {
      margin-bottom: 10px;
      color: #1abc9c;
    }
    .pact-offer-item {
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .pact-offer-item button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .pact-offer-item .accept-btn {
      background: linear-gradient(45deg, #27ae60, #2ecc71);
      color: #fff;
    }
    .pact-offer-item .reject-btn {
      background: linear-gradient(45deg, #c0392b, #e74c3c);
      color: #fff;
    }
    .active-pact-item {
      background: rgba(0, 0, 0, 0.45);
      padding: 8px;
      border-radius: 5px;
      margin-bottom: 8px;
    }

    /**********************************************************
     * TİCARET POPUP
     **********************************************************/
    .market-popup {
      width: 500px;
      max-height: 70vh;
      display: none;
      flex-direction: column;
      z-index: 3002;
      animation: fadeInPopup 0.5s ease forwards;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
    }
    .market-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
    }
    .market-header button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .market-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      background: rgba(0, 0, 0, 0.3);
    }
    .market-section {
      margin-bottom: 20px;
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    .market-section h3 {
      font-size: 17px;
      margin-bottom: 10px;
      color: #1abc9c;
    }
    .offer-item {
      background: rgba(0, 0, 0, 0.4);
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /**********************************************************
     * OYUNCULAR POPUP (SOL TARAFTA AÇILSIN)
     **********************************************************/
    #players-popup {
      position: fixed;
      bottom: 80px;
      left: 20px;
      width: 450px;
      max-height: 70vh;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: none;
      flex-direction: column;
      z-index: 3002;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      animation: fadeInPopup 0.5s ease forwards;
    }
    #players-popup .popup-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
    }
    #players-popup .popup-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      font-size: 15px;
      background: rgba(0, 0, 0, 0.3);
    }
    #players-popup .popup-content .player-info {
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      font-size: 15px;
    }
    #players-popup .popup-content .player-info p {
      margin: 4px 0;
      color: #ddd;
    }

    /**********************************************************
     * RESPONSIVE (MOBİL) TASARIM
     **********************************************************/
    @media screen and (max-width: 768px) {
      /* LOBİ */
      #lobby-container {
        width: 90%;
        margin: 20px auto;
        padding: 20px;
      }
      #lobby-container h1 {
        font-size: 28px;
      }
      #lobby-container h2 {
        font-size: 18px;
      }

      /* ÜST BİLGİ */
      #top-info {
        width: 90%;
        padding: 8px 10px;
        gap: 5px;
        left: 50%;
        transform: translateX(-50%);
        flex-direction: column;
      }
      #top-info p {
        font-size: 14px;
      }

      /* ALT BUTONLAR */
      #bottom-icons {
        gap: 10px;
      }
      .bottom-icon-btn {
        width: 44px;
        height: 44px;
        font-size: 16px;
      }

      /* ODADAN ÇIK BUTONU */
      #exit-room-btn {
        bottom: 80px;
        right: 20px;
        font-size: 13px;
        padding: 8px 12px;
      }

      /* POPUP'LAR GENEL */
      .modern-popup,
      .chat-popup,
      .market-popup,
      #pact-popup,
      #players-popup {
        width: 90% !important;
        right: 5% !important;
        left: auto !important;
        bottom: 90px;
      }
    }
  </style>
</head>

<body class="lobby">
  <!-- ===================== LOBBY (Oda Oluşturma & Katılma) ===================== -->
  <div id="lobby-container" class="animate__animated animate__fadeIn">
    <h1>GLOBAL CONQUEST</h1>
    <!-- Oda Oluşturma -->
    <div id="create-room-section">
      <h2>Oda Oluştur</h2>
      <input type="text" id="creator-player-name" placeholder="Adınız" />
      <div class="color-options" id="creator-color-options"></div>
      <input
        type="number"
        id="max-players"
        placeholder="Oyuncu Sayısı (2-8)"
        min="2"
        max="8"
      />
      <button id="create-room-btn">Oda Oluştur</button>
    </div>
    <hr />
    <!-- Odaya Katılma -->
    <div id="join-room-section">
      <h2>Odaya Katıl</h2>
      <input type="text" id="join-player-name" placeholder="Adınız" />
      <div class="color-options" id="join-color-options"></div>
      <input
        type="text"
        id="room-code"
        placeholder="Oda Kodu (Örn: AB12CD)"
      />
      <button id="join-room-btn">Odaya Katıl</button>
    </div>
  </div>

  <!-- ===================== KISA SÜRELİ BİLDİRİMLER ALANI ===================== -->
  <div id="notification-area"></div>

  <!-- ===================== OYUN EKRANI ===================== -->
  <div id="game-container">
    <!-- Üst Bilgi (Tur, Sıra, Oda Kodu, Oyun Başlat vb.) -->
    <div id="top-info">
      <p>
        Oda Kodu: <span id="display-room-code">-</span> |
        Tur: <span id="current-round">1</span> |
        Sıra: <span id="current-player">Oyuncu Adı</span>
      </p>
      <button id="end-turn-btn">
        <i class="fas fa-forward"></i> Tur Sonu
        <span id="turn-timer">60s</span>
      </button>

      <!-- OYUNU BAŞLAT BUTONU (Sadece Kurucu Oyuncu görecek) -->
      <button id="start-game-btn">Oyunu Başlat</button>
      <!-- 30 Saniye Geri Sayım Ekranı -->
      <span id="start-countdown">30</span>
    </div>

    <!-- Harita Alanı -->
    <div id="map-container">
      <div id="map"></div>
      <!-- Bilgi Kartları Toggle Butonu -->
      <button id="toggle-info-cards" class="toggle-info-cards">
        <i class="fas fa-eye-slash"></i>
      </button>
    </div>

    <!-- Odadan Çık Butonu (Sağ Alt) -->
    <button id="exit-room-btn">Odadan Çık</button>

    <!-- Alt İkonlar (Chat, Pakt, Market, vs.) -->
    <div id="bottom-icons">
      <!-- Oyuncu Bilgileri -->
      <button id="open-players-btn" class="bottom-icon-btn" title="Oyuncular">
        <i class="fas fa-users"></i>
      </button>
      <!-- Asker İşlemleri -->
      <button id="open-military-btn" class="bottom-icon-btn" title="Asker İşlemleri">
        <i class="fas fa-shield-alt"></i>
      </button>
      <!-- Bina Kurma -->
      <button id="open-building-btn" class="bottom-icon-btn" title="Bina Kurma">
        <i class="fas fa-building"></i>
      </button>
      <!-- Kaynak Gönderme -->
      <button id="open-resource-btn" class="bottom-icon-btn" title="Kaynak Gönderme">
        <i class="fas fa-hand-holding-usd"></i>
      </button>
      <!-- Market -->
      <button
        id="open-market-btn"
        class="bottom-icon-btn"
        data-badge=""
        title="Ticaret Merkezi"
      >
        <i class="fas fa-store"></i>
      </button>
      <!-- Pakt -->
      <button id="open-pact-btn" class="bottom-icon-btn" title="Saldırmazlık Pakti">
        <i class="fas fa-handshake"></i>
      </button>
      <!-- Chat -->
      <button
        id="open-chat-btn"
        class="bottom-icon-btn"
        data-badge=""
        title="Sohbet"
      >
        <i class="fas fa-comments"></i>
      </button>
      <!-- Bildirim İkonu -->
      <button
        id="open-notifications-btn"
        class="bottom-icon-btn"
        title="Bildirimler"
      >
        <i class="fas fa-bell"></i>
      </button>
    </div>
  </div>

  <!-- ===================== ASKER İŞLEMLERİ POPUP ===================== -->
  <div id="military-popup" class="modern-popup">
    <div class="popup-header" id="military-popup-header">
      <span>Asker İşlemleri</span>
      <button id="close-military-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Saldırı (Sadece Kendi Sıranda)</h3>
      <p style="font-size:14px; color:#ccc;">
        - Saldırmak istediğiniz ülkeyi haritadan seçin<br />
        - Gönderilecek asker sayısını girin (Her asker 1 varil petrol harcar)
      </p>
      <input
        type="number"
        id="attack-soldiers"
        placeholder="Asker sayısı"
        min="1"
      />
      <button id="attack-btn">
        <i class="fas fa-crosshairs"></i> Saldırı Yap
      </button>

      <h3>Asker Satın Alma (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">(1 Asker = 10$ + 25 Buğday)</p>
      <input
        type="number"
        id="soldiers-to-buy"
        placeholder="Adet"
        min="1"
      />
      <button id="buy-soldiers-btn">
        <i class="fas fa-user-plus"></i> Satın Al
      </button>

      <h3>Asker Çek (Kendi Ülkenizden veya Destek Gönderdiğiniz Ülkeden)</h3>
      <input
        type="number"
        id="pull-soldiers-count"
        placeholder="Asker sayısı"
        min="1"
      />
      <button id="pull-soldiers-btn">
        <i class="fas fa-running"></i> Asker Çek
      </button>

      <h3>Askeri Destek Gönder (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">
        Seçtiğiniz oyuncunun ülkesine asker desteği
      </p>
      <select id="support-recipient"></select>
      <select id="support-recipient-country"></select>
      <input
        type="number"
        id="support-soldiers"
        placeholder="Asker sayısı"
        min="1"
      />
      <button id="send-support-btn">
        <i class="fas fa-hands-helping"></i> Destek Gönder
      </button>
    </div>
  </div>

  <!-- ===================== BİNA KURMA POPUP ===================== -->
  <div id="building-popup" class="modern-popup">
    <div class="popup-header" id="building-popup-header">
      <span>Bina Kurma</span>
      <button id="close-building-btn">&times;</button>
    </div>
    <div class="popup-content">
      <!-- Kışla Kur -->
      <h3>Kışla Kur (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">
        (1 Kışla = 300$ + 50 Varil + 120 Buğday)
      </p>
      <input
        type="number"
        id="barracks-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="buy-barracks-btn">
        <i class="fas fa-fort-awesome"></i> Kışla Kur
      </button>

      <!-- Fabrika Kur -->
      <h3>Fabrika Kur (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">(1 Fabrika = 500$ + 130 varil)</p>
      <input
        type="number"
        id="factory-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="build-factory-btn">
        <i class="fas fa-industry"></i> Fabrika Kur
      </button>

      <!-- Rafine Kur -->
      <h3>Rafine Kur (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">
        (1 Rafine = 800$ + 250 varil)
      </p>
      <input
        type="number"
        id="refinery-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="build-refinery-btn">
        <i class="fas fa-oil-can"></i> Rafine Kur
      </button>

      <!-- Değirmen Kur -->
      <h3>Değirmen Kur (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">(1 Değirmen = 200$ + 100 Varil)</p>
      <input
        type="number"
        id="grainmill-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="build-grainmill-btn">
        <i class="fas fa-wheat-awn"></i> Değirmen Kur
      </button>

      <!-- Kale Kur -->
      <h3>Kale Kur (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">
        - 1 Kale = 1000$ + 1000 Varil + 1000 Buğday <br/>
        - Bir ülkede yalnızca 1 kale kurulabilir<br/>
        - Kale, o ülkeye saldıran askerlerin %5'ini öldürür (temel savunma)
      </p>
      <button id="build-castle-btn">
        <i class="fas fa-chess-rook"></i> Kale Kur
      </button>

      <!-- Kale Güçlendirme -->
      <h3>Kale Güçlendirme</h3>
      <p style="font-size:14px; color:#ccc;">
        - Her güçlendirme kale savunmasına +%5 ekler (Max %30)<br/>
        - İlk güçlendirme maliyeti: 1300$ + 1300 Varil + 1300 Buğday<br/>
        - Sonraki her güçlendirme maliyeti de bir önceki fiyata göre %30 artar
      </p>
      <p style="font-size:14px; color:#1abc9c;">
        Mevcut / Sonraki Güçlendirme Fiyatı:
        <span id="castle-upgrade-cost-text">-</span>
      </p>
      <button id="upgrade-castle-btn">
        <i class="fas fa-arrow-up"></i> Kale Güçlendir
      </button>
    </div>
  </div>

  <!-- ===================== KAYNAK GÖNDERME POPUP ===================== -->
  <div id="resource-popup" class="modern-popup">
    <div class="popup-header" id="resource-popup-header">
      <span>Kaynak Gönderme (Her Zaman)</span>
      <button id="close-resource-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Para Gönder</h3>
      <input
        type="number"
        id="money-to-send"
        placeholder="Miktar ($)"
        min="1"
      />
      <select id="recipient-player"></select>
      <button id="send-money-btn">
        <i class="fas fa-hand-holding-usd"></i> Para Gönder
      </button>

      <h3>Petrol Gönder</h3>
      <input
        type="number"
        id="petrol-to-send"
        placeholder="Varil"
        min="1"
      />
      <select id="recipient-player-petrol"></select>
      <button id="send-petrol-btn">
        <i class="fas fa-gas-pump"></i> Petrol Gönder
      </button>

      <h3>Buğday Gönder</h3>
      <input
        type="number"
        id="wheat-to-send"
        placeholder="Buğday"
        min="1"
      />
      <select id="recipient-player-wheat"></select>
      <button id="send-wheat-btn">
        <i class="fas fa-wheat-awn"></i> Buğday Gönder
      </button>
    </div>
  </div>

  <!-- ===================== OYUNCULAR POPUP (SOLDA) ===================== -->
  <div id="players-popup">
    <div class="popup-header" id="players-popup-header">
      <span>Oyuncu Bilgileri</span>
      <button id="close-players-btn">&times;</button>
    </div>
    <div class="popup-content" id="players-info">
      <!-- Oyuncu listesi dinamik olarak buraya eklenecek -->
    </div>
  </div>

  <!-- ===================== CHAT POPUP (GENEL + ÖZEL) ===================== -->
  <div id="chat-popup" class="chat-popup modern-popup">
    <div class="chat-header" id="chat-popup-header">
      <span>Sohbet</span>
      <button id="close-chat-btn">&times;</button>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <!-- Genel Sohbet Girişi -->
    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Mesajınızı yazın..." />
      <button id="send-chat-btn">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    <!-- Özel Mesaj Girişi -->
    <div class="chat-private-container">
      <h4>Özel Mesaj</h4>
      <select id="private-message-recipient"></select>
      <input
        type="text"
        id="private-message-input"
        placeholder="Özel mesajınız..."
      />
      <button id="send-private-message-btn">
        <i class="fas fa-user-secret"></i> Gönder
      </button>
    </div>
  </div>

  <!-- ===================== SALDIRMAZLIK PAKTI POPUP ===================== -->
  <div id="pact-popup" class="modern-popup">
    <div id="pact-popup-header" class="popup-header">
      <span>Saldırmazlık Pakti</span>
      <button id="close-pact-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Yeni Pakt Teklifi Gönder</h3>
      <select id="pact-offer-recipient"></select>
      <!-- Tur sayısı ve para bedeli -->
      <input
        type="number"
        id="pact-duration"
        placeholder="Tur sayısı (örn: 3)"
      />
      <input type="number" id="pact-cost" placeholder="Tek seferlik para ($)" />
      <button id="send-pact-offer-btn" style="margin-bottom: 15px;">
        Teklif Gönder
      </button>

      <h3>Gelen Teklifler</h3>
      <div id="pact-pending-offers"></div>

      <h3>Aktif Paktlarınız</h3>
      <div id="active-pacts-container"></div>
    </div>
  </div>

  <!-- ===================== TİCARET POPUP ===================== -->
  <div id="market-popup" class="market-popup modern-popup">
    <div class="market-header" id="market-popup-header">
      <h2>Ticaret Merkezi</h2>
      <button id="close-market-btn">&times;</button>
    </div>
    <div class="market-content">
      <!-- Teklif Oluşturma -->
      <div class="market-section">
        <h3>Yeni Teklif Oluştur</h3>
        <label style="font-size:14px;color:#ccc;"
          >Satmak istediğiniz ürün:</label
        ><br />
        <select id="trade-item-type">
          <option value="petrol">Petrol</option>
          <option value="wheat">Buğday</option>
        </select>
        <br /><br />

        <label style="font-size:14px;color:#ccc;"
          >Miktar (adet/varil/buğday):</label
        >
        <input
          type="number"
          id="trade-quantity"
          placeholder="Miktar"
          min="1"
        />

        <label style="font-size:14px;color:#ccc;">Birim Fiyat ($):</label>
        <input
          type="number"
          id="trade-price"
          placeholder="Birim Fiyat"
          min="1"
        />

        <label style="font-size:14px;color:#ccc;">Ambargo (Oyuncular):</label
        ><br />
        <select
          id="embargo-players"
          multiple
          style="width: 100%; min-height: 50px;"
        ></select>
        <small style="color:#ccc;"
          >(Seçtiğiniz oyuncular bu teklifi satın
          alamaz)</small
        >
        <br /><br />

        <button
          id="create-trade-offer-btn"
          style="font-size:15px;"
        >
          Teklifi Oluştur
        </button>
      </div>
      <!-- Mevcut Teklifler -->
      <div class="market-section offer-list">
        <h3>Mevcut Teklifler</h3>
        <div id="trade-offers-list"></div>
      </div>
    </div>
  </div>
<script>
/*****************************************************************
 * 1) Firebase Başlatma
 *****************************************************************/
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DATABASE_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_ID",
  appId: "YOUR_APP_ID",
  measurementId: "YOUR_MEASUREMENT_ID"
};
// Firebase’i başlat
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/*****************************************************************
 * 2) GLOBAL DEĞİŞKENLER ve Yardımcı Fonksiyonlar
 *****************************************************************/
let localPlayerId = null;
let currentRoomCode = null;
let roomRef = null;
let roomData = null;
let selectedCountry = null;
let map, geoJsonLayer = null;
let localPlayerColor = null;

// 8 adet renk seçeneği
const availableColors = [
  "red",
  "blue",
  "green",
  "yellow",
  "purple",
  "orange",
  "brown",
  "pink"
];

// Chat ile ilgili
let chatListenerAdded = false;
let chatOpen = false;
let unreadMessages = 0;

// Bilgi kartlarının sürekli açık/kapalı olması
let infoCardsPermanent = false;

// Bildirim sesleri kapalı mı?
let notificationsMuted = false;

// 60 saniye turn sayacı
let turnTimeRemaining = 60;
let turnTimerInterval = null;

// Oyun başlat geri sayım
let startInterval = null;

/** Kullanıcıya kısa süreli bildirim gösterir. */
function showNotification(message, duration = 3000) {
  if (notificationsMuted) return; // Bildirim kapalıysa gösterme
  const nArea = document.getElementById("notification-area");
  if (!nArea) return;

  const item = document.createElement("div");
  item.className = "notification-item";
  item.textContent = message;
  nArea.appendChild(item);

  setTimeout(() => {
    if (nArea.contains(item)) {
      nArea.removeChild(item);
    }
  }, duration + 800); // +800 ms, animasyon süresi
}

/** Tüm oyunculara gidecek şekilde veritabanına bildirim kaydı oluşturur. */
function broadcastNotification(text) {
  if (!roomRef) return;
  roomRef.child("notifications").push({
    text: text,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });
}

/** DB'den gelen bildirimleri ekrana yansıtır. */
function displayGlobalNotification(text) {
  if (notificationsMuted) return;
  const nArea = document.getElementById("notification-area");
  if (!nArea) return;

  const item = document.createElement("div");
  item.className = "notification-item";
  item.textContent = text;
  nArea.appendChild(item);

  setTimeout(() => {
    if (nArea.contains(item)) {
      nArea.removeChild(item);
    }
  }, 6500);
}

/** Rastgele bir oda kodu üretir. */
function generateRoomCode() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code = "";
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

/** İlgili oyuncular arasında hâlâ aktif pakt olup olmadığını döndürür. */
function hasActivePact(playerA, playerB) {
  if (!roomData || !roomData.pacts) return false;
  for (let pactId in roomData.pacts) {
    const p = roomData.pacts[pactId];
    if (p.active && roomData.round <= p.expirationRound) {
      // Oyuncuları eşleştir
      if (
        (p.playerA === playerA && p.playerB === playerB) ||
        (p.playerA === playerB && p.playerB === playerA)
      ) {
        return true;
      }
    }
  }
  return false;
}

/** Şu an sıra bizde mi kontrolü. */
function isMyTurn() {
  if (!roomData || !roomData.playerOrder) return false;
  if (roomData.gameState !== "started") return false;
  const currentTurnIndex = roomData.currentTurnIndex || 0;
  return roomData.playerOrder[currentTurnIndex] === localPlayerId;
}

/*****************************************************************
 * 3) 60 Saniye Sayaç Fonksiyonları
 *****************************************************************/
function startTurnTimer() {
  const timerEl = document.getElementById("turn-timer");
  turnTimeRemaining = 60;
  if (turnTimerInterval) clearInterval(turnTimerInterval);
  timerEl.textContent = turnTimeRemaining + "s";

  turnTimerInterval = setInterval(() => {
    turnTimeRemaining--;
    if (turnTimeRemaining <= 0) {
      clearInterval(turnTimerInterval);
      turnTimeRemaining = 0;
      timerEl.textContent = "0s";
      // Süre dolunca otomatik tur geç
      if (roomData && roomData.gameState === "started" && isMyTurn()) {
        nextTurn(true);
      }
    } else {
      timerEl.textContent = turnTimeRemaining + "s";
    }
  }, 1000);
}

function stopTurnTimer() {
  if (turnTimerInterval) {
    clearInterval(turnTimerInterval);
    turnTimerInterval = null;
  }
  const timerEl = document.getElementById("turn-timer");
  if (timerEl) {
    timerEl.textContent = "60s";
  }
}

/*****************************************************************
 * 4) LOBBY (Oda Oluşturma - Katılma) & Otomatik Bağlanma
 *****************************************************************/
document.addEventListener("DOMContentLoaded", () => {
  // Local playerId yoksa yarat
  if (!localStorage.getItem("playerId")) {
    localStorage.setItem("playerId", Math.random().toString(36).substr(2, 9));
  }
  localPlayerId = localStorage.getItem("playerId");

  // 1) Renk Butonlarını Oluştur (Oda Oluşturma tarafı)
  const creatorColorDiv = document.getElementById("creator-color-options");
  availableColors.forEach((color) => {
    const btn = document.createElement("button");
    btn.className = "global-color-option";
    btn.style.background = color;
    btn.dataset.color = color;
    btn.addEventListener("click", () => {
      creatorColorDiv
        .querySelectorAll(".global-color-option")
        .forEach((el) => el.classList.remove("selected"));
      btn.classList.add("selected");
      localPlayerColor = color;
    });
    creatorColorDiv.appendChild(btn);
  });

  // 2) Renk Butonları (Odaya Katılma tarafı)
  const joinColorDiv = document.getElementById("join-color-options");
  availableColors.forEach((color) => {
    const btn = document.createElement("button");
    btn.className = "global-color-option";
    btn.style.background = color;
    btn.dataset.color = color;
    btn.addEventListener("click", () => {
      joinColorDiv
        .querySelectorAll(".global-color-option")
        .forEach((el) => el.classList.remove("selected"));
      btn.classList.add("selected");
      localPlayerColor = color;
    });
    joinColorDiv.appendChild(btn);
  });

  // 3) Oda Oluştur
  document.getElementById("create-room-btn").addEventListener("click", () => {
    const playerName = document
      .getElementById("creator-player-name")
      .value.trim();
    const maxPlayers = parseInt(document.getElementById("max-players").value);
    if (!playerName) {
      showNotification("Lütfen adınızı girin!");
      return;
    }
    if (!localPlayerColor) {
      showNotification("Lütfen bir renk seçin!");
      return;
    }
    if (isNaN(maxPlayers) || maxPlayers < 2 || maxPlayers > 8) {
      showNotification("Oyuncu sayısı 2 ile 8 arasında olmalıdır!");
      return;
    }

    const roomCode = generateRoomCode();
    currentRoomCode = roomCode;
    roomRef = db.ref("rooms/" + roomCode);

    // Yeni oda verisi
    const newRoomData = {
      roomCode: roomCode,
      maxPlayers: maxPlayers,
      gameState: "waiting", // Bekleme durumunda
      currentTurnIndex: 0,
      round: 1,
      playerOrder: [localPlayerId],
      players: {},
      countryData: {},
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };

    // Odayı kuran oyuncu
    newRoomData.players[localPlayerId] = {
      name: playerName,
      color: localPlayerColor,
      money: 1000,
      soldiers: 0,
      countries: [],
      petrol: 100,
      wheat: 400,
      joinedAt: firebase.database.ServerValue.TIMESTAMP,
      isHost: true
    };

    roomRef.set(newRoomData, (error) => {
      if (error) {
        showNotification("Oda oluşturulurken hata oluştu!");
      } else {
        showNotification("Oda oluşturuldu. Kodu: " + roomCode);
        localStorage.setItem("roomCode", roomCode);
        loadAndInitializeGeoJson(); // Ülkeleri ilk defa oluştur (Sadece kurucu)
        joinRoomAndListen();        // Odayı dinlemeye başla
        // Lobi ekranını kapat, oyun ekranını aç
        document.body.classList.remove("lobby");
        document.getElementById("lobby-container").style.display = "none";
        document.getElementById("game-container").style.display = "block";
        document.getElementById("display-room-code").textContent = roomCode;
      }
    });
  });

  // 4) Odaya Katıl
  document.getElementById("join-room-btn").addEventListener("click", () => {
    const playerName = document
      .getElementById("join-player-name")
      .value.trim();
    const roomCodeInput = document
      .getElementById("room-code")
      .value.trim()
      .toUpperCase();

    if (!playerName) {
      showNotification("Lütfen adınızı girin!");
      return;
    }
    if (!localPlayerColor) {
      showNotification("Lütfen bir renk seçin!");
      return;
    }
    if (!roomCodeInput) {
      showNotification("Lütfen oda kodu girin!");
      return;
    }

    currentRoomCode = roomCodeInput;
    roomRef = db.ref("rooms/" + roomCodeInput);

    roomRef.once("value", (snapshot) => {
      if (!snapshot.exists()) {
        showNotification("Böyle bir oda bulunamadı!");
        return;
      }
      const room = snapshot.val();
      if (room.gameState !== "waiting") {
        showNotification("Oyun zaten başladı veya başlamak üzere!");
        return;
      }
      const playerCount = Object.keys(room.players || {}).length;
      if (playerCount >= room.maxPlayers) {
        showNotification("Oda dolu!");
        return;
      }
      // Katılan oyuncuyu ekle
      const updates = {};
      updates["players/" + localPlayerId] = {
        name: playerName,
        color: localPlayerColor,
        money: 1000,
        soldiers: 0,
        countries: [],
        petrol: 100,
        wheat: 400,
        joinedAt: firebase.database.ServerValue.TIMESTAMP,
        isHost: false
      };
      if (!room.playerOrder) room.playerOrder = [];
      room.playerOrder.push(localPlayerId);
      updates["playerOrder"] = room.playerOrder;

      roomRef.update(updates, (error) => {
        if (error) {
          showNotification("Odaya katılırken hata oluştu!");
        } else {
          showNotification("Odaya katıldınız!");
          localStorage.setItem("roomCode", roomCodeInput);
          joinRoomAndListen();
          document.body.classList.remove("lobby");
          document.getElementById("lobby-container").style.display = "none";
          document.getElementById("game-container").style.display = "block";
          document.getElementById("display-room-code").textContent =
            roomCodeInput;
        }
      });
    });
  });

  // 5) Daha önce bir odaya katıldıysak otomatik bağlan
  autoReconnect();

  // 6) Bilgi kartı toggle
  const toggleInfoButton = document.getElementById("toggle-info-cards");
  const icon = toggleInfoButton.querySelector("i");
  toggleInfoButton.addEventListener("click", () => {
    infoCardsPermanent = !infoCardsPermanent;
    updateTooltipsPermanent();
    icon.className = infoCardsPermanent ? "fas fa-eye" : "fas fa-eye-slash";
  });
});

/** Odaya otomatik bağlanmak için localStorage'daki roomCode'a bakar. */
function autoReconnect() {
  const savedRoomCode = localStorage.getItem("roomCode");
  if (savedRoomCode) {
    const refCheck = db.ref("rooms/" + savedRoomCode);
    refCheck.once("value", (snapshot) => {
      if (!snapshot.exists()) return;
      const savedRoomData = snapshot.val();
      if (
        !savedRoomData.players ||
        !savedRoomData.players[localPlayerId]
      ) {
        return;
      }
      currentRoomCode = savedRoomCode;
      roomRef = refCheck;
      joinRoomAndListen();
      document.body.classList.remove("lobby");
      document.getElementById("lobby-container").style.display = "none";
      document.getElementById("game-container").style.display = "block";
      document.getElementById("display-room-code").textContent = savedRoomCode;
    });
  }
}

/*****************************************************************
 * 5) GeoJSON ve Ülke Verilerini Yükleme (Sadece Oda Kurucusu)
 *****************************************************************/
function loadAndInitializeGeoJson() {
  // Dış kaynaktan GeoJSON indir
  fetch(
    "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json"
  )
    .then((res) => res.json())
    .then((geoJsonData) => {
      const features = geoJsonData.features;
      // Rastgele 43 ülkeye petrol, 60 ülkeye buğday
      let oilIndexes = [];
      if (features.length > 43) {
        while (oilIndexes.length < 43) {
          const r = Math.floor(Math.random() * features.length);
          if (!oilIndexes.includes(r)) {
            oilIndexes.push(r);
          }
        }
      }
      let wheatIndexes = [];
      if (features.length > 60) {
        while (wheatIndexes.length < 60) {
          const r = Math.floor(Math.random() * features.length);
          if (!wheatIndexes.includes(r)) {
            wheatIndexes.push(r);
          }
        }
      }
      // Başlangıç
      const countryDataInit = {};
      features.forEach((f, idx) => {
        const countryName = f.properties.name;
        let oilProduction = 0;
        let wheatProduction = 0;
        if (oilIndexes.includes(idx)) {
          oilProduction = Math.floor(Math.random() * (500 - 150 + 1)) + 150;
        }
        if (wheatIndexes.includes(idx)) {
          wheatProduction = Math.floor(Math.random() * (700 - 200 + 1)) + 200;
        }

        countryDataInit[countryName] = {
          income: Math.floor(Math.random() * 500) + 100,
          soldiers: 0,
          owner: null,
          barracksCount: 0,
          factories: 0,
          refineries: 0,
          oilProduction: oilProduction,
          wheatProduction: wheatProduction,
          grainMills: 0,
          supporters: {},
          // Kale
          castleDefenseLevel: 0,
          castleNextUpgradeCost: null
        };
      });
      // DB’ye yaz
      roomRef.child("countryData").set(countryDataInit);
    });
}

/*****************************************************************
 * 6) Oda (roomRef) Dinleme & UI Güncelleme
 *****************************************************************/
function joinRoomAndListen() {
  if (!roomRef) return;

  // Oda verilerini sürekli dinle
  roomRef.on("value", (snapshot) => {
    roomData = snapshot.val();
    updateGameUI();
    displayPendingPactOffers();
    displayActivePacts();
    displayTradeOffers();
  });

  // Chat ve global notifications sadece bir kez
  if (!chatListenerAdded) {
    // Chat
    roomRef.child("chat").on("child_added", (snap) => {
      const msg = snap.val();
      appendChatMessage(msg);
    });
    // Global bildirimler
    roomRef.child("notifications").on("child_added", (snap) => {
      const data = snap.val();
      if (data && data.text) displayGlobalNotification(data.text);
    });
    chatListenerAdded = true;
  }
}

/** Oyun ekranındaki UI güncellemeleri. */
function updateGameUI() {
  if (!roomData) return;

  // Tur ve Sıra
  document.getElementById("current-round").textContent = roomData.round || 1;
  if (roomData.playerOrder && roomData.players) {
    const cIndex = roomData.currentTurnIndex || 0;
    const cPlayerId = roomData.playerOrder[cIndex];
    if (roomData.players[cPlayerId]) {
      document.getElementById("current-player").textContent =
        roomData.players[cPlayerId].name;
    }
  }

  // Oyun state
  handleGameState(roomData.gameState);

  // Oyuncu Listesi (sol popup)
  const playersInfoDiv = document.getElementById("players-info");
  if (playersInfoDiv) {
    playersInfoDiv.innerHTML = "";
    if (roomData.playerOrder) {
      roomData.playerOrder.forEach((pid) => {
        if (roomData.players[pid]) {
          const pData = roomData.players[pid];
          const div = document.createElement("div");
          div.className = "player-info";
          div.id = "player-info-" + pid;
          div.innerHTML = `
            <p><strong>${pData.name}</strong></p>
            <p>Para: <span>${pData.money}</span>$</p>
            <p>Asker: <span>${pData.soldiers}</span></p>
            <p>Ülkeler: <span>${pData.countries ? pData.countries.length : 0}</span></p>
            <p>Petrol: <span>${pData.petrol}</span> varil</p>
            <p>Buğday: <span>${pData.wheat}</span></p>
          `;
          playersInfoDiv.appendChild(div);
        }
      });
    }
  }

  // Harita güncelle (owner rengi vs.)
  if (map && roomData.countryData && geoJsonLayer) {
    geoJsonLayer.eachLayer((layer) => {
      const cname = layer.feature.properties.name;
      const c = roomData.countryData[cname];
      if (!c) return;
      if (c.owner && roomData.players[c.owner]) {
        layer.setStyle({
          fillColor: roomData.players[c.owner].color,
          fillOpacity: 0.7,
          color: "#555",
          weight: 1
        });
      } else {
        layer.setStyle({
          fillColor: "#ccc",
          fillOpacity: 0.7,
          color: "#555",
          weight: 1
        });
      }
      layer.setTooltipContent(getCountryPopupContent(cname, c));
    });
  }

  updateRecipientSelects();
  updatePrivateMessageRecipientSelect();
  updateEmbargoPlayersSelect();
  updateSupportRecipientSelect();
  updatePactRecipientSelect();

  // Sayaç başlat/bitir
  if (roomData.gameState === "started") {
    if (isMyTurn()) {
      startTurnTimer();
    } else {
      stopTurnTimer();
    }
  } else {
    stopTurnTimer();
  }
}

/** Oyun state yönetimi: (waiting, starting, started) */
function handleGameState(state) {
  const startBtn = document.getElementById("start-game-btn");
  const countdownSpan = document.getElementById("start-countdown");
  if (!state) return;

  if (state === "waiting") {
    // Host ise buton göster
    if (
      roomData.players[localPlayerId] &&
      roomData.players[localPlayerId].isHost
    ) {
      startBtn.style.display = "block";
    } else {
      startBtn.style.display = "none";
    }
    countdownSpan.style.display = "none";
  } else if (state === "starting") {
    startBtn.style.display = "none";
    countdownSpan.style.display = "inline";
    startCountdownListener();
  } else if (state === "started") {
    startBtn.style.display = "none";
    countdownSpan.style.display = "none";
    clearInterval(startInterval);
    startInterval = null;
  }
}

/** Oyun Başlat Butonu - Sadece host */
document.getElementById("start-game-btn").addEventListener("click", () => {
  if (!roomData || !roomData.players[localPlayerId].isHost) return;
  if (roomData.gameState !== "waiting") return;
  const now = Date.now();
  const startTime = now + 30000; // 30sn geri sayım
  roomRef.update({
    gameState: "starting",
    startTime: startTime
  });
});

/** 30 sn geri sayımı başlatır */
function startCountdownListener() {
  if (!roomData || !roomData.startTime) return;
  const countdownSpan = document.getElementById("start-countdown");
  if (startInterval) clearInterval(startInterval);

  startInterval = setInterval(() => {
    if (!roomData) return;
    const now = Date.now();
    const diff = roomData.startTime - now;
    if (diff <= 0) {
      clearInterval(startInterval);
      startInterval = null;
      roomRef.update({ gameState: "started" });
      return;
    }
    countdownSpan.textContent = Math.floor(diff / 1000);
  }, 1000);
}

/** Ülke popup içeriğini oluşturur. */
function getCountryPopupContent(countryName, country) {
  const ownerName = country.owner
    ? roomData.players[country.owner]?.name || "?"
    : "Yok";

  // Fabrika %20 ek gelir, rafine %15 petrol artışı, değirmen %20 buğday artışı
  let effectiveIncome = country.income || 0;
  if (country.factories) {
    effectiveIncome = Math.floor(
      effectiveIncome * (1 + 0.2 * country.factories)
    );
  }
  const effectiveOil = country.oilProduction
    ? Math.floor(
        country.oilProduction * (1 + 0.15 * (country.refineries || 0))
      )
    : 0;
  const effectiveWheat = country.wheatProduction
    ? Math.floor(
        country.wheatProduction * (1 + 0.2 * (country.grainMills || 0))
      )
    : 0;

  // Kale
  const castleDefensePercent = country.castleDefenseLevel * 5; // 1 => %5, 6 => %30

  return `
    <div>
      <p><i class="fas fa-money-bill-wave"></i> Gelir: ${effectiveIncome}$</p>
      <p><i class="fas fa-users"></i> Asker: ${country.soldiers || 0}</p>
      <p><i class="fas fa-fort-awesome"></i> Kışla: ${country.barracksCount || 0}</p>
      <p><i class="fas fa-industry"></i> Fabrika: ${country.factories || 0}</p>
      <p><i class="fas fa-oil-can"></i> Rafine: ${country.refineries || 0}</p>
      <p><i class="fas fa-oil-can"></i> Petrol Üretimi: ${effectiveOil}</p>
      <p><i class="fas fa-wheat-awn"></i> Değirmen: ${country.grainMills || 0}</p>
      <p><i class="fas fa-wheat-awn"></i> Buğday Üretimi: ${effectiveWheat}</p>
      <p><i class="fas fa-chess-rook"></i> Kale Gücü: ${
        castleDefensePercent > 0 ? "%" + castleDefensePercent : "-"
      }</p>
      <p><i class="fas fa-crown"></i> Sahip: ${ownerName}</p>
    </div>
  `;
}

/** Bilgi kartlarının sürekli/permanent gösterimini ayarlar. */
function updateTooltipsPermanent() {
  if (!geoJsonLayer) return;
  geoJsonLayer.eachLayer((layer) => {
    layer.unbindTooltip();
    const cname = layer.feature.properties.name;
    const cinfo = roomData.countryData[cname];
    layer.bindTooltip(getCountryPopupContent(cname, cinfo || {}), {
      permanent: infoCardsPermanent,
      direction: "center",
      className: "country-popup-tooltip"
    });
  });
}

/** Bir ülkeyi seçince kısa bildirim + highlight. */
function selectCountry(countryName, layer) {
  selectedCountry = countryName;
  showNotification("Seçilen ülke: " + countryName, 1500);
  layer.setStyle({ weight: 4, color: "#FF4500" });

  setTimeout(() => {
    const c = roomData.countryData[countryName];
    if (c.owner && roomData.players[c.owner]) {
      layer.setStyle({
        fillColor: roomData.players[c.owner].color,
        fillOpacity: 0.7,
        weight: 1,
        color: "#555"
      });
    } else {
      layer.setStyle({
        fillColor: "#ccc",
        fillOpacity: 0.7,
        weight: 1,
        color: "#555"
      });
    }
  }, 800);

  // Kale yükseltme maliyetini UI’da güncelle
  updateCastleUpgradeCostUI();
}

/** Kale yükseltme maliyetini popup içinde gösterir. */
function updateCastleUpgradeCostUI() {
  const costSpan = document.getElementById("castle-upgrade-cost-text");
  if (!selectedCountry || !roomData || !roomData.countryData[selectedCountry]) {
    costSpan.textContent = "-";
    return;
  }
  const c = roomData.countryData[selectedCountry];
  if (c.castleDefenseLevel < 1) {
    costSpan.textContent = "Önce kale kurulmalı.";
    return;
  }
  if (c.castleDefenseLevel >= 6) {
    costSpan.textContent = "Maksimum seviye (%30).";
    return;
  }
  if (!c.castleNextUpgradeCost) {
    costSpan.textContent = "-";
    return;
  }
  costSpan.textContent = `${c.castleNextUpgradeCost.money}$ + ${c.castleNextUpgradeCost.petrol} Varil + ${c.castleNextUpgradeCost.wheat} Buğday`;
}

/** Kaynak gönder popuplarındaki alıcı listesi. */
function updateRecipientSelects() {
  const moneySel = document.getElementById("recipient-player");
  const petrolSel = document.getElementById("recipient-player-petrol");
  const wheatSel = document.getElementById("recipient-player-wheat");
  if (!moneySel || !petrolSel || !wheatSel) return;

  moneySel.innerHTML = "";
  petrolSel.innerHTML = "";
  wheatSel.innerHTML = "";

  if (roomData && roomData.playerOrder) {
    roomData.playerOrder.forEach((pid) => {
      if (roomData.players[pid]) {
        const o1 = document.createElement("option");
        o1.value = pid;
        o1.textContent = roomData.players[pid].name;
        moneySel.appendChild(o1);

        const o2 = document.createElement("option");
        o2.value = pid;
        o2.textContent = roomData.players[pid].name;
        petrolSel.appendChild(o2);

        const o3 = document.createElement("option");
        o3.value = pid;
        o3.textContent = roomData.players[pid].name;
        wheatSel.appendChild(o3);
      }
    });
  }
}

/** Özel mesaj için alıcı listesi */
function updatePrivateMessageRecipientSelect() {
  const sel = document.getElementById("private-message-recipient");
  if (!sel) return;
  sel.innerHTML = "";
  if (roomData && roomData.playerOrder) {
    roomData.playerOrder.forEach((pid) => {
      if (pid !== localPlayerId && roomData.players[pid]) {
        const opt = document.createElement("option");
        opt.value = pid;
        opt.textContent = roomData.players[pid].name;
        sel.appendChild(opt);
      }
    });
  }
}

/** Ticaret teklifinde ambargo koyarken seçilecek oyuncular */
function updateEmbargoPlayersSelect() {
  const embargoSel = document.getElementById("embargo-players");
  if (!embargoSel) return;
  embargoSel.innerHTML = "";
  if (roomData && roomData.playerOrder) {
    roomData.playerOrder.forEach((pid) => {
      if (pid !== localPlayerId && roomData.players[pid]) {
        const opt = document.createElement("option");
        opt.value = pid;
        opt.textContent = roomData.players[pid].name;
        embargoSel.appendChild(opt);
      }
    });
  }
}

/** Askeri destek verecek kişi ve ülke seçimi */
function updateSupportRecipientSelect() {
  const supRec = document.getElementById("support-recipient");
  const supRecCountry = document.getElementById("support-recipient-country");
  if (!supRec || !supRecCountry) return;

  supRec.innerHTML = "";
  supRecCountry.innerHTML = "<option value=''>--Ülke Seç--</option>";

  if (roomData && roomData.playerOrder) {
    roomData.playerOrder.forEach((pid) => {
      if (pid !== localPlayerId && roomData.players[pid]) {
        const opt = document.createElement("option");
        opt.value = pid;
        opt.textContent = roomData.players[pid].name;
        supRec.appendChild(opt);
      }
    });

    if (roomData.countryData) {
      Object.keys(roomData.countryData).forEach((cName) => {
        const op = document.createElement("option");
        op.value = cName;
        op.textContent = cName;
        supRecCountry.appendChild(op);
      });
    }
  }
}

/** Pakt teklifi için alıcı seçimi */
function updatePactRecipientSelect() {
  const sel = document.getElementById("pact-offer-recipient");
  if (!sel) return;
  sel.innerHTML = "";
  if (roomData && roomData.playerOrder) {
    roomData.playerOrder.forEach((pid) => {
      if (pid !== localPlayerId && roomData.players[pid]) {
        const opt = document.createElement("option");
        opt.value = pid;
        opt.textContent = roomData.players[pid].name;
        sel.appendChild(opt);
      }
    });
  }
}

/*****************************************************************
 * 7) SALDIRMAZLIK PAKTI (Teklif - Kabul - Reddet - Liste)
 *****************************************************************/
document
  .getElementById("send-pact-offer-btn")
  .addEventListener("click", () => {
    if (!isMyTurn()) {
      showNotification(
        "Pakt teklifini sadece kendi sıranızda gönderebilirsiniz!"
      );
      return;
    }
    const rec = document.getElementById("pact-offer-recipient").value;
    const dur = parseInt(document.getElementById("pact-duration").value);
    const cost = parseInt(document.getElementById("pact-cost").value);
    if (!rec || rec === localPlayerId) {
      showNotification("Lütfen geçerli bir oyuncu seçin!");
      return;
    }
    if (isNaN(dur) || dur <= 0) {
      showNotification("Geçerli tur sayısı girin!");
      return;
    }
    if (isNaN(cost) || cost < 0) {
      showNotification("Geçerli bir para miktarı girin (0 veya üstü)!");
      return;
    }
    if (hasActivePact(localPlayerId, rec)) {
      showNotification("Bu oyuncuyla zaten aktif bir paktınız var!");
      return;
    }
    const senderData = roomData.players[localPlayerId];
    if (!senderData) return;

    const pRef = roomRef.child("pactOffers").push();
    const newOffer = {
      offerId: pRef.key,
      senderId: localPlayerId,
      senderName: senderData.name,
      recipientId: rec,
      duration: dur,
      cost: cost,
      status: "pending"
    };
    pRef.set(newOffer);

    broadcastNotification(
      `Saldırmazlık Paktı Teklifi: ${senderData.name} → ${
        roomData.players[rec].name
      } (Tur: ${dur}, Para: ${cost}$)`
    );
    showNotification("Pakt teklifi gönderildi!");
  });

function displayPendingPactOffers() {
  const cont = document.getElementById("pact-pending-offers");
  if (!cont) return;
  cont.innerHTML = "";
  if (!roomData || !roomData.pactOffers) return;

  Object.values(roomData.pactOffers).forEach((offer) => {
    if (offer.status === "pending" && offer.recipientId === localPlayerId) {
      const div = document.createElement("div");
      div.className = "pact-offer-item";
      div.setAttribute("data-offer-id", offer.offerId);

      div.innerHTML = `
        <p><strong>${offer.senderName}</strong> size saldırmazlık pakti teklif ediyor.</p>
        <p>Tur sayısı: <strong>${offer.duration}</strong></p>
        <p>Para talebi: <strong>${offer.cost}$</strong></p>
        <button class="accept-btn" data-offer-id="${offer.offerId}">Kabul Et</button>
        <button class="reject-btn" data-offer-id="${offer.offerId}">Reddet</button>
      `;

      cont.appendChild(div);
    }
  });
}

function displayActivePacts() {
  const cont = document.getElementById("active-pacts-container");
  if (!cont) return;
  cont.innerHTML = "";
  if (!roomData || !roomData.pacts) return;

  for (let pactId in roomData.pacts) {
    const p = roomData.pacts[pactId];
    if (p.active && roomData.round <= p.expirationRound) {
      if (p.playerA === localPlayerId || p.playerB === localPlayerId) {
        const otherId =
          p.playerA === localPlayerId ? p.playerB : p.playerA;
        const otherName = roomData.players[otherId]?.name || "???";
        const remain = p.expirationRound - roomData.round + 1;
        const div = document.createElement("div");
        div.className = "active-pact-item";
        div.innerHTML = `
          <p>Pakt: <strong>${otherName}</strong></p>
          <p>Kalan Tur: <strong>${remain}</strong></p>
        `;
        cont.appendChild(div);
      }
    }
  }
}

// Pakt teklifini kabul/reddet
document
  .getElementById("pact-pending-offers")
  .addEventListener("click", function (e) {
    if (e.target.classList.contains("accept-btn")) {
      const offId = e.target.getAttribute("data-offer-id");
      acceptPactOffer(offId);
    } else if (e.target.classList.contains("reject-btn")) {
      const offId = e.target.getAttribute("data-offer-id");
      rejectPactOffer(offId);
    }
  });

function acceptPactOffer(offerId) {
  const offer = roomData.pactOffers[offerId];
  if (!offer || offer.status !== "pending") return;
  if (hasActivePact(offer.senderId, offer.recipientId)) {
    showNotification("Bu oyuncuyla zaten aktif paktınız var!");
    roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
    return;
  }
  const sender = roomData.players[offer.senderId];
  const recipient = roomData.players[offer.recipientId];
  if (!sender || !recipient) {
    showNotification("Teklifteki oyuncular bulunamadı!");
    return;
  }
  if (sender.money < offer.cost) {
    showNotification("Gönderenin parası kalmamış! Teklif geçersiz.");
    roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
    return;
  }

  const expirationRound = (roomData.round || 1) + offer.duration;
  const pactId = db.ref().push().key;
  const updates = {};

  updates[`pactOffers/${offerId}/status`] = "accepted";
  updates[`players/${offer.senderId}/money`] = sender.money - offer.cost;
  updates[`players/${offer.recipientId}/money`] = recipient.money + offer.cost;

  updates[`pacts/${pactId}`] = {
    playerA: offer.senderId,
    playerB: offer.recipientId,
    active: true,
    cost: offer.cost,
    duration: offer.duration,
    expirationRound: expirationRound
  };

  roomRef.update(updates);

  broadcastNotification(
    `Pakt Anlaşması: ${sender.name} & ${recipient.name} (${offer.duration} tur, ${offer.cost}$)`
  );
  showNotification("Pakt teklifi kabul edildi!");
}

function rejectPactOffer(offerId) {
  const offer = roomData.pactOffers[offerId];
  if (!offer || offer.status !== "pending") return;
  roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
  broadcastNotification(
    `Pakt Reddedildi: ${offer.senderName} → Teklif reddedildi.`
  );
  showNotification("Pakt teklifi reddedildi.");
}

/*****************************************************************
 * 8) OYUN İŞLEMLERİ (Saldırı, Asker, Bina vb.)
 *****************************************************************/

/** Saldırı butonu */
document.getElementById("attack-btn").addEventListener("click", attack);

function attack() {
  if (!isMyTurn()) {
    showNotification("Sıranız değil!");
    return;
  }
  if (!selectedCountry) {
    showNotification("Önce haritadan bir ülke seçin!");
    return;
  }
  const soldiersToSend = parseInt(
    document.getElementById("attack-soldiers").value
  );
  if (isNaN(soldiersToSend) || soldiersToSend <= 0) {
    showNotification("Geçerli asker sayısı girin!");
    return;
  }
  const attacker = roomData.players[localPlayerId];
  if (attacker.petrol < soldiersToSend) {
    showNotification(
      `Yeterli petrol yok! (${soldiersToSend} varil gerekiyor)`
    );
    return;
  }

  const target = roomData.countryData[selectedCountry];
  if (!target) return;

  // İlk 3 tur: sadece sahipsiz ülkeye saldır
  if (roomData.round < 4) {
    if (target.owner) {
      showNotification(
        "İlk 3 tur yalnızca sahipsiz ülkelere saldırabilirsiniz!"
      );
      return;
    }
  }
  // Pakt var mı?
  if (target.owner && target.owner !== localPlayerId) {
    if (hasActivePact(localPlayerId, target.owner)) {
      showNotification("Bu oyuncu ile saldırmazlık paktınız var!");
      return;
    }
  }

  // Güncelleme objesi
  const updates = {};
  // Petrol düş
  updates[`players/${localPlayerId}/petrol`] = attacker.petrol - soldiersToSend;

  // Eğer kendi toprağımız ise “yerleştirme”
  if (target.owner === localPlayerId) {
    if (soldiersToSend > attacker.soldiers) {
      showNotification("Yeterli askeriniz yok!");
      return;
    }
    updates[`countryData/${selectedCountry}/soldiers`] =
      target.soldiers + soldiersToSend;
    updates[`players/${localPlayerId}/soldiers`] =
      attacker.soldiers - soldiersToSend;
    broadcastNotification(
      `Saldırı (yerleştirme): ${attacker.name}, kendi ülkesine ${soldiersToSend} asker ekledi.`
    );
    showNotification(
      `${selectedCountry} ülkesine ${soldiersToSend} asker yerleştirildi.`
    );
    roomRef.update(updates);
    return;
  }

  // Başka ülkeye saldırı
  if (soldiersToSend > attacker.soldiers) {
    showNotification("Yeterli askeriniz yok!");
    return;
  }
  updates[`players/${localPlayerId}/soldiers`] =
    attacker.soldiers - soldiersToSend;

  // Kale savunması
  let effectiveAttackers = soldiersToSend;
  if (target.castleDefenseLevel > 0) {
    const killPercent = 5 * target.castleDefenseLevel;
    const killedByCastle = Math.floor((killPercent / 100) * effectiveAttackers);
    effectiveAttackers -= killedByCastle;
    if (effectiveAttackers < 0) effectiveAttackers = 0;
    showNotification(
      `Kale savunması: ${killedByCastle} saldırgan asker öldü.`,
      2000
    );
  }

  let attackResult = "";
  if (effectiveAttackers > target.soldiers) {
    // Ülke fethedildi
    const remaining = effectiveAttackers - target.soldiers;
    updates[`countryData/${selectedCountry}/soldiers`] = remaining;
    // Sahipliği güncelle
    const oldOwner = target.owner;
    updates[`countryData/${selectedCountry}/owner`] = localPlayerId;
    updates[`countryData/${selectedCountry}/supporters`] = {};
    // (Kale devri. İsterseniz sıfırlayabilirsiniz)

    // Eski owner’ın ülkelerinden çıkar
    if (oldOwner && roomData.players[oldOwner]) {
      let defCountries = roomData.players[oldOwner].countries || [];
      defCountries = defCountries.filter((x) => x !== selectedCountry);
      updates[`players/${oldOwner}/countries`] = defCountries;
    }

    // Yeni sahibin listesine ekle
    let atkCountries = attacker.countries || [];
    if (!atkCountries.includes(selectedCountry)) {
      atkCountries.push(selectedCountry);
    }
    updates[`players/${localPlayerId}/countries`] = atkCountries;

    attackResult = `${selectedCountry} fethedildi! (${soldiersToSend} vs ${target.soldiers})`;
    showNotification(attackResult);
  } else {
    // Savunma başarılı
    updates[`countryData/${selectedCountry}/soldiers`] =
      target.soldiers - effectiveAttackers;
    attackResult = `${selectedCountry} savunuldu! (${soldiersToSend} vs ${target.soldiers})`;
    showNotification(attackResult);
  }

  // DB güncelle
  roomRef.update(updates, () => {
    // Saldırı sonrası “petrol ödülü” => anlık
    immediateOilReward(localPlayerId);
  });

  broadcastNotification(
    `Saldırı: ${attacker.name} → ${selectedCountry}. ${attackResult}`
  );
  // Tur geç
  nextTurn();
}

/** Saldırı sonrası anlık petrol ödülü (fethedilen topraklardan). */
function immediateOilReward(playerId) {
  if (!roomData || !roomData.players[playerId]) return;
  const p = roomData.players[playerId];
  if (!p.countries) return;

  let totalPetrolGained = 0;
  p.countries.forEach((cName) => {
    const c = roomData.countryData[cName];
    if (c && c.oilProduction) {
      const effOil = Math.floor(
        c.oilProduction * (1 + 0.15 * (c.refineries || 0))
      );
      totalPetrolGained += effOil;
    }
  });
  if (totalPetrolGained > 0) {
    const upd = {};
    upd[`players/${playerId}/petrol`] = p.petrol + totalPetrolGained;
    roomRef.update(upd);
    showNotification(
      `Saldırı sonrası ek petrol: +${totalPetrolGained} varil`,
      2500
    );
    broadcastNotification(
      `${p.name}, saldırı sonrası +${totalPetrolGained} varil petrol kazandı.`
    );
  }
}

/** Asker Satın Al */
document
  .getElementById("buy-soldiers-btn")
  .addEventListener("click", buySoldiers);

function buySoldiers() {
  const count = parseInt(document.getElementById("soldiers-to-buy").value);
  if (isNaN(count) || count <= 0) {
    showNotification("Geçerli asker sayısı girin!");
    return;
  }
  const costMoney = 10 * count;
  const costWheat = 25 * count;
  const p = roomData.players[localPlayerId];
  if (p.money < costMoney) {
    showNotification("Yeterli paranız yok!");
    return;
  }
  if (p.wheat < costWheat) {
    showNotification("Yeterli buğdayınız yok!");
    return;
  }
  const upd = {};
  upd[`players/${localPlayerId}/money`] = p.money - costMoney;
  upd[`players/${localPlayerId}/wheat`] = p.wheat - costWheat;
  upd[`players/${localPlayerId}/soldiers`] = p.soldiers + count;
  roomRef.update(upd);
  broadcastNotification(
    `${p.name} ${count} asker satın aldı (Toplam: ${p.soldiers + count}).`
  );
  showNotification(`${count} asker satın alındı!`);
}

/** Asker Çekme (Kendi ülkenizden veya destek verdiğiniz ülkeden) */
document
  .getElementById("pull-soldiers-btn")
  .addEventListener("click", pullSoldiers);

function pullSoldiers() {
  if (!selectedCountry) {
    showNotification("Önce ülke seçin!");
    return;
  }
  const count = parseInt(document.getElementById("pull-soldiers-count").value);
  if (isNaN(count) || count <= 0) {
    showNotification("Geçerli asker sayısı girin!");
    return;
  }
  const p = roomData.players[localPlayerId];
  const c = roomData.countryData[selectedCountry];
  if (!p || !c) return;

  const upd = {};
  if (c.owner === localPlayerId) {
    // Kendi askerini çek
    // (Varsayım: c.soldiers - supporters = ülke sahibine ait)
    let totalSupporters = 0;
    if (c.supporters) {
      for (let sid in c.supporters) {
        totalSupporters += c.supporters[sid];
      }
    }
    const occupantSoldiers = c.soldiers - totalSupporters;
    if (occupantSoldiers < count) {
      showNotification("Bu kadar kendi askeriniz yok!");
      return;
    }
    upd[`countryData/${selectedCountry}/soldiers`] = c.soldiers - count;
    upd[`players/${localPlayerId}/soldiers`] = p.soldiers + count;
    broadcastNotification(
      `${p.name}, ${selectedCountry} ülkesinden ${count} asker çekti.`
    );
  } else {
    // Destek çekme
    const supAmount = c.supporters[localPlayerId] || 0;
    if (supAmount < count) {
      showNotification("Bu ülkede bu kadar destek askeriniz yok!");
      return;
    }
    if (c.soldiers < count) {
      showNotification("Veri tutarsızlığı: ülkedeki toplam asker az!");
      return;
    }
    upd[`countryData/${selectedCountry}/soldiers`] = c.soldiers - count;
    const newSup = supAmount - count;
    if (newSup <= 0) {
      upd[`countryData/${selectedCountry}/supporters/${localPlayerId}`] = null;
    } else {
      upd[`countryData/${selectedCountry}/supporters/${localPlayerId}`] = newSup;
    }
    upd[`players/${localPlayerId}/soldiers`] = p.soldiers + count;
    broadcastNotification(
      `${p.name}, ${selectedCountry} ülkesine verdiği ${count} askeri geri çekti.`
    );
  }
  roomRef.update(upd);
  showNotification(`${selectedCountry} ülkesinden ${count} asker çekildi.`);
}

/** Askeri Destek Gönder */
document
  .getElementById("send-support-btn")
  .addEventListener("click", sendSupport);

function sendSupport() {
  const rec = document.getElementById("support-recipient").value;
  const recCountry = document.getElementById("support-recipient-country").value;
  const count = parseInt(document.getElementById("support-soldiers").value);

  if (!rec || !recCountry) {
    showNotification("Oyuncu ve ülke seçmelisiniz!");
    return;
  }
  if (isNaN(count) || count <= 0) {
    showNotification("Geçerli asker sayısı girin!");
    return;
  }
  const me = roomData.players[localPlayerId];
  if (me.soldiers < count) {
    showNotification("Yeterli askeriniz yok!");
    return;
  }
  const c = roomData.countryData[recCountry];
  if (!c) {
    showNotification("Ülke bulunamadı!");
    return;
  }
  if (c.owner !== rec) {
    showNotification("Seçili ülke, bu oyuncuya ait değil!");
    return;
  }

  const upd = {};
  upd[`players/${localPlayerId}/soldiers`] = me.soldiers - count;
  upd[`countryData/${recCountry}/soldiers`] = c.soldiers + count;
  const oldSupport = c.supporters[localPlayerId] || 0;
  upd[`countryData/${recCountry}/supporters/${localPlayerId}`] =
    oldSupport + count;

  roomRef.update(upd);
  broadcastNotification(
    `${me.name}, ${roomData.players[rec].name} (${recCountry}) ülkesine ${count} asker destek gönderdi.`
  );
  showNotification("Askeri destek gönderildi!");
}

/*****************************************************************
 * 9) KAYNAK GÖNDERME (Para, Petrol, Buğday)
 *****************************************************************/
document.getElementById("send-money-btn").addEventListener("click", sendMoney);
function sendMoney() {
  const amt = parseInt(document.getElementById("money-to-send").value);
  const rec = document.getElementById("recipient-player").value;
  if (isNaN(amt) || amt <= 0) {
    showNotification("Geçerli bir miktar girin!");
    return;
  }
  const me = roomData.players[localPlayerId];
  if (me.money < amt) {
    showNotification("Yeterli paranız yok!");
    return;
  }
  if (rec === localPlayerId) {
    showNotification("Kendinize gönderemezsiniz!");
    return;
  }
  const upd = {};
  upd[`players/${localPlayerId}/money`] = me.money - amt;
  upd[`players/${rec}/money`] = roomData.players[rec].money + amt;
  roomRef.update(upd);
  broadcastNotification(
    `${me.name} → ${roomData.players[rec].name} için ${amt}$ gönderdi.`
  );
  showNotification(`${amt}$ gönderildi.`);
}

document.getElementById("send-petrol-btn").addEventListener("click", () => {
  const amt = parseInt(document.getElementById("petrol-to-send").value);
  const rec = document.getElementById("recipient-player-petrol").value;
  if (isNaN(amt) || amt <= 0) {
    showNotification("Geçerli miktar girin!");
    return;
  }
  const me = roomData.players[localPlayerId];
  if (me.petrol < amt) {
    showNotification("Yeterli petrol yok!");
    return;
  }
  if (rec === localPlayerId) {
    showNotification("Kendinize gönderemezsiniz!");
    return;
  }
  const upd = {};
  upd[`players/${localPlayerId}/petrol`] = me.petrol - amt;
  upd[`players/${rec}/petrol`] = roomData.players[rec].petrol + amt;
  roomRef.update(upd);
  broadcastNotification(
    `${me.name} → ${roomData.players[rec].name} için ${amt} varil petrol gönderdi.`
  );
  showNotification(`${amt} varil petrol gönderildi.`);
});

document.getElementById("send-wheat-btn").addEventListener("click", () => {
  const amt = parseInt(document.getElementById("wheat-to-send").value);
  const rec = document.getElementById("recipient-player-wheat").value;
  if (isNaN(amt) || amt <= 0) {
    showNotification("Geçerli miktar girin!");
    return;
  }
  const me = roomData.players[localPlayerId];
  if (me.wheat < amt) {
    showNotification("Yeterli buğday yok!");
    return;
  }
  if (rec === localPlayerId) {
    showNotification("Kendinize gönderemezsiniz!");
    return;
  }
  const upd = {};
  upd[`players/${localPlayerId}/wheat`] = me.wheat - amt;
  upd[`players/${rec}/wheat`] = roomData.players[rec].wheat + amt;
  roomRef.update(upd);
  broadcastNotification(
    `${me.name} → ${roomData.players[rec].name} için ${amt} buğday gönderdi.`
  );
  showNotification(`${amt} buğday gönderildi.`);
});

/*****************************************************************
 * 10) TUR GEÇİŞİ
 *****************************************************************/
document.getElementById("end-turn-btn").addEventListener("click", () =>
  nextTurn(false)
);

function nextTurn(autoEnd = false) {
  if (!isMyTurn()) return;
  stopTurnTimer();

  const cIndex = roomData.currentTurnIndex || 0;
  const cPlayerId = roomData.playerOrder[cIndex];
  const p = roomData.players[cPlayerId];
  if (!p) return;

  const updates = {};

  // Tur bitiminde Gelir & Üretim
  if (p.countries && roomData.countryData) {
    let totalMoneyGained = 0;
    let totalPetrolGained = 0;
    let totalWheatGained = 0;

    p.countries.forEach((cn) => {
      const c = roomData.countryData[cn];
      if (!c) return;

      // Kışla => +5 asker
      if (c.barracksCount) {
        updates[`countryData/${cn}/soldiers`] = (c.soldiers || 0) + 5 * c.barracksCount;
      }

      // Para geliri (fabrika +%20)
      let effIncome = c.income || 0;
      if (c.factories) {
        effIncome = Math.floor(effIncome * (1 + 0.2 * c.factories));
      }
      totalMoneyGained += effIncome;

      // Petrol (rafine +%15)
      if (c.oilProduction) {
        const effOil = Math.floor(
          c.oilProduction * (1 + 0.15 * c.refineries)
        );
        totalPetrolGained += effOil;
      }
      // Buğday (değirmen +%20)
      if (c.wheatProduction) {
        const effWheat = Math.floor(
          c.wheatProduction * (1 + 0.2 * c.grainMills)
        );
        totalWheatGained += effWheat;
      }
    });

    updates[`players/${cPlayerId}/money`] = p.money + totalMoneyGained;
    updates[`players/${cPlayerId}/petrol`] = p.petrol + totalPetrolGained;
    updates[`players/${cPlayerId}/wheat`] = p.wheat + totalWheatGained;
  }

  // Sırayı sonraki oyuncuya
  let newIndex = cIndex + 1;
  let newRound = roomData.round;
  if (newIndex >= roomData.playerOrder.length) {
    newIndex = 0;
    newRound++;
    updates["round"] = newRound;
  }
  updates["currentTurnIndex"] = newIndex;

  roomRef.update(updates);

  const nextId = roomData.playerOrder[newIndex];
  let txt = `Sıra ${roomData.players[nextId]?.name || "?"} adlı oyuncuda.`;
  if (autoEnd) {
    txt = `${p.name} süresini doldurdu! ${txt}`;
  }
  broadcastNotification(txt);
  showNotification(txt, 1500);
}

/*****************************************************************
 * 11) ODADAN ÇIKIŞ
 *****************************************************************/
document.getElementById("exit-room-btn").addEventListener("click", () => {
  if (!roomRef || !roomData) return;

  const updates = {};
  let newOrder = (roomData.playerOrder || []).filter(
    (x) => x !== localPlayerId
  );

  // Sıra bizdeyse turu sonraki oyuncuya
  if (isMyTurn()) {
    stopTurnTimer();
    let idx = roomData.currentTurnIndex || 0;
    idx++;
    let newRound = roomData.round || 1;
    if (idx >= newOrder.length) {
      idx = 0;
      newRound++;
    }
    updates["round"] = newRound;
    updates["currentTurnIndex"] = idx;
  }

  updates["playerOrder"] = newOrder;
  updates[`players/${localPlayerId}`] = null;

  roomRef.update(updates);

  document.getElementById("game-container").style.display = "none";
  document.getElementById("lobby-container").style.display = "block";
  document.body.classList.add("lobby");

  localStorage.removeItem("roomCode");
  stopTurnTimer();
  clearInterval(startInterval);

  showNotification("Odadan çıktınız. Artık oyunda yoksunuz.");
});

/*****************************************************************
 * 12) BİNA KURMA (Kışla, Fabrika, Rafine, Değirmen, Kale)
 ****************************************************************/
document
  .getElementById("buy-barracks-btn")
  .addEventListener("click", buildBarracks);
function buildBarracks() {
  if (!selectedCountry) {
    showNotification("Önce ülke seçin!");
    return;
  }
  const qty = parseInt(document.getElementById("barracks-quantity").value);
  if (isNaN(qty) || qty <= 0) {
    showNotification("Geçerli bir adet girin!");
    return;
  }
  const cData = roomData.countryData[selectedCountry];
  if (!cData) return;
  if (cData.owner !== localPlayerId) {
    showNotification("Bu ülke size ait değil!");
    return;
  }
  // Maliyet: 300$ + 50 varil + 120 buğday
  const me = roomData.players[localPlayerId];
  const totalCostMoney = 300 * qty;
  const totalCostPetrol = 50 * qty;
  const totalCostWheat = 120 * qty;
  if (
    me.money < totalCostMoney ||
    me.petrol < totalCostPetrol ||
    me.wheat < totalCostWheat
  ) {
    showNotification("Yeterli kaynağınız yok!");
    return;
  }
  const upd = {};
  upd[`players/${localPlayerId}/money`] = me.money - totalCostMoney;
  upd[`players/${localPlayerId}/petrol`] = me.petrol - totalCostPetrol;
  upd[`players/${localPlayerId}/wheat`] = me.wheat - totalCostWheat;
  upd[`countryData/${selectedCountry}/barracksCount`] = cData.barracksCount + qty;

  roomRef.update(upd);
  broadcastNotification(
    `${me.name}, ${selectedCountry} ülkesine ${qty} adet kışla kurdu.`
  );
  showNotification(`${qty} adet kışla kuruldu.`);
}

document
  .getElementById("build-factory-btn")
  .addEventListener("click", buildFactory);
function buildFactory() {
  if (!selectedCountry) {
    showNotification("Önce ülke seçin!");
    return;
  }
  const qty = parseInt(document.getElementById("factory-quantity").value);
  if (isNaN(qty) || qty <= 0) {
    showNotification("Geçerli bir adet girin!");
    return;
  }
  const cData = roomData.countryData[selectedCountry];
  if (!cData) return;
  if (cData.owner !== localPlayerId) {
    showNotification("Bu ülke size ait değil!");
    return;
  }
  // Fabrika: 500$ + 130 varil
  const me = roomData.players[localPlayerId];
  const totalCostMoney = 500 * qty;
  const totalCostPetrol = 130 * qty;
  if (me.money < totalCostMoney || me.petrol < totalCostPetrol) {
    showNotification("Yeterli kaynağınız yok!");
    return;
  }
  const upd = {};
  upd[`players/${localPlayerId}/money`] = me.money - totalCostMoney;
  upd[`players/${localPlayerId}/petrol`] = me.petrol - totalCostPetrol;
  upd[`countryData/${selectedCountry}/factories`] = cData.factories + qty;

  roomRef.update(upd);
  broadcastNotification(
    `${me.name}, ${selectedCountry} ülkesine ${qty} adet fabrika kurdu.`
  );
  showNotification(`${qty} adet fabrika kuruldu.`);
}

document
  .getElementById("build-refinery-btn")
  .addEventListener("click", buildRefinery);
function buildRefinery() {
  if (!selectedCountry) {
    showNotification("Önce ülke seçin!");
    return;
  }
  const qty = parseInt(document.getElementById("refinery-quantity").value);
  if (isNaN(qty) || qty <= 0) {
    showNotification("Geçerli bir adet girin!");
    return;
  }
  const cData = roomData.countryData[selectedCountry];
  if (!cData) return;
  if (cData.owner !== localPlayerId) {
    showNotification("Bu ülke size ait değil!");
    return;
  }
  // Rafine: 800$ + 250 varil
  const me = roomData.players[localPlayerId];
  const totalCostMoney = 800 * qty;
  const totalCostPetrol = 250 * qty;
  if (me.money < totalCostMoney || me.petrol < totalCostPetrol) {
    showNotification("Yeterli kaynağınız yok!");
    return;
  }
  const upd = {};
  upd[`players/${localPlayerId}/money`] = me.money - totalCostMoney;
  upd[`players/${localPlayerId}/petrol`] = me.petrol - totalCostPetrol;
  upd[`countryData/${selectedCountry}/refineries`] = cData.refineries + qty;

  roomRef.update(upd);
  broadcastNotification(
    `${me.name}, ${selectedCountry} ülkesine ${qty} adet rafine kurdu.`
  );
  showNotification(`${qty} adet rafine kuruldu.`);
}

document
  .getElementById("build-grainmill-btn")
  .addEventListener("click", buildGrainMill);
function buildGrainMill() {
  if (!selectedCountry) {
    showNotification("Önce ülke seçin!");
    return;
  }
  const qty = parseInt(document.getElementById("grainmill-quantity").value);
  if (isNaN(qty) || qty <= 0) {
    showNotification("Geçerli bir adet girin!");
    return;
  }
  const cData = roomData.countryData[selectedCountry];
  if (!cData) return;
  if (cData.owner !== localPlayerId) {
    showNotification("Bu ülke size ait değil!");
    return;
  }
  // Değirmen: 200$ + 100 varil
  const me = roomData.players[localPlayerId];
  const totalCostMoney = 200 * qty;
  const totalCostPetrol = 100 * qty;
  if (me.money < totalCostMoney || me.petrol < totalCostPetrol) {
    showNotification("Yeterli kaynağınız yok!");
    return;
  }
  const upd = {};
  upd[`players/${localPlayerId}/money`] = me.money - totalCostMoney;
  upd[`players/${localPlayerId}/petrol`] = me.petrol - totalCostPetrol;
  upd[`countryData/${selectedCountry}/grainMills`] = cData.grainMills + qty;

  roomRef.update(upd);
  broadcastNotification(
    `${me.name}, ${selectedCountry} ülkesine ${qty} adet değirmen kurdu.`
  );
  showNotification(`${qty} adet değirmen kuruldu.`);
}

/** Kale Kur */
document.getElementById("build-castle-btn").addEventListener("click", buildCastle);
function buildCastle() {
  if (!selectedCountry) {
    showNotification("Önce ülke seçin!");
    return;
  }
  const c = roomData.countryData[selectedCountry];
  if (!c) return;
  if (c.owner !== localPlayerId) {
    showNotification("Bu ülke size ait değil!");
    return;
  }
  if (c.castleDefenseLevel > 0) {
    showNotification("Bu ülkede zaten kale var!");
    return;
  }
  // Kale maliyeti: 1000$ + 1000 varil + 1000 buğday
  const me = roomData.players[localPlayerId];
  if (me.money < 1000 || me.petrol < 1000 || me.wheat < 1000) {
    showNotification("Kale için yeterli kaynağınız yok!");
    return;
  }
  const upd = {};
  upd[`players/${localPlayerId}/money`] = me.money - 1000;
  upd[`players/${localPlayerId}/petrol`] = me.petrol - 1000;
  upd[`players/${localPlayerId}/wheat`] = me.wheat - 1000;
  upd[`countryData/${selectedCountry}/castleDefenseLevel`] = 1;
  upd[`countryData/${selectedCountry}/castleNextUpgradeCost`] = {
    money: 1300,
    petrol: 1300,
    wheat: 1300
  };

  roomRef.update(upd);
  broadcastNotification(`${me.name}, ${selectedCountry} ülkesine kale kurdu!`);
  showNotification("Kale kuruldu (Savunma %5).");
}

/** Kale Güçlendir */
document
  .getElementById("upgrade-castle-btn")
  .addEventListener("click", upgradeCastle);

function upgradeCastle() {
  if (!selectedCountry) {
    showNotification("Ülke seçin!");
    return;
  }
  const c = roomData.countryData[selectedCountry];
  if (!c) return;
  if (c.owner !== localPlayerId) {
    showNotification("Bu ülke size ait değil!");
    return;
  }
  if (c.castleDefenseLevel < 1) {
    showNotification("Önce kale kurun!");
    return;
  }
  if (c.castleDefenseLevel >= 6) {
    showNotification("Kale savunması maksimum (%30)!");
    return;
  }
  if (!c.castleNextUpgradeCost) {
    showNotification("Kale yükseltme maliyeti bulunamadı!");
    return;
  }
  const me = roomData.players[localPlayerId];
  const cost = c.castleNextUpgradeCost;
  if (
    me.money < cost.money ||
    me.petrol < cost.petrol ||
    me.wheat < cost.wheat
  ) {
    showNotification("Güçlendirme için yeterli kaynağınız yok!");
    return;
  }
  const upd = {};
  upd[`players/${localPlayerId}/money`] = me.money - cost.money;
  upd[`players/${localPlayerId}/petrol`] = me.petrol - cost.petrol;
  upd[`players/${localPlayerId}/wheat`] = me.wheat - cost.wheat;

  const newLevel = c.castleDefenseLevel + 1;
  upd[`countryData/${selectedCountry}/castleDefenseLevel`] = newLevel;

  // Sonraki maliyet %30 artacak
  const nextMoney = Math.floor(cost.money * 1.3);
  const nextPetrol = Math.floor(cost.petrol * 1.3);
  const nextWheat = Math.floor(cost.wheat * 1.3);
  upd[`countryData/${selectedCountry}/castleNextUpgradeCost`] = {
    money: nextMoney,
    petrol: nextPetrol,
    wheat: nextWheat
  };

  roomRef.update(upd, () => {
    updateCastleUpgradeCostUI();
  });

  broadcastNotification(
    `${me.name}, ${selectedCountry} kalesini güçlendirdi (Seviye: ${newLevel}, Savunma: %${newLevel * 5}).`
  );
  showNotification(`Kale güçlendirildi! Yeni savunma: %${newLevel * 5}.`);
}

/*****************************************************************
 * 13) CHAT SİSTEMİ (Genel + Özel)
 *****************************************************************/
document.getElementById("open-chat-btn").addEventListener("click", () => {
  toggleChat(!chatOpen);
});
document
  .getElementById("chat-popup-header")
  .addEventListener("click", (e) => {
    if (e.target.id === "chat-popup-header") {
      toggleChat(false);
    }
  });
document.getElementById("close-chat-btn").addEventListener("click", () => {
  toggleChat(false);
});
document.getElementById("send-chat-btn").addEventListener("click", () => {
  sendChatMessage();
});
document.getElementById("chat-input").addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendChatMessage();
});

function toggleChat(show) {
  const chatPopup = document.getElementById("chat-popup");
  chatPopup.style.display = show ? "flex" : "none";
  chatOpen = show;
  if (chatOpen) {
    unreadMessages = 0;
    updateChatBadge();
  }
}

function sendChatMessage() {
  const input = document.getElementById("chat-input");
  const msg = input.value.trim();
  if (!msg) return;
  if (!roomRef) {
    showNotification("Oda verisi yok!");
    return;
  }
  let senderName = "Anonim";
  if (roomData && roomData.players && roomData.players[localPlayerId]) {
    senderName = roomData.players[localPlayerId].name;
  }
  const chatMessage = {
    sender: senderName,
    senderId: localPlayerId,
    text: msg,
    recipientId: "",
    timestamp: firebase.database.ServerValue.TIMESTAMP
  };
  roomRef.child("chat").push(chatMessage, (err) => {
    if (!err) input.value = "";
  });
}

/** Özel Mesaj Gönder */
document
  .getElementById("send-private-message-btn")
  .addEventListener("click", () => {
    const privateInput = document.getElementById("private-message-input");
    const recSelect = document.getElementById("private-message-recipient");
    const msg = privateInput.value.trim();
    const recId = recSelect.value;
    if (!msg || !recId) return;

    let senderName = "Anonim";
    if (roomData && roomData.players && roomData.players[localPlayerId]) {
      senderName = roomData.players[localPlayerId].name;
    }
    const pm = {
      sender: senderName,
      senderId: localPlayerId,
      text: msg,
      recipientId: recId,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(pm, (err) => {
      if (!err) {
        privateInput.value = "";
        showNotification("Özel mesaj gönderildi!");
      }
    });
  });

function appendChatMessage(message) {
  // Özel mesaj mı?
  if (message.recipientId && message.recipientId !== "") {
    // Gönderici biz miyiz veya alıcı biz miyiz?
    if (
      message.senderId !== localPlayerId &&
      message.recipientId !== localPlayerId
    ) {
      // İlgisiz özel mesaj
      return;
    }
  }

  const chatMessagesDiv = document.getElementById("chat-messages");
  const msgDiv = document.createElement("div");

  if (message.recipientId && message.recipientId !== "") {
    // PM
    const targetName =
      roomData.players[message.recipientId]?.name || "Bilinmeyen";
    if (message.senderId === localPlayerId) {
      msgDiv.innerHTML = `<strong>[PM to ${targetName}]:</strong> ${message.text}`;
    } else {
      msgDiv.innerHTML = `<strong>[PM from ${message.sender}]:</strong> ${message.text}`;
    }
    msgDiv.style.color = "#f39c12";
  } else {
    // Genel
    msgDiv.textContent = message.sender + ": " + message.text;
  }
  chatMessagesDiv.appendChild(msgDiv);
  chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;

  // Chat kapalıysa unread++ (başka oyuncu gönderiyorsa)
  if (!chatOpen && message.senderId !== localPlayerId) {
    unreadMessages++;
    updateChatBadge();
  }
}

function updateChatBadge() {
  const btn = document.getElementById("open-chat-btn");
  if (unreadMessages > 0) {
    btn.dataset.badge = unreadMessages;
  } else {
    btn.dataset.badge = "";
  }
}

/*****************************************************************
 * 14) TİCARET (MARKET) SİSTEMİ
 *****************************************************************/
document
  .getElementById("open-market-btn")
  .addEventListener("click", () => {
    const mPopup = document.getElementById("market-popup");
    mPopup.style.display = mPopup.style.display === "flex" ? "none" : "flex";
  });
document
  .getElementById("market-popup-header")
  .addEventListener("click", (e) => {
    if (e.target.id === "market-popup-header") {
      document.getElementById("market-popup").style.display = "none";
    }
  });
document
  .getElementById("close-market-btn")
  .addEventListener("click", () => {
    document.getElementById("market-popup").style.display = "none";
  });

document
  .getElementById("create-trade-offer-btn")
  .addEventListener("click", createTradeOffer);

function createTradeOffer() {
  if (!roomData || !roomData.players[localPlayerId]) {
    showNotification("Oyun verisi yok veya geçersiz oyuncu!");
    return;
  }
  const itemType = document.getElementById("trade-item-type").value;
  const quantity = parseInt(document.getElementById("trade-quantity").value);
  const price = parseInt(document.getElementById("trade-price").value);
  if (isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
    showNotification("Geçerli adet ve fiyat girin!");
    return;
  }

  const seller = roomData.players[localPlayerId];
  let enough = false;
  if (itemType === "petrol") {
    if (seller.petrol >= quantity) enough = true;
  } else if (itemType === "wheat") {
    if (seller.wheat >= quantity) enough = true;
  }
  if (!enough) {
    showNotification("Satacak yeterli miktarınız yok!");
    return;
  }

  // Ambargo listesi
  const embargoSelect = document.getElementById("embargo-players");
  let embargoList = [];
  for (let i = 0; i < embargoSelect.options.length; i++) {
    if (embargoSelect.options[i].selected) {
      embargoList.push(embargoSelect.options[i].value);
    }
  }

  const tRef = roomRef.child("tradeOffers").push();
  const newOffer = {
    offerId: tRef.key,
    sellerId: localPlayerId,
    sellerName: seller.name,
    itemType,
    quantity,
    price,
    status: "pending",
    embargo: embargoList
  };
  tRef.set(newOffer);
  broadcastNotification(
    `${seller.name} bir ticaret teklifi oluşturdu (${itemType}, adet: ${quantity}, fiyat: ${price}$).`
  );
  showNotification("Ticaret teklifi oluşturuldu!");
}

function displayTradeOffers() {
  const listDiv = document.getElementById("trade-offers-list");
  if (!listDiv) return;
  listDiv.innerHTML = "";
  if (!roomData || !roomData.tradeOffers) return;

  Object.values(roomData.tradeOffers).forEach((offer) => {
    if (offer.status !== "pending") return;
    // Ambargo kontrol
    if (offer.embargo && offer.embargo.includes(localPlayerId)) {
      return;
    }
    const oDiv = document.createElement("div");
    oDiv.className = "offer-item";
    const itemText = offer.itemType === "petrol" ? "Petrol" : "Buğday";
    let html = `
      <p><strong>Satıcı:</strong> ${offer.sellerName}</p>
      <p><strong>Ürün:</strong> ${itemText}</p>
      <p><strong>Mevcut Miktar:</strong> ${offer.quantity}</p>
      <p><strong>Birim Fiyat:</strong> ${offer.price} $</p>
    `;
    if (offer.sellerId !== localPlayerId) {
      // Satın alma alanı
      html += `
        <label style="font-size:14px;color:#ccc;">Almak istediğiniz miktar:</label>
        <input type="number" class="partial-buy-quantity" placeholder="Miktar" min="1" max="${offer.quantity}"/>
        <button class="partial-buy-btn">Satın Al</button>
      `;
    } else {
      // İptal butonu
      html += `
        <button class="cancel-offer-btn" style="background: linear-gradient(45deg, #c0392b, #e74c3c); margin-top:10px;">
          İptal
        </button>
      `;
    }
    if (offer.embargo && offer.embargo.length > 0) {
      const embUsers = offer.embargo
        .map((e) => roomData.players[e]?.name || "???")
        .join(", ");
      html += `<p style="color:red;"><strong>Ambargo:</strong> ${embUsers}</p>`;
    }
    oDiv.innerHTML = html;

    // Satın Al butonu
    const buyBtn = oDiv.querySelector(".partial-buy-btn");
    if (buyBtn) {
      buyBtn.addEventListener("click", () => {
        const inp = oDiv.querySelector(".partial-buy-quantity");
        const amount = parseInt(inp.value);
        if (isNaN(amount) || amount <= 0) {
          showNotification("Geçerli miktar girin!");
          return;
        }
        acceptTradeOffer(offer.offerId, amount);
      });
    }
    // İptal butonu
    const cancelBtn = oDiv.querySelector(".cancel-offer-btn");
    if (cancelBtn) {
      cancelBtn.addEventListener("click", () => cancelTradeOffer(offer.offerId));
    }

    listDiv.appendChild(oDiv);
  });
}

function acceptTradeOffer(offerId, buyAmount) {
  const offer = roomData.tradeOffers[offerId];
  if (!offer || offer.status !== "pending") {
    showNotification("Teklif geçerli değil!");
    return;
  }
  const seller = roomData.players[offer.sellerId];
  const buyer = roomData.players[localPlayerId];
  if (!seller || !buyer) {
    showNotification("Satıcı veya alıcı geçersiz!");
    return;
  }
  if (buyAmount > offer.quantity) {
    showNotification("Yeterli miktar yok!");
    return;
  }
  const totalCost = offer.price * buyAmount;
  if (buyer.money < totalCost) {
    showNotification("Yeterli paranız yok!");
    return;
  }

  let updates = {};
  let hasEnough = false;
  if (offer.itemType === "petrol") {
    if (seller.petrol >= buyAmount) {
      hasEnough = true;
      updates[`players/${offer.sellerId}/petrol`] = seller.petrol - buyAmount;
      updates[`players/${localPlayerId}/petrol`] = buyer.petrol + buyAmount;
    }
  } else if (offer.itemType === "wheat") {
    if (seller.wheat >= buyAmount) {
      hasEnough = true;
      updates[`players/${offer.sellerId}/wheat`] = seller.wheat - buyAmount;
      updates[`players/${localPlayerId}/wheat`] = buyer.wheat + buyAmount;
    }
  }
  if (!hasEnough) {
    showNotification("Satıcının yeterli ürünü kalmamış!");
    return;
  }

  updates[`players/${localPlayerId}/money`] = buyer.money - totalCost;
  updates[`players/${offer.sellerId}/money`] = seller.money + totalCost;

  const newQ = offer.quantity - buyAmount;
  if (newQ <= 0) {
    updates[`tradeOffers/${offerId}/status`] = "completed";
  }
  updates[`tradeOffers/${offerId}/quantity`] = newQ;

  roomRef.update(updates, (err) => {
    if (!err) {
      broadcastNotification(
        `Ticaret: ${seller.name} -> ${buyer.name}, ${buyAmount} adet ${offer.itemType}`
      );
      showNotification("Ticaret başarıyla gerçekleşti!");
      const sysMsg = {
        sender: "Sistem",
        senderId: "system",
        text: `Ticaret Onaylandı: ${seller.name} -> ${buyer.name} (${buyAmount} x ${offer.itemType})`,
        recipientId: "",
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.child("chat").push(sysMsg);
    }
  });
}

function cancelTradeOffer(offerId) {
  const offer = roomData.tradeOffers[offerId];
  if (!offer || offer.sellerId !== localPlayerId) {
    showNotification("Yalnızca kendi teklifinizi iptal edebilirsiniz!");
    return;
  }
  if (offer.status !== "pending") {
    showNotification("Bu teklif zaten tamamlanmış veya iptal edilmiş.");
    return;
  }
  roomRef.child("tradeOffers").child(offerId).update({ status: "cancelled" });
  broadcastNotification(
    `Ticaret teklifi iptal edildi: ${offer.sellerName}`
  );
  showNotification("Teklif iptal edildi.");
}

/*****************************************************************
 * 15) HARİTA (Leaflet) KURULUMU
 *****************************************************************/
function initializeMap() {
  if (map) return;
  map = L.map("map").setView([20, 0], 2);

  L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}",
    {
      maxZoom: 12,
      attribution:
        'Tiles &copy; Esri &mdash; Source: Esri, GEBCO, NOAA, National Geographic, DeLorme, HERE, Geonames.org and others'
    }
  ).addTo(map);

  // Ülkelerin GeoJSON verisi
  fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
    .then((res) => res.json())
    .then((geoJsonData) => {
      geoJsonLayer = L.geoJson(geoJsonData, {
        style: () => ({
          color: "#555",
          weight: 1,
          fillColor: "#ccc",
          fillOpacity: 0.7
        }),
        onEachFeature: (feature, layer) => {
          const cname = feature.properties.name;
          let cinfo = {};
          if (roomData && roomData.countryData && roomData.countryData[cname]) {
            cinfo = roomData.countryData[cname];
          }
          layer.bindTooltip(getCountryPopupContent(cname, cinfo), {
            permanent: infoCardsPermanent,
            direction: "center",
            className: "country-popup-tooltip"
          });
          layer.on("click", () => selectCountry(cname, layer));
        }
      }).addTo(map);
    });
}

/** game-container görünür hale geldiğinde haritayı başlat */
const gameContainerObserver = new MutationObserver(() => {
  const gc = document.getElementById("game-container");
  if (gc.style.display !== "none") {
    initializeMap();
  }
});
gameContainerObserver.observe(document.getElementById("game-container"), {
  attributes: true,
  attributeFilter: ["style"]
});

/*****************************************************************
 * 16) BİLGİLENDİRME BUTONLARI (Örneğin Bildirimleri Kapat/Aç)
 *****************************************************************/
document
  .getElementById("open-notifications-btn")
  .addEventListener("click", () => {
    notificationsMuted = !notificationsMuted;
    if (!notificationsMuted) {
      showNotification("Bildirimler açıldı.");
    } else {
      showNotification("Bildirimler kapatıldı.");
    }
  });

/*****************************************************************
 * POPUP AÇMA/KAPAMA (Asker, Bina, Kaynak, Pakt, vs.)
 *****************************************************************/
// Asker
const militaryPopup = document.getElementById("military-popup");
document
  .getElementById("open-military-btn")
  .addEventListener("click", () => {
    militaryPopup.style.display =
      militaryPopup.style.display === "flex" ? "none" : "flex";
  });
document
  .getElementById("military-popup-header")
  .addEventListener("click", (e) => {
    if (e.target.id === "military-popup-header") {
      militaryPopup.style.display = "none";
    }
  });
document
  .getElementById("close-military-btn")
  .addEventListener("click", () => {
    militaryPopup.style.display = "none";
  });

// Bina
const buildingPopup = document.getElementById("building-popup");
document
  .getElementById("open-building-btn")
  .addEventListener("click", () => {
    buildingPopup.style.display =
      buildingPopup.style.display === "flex" ? "none" : "flex";
    updateCastleUpgradeCostUI();
  });
document
  .getElementById("building-popup-header")
  .addEventListener("click", (e) => {
    if (e.target.id === "building-popup-header") {
      buildingPopup.style.display = "none";
    }
  });
document
  .getElementById("close-building-btn")
  .addEventListener("click", () => {
    buildingPopup.style.display = "none";
  });

// Kaynak
const resourcePopup = document.getElementById("resource-popup");
document
  .getElementById("open-resource-btn")
  .addEventListener("click", () => {
    resourcePopup.style.display =
      resourcePopup.style.display === "flex" ? "none" : "flex";
  });
document
  .getElementById("resource-popup-header")
  .addEventListener("click", (e) => {
    if (e.target.id === "resource-popup-header") {
      resourcePopup.style.display = "none";
    }
  });
document
  .getElementById("close-resource-btn")
  .addEventListener("click", () => {
    resourcePopup.style.display = "none";
  });

// Oyuncular
const playersPopup = document.getElementById("players-popup");
document
  .getElementById("open-players-btn")
  .addEventListener("click", () => {
    playersPopup.style.display =
      playersPopup.style.display === "flex" ? "none" : "flex";
  });
document
  .getElementById("players-popup-header")
  .addEventListener("click", (e) => {
    if (e.target.id === "players-popup-header") {
      playersPopup.style.display = "none";
    }
  });
document
  .getElementById("close-players-btn")
  .addEventListener("click", () => {
    playersPopup.style.display = "none";
  });

// Pakt
const pactPopup = document.getElementById("pact-popup");
document
  .getElementById("open-pact-btn")
  .addEventListener("click", () => {
    pactPopup.style.display =
      pactPopup.style.display === "flex" ? "none" : "flex";
  });
document
  .getElementById("pact-popup-header")
  .addEventListener("click", (e) => {
    if (e.target.id === "pact-popup-header") {
      pactPopup.style.display = "none";
    }
  });
document.getElementById("close-pact-btn").addEventListener("click", () => {
  pactPopup.style.display = "none";
});

</script>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
</body>
</html>
