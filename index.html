<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Harita Fetih Oyunu - Online Versiyon</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- FontAwesome (Simgeler için) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  
  <!-- Inline CSS -->
  <style>
    /* Genel Sıfırlama */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #2a2a3d);
      color: #eee;
      overflow-x: hidden;
    }
    a { text-decoration: none; color: inherit; }
    
    /* Bildirim Alanı */
    #notification-area {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      display: none;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      font-size: 14px;
    }
    
    /* Oda (Lobby) Ekranı */
    #lobby-container {
      max-width: 500px;
      margin: 50px auto;
      background: #2a2a3d;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      text-align: center;
    }
    #lobby-container h2 {
      color: #f1c40f;
      margin-bottom: 15px;
    }
    #lobby-container input[type="text"],
    #lobby-container input[type="number"] {
      width: 90%;
      padding: 10px;
      margin: 8px 0;
      border: none;
      border-radius: 6px;
      font-size: 14px;
    }
    #lobby-container button {
      width: 95%;
      padding: 12px;
      margin: 8px 0;
      background: linear-gradient(45deg, #f39c12, #e67e22);
      border: none;
      border-radius: 6px;
      font-size: 16px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    #lobby-container button:hover {
      background: linear-gradient(45deg, #e67e22, #d35400);
    }
    .global-color-option {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      display: inline-block;
      margin: 0 5px;
      transition: transform 0.3s, border-color 0.3s;
    }
    .global-color-option:hover { transform: scale(1.1); border-color: #fff; }
    .global-color-option.selected { border-color: #f1c40f; }
    #room-waiting { margin-top: 20px; }
    #room-waiting ul { list-style: none; margin-top: 10px; text-align: left; }
    
    /* Oyun Ekranı */
    #game-container { display: none; height: 100vh; }
    #main-content { display: flex; height: 100%; }
    #map-container { flex: 7; position: relative; }
    #map { width: 100%; height: 100%; }
    #side-panel {
      flex: 3;
      background: #1e1e2f;
      padding: 20px;
      overflow-y: auto;
      box-shadow: -4px 0 10px rgba(0, 0, 0, 0.4);
    }
    #game-info, #player-info-section, #country-info-section, #market-section {
      margin-bottom: 20px;
      background: #2a2a3d;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #game-info h2, #player-info-section h2, #country-info-section h2, #market-section h2 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #f1c40f;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    .player-info {
      background: #24243a;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      font-size: 14px;
    }
    .action-group {
      margin-bottom: 15px;
      background: #24243a;
      padding: 12px;
      border-radius: 6px;
    }
    .action-group h3 { font-size: 16px; color: #ccc; margin-bottom: 8px; }
    .action-group input[type="number"], .action-group select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }
    .action-group button {
      width: 100%;
      padding: 10px;
      background: linear-gradient(45deg, #f39c12, #e67e22);
      border: none;
      border-radius: 4px;
      font-size: 14px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .action-group button:hover {
      background: linear-gradient(45deg, #e67e22, #d35400);
    }
    .turn-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #ddd;
      margin-bottom: 10px;
    }
    .turn-info span { font-weight: 600; color: #f1c40f; }
    
    /* Ülke Tooltip & Popup */
    .leaflet-tooltip,
    .country-popup-tooltip {
      background: rgba(0,0,0,0.7);
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      padding: 4px 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    .country-popup-tooltip {
      border-radius: 6px;
      padding: 6px 10px;
      text-align: left;
    }
    .country-popup-tooltip .emoji { margin-right: 4px; }
    
    /* Buton Ripple Efekti */
    .button-click-effect { position: relative; overflow: hidden; }
    .button-click-effect .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255,255,255,0.6);
      transform: scale(0);
      animation: ripple-animation 0.6s linear;
    }
    @keyframes ripple-animation { to { transform: scale(4); opacity: 0; } }
    
    /* Saldırı Efekti */
    .attack-effect { animation: attack-effect 0.6s; }
    @keyframes attack-effect {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.5; }
      100% { transform: scale(1); opacity: 1; }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      #main-content { flex-direction: column; }
      #map-container, #side-panel { height: 50vh; flex: unset; }
      #side-panel { box-shadow: none; border-top: 1px solid #444; }
    }
  </style>
</head>
<body>
  <!-- Bildirim Alanı -->
  <div id="notification-area"></div>
  
  <!-- Oda (Lobby) Ekranı -->
  <div id="lobby-container">
    <h2>Online Oyun Lobby</h2>
    <button id="create-room-btn">Oda Oluştur</button>
    <button id="join-room-btn">Odaya Katıl</button>
    
    <!-- Oda Oluşturma Formu -->
    <div id="create-room-form" style="display:none;">
      <input type="text" id="create-room-code" placeholder="Oda Kodu (boş bırakılırsa otomatik oluşturulur)" />
      <input type="number" id="create-player-count" placeholder="Oyuncu Sayısı (2-5)" min="2" max="5" />
      <input type="text" id="create-player-name" placeholder="Oyuncu İsminiz" />
      <p>Renk Seçiniz:</p>
      <div id="create-color-options"></div>
      <button id="confirm-create-room">Odayı Oluştur</button>
    </div>
    
    <!-- Odaya Katılma Formu -->
    <div id="join-room-form" style="display:none;">
      <input type="text" id="join-room-code" placeholder="Oda Kodu" />
      <input type="text" id="join-player-name" placeholder="Oyuncu İsminiz" />
      <p>Renk Seçiniz:</p>
      <div id="join-color-options"></div>
      <button id="confirm-join-room">Odaya Katıl</button>
    </div>
    
    <!-- Oda Bekleme Alanı -->
    <div id="room-waiting" style="display:none;">
      <h3>Oda: <span id="display-room-code"></span></h3>
      <p>Oyuncular:</p>
      <ul id="players-list"></ul>
      <button id="start-game-btn" style="display:none;">Oyunu Başlat</button>
    </div>
  </div>
  
  <!-- Oyun Ekranı -->
  <div id="game-container">
    <div id="main-content">
      <!-- Harita Bölgesi -->
      <div id="map-container">
        <div id="map"></div>
      </div>
      <!-- Sağ Panel -->
      <div id="side-panel">
        <!-- Oyun Bilgileri -->
        <section id="game-info">
          <h2>Oyun Bilgileri</h2>
          <p>Tur: <span id="current-round">1</span></p>
          <p>Toplam Petrol: <span id="total-petrol">0</span> varil</p>
        </section>
        <!-- Oyuncu Bilgileri -->
        <section id="player-info-section">
          <h2>Oyuncular</h2>
          <div id="players-info">
            <!-- Oyuncu kartları dinamik olarak oluşturulacak -->
          </div>
        </section>
        <!-- Seçili Ülke Bilgileri -->
        <section id="country-info-section">
          <h2>Ülke Detayları</h2>
          <div id="country-info">
            <p>Ülke: <span id="selected-country-name">Yok</span></p>
            <p>Sahip: <span id="selected-country-owner">Yok</span></p>
            <p>Asker: <span id="selected-country-soldiers">0</span></p>
            <p>Gelir: <span id="selected-country-income">0</span>$</p>
            <p>Kışla: <span id="selected-country-barracks">0</span></p>
            <p>Fabrika: <span id="selected-country-factories">0</span></p>
            <p>Rafine: <span id="selected-country-refineries">0</span></p>
            <p>Üretim Kapasitesi: <span id="selected-country-oilProduction">0</span> varil</p>
          </div>
        </section>
        <!-- İşlemler ve Market -->
        <section id="market-section">
          <h2>İşlemler</h2>
          <div class="action-group">
            <h3>Saldırı</h3>
            <input type="number" id="attack-soldiers" placeholder="Asker sayısı" min="1" />
            <button id="attack-btn"><i class="fas fa-crosshairs"></i> Saldırı Yap</button>
          </div>
          <div class="action-group">
            <h3>Asker Satın Alma</h3>
            <input type="number" id="soldiers-to-buy" placeholder="Adet" min="1" />
            <button id="buy-soldiers-btn"><i class="fas fa-user-plus"></i> Satın Al (10$/adet)</button>
          </div>
          <div class="action-group">
            <h3>Asker Kışlası Kur</h3>
            <button id="buy-barracks-btn"><i class="fas fa-fort-awesome"></i> Kışla Kur (130$ + 40 varil)</button>
          </div>
          <div class="action-group">
            <h3>Fabrika Kur</h3>
            <button id="build-factory-btn"><i class="fas fa-industry"></i> Fabrika Kur (250$ + 90 varil)</button>
          </div>
          <div class="action-group">
            <h3>Rafine Kur</h3>
            <button id="build-refinery-btn"><i class="fas fa-oil-can"></i> Rafine Kur (250 varil + 800$)</button>
          </div>
          <div class="action-group">
            <h3>Asker Çek</h3>
            <input type="number" id="pull-soldiers-count" placeholder="Asker sayısı" min="1" />
            <button id="pull-soldiers-btn"><i class="fas fa-running"></i> Asker Çek</button>
          </div>
          <div class="action-group">
            <h3>Para Gönder</h3>
            <input type="number" id="money-to-send" placeholder="Miktar" min="1" />
            <select id="recipient-player">
              <!-- Dinamik oyuncu seçenekleri -->
            </select>
            <button id="send-money-btn"><i class="fas fa-hand-holding-usd"></i> Para Gönder</button>
          </div>
          <div class="action-group">
            <h3>Petrol Gönder</h3>
            <input type="number" id="petrol-to-send" placeholder="Varil" min="1" />
            <select id="recipient-player-petrol">
              <!-- Dinamik oyuncu seçenekleri -->
            </select>
            <button id="send-petrol-btn"><i class="fas fa-gas-pump"></i> Petrol Gönder</button>
          </div>
          <div class="action-group">
            <h3>Tur</h3>
            <p>Sıra: <span id="current-player">Oyuncu Adı</span></p>
            <button id="end-turn-btn"><i class="fas fa-forward"></i> Tur Sonu</button>
          </div>
        </section>
      </div>
    </div>
  </div>
  
  <!-- Ülke Tooltip Şablonu -->
  <template id="country-popup-template">
    <div class="country-popup">
      <p><span class="emoji"><i class="fas fa-money-bill-wave"></i></span> Gelir: <span class="income"></span>$</p>
      <p><span class="emoji"><i class="fas fa-users"></i></span> Asker: <span class="soldiers"></span></p>
      <p><span class="emoji"><i class="fas fa-fort-awesome"></i></span> Kışla: <span class="barracks"></span></p>
      <p><span class="emoji"><i class="fas fa-industry"></i></span> Fabrika: <span class="factories"></span></p>
      <p><span class="emoji"><i class="fas fa-oil-can"></i></span> Rafine: <span class="refineries"></span></p>
      <p><span class="emoji"><i class="fas fa-gas-pump"></i></span> Üretim Kapasitesi: <span class="oilProduction"></span> varil</p>
      <p><span class="emoji"><i class="fas fa-crown"></i></span> Sahip: <span class="owner"></span></p>
    </div>
  </template>
  
  <!-- Firebase & Leaflet JS -->
  <!-- Firebase compat sürümü -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  
  <!-- Oyun ve Online İşlevler JS -->
  <script>
    /*****************************************************************
     * Firebase Ayarları ve Global Değişkenler
     *****************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyCINihMNGs-qRYIIBLzXyeaLnM_Lhp-iwg",
      authDomain: "warmapg-77acb.firebaseapp.com",
      databaseURL: "https://warmapg-77acb-default-rtdb.firebaseio.com",
      projectId: "warmapg-77acb",
      storageBucket: "warmapg-77acb.firebasestorage.app",
      messagingSenderId: "895613631339",
      appId: "1:895613631339:web:a7ecc0cfd8ab3ae7e02a2e",
      measurementId: "G-6SJVLLVDCF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Online oyun global değişkenleri
    let roomCode = null;
    let playerId = null;
    let isHost = false;
    let localGameState = null;
    let localPlayers = null;
    let localCountryLayers = {};  // Harita katman referansları
    let selectedCountry = null;
    let map;
    let selectedColor = null;
    const availableColors = ["red", "blue", "green", "yellow", "purple"];
    
    /*****************************************************************
     * Yardımcı Fonksiyonlar
     *****************************************************************/
    // animate.css animasyon fonksiyonu
    function animateWithAnimateCSS(element, animationName, callback) {
      element.classList.add("animate__animated", animationName);
      function handleAnimationEnd(event) {
        event.stopPropagation();
        element.classList.remove("animate__animated", animationName);
        element.removeEventListener("animationend", handleAnimationEnd);
        if (typeof callback === "function") callback();
      }
      element.addEventListener("animationend", handleAnimationEnd);
    }
    
    // Buton ripple efekti
    function createRipple(e) {
      const button = e.currentTarget;
      const circle = document.createElement("span");
      circle.classList.add("ripple");
      const diameter = Math.max(button.clientWidth, button.clientHeight);
      circle.style.width = circle.style.height = `${diameter}px`;
      const rect = button.getBoundingClientRect();
      circle.style.left = `${e.clientX - rect.left - diameter / 2}px`;
      circle.style.top = `${e.clientY - rect.top - diameter / 2}px`;
      button.appendChild(circle);
      setTimeout(() => circle.remove(), 500);
    }
    
    // Bildirim gösterme fonksiyonu
    function showNotification(message, duration = 3000) {
      const notificationArea = document.getElementById("notification-area");
      notificationArea.innerHTML = `<div class="popup">${message}</div>`;
      notificationArea.style.display = "flex";
      notificationArea.style.opacity = 0;
      notificationArea.style.transform = "translateY(-20px)";
      setTimeout(() => {
        notificationArea.style.transition = "opacity 0.5s, transform 0.5s";
        notificationArea.style.opacity = 1;
        notificationArea.style.transform = "translateY(0)";
      }, 10);
      setTimeout(() => {
        notificationArea.style.opacity = 0;
        notificationArea.style.transform = "translateY(-20px)";
        setTimeout(() => { notificationArea.style.display = "none"; }, 500);
      }, duration);
    }
    
    // Harita katmanına saldırı efektini uygular
    function flashLayer(layer, flashColor) {
      const originalStyle = {
        fillColor: layer.options.fillColor,
        weight: layer.options.weight,
        color: layer.options.color,
      };
      layer.setStyle({ fillColor: flashColor, weight: 3 });
      if (layer.getElement) {
        const elem = layer.getElement();
        if (elem) {
          elem.classList.add("attack-effect");
          setTimeout(() => elem.classList.remove("attack-effect"), 600);
        }
      }
      setTimeout(() => layer.setStyle(originalStyle), 600);
    }
    
    /*****************************************************************
     * Oda (Lobby) İşlemleri
     *****************************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      // Tüm butonlara ripple efekti ekle
      document.querySelectorAll("button").forEach((btn) => {
        btn.classList.add("button-click-effect");
        btn.addEventListener("click", createRipple);
      });
      initLobby();
    });
    
    function generateRoomCode() {
      return Math.random().toString(36).substring(2,8).toUpperCase();
    }
    
    function initLobby() {
      const createRoomBtn = document.getElementById("create-room-btn");
      const joinRoomBtn = document.getElementById("join-room-btn");
      const createRoomForm = document.getElementById("create-room-form");
      const joinRoomForm = document.getElementById("join-room-form");
      const roomWaiting = document.getElementById("room-waiting");
      const startGameBtn = document.getElementById("start-game-btn");
      
      createRoomBtn.addEventListener("click", () => {
        createRoomForm.style.display = "block";
        joinRoomForm.style.display = "none";
      });
      joinRoomBtn.addEventListener("click", () => {
        joinRoomForm.style.display = "block";
        createRoomForm.style.display = "none";
      });
      
      // Renk seçeneklerini doldur
      const createColorDiv = document.getElementById("create-color-options");
      availableColors.forEach(color => {
        const btn = document.createElement("button");
        btn.className = "global-color-option";
        btn.style.background = color;
        btn.dataset.color = color;
        btn.addEventListener("click", function() {
          createColorDiv.querySelectorAll(".global-color-option").forEach(s => s.classList.remove("selected"));
          btn.classList.add("selected");
          selectedColor = color;
        });
        createColorDiv.appendChild(btn);
      });
      const joinColorDiv = document.getElementById("join-color-options");
      availableColors.forEach(color => {
        const btn = document.createElement("button");
        btn.className = "global-color-option";
        btn.style.background = color;
        btn.dataset.color = color;
        btn.addEventListener("click", function() {
          joinColorDiv.querySelectorAll(".global-color-option").forEach(s => s.classList.remove("selected"));
          btn.classList.add("selected");
          selectedColor = color;
        });
        joinColorDiv.appendChild(btn);
      });
      
      // Oda oluşturma
      document.getElementById("confirm-create-room").addEventListener("click", () => {
        let inputRoomCode = document.getElementById("create-room-code").value.trim();
        roomCode = inputRoomCode ? inputRoomCode.toUpperCase() : generateRoomCode();
        const playerCount = parseInt(document.getElementById("create-player-count").value);
        if(isNaN(playerCount) || playerCount < 2 || playerCount > 5) {
          showNotification("Oyuncu sayısı 2 ile 5 arasında olmalı!");
          return;
        }
        const playerName = document.getElementById("create-player-name").value.trim();
        if(!playerName) { showNotification("Lütfen isminizi girin!"); return; }
        if(!selectedColor) { showNotification("Lütfen bir renk seçin!"); return; }
        
        // Host için benzersiz playerId üret
        playerId = firebase.database().ref().push().key;
        isHost = true;
        localPlayers = {};
        localPlayers[playerId] = {
          name: playerName,
          color: selectedColor,
          money: 1000,
          soldiers: 0,
          countries: [],
          petrol: 0,
          order: 1
        };
        const roomData = {
          settings: { totalPlayers: playerCount, host: playerId },
          players: localPlayers,
          gameStarted: false,
          gameState: null
        };
        db.ref("rooms/" + roomCode).set(roomData, (error) => {
          if(error) { showNotification("Oda oluşturulamadı!"); }
          else {
            showNotification("Oda oluşturuldu! Oda Kodu: " + roomCode);
            enterRoomLobby();
          }
        });
      });
      
      // Odaya katılma
      document.getElementById("confirm-join-room").addEventListener("click", () => {
        roomCode = document.getElementById("join-room-code").value.trim().toUpperCase();
        if(!roomCode) { showNotification("Lütfen oda kodunu girin!"); return; }
        const playerName = document.getElementById("join-player-name").value.trim();
        if(!playerName) { showNotification("Lütfen isminizi girin!"); return; }
        if(!selectedColor) { showNotification("Lütfen bir renk seçin!"); return; }
        
        db.ref("rooms/" + roomCode).once("value").then(snapshot => {
          if(!snapshot.exists()) { showNotification("Oda bulunamadı!"); return; }
          const roomData = snapshot.val();
          if(roomData.gameStarted) { showNotification("Oyun zaten başladı!"); return; }
          const totalPlayers = roomData.settings.totalPlayers;
          const currentPlayers = roomData.players ? Object.keys(roomData.players).length : 0;
          if(currentPlayers >= totalPlayers) { showNotification("Oda dolu!"); return; }
          
          playerId = firebase.database().ref().push().key;
          isHost = false;
          const order = currentPlayers + 1;
          const newPlayer = {
            name: playerName,
            color: selectedColor,
            money: 1000,
            soldiers: 0,
            countries: [],
            petrol: 0,
            order: order
          };
          db.ref("rooms/" + roomCode + "/players/" + playerId).set(newPlayer, (error) => {
            if(error) { showNotification("Odaya katılamadınız!"); }
            else {
              showNotification("Odaya katıldınız!");
              enterRoomLobby();
            }
          });
        });
      });
      
      function enterRoomLobby() {
        createRoomForm.style.display = "none";
        joinRoomForm.style.display = "none";
        document.getElementById("room-waiting").style.display = "block";
        document.getElementById("display-room-code").textContent = roomCode;
        
        // Oyuncu listesini dinle
        db.ref("rooms/" + roomCode + "/players").on("value", snapshot => {
          localPlayers = snapshot.val();
          updatePlayersList();
          db.ref("rooms/" + roomCode + "/settings/totalPlayers").once("value").then(snap => {
            const required = snap.val();
            if(isHost && snapshot.numChildren() === required)
              startGameBtn.style.display = "block";
            else
              startGameBtn.style.display = "none";
          });
        });
        
        // Oyun başladı mı dinle
        db.ref("rooms/" + roomCode + "/gameStarted").on("value", snapshot => {
          if(snapshot.val() === true) {
            document.getElementById("lobby-container").style.display = "none";
            document.getElementById("game-container").style.display = "block";
            initGame();
          }
        });
      }
      
      function updatePlayersList() {
        const playersList = document.getElementById("players-list");
        playersList.innerHTML = "";
        for(let pid in localPlayers) {
          const li = document.createElement("li");
          li.textContent = localPlayers[pid].name + " (" + localPlayers[pid].color + ")";
          playersList.appendChild(li);
        }
      }
      
      // Host: Oyunu başlatma
      startGameBtn.addEventListener("click", () => {
        if(!isHost) return;
        fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
          .then(response => response.json())
          .then(geoJsonData => {
            const features = geoJsonData.features;
            let countryData = {};
            let oilIndexes = [];
            if(features.length > 43) {
              while(oilIndexes.length < 43) {
                const randIdx = Math.floor(Math.random() * features.length);
                if(!oilIndexes.includes(randIdx))
                  oilIndexes.push(randIdx);
              }
            }
            features.forEach((feature, idx) => {
              const countryName = feature.properties.name;
              let oilProduction = 0;
              if(oilIndexes.includes(idx))
                oilProduction = Math.floor(Math.random() * (1000 - 250 + 1)) + 250;
              countryData[countryName] = {
                income: Math.floor(Math.random() * 500) + 100,
                soldiers: 0,
                owner: null,
                barracksCount: 0,
                factories: 0,
                refineries: 0,
                oilProduction: oilProduction
              };
            });
            localGameState = { currentPlayer: 1, currentRound: 1, countryData: countryData };
            db.ref("rooms/" + roomCode + "/gameState").set(localGameState);
            db.ref("rooms/" + roomCode).update({ gameStarted: true });
          });
      });
    }
    
    /*****************************************************************
     * Oyun İşlemleri ve UI Güncellemeleri
     *****************************************************************/
    function initGame() {
      // Haritayı başlat
      map = L.map("map").setView([20, 0], 2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 18 }).addTo(map);
      // GeoJSON ile ülke katmanlarını oluştur ve referansları sakla
      fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
        .then(response => response.json())
        .then(geoJsonData => {
          L.geoJson(geoJsonData, {
            style: function(feature) {
              const countryName = feature.properties.name;
              let fillColor = "#ccc";
              if(localGameState && localGameState.countryData && localGameState.countryData[countryName] && localGameState.countryData[countryName].owner) {
                const ownerOrder = localGameState.countryData[countryName].owner;
                for(let pid in localPlayers) {
                  if(localPlayers[pid].order === ownerOrder) { fillColor = localPlayers[pid].color; break; }
                }
              }
              return { color: "#555", weight: 1, fillColor: fillColor, fillOpacity: 0.7 };
            },
            onEachFeature: function(feature, layer) {
              const countryName = feature.properties.name;
              localCountryLayers[countryName] = layer;
              layer.bindTooltip(getCountryPopupContent(countryName), {
                permanent: true,
                direction: "center",
                className: "country-popup-tooltip"
              });
              layer.on("click", () => selectCountry(countryName, layer));
            }
          }).addTo(map);
        });
      // Oyun durumunu ve oyuncu verilerini Firebase’den dinle
      db.ref("rooms/" + roomCode + "/gameState").on("value", snapshot => {
        localGameState = snapshot.val();
        updateGameUI();
      });
      db.ref("rooms/" + roomCode + "/players").on("value", snapshot => {
        localPlayers = snapshot.val();
        updatePlayersUI();
      });
    }
    
    function getCountryPopupContent(countryName) {
      if(!localGameState || !localGameState.countryData || !localGameState.countryData[countryName]) return "";
      const c = localGameState.countryData[countryName];
      let ownerText = "Yok";
      if(c.owner) {
        for(let pid in localPlayers) {
          if(localPlayers[pid].order === c.owner) { ownerText = localPlayers[pid].name; break; }
        }
      }
      const effectiveIncome = c.factories ? Math.floor(c.income * (1 + 0.25 * c.factories)) : c.income;
      const effectiveProduction = c.oilProduction ? Math.floor(c.oilProduction * (1 + 0.20 * (c.refineries || 0))) : 0;
      return `
        <div class="country-popup">
          <p><span class="emoji"><i class="fas fa-money-bill-wave"></i></span> Gelir: ${effectiveIncome}$</p>
          <p><span class="emoji"><i class="fas fa-users"></i></span> Asker: ${c.soldiers}</p>
          <p><span class="emoji"><i class="fas fa-fort-awesome"></i></span> Kışla: ${c.barracksCount || 0}</p>
          <p><span class="emoji"><i class="fas fa-industry"></i></span> Fabrika: ${c.factories || 0}</p>
          <p><span class="emoji"><i class="fas fa-oil-can"></i></span> Rafine: ${c.refineries || 0}</p>
          <p><span class="emoji"><i class="fas fa-gas-pump"></i></span> Üretim Kapasitesi: ${effectiveProduction} varil</p>
          <p><span class="emoji"><i class="fas fa-crown"></i></span> Sahip: ${ownerText}</p>
        </div>
      `;
    }
    
    function selectCountry(countryName, layer) {
      selectedCountry = countryName;
      showNotification("Seçilen ülke: " + countryName, 1500);
      layer.setStyle({ weight: 4, color: "#FF4500" });
      setTimeout(() => {
        let fillColor = "#ccc";
        if(localGameState && localGameState.countryData[countryName] && localGameState.countryData[countryName].owner) {
          const ownerOrder = localGameState.countryData[countryName].owner;
          for(let pid in localPlayers) {
            if(localPlayers[pid].order === ownerOrder) { fillColor = localPlayers[pid].color; break; }
          }
        }
        layer.setStyle({ fillColor: fillColor, fillOpacity: 0.7, weight: 1, color: "#555" });
      }, 800);
      updateSelectedCountryInfo();
    }
    
    function updateSelectedCountryInfo() {
      if(selectedCountry && localGameState && localGameState.countryData[selectedCountry]) {
        const c = localGameState.countryData[selectedCountry];
        document.getElementById("selected-country-name").textContent = selectedCountry;
        let ownerName = "Yok";
        if(c.owner) {
          for(let pid in localPlayers) {
            if(localPlayers[pid].order === c.owner) { ownerName = localPlayers[pid].name; break; }
          }
        }
        document.getElementById("selected-country-owner").textContent = ownerName;
        document.getElementById("selected-country-soldiers").textContent = c.soldiers;
        const effectiveIncome = c.factories ? Math.floor(c.income * (1 + 0.25 * c.factories)) : c.income;
        document.getElementById("selected-country-income").textContent = effectiveIncome;
        document.getElementById("selected-country-barracks").textContent = c.barracksCount || 0;
        document.getElementById("selected-country-factories").textContent = c.factories || 0;
        document.getElementById("selected-country-refineries").textContent = c.refineries || 0;
        const effectiveProduction = c.oilProduction ? Math.floor(c.oilProduction * (1 + 0.20 * (c.refineries || 0))) : 0;
        document.getElementById("selected-country-oilProduction").textContent = effectiveProduction;
      } else {
        document.getElementById("selected-country-name").textContent = "Yok";
        document.getElementById("selected-country-owner").textContent = "Yok";
        document.getElementById("selected-country-soldiers").textContent = 0;
        document.getElementById("selected-country-income").textContent = 0;
        document.getElementById("selected-country-barracks").textContent = 0;
        document.getElementById("selected-country-factories").textContent = 0;
        document.getElementById("selected-country-refineries").textContent = 0;
        document.getElementById("selected-country-oilProduction").textContent = 0;
      }
    }
    
    function updateGameUI() {
      if(localGameState) {
        document.getElementById("current-round").textContent = localGameState.currentRound;
      }
      updateSelectedCountryInfo();
      updateMapStyles();
    }
    
    function updatePlayersUI() {
      for(let pid in localPlayers) {
        const player = localPlayers[pid];
        let playerDiv = document.getElementById("player-info-" + pid);
        if(!playerDiv) {
          playerDiv = document.createElement("div");
          playerDiv.className = "player-info";
          playerDiv.id = "player-info-" + pid;
          playerDiv.innerHTML = `
            <p><strong>${player.name}</strong></p>
            <p>Para: <span id="money-${pid}">${player.money}</span>$</p>
            <p>Asker: <span id="soldiers-${pid}">${player.soldiers}</span></p>
            <p>Ülkeler: <span id="countries-${pid}">${player.countries.length}</span></p>
            <p>Petrol: <span id="petrol-${pid}">${player.petrol}</span> varil</p>
          `;
          document.getElementById("players-info").appendChild(playerDiv);
        } else {
          document.getElementById("money-" + pid).textContent = player.money;
          document.getElementById("soldiers-" + pid).textContent = player.soldiers;
          document.getElementById("countries-" + pid).textContent = player.countries.length;
          document.getElementById("petrol-" + pid).textContent = player.petrol;
        }
        if(localGameState && localGameState.currentPlayer) {
          document.getElementById("current-player").textContent = getPlayerNameByOrder(localGameState.currentPlayer);
        }
      }
    }
    
    function updateMapStyles() {
      if(!localGameState || !localGameState.countryData) return;
      for(const countryName in localGameState.countryData) {
        const c = localGameState.countryData[countryName];
        const layer = localCountryLayers[countryName];
        if(layer) {
          let fillColor = "#ccc";
          if(c.owner) {
            for(const pid in localPlayers) {
              if(localPlayers[pid].order === c.owner) { fillColor = localPlayers[pid].color; break; }
            }
          }
          layer.setStyle({ fillColor: fillColor, fillOpacity: 0.7 });
          layer.setTooltipContent(getCountryPopupContent(countryName));
        }
      }
    }
    
    function getPlayerNameByOrder(order) {
      for(const pid in localPlayers) {
        if(localPlayers[pid].order === order) { return localPlayers[pid].name; }
      }
      return "";
    }
    
    /*****************************************************************
     * Oyun İşlemleri (Buton Event'leri)
     *****************************************************************/
    function attack() {
      if(!selectedCountry) { showNotification("Bir ülke seçin!"); return; }
      const soldiersToSend = parseInt(document.getElementById("attack-soldiers").value);
      if(isNaN(soldiersToSend) || soldiersToSend <= 0) { showNotification("Geçerli bir asker sayısı girin!"); return; }
      const myOrder = localPlayers[playerId].order;
      if(myOrder !== localGameState.currentPlayer) { showNotification("Sıra sizde değil!"); return; }
      if(localPlayers[playerId].soldiers < soldiersToSend) { showNotification("Yeterli askeriniz yok!"); return; }
      const target = localGameState.countryData[selectedCountry];
      if(target.owner === myOrder) {
        target.soldiers += soldiersToSend;
        localPlayers[playerId].soldiers -= soldiersToSend;
        showNotification(`${selectedCountry} ülkesine ${soldiersToSend} asker ekleniyor.`);
      } else {
        localPlayers[playerId].soldiers -= soldiersToSend;
        if(soldiersToSend > target.soldiers) {
          const remaining = soldiersToSend - target.soldiers;
          target.soldiers = remaining;
          const previousOwner = target.owner;
          target.owner = myOrder;
          for(const pid in localPlayers) {
            if(localPlayers[pid].order === previousOwner) {
              const idx = localPlayers[pid].countries.indexOf(selectedCountry);
              if(idx !== -1) localPlayers[pid].countries.splice(idx, 1);
            }
          }
          localPlayers[playerId].countries.push(selectedCountry);
          const layer = localCountryLayers[selectedCountry];
          if(layer) {
            layer.setStyle({ fillColor: localPlayers[playerId].color, fillOpacity: 0.7 });
            flashLayer(layer, "#FF6347");
          }
          showNotification(`${selectedCountry} fethedildi!`);
        } else {
          target.soldiers -= soldiersToSend;
          const layer = localCountryLayers[selectedCountry];
          if(layer) { flashLayer(layer, "#FF6347"); }
          showNotification(`${selectedCountry} savunuldu!`);
        }
        nextTurn();
      }
      updateFirebaseState();
    }
    
    function buySoldiers() {
      const count = parseInt(document.getElementById("soldiers-to-buy").value);
      if(isNaN(count) || count <= 0) { showNotification("Geçerli bir asker sayısı girin!"); return; }
      const cost = count * 10;
      if(localPlayers[playerId].money < cost) { showNotification("Yeterli paranız yok!"); return; }
      localPlayers[playerId].money -= cost;
      localPlayers[playerId].soldiers += count;
      showNotification(`${count} asker satın alındı.`);
      updateFirebaseState();
    }
    
    function buyBarracks() {
      if(!selectedCountry) { showNotification("Lütfen bir ülke seçin!"); return; }
      const target = localGameState.countryData[selectedCountry];
      const myOrder = localPlayers[playerId].order;
      if(target.owner !== myOrder) { showNotification("Bu ülke size ait değil!"); return; }
      if(localPlayers[playerId].money < 130) { showNotification("Yeterli paranız yok!"); return; }
      if(localPlayers[playerId].petrol < 40) { showNotification("Yeterli petrolünüz yok!"); return; }
      localPlayers[playerId].money -= 130;
      localPlayers[playerId].petrol -= 40;
      target.barracksCount = (target.barracksCount || 0) + 1;
      showNotification("Asker kışlası kuruldu.");
      updateFirebaseState();
    }
    
    function buildFactory() {
      if(!selectedCountry) { showNotification("Lütfen bir ülke seçin!"); return; }
      const target = localGameState.countryData[selectedCountry];
      const myOrder = localPlayers[playerId].order;
      if(target.owner !== myOrder) { showNotification("Bu ülke size ait değil!"); return; }
      if(localPlayers[playerId].money < 250) { showNotification("Yeterli paranız yok!"); return; }
      if(localPlayers[playerId].petrol < 90) { showNotification("Yeterli petrolünüz yok!"); return; }
      localPlayers[playerId].money -= 250;
      localPlayers[playerId].petrol -= 90;
      target.factories = (target.factories || 0) + 1;
      showNotification("Fabrika kuruldu.");
      updateFirebaseState();
    }
    
    function buildRefinery() {
      if(!selectedCountry) { showNotification("Lütfen bir ülke seçin!"); return; }
      const target = localGameState.countryData[selectedCountry];
      const myOrder = localPlayers[playerId].order;
      if(target.owner !== myOrder) { showNotification("Bu ülke size ait değil!"); return; }
      if(!target.oilProduction) { showNotification("Bu ülkede üretim kapasitesi bulunmuyor!"); return; }
      if(localPlayers[playerId].money < 800) { showNotification("Yeterli paranız yok!"); return; }
      if(localPlayers[playerId].petrol < 250) { showNotification("Yeterli petrolünüz yok! (250 varil gereklidir)"); return; }
      localPlayers[playerId].money -= 800;
      localPlayers[playerId].petrol -= 250;
      target.refineries = (target.refineries || 0) + 1;
      showNotification("Rafine kuruldu. Üretim kapasitesi %20 arttı.");
      updateFirebaseState();
    }
    
    function pullSoldiers() {
      if(!selectedCountry) { showNotification("Bir ülke seçin!"); return; }
      const target = localGameState.countryData[selectedCountry];
      const myOrder = localPlayers[playerId].order;
      if(target.owner !== myOrder) { showNotification("Bu ülke size ait değil!"); return; }
      const count = parseInt(document.getElementById("pull-soldiers-count").value);
      if(isNaN(count) || count <= 0) { showNotification("Geçerli bir asker sayısı girin!"); return; }
      if(target.soldiers < count) { showNotification("Bu ülkede yeterli asker yok!"); return; }
      target.soldiers -= count;
      localPlayers[playerId].soldiers += count;
      showNotification(`${selectedCountry} ülkesinden ${count} asker çekildi.`);
      updateFirebaseState();
    }
    
    function nextTurn() {
      const currentOrder = localGameState.currentPlayer;
      for(const pid in localPlayers) {
        if(localPlayers[pid].order === currentOrder) {
          localPlayers[pid].countries.forEach(countryName => {
            const country = localGameState.countryData[countryName];
            if(country.barracksCount) { country.soldiers += 5 * country.barracksCount; }
            let effectiveIncome = country.income;
            if(country.factories) { effectiveIncome = Math.floor(country.income * (1 + 0.25 * country.factories)); }
            localPlayers[pid].money += effectiveIncome;
            if(country.oilProduction) {
              const effectiveProduction = Math.floor(country.oilProduction * (1 + 0.20 * (country.refineries || 0)));
              localPlayers[pid].petrol += effectiveProduction;
            }
          });
        }
      }
      const orders = [];
      for(const pid in localPlayers) { orders.push(localPlayers[pid].order); }
      const maxOrder = Math.max(...orders);
      if(localGameState.currentPlayer === maxOrder) { localGameState.currentRound++; }
      localGameState.currentPlayer = (localGameState.currentPlayer % maxOrder) + 1;
      showNotification(`Sıra ${getPlayerNameByOrder(localGameState.currentPlayer)} oyuncuya geçti.`, 1500);
      updateFirebaseState();
    }
    
    function sendMoney() {
      const amount = parseInt(document.getElementById("money-to-send").value);
      const recipientOrder = parseInt(document.getElementById("recipient-player").value);
      if(isNaN(amount) || amount <= 0) { showNotification("Geçerli bir miktar girin!"); return; }
      if(localPlayers[playerId].money < amount) { showNotification("Yeterli paranız yok!"); return; }
      if(localPlayers[playerId].order === recipientOrder) { showNotification("Kendinize para gönderemezsiniz!"); return; }
      let recipientId = null;
      for(const pid in localPlayers) {
        if(localPlayers[pid].order === recipientOrder) { recipientId = pid; break; }
      }
      if(recipientId) {
        localPlayers[playerId].money -= amount;
        localPlayers[recipientId].money += amount;
        showNotification(`${amount}$, ${localPlayers[recipientId].name} oyuncusuna gönderildi.`);
        updateFirebaseState();
      }
    }
    
    function sendPetrol() {
      const amount = parseInt(document.getElementById("petrol-to-send").value);
      const recipientOrder = parseInt(document.getElementById("recipient-player-petrol").value);
      if(isNaN(amount) || amount <= 0) { showNotification("Geçerli bir miktar girin!"); return; }
      if(localPlayers[playerId].petrol < amount) { showNotification("Yeterli petrolünüz yok!"); return; }
      if(localPlayers[playerId].order === recipientOrder) { showNotification("Kendinize petrol gönderemezsiniz!"); return; }
      let recipientId = null;
      for(const pid in localPlayers) {
        if(localPlayers[pid].order === recipientOrder) { recipientId = pid; break; }
      }
      if(recipientId) {
        localPlayers[playerId].petrol -= amount;
        localPlayers[recipientId].petrol += amount;
        showNotification(`${amount} varil, ${localPlayers[recipientId].name} oyuncusuna gönderildi.`);
        updateFirebaseState();
      }
    }
    
    function updateFirebaseState() {
      db.ref("rooms/" + roomCode + "/gameState").set(localGameState);
      db.ref("rooms/" + roomCode + "/players").set(localPlayers);
    }
    
    // Event listener'ları ekle
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("attack-btn").addEventListener("click", attack);
      document.getElementById("buy-soldiers-btn").addEventListener("click", buySoldiers);
      document.getElementById("buy-barracks-btn").addEventListener("click", buyBarracks);
      document.getElementById("build-factory-btn").addEventListener("click", buildFactory);
      document.getElementById("build-refinery-btn").addEventListener("click", buildRefinery);
      document.getElementById("send-money-btn").addEventListener("click", sendMoney);
      document.getElementById("send-petrol-btn").addEventListener("click", sendPetrol);
      document.getElementById("end-turn-btn").addEventListener("click", nextTurn);
      document.getElementById("pull-soldiers-btn").addEventListener("click", pullSoldiers);
    });
  </script>
</body>
</html>
