<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <!-- Mobil cihazlarda uygun ölçeklendirme ve görünüm için -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Global Conquest - Online</title>

  <!-- Google Fonts: Cinzel (askeri, dramatik his için) -->
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap"
    rel="stylesheet"
  />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <!-- FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- Animate.css -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
  />

  <style>
    /**********************************************************
     * GENEL SIFIRLAMA & GLOBAL AYARLAR
     **********************************************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Cinzel", serif;
      color: #eee;
      overflow-x: hidden;
      transition: background 0.5s;
    }
    a {
      text-decoration: none;
      color: inherit;
    }

    /**********************************************************
     * LOBI SAYFASI TASARIMI (OKYANUS TEMASI)
     **********************************************************/
    body.lobby {
      background: linear-gradient(180deg, #0a1f44 0%, #0b2a63 35%, #0b3553 100%);
      background-attachment: fixed;
      background-size: cover;
    }

    #lobby-container {
      max-width: 500px;
      margin: 60px auto;
      padding: 30px;
      background: rgba(0, 0, 0, 0.65);
      border: 2px solid #1abc9c;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      animation: fadeInLobby 1s ease forwards;
    }
    @keyframes fadeInLobby {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #lobby-container h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #1abc9c;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: 38px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
      animation: animateTitle 1s ease;
    }
    @keyframes animateTitle {
      0% {
        letter-spacing: 8px;
        opacity: 0;
      }
      100% {
        letter-spacing: 3px;
        opacity: 1;
      }
    }

    #lobby-container h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #aef7f2;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 24px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
    }

    #lobby-container input[type="text"],
    #lobby-container input[type="number"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #1abc9c;
      border-radius: 4px;
      font-size: 16px;
      outline: none;
      color: #333;
      transition: box-shadow 0.3s;
    }
    #lobby-container input[type="text"]:focus,
    #lobby-container input[type="number"]:focus {
      box-shadow: 0 0 8px #1abc9c;
    }

    #lobby-container button {
      width: 100%;
      padding: 14px;
      margin-bottom: 15px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: 1px solid #16a085;
      border-radius: 6px;
      font-size: 18px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.7);
      transition: background 0.3s, transform 0.3s;
    }
    #lobby-container button:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
      transform: scale(1.02);
    }

    .color-options {
      margin-bottom: 15px;
      text-align: center;
    }
    .global-color-option {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      display: inline-block;
      margin: 0 5px;
      transition: transform 0.3s, border-color 0.3s;
    }
    .global-color-option:hover {
      transform: scale(1.2);
      border-color: #fff;
    }
    .global-color-option.selected {
      border-color: #f1c40f;
    }

    /**********************************************************
     * BİLDİRİM ALANI (POPUP) - 6s EKRANDA KALAN
     **********************************************************/
    #notification-area {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .notification-item {
      min-width: 200px;
      max-width: 350px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
      font-size: 16px;
      line-height: 1.4;
      opacity: 0;
      transform: translateX(100%);
      animation: slideIn 0.5s forwards, fadeOut 0.5s 5.5s forwards;
    }
    @keyframes slideIn {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    /**********************************************************
     * OYUN EKRANI STİLLERİ
     **********************************************************/
    #game-container {
      display: none;
      height: 100vh;
      background: linear-gradient(180deg, #0b2a63 0%, #0a1f44 100%);
      position: relative;
    }

    /* Harita Alanı */
    #map-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
      background-color: #0e2740;
    }

    /* Bilgi Kartları Toggle Butonu */
    .toggle-info-cards {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1100;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
    }

    /**********************************************************
     * ÜST BİLGİ (TUR, ODA KODU, SIRA) + BAŞLAT BUTONU
     **********************************************************/
    #top-info {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3000;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    #top-info p {
      margin: 0;
      font-size: 16px;
    }
    #top-info p span {
      font-weight: 600;
      color: #f39c12;
    }
    #end-turn-btn {
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #end-turn-btn:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }

    /* 60 saniyelik sayaç (estetik) */
    #turn-timer {
      font-size: 14px;
      color: #f39c12;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* OYUNU BAŞLAT BUTONU + SAYIM GÖSTERGELERİ */
    #start-game-btn {
      background: linear-gradient(45deg, #2ecc71, #27ae60);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.3s;
      display: none; /* Sadece host görecek */
    }
    #start-game-btn:hover {
      background: linear-gradient(45deg, #27ae60, #2ecc71);
    }
    #start-countdown {
      font-size: 16px;
      color: #f39c12;
      display: none;
    }

    /**********************************************************
     * ALT BİLDİRGELER (CHAT, MARKET, vs.) ve DİĞER İKONLAR
     **********************************************************/
    #bottom-icons {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 3000;
    }
    .bottom-icon-btn {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      transition: transform 0.3s, background 0.3s;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .bottom-icon-btn:hover {
      transform: scale(1.05);
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }
    /* Chat Badge (Bildirim sayısı) */
    .bottom-icon-btn[data-badge]:after {
      content: attr(data-badge);
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      border-radius: 50%;
      min-width: 20px;
      min-height: 20px;
      padding: 2px 6px;
      text-align: center;
      font-size: 12px;
      pointer-events: none;
    }

    /* Odadan Çık Butonu (Sağ Alt) */
    #exit-room-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(45deg, #c0392b, #e74c3c);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: #fff;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.3s;
      z-index: 3000;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
    #exit-room-btn:hover {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
    }

    /**********************************************************
     * LEAFLET TOOLTIP & ÜLKE POPUP
     **********************************************************/
    .leaflet-tooltip {
      background: transparent;
      border: none;
    }
    .country-popup-tooltip {
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /**********************************************************
     * GENEL POPUP TASARIMI (Modern & Daha Büyük)
     **********************************************************/
    .modern-popup {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 450px;
      max-height: 70vh;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: none;
      flex-direction: column;
      z-index: 3002;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      animation: fadeInPopup 0.5s ease forwards;
    }
    @keyframes fadeInPopup {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modern-popup .popup-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      cursor: pointer;
    }
    .modern-popup .popup-header button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .modern-popup .popup-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      font-size: 15px;
    }
    .modern-popup .popup-content h3 {
      font-size: 18px;
      color: #1abc9c;
      margin-bottom: 10px;
    }
    .modern-popup .popup-content input[type="number"],
    .modern-popup .popup-content select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #1abc9c;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
    }
    .modern-popup .popup-content button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      border-radius: 6px;
      font-size: 16px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }
    .modern-popup .popup-content button:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }

    /**********************************************************
     * CHAT POPUP (GENEL + ÖZEL)
     **********************************************************/
    .chat-popup {
      width: 450px;
      max-height: 70vh;
      display: none;
      flex-direction: column;
      z-index: 3001;
    }
    .chat-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      cursor: pointer;
    }
    .chat-header button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.3);
      color: #eee;
      font-size: 15px;
    }
    .chat-input-container {
      display: flex;
      border-top: 1px solid #444;
    }
    .chat-input-container input[type="text"] {
      flex: 1;
      padding: 15px;
      border: none;
      outline: none;
      background: #1e1e2f;
      color: #eee;
      font-size: 15px;
    }
    .chat-input-container button {
      padding: 15px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      cursor: pointer;
      color: #fff;
      font-size: 18px;
    }
    .chat-private-container {
      border-top: 1px solid #444;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chat-private-container select,
    .chat-private-container input[type="text"] {
      padding: 10px;
      border: 1px solid #1abc9c;
      border-radius: 6px;
      outline: none;
      background: #1e1e2f;
      color: #eee;
      font-size: 15px;
    }
    .chat-private-container button {
      padding: 10px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none;
      cursor: pointer;
      color: #fff;
      align-self: flex-end;
      font-size: 16px;
    }

    /**********************************************************
     * PAKT POPUP
     **********************************************************/
    #pact-popup {
      width: 450px;
      max-height: 70vh;
      display: none;
      flex-direction: column;
      z-index: 3002;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      animation: fadeInPopup 0.5s ease forwards;
    }
    #pact-popup-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      cursor: pointer;
    }
    #pact-popup .popup-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      font-size: 15px;
      background: rgba(0, 0, 0, 0.3);
    }
    #pact-popup .popup-content h3 {
      margin-bottom: 10px;
      color: #1abc9c;
    }
    .pact-offer-item {
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .pact-offer-item button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .pact-offer-item .accept-btn {
      background: linear-gradient(45deg, #27ae60, #2ecc71);
      color: #fff;
    }
    .pact-offer-item .reject-btn {
      background: linear-gradient(45deg, #c0392b, #e74c3c);
      color: #fff;
    }
    .active-pact-item {
      background: rgba(0, 0, 0, 0.45);
      padding: 8px;
      border-radius: 5px;
      margin-bottom: 8px;
    }

    /**********************************************************
     * TİCARET POPUP
     **********************************************************/
    .market-popup {
      width: 500px;
      max-height: 70vh;
      display: none;
      flex-direction: column;
      z-index: 3002;
      animation: fadeInPopup 0.5s ease forwards;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
    }
    .market-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
    }
    .market-header button {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .market-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      background: rgba(0, 0, 0, 0.3);
    }
    .market-section {
      margin-bottom: 20px;
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    .market-section h3 {
      font-size: 17px;
      margin-bottom: 10px;
      color: #1abc9c;
    }
    .offer-item {
      background: rgba(0, 0, 0, 0.4);
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /**********************************************************
     * OYUNCULAR POPUP (SOL TARAFTA AÇILSIN)
     **********************************************************/
    #players-popup {
      position: fixed;
      bottom: 80px;
      left: 20px;
      width: 450px;
      max-height: 70vh;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: none;
      flex-direction: column;
      z-index: 3002;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      animation: fadeInPopup 0.5s ease forwards;
    }
    #players-popup .popup-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 15px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
    }
    #players-popup .popup-content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      color: #eee;
      font-size: 15px;
      background: rgba(0, 0, 0, 0.3);
    }
    #players-popup .popup-content .player-info {
      background: rgba(0, 0, 0, 0.4);
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      font-size: 15px;
    }
    #players-popup .popup-content .player-info p {
      margin: 4px 0;
      color: #ddd;
    }

    /**********************************************************
     * RESPONSIVE (MOBİL) TASARIM
     **********************************************************/
    @media screen and (max-width: 768px) {
      /* LOBİ */
      #lobby-container {
        width: 90%;
        margin: 20px auto;
        padding: 20px;
      }
      #lobby-container h1 {
        font-size: 28px;
      }
      #lobby-container h2 {
        font-size: 18px;
      }

      /* ÜST BİLGİ */
      #top-info {
        width: 90%;
        padding: 8px 10px;
        gap: 5px;
        left: 50%;
        transform: translateX(-50%);
        flex-direction: column;
      }
      #top-info p {
        font-size: 14px;
      }

      /* ALT BUTONLAR */
      #bottom-icons {
        gap: 10px;
      }
      .bottom-icon-btn {
        width: 44px;
        height: 44px;
        font-size: 16px;
      }

      /* ODADAN ÇIK BUTONU */
      #exit-room-btn {
        bottom: 80px;
        right: 20px;
        font-size: 13px;
        padding: 8px 12px;
      }

      /* POPUP'LAR GENEL */
      .modern-popup,
      .chat-popup,
      .market-popup,
      #pact-popup,
      #players-popup {
        width: 90% !important;
        right: 5% !important;
        left: auto !important;
        bottom: 90px;
      }
    }
  </style>
</head>

<body class="lobby">
  <!-- ===================== LOBBY (Oda Oluşturma & Katılma) ===================== -->
  <div id="lobby-container" class="animate__animated animate__fadeIn">
    <h1>GLOBAL CONQUEST</h1>
    <!-- Oda Oluşturma -->
    <div id="create-room-section">
      <h2>Oda Oluştur</h2>
      <input type="text" id="creator-player-name" placeholder="Adınız" />
      <div class="color-options" id="creator-color-options"></div>
      <!-- Oyuncu sayısı kaldırıldı -->
      <button id="create-room-btn">Oda Oluştur</button>
    </div>
    <hr />
    <!-- Odaya Katılma -->
    <div id="join-room-section">
      <h2>Odaya Katıl</h2>
      <input type="text" id="join-player-name" placeholder="Adınız" />
      <div class="color-options" id="join-color-options"></div>
      <input
        type="text"
        id="room-code"
        placeholder="Oda Kodu (Örn: AB12CD)"
      />
      <button id="join-room-btn">Odaya Katıl</button>
    </div>
  </div>

  <!-- ===================== KISA SÜRELİ BİLDİRİMLER ALANI ===================== -->
  <div id="notification-area"></div>

  <!-- ===================== OYUN EKRANI ===================== -->
  <div id="game-container">
    <!-- Üst Bilgi (Tur, Sıra, Oda Kodu, Oyun Başlat vb.) -->
    <div id="top-info">
      <p>
        Oda Kodu: <span id="display-room-code">-</span> |
        Tur: <span id="current-round">1</span> |
        Sıra: <span id="current-player">Oyuncu Adı</span>
      </p>
      <button id="end-turn-btn">
        <i class="fas fa-forward"></i> Tur Sonu
        <span id="turn-timer">60s</span>
      </button>

      <!-- OYUNU BAŞLAT BUTONU (Sadece Kurucu Oyuncu görecek) -->
      <button id="start-game-btn">Oyunu Başlat</button>
      <!-- 30 Saniye Geri Sayım Ekranı -->
      <span id="start-countdown">30</span>
    </div>

    <!-- Harita Alanı -->
    <div id="map-container">
      <div id="map"></div>
      <!-- Bilgi Kartları Toggle Butonu -->
      <button id="toggle-info-cards" class="toggle-info-cards">
        <i class="fas fa-eye-slash"></i>
      </button>
    </div>

    <!-- Odadan Çık Butonu (Sağ Alt) -->
    <button id="exit-room-btn">Odadan Çık</button>

    <!-- Alt İkonlar (Chat, Pakt, Market, vs.) -->
    <div id="bottom-icons">
      <!-- Oyuncu Bilgileri -->
      <button id="open-players-btn" class="bottom-icon-btn" title="Oyuncular">
        <i class="fas fa-users"></i>
      </button>
      <!-- Asker İşlemleri -->
      <button id="open-military-btn" class="bottom-icon-btn" title="Asker İşlemleri">
        <i class="fas fa-shield-alt"></i>
      </button>
      <!-- Bina Kurma -->
      <button id="open-building-btn" class="bottom-icon-btn" title="Bina Kurma">
        <i class="fas fa-building"></i>
      </button>
      <!-- Kaynak Gönderme -->
      <button id="open-resource-btn" class="bottom-icon-btn" title="Kaynak Gönderme">
        <i class="fas fa-hand-holding-usd"></i>
      </button>
      <!-- Market -->
      <button
        id="open-market-btn"
        class="bottom-icon-btn"
        data-badge=""
        title="Ticaret Merkezi"
      >
        <i class="fas fa-store"></i>
      </button>
      <!-- Pakt -->
      <button id="open-pact-btn" class="bottom-icon-btn" title="Saldırmazlık Pakti">
        <i class="fas fa-handshake"></i>
      </button>
      <!-- Chat -->
      <button
        id="open-chat-btn"
        class="bottom-icon-btn"
        data-badge=""
        title="Sohbet"
      >
        <i class="fas fa-comments"></i>
      </button>
      <!-- Bildirim İkonu -->
      <button
        id="open-notifications-btn"
        class="bottom-icon-btn"
        title="Bildirimler"
      >
        <i class="fas fa-bell"></i>
      </button>
    </div>
  </div>

  <!-- ===================== ASKER İŞLEMLERİ POPUP ===================== -->
  <div id="military-popup" class="modern-popup">
    <div class="popup-header" id="military-popup-header">
      <span>Asker İşlemleri</span>
      <button id="close-military-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Saldırı (Sadece Kendi Sıranda)</h3>
      <p style="font-size:14px; color:#ccc;">
        - Saldırmak istediğiniz ülkeyi haritadan seçin<br />
        - Gönderilecek asker sayısını girin (Her asker 1 varil petrol harcar)
      </p>
      <input
        type="number"
        id="attack-soldiers"
        placeholder="Asker sayısı"
        min="1"
      />
      <button id="attack-btn">
        <i class="fas fa-crosshairs"></i> Saldırı Yap
      </button>

      <h3>Asker Satın Alma (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">(1 Asker = 10$ + 25 Buğday)</p>
      <input
        type="number"
        id="soldiers-to-buy"
        placeholder="Adet"
        min="1"
      />
      <button id="buy-soldiers-btn">
        <i class="fas fa-user-plus"></i> Satın Al
      </button>

      <h3>Asker Çek (Kendi Ülkenizden veya Destek Gönderdiğiniz Ülkeden)</h3>
      <input
        type="number"
        id="pull-soldiers-count"
        placeholder="Asker sayısı"
        min="1"
      />
      <button id="pull-soldiers-btn">
        <i class="fas fa-running"></i> Asker Çek
      </button>

      <h3>Askeri Destek Gönder (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">
        Seçtiğiniz oyuncunun ülkesine asker desteği
      </p>
      <select id="support-recipient"></select>
      <select id="support-recipient-country"></select>
      <input
        type="number"
        id="support-soldiers"
        placeholder="Asker sayısı"
        min="1"
      />
      <button id="send-support-btn">
        <i class="fas fa-hands-helping"></i> Destek Gönder
      </button>
    </div>
  </div>

  <!-- ===================== BİNA KURMA POPUP ===================== -->
  <div id="building-popup" class="modern-popup">
    <div class="popup-header" id="building-popup-header">
      <span>Bina Kurma</span>
      <button id="close-building-btn">&times;</button>
    </div>
    <div class="popup-content">
      <!-- Kışla Kur -->
      <h3>Kışla Kur (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">
        (1 Kışla = 300$ + 50 Varil + 120 Buğday)
      </p>
      <input
        type="number"
        id="barracks-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="buy-barracks-btn">
        <i class="fas fa-fort-awesome"></i> Kışla Kur
      </button>

      <!-- Fabrika Kur -->
      <h3>Fabrika Kur (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">(1 Fabrika = 500$ + 130 varil)</p>
      <input
        type="number"
        id="factory-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="build-factory-btn">
        <i class="fas fa-industry"></i> Fabrika Kur
      </button>

      <!-- Rafine Kur -->
      <h3>Rafine Kur (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">
        (1 Rafine = 800$ + 250 varil)
      </p>
      <input
        type="number"
        id="refinery-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="build-refinery-btn">
        <i class="fas fa-oil-can"></i> Rafine Kur
      </button>

      <!-- Değirmen Kur -->
      <h3>Değirmen Kur (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">(1 Değirmen = 200$ + 100 Varil)</p>
      <input
        type="number"
        id="grainmill-quantity"
        placeholder="Adet"
        min="1"
      />
      <button id="build-grainmill-btn">
        <i class="fas fa-wheat-awn"></i> Değirmen Kur
      </button>

      <!-- Kale Kur -->
      <h3>Kale Kur (Her Zaman)</h3>
      <p style="font-size:14px; color:#ccc;">
        - 1 Kale = 1000$ + 1000 Varil + 1000 Buğday <br/>
        - Bir ülkede yalnızca 1 kale kurulabilir<br/>
        - Kale, o ülkeye saldıran askerlerin %5'ini öldürür (temel savunma)
      </p>
      <button id="build-castle-btn">
        <i class="fas fa-chess-rook"></i> Kale Kur
      </button>

      <!-- Kale Güçlendirme -->
      <h3>Kale Güçlendirme</h3>
      <p style="font-size:14px; color:#ccc;">
        - Her güçlendirme kale savunmasına +%5 ekler (Max %30)<br/>
        - İlk güçlendirme maliyeti: 1300$ + 1300 Varil + 1300 Buğday<br/>
        - Sonraki her güçlendirme maliyeti de bir önceki fiyata göre %30 artar
      </p>
      <p style="font-size:14px; color:#1abc9c;">
        Mevcut / Sonraki Güçlendirme Fiyatı:
        <span id="castle-upgrade-cost-text">-</span>
      </p>
      <button id="upgrade-castle-btn">
        <i class="fas fa-arrow-up"></i> Kale Güçlendir
      </button>
    </div>
  </div>

  <!-- ===================== KAYNAK GÖNDERME POPUP ===================== -->
  <div id="resource-popup" class="modern-popup">
    <div class="popup-header" id="resource-popup-header">
      <span>Kaynak Gönderme (Her Zaman)</span>
      <button id="close-resource-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Para Gönder</h3>
      <input
        type="number"
        id="money-to-send"
        placeholder="Miktar ($)"
        min="1"
      />
      <select id="recipient-player"></select>
      <button id="send-money-btn">
        <i class="fas fa-hand-holding-usd"></i> Para Gönder
      </button>

      <h3>Petrol Gönder</h3>
      <input
        type="number"
        id="petrol-to-send"
        placeholder="Varil"
        min="1"
      />
      <select id="recipient-player-petrol"></select>
      <button id="send-petrol-btn">
        <i class="fas fa-gas-pump"></i> Petrol Gönder
      </button>

      <h3>Buğday Gönder</h3>
      <input
        type="number"
        id="wheat-to-send"
        placeholder="Buğday"
        min="1"
      />
      <select id="recipient-player-wheat"></select>
      <button id="send-wheat-btn">
        <i class="fas fa-wheat-awn"></i> Buğday Gönder
      </button>
    </div>
  </div>

  <!-- ===================== OYUNCULAR POPUP (SOLDA) ===================== -->
  <div id="players-popup">
    <div class="popup-header" id="players-popup-header">
      <span>Oyuncu Bilgileri</span>
      <button id="close-players-btn">&times;</button>
    </div>
    <div class="popup-content" id="players-info">
      <!-- Oyuncu listesi dinamik olarak buraya eklenecek -->
    </div>
  </div>

  <!-- ===================== CHAT POPUP (GENEL + ÖZEL) ===================== -->
  <div id="chat-popup" class="chat-popup modern-popup">
    <div class="chat-header" id="chat-popup-header">
      <span>Sohbet</span>
      <button id="close-chat-btn">&times;</button>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <!-- Genel Sohbet Girişi -->
    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Mesajınızı yazın..." />
      <button id="send-chat-btn">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    <!-- Özel Mesaj Girişi -->
    <div class="chat-private-container">
      <h4>Özel Mesaj</h4>
      <select id="private-message-recipient"></select>
      <input
        type="text"
        id="private-message-input"
        placeholder="Özel mesajınız..."
      />
      <button id="send-private-message-btn">
        <i class="fas fa-user-secret"></i> Gönder
      </button>
    </div>
  </div>

  <!-- ===================== SALDIRMAZLIK PAKTI POPUP ===================== -->
  <div id="pact-popup" class="modern-popup">
    <div id="pact-popup-header" class="popup-header">
      <span>Saldırmazlık Pakti</span>
      <button id="close-pact-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Yeni Pakt Teklifi Gönder</h3>
      <select id="pact-offer-recipient"></select>
      <!-- Tur sayısı ve para bedeli -->
      <input
        type="number"
        id="pact-duration"
        placeholder="Tur sayısı (örn: 3)"
      />
      <input type="number" id="pact-cost" placeholder="Tek seferlik para ($)" />
      <button id="send-pact-offer-btn" style="margin-bottom: 15px;">
        Teklif Gönder
      </button>

      <h3>Gelen Teklifler</h3>
      <div id="pact-pending-offers"></div>

      <h3>Aktif Paktlarınız</h3>
      <div id="active-pacts-container"></div>
    </div>
  </div>

  <!-- ===================== TİCARET POPUP ===================== -->
  <div id="market-popup" class="market-popup modern-popup">
    <div class="market-header" id="market-popup-header">
      <h2>Ticaret Merkezi</h2>
      <button id="close-market-btn">&times;</button>
    </div>
    <div class="market-content">
      <!-- Teklif Oluşturma -->
      <div class="market-section">
        <h3>Yeni Teklif Oluştur</h3>
        <label style="font-size:14px;color:#ccc;"
          >Satmak istediğiniz ürün:</label
        ><br />
        <select id="trade-item-type">
          <option value="petrol">Petrol</option>
          <option value="wheat">Buğday</option>
        </select>
        <br /><br />

        <label style="font-size:14px;color:#ccc;"
          >Miktar (adet/varil/buğday):</label
        >
        <input
          type="number"
          id="trade-quantity"
          placeholder="Miktar"
          min="1"
        />

        <label style="font-size:14px;color:#ccc;">Birim Fiyat ($):</label>
        <input
          type="number"
          id="trade-price"
          placeholder="Birim Fiyat"
          min="1"
        />

        <label style="font-size:14px;color:#ccc;">Ambargo (Oyuncular):</label
        ><br />
        <select
          id="embargo-players"
          multiple
          style="width: 100%; min-height: 50px;"
        ></select>
        <small style="color:#ccc;"
          >(Seçtiğiniz oyuncular bu teklifi satın
          alamaz)</small
        >
        <br /><br />

        <button
          id="create-trade-offer-btn"
          style="font-size:15px;"
        >
          Teklifi Oluştur
        </button>
      </div>
      <!-- Mevcut Teklifler -->
      <div class="market-section offer-list">
        <h3>Mevcut Teklifler</h3>
        <div id="trade-offers-list"></div>
      </div>
    </div>
  </div>

  <!-- 
    =====================
    BURADA JAVASCRIPT KISMI (2. KISIM) GELECEK
    =====================
    Not: Firebase, Leaflet JS, vb. kütüphane bağlantıları (CDN) 
    ve tüm işlevsel kodlar 2. kısımda (JS dosyasında) paylaşılacaktır.
  -->
</body>
</html>
<!-- Firebase & Leaflet JS Kütüphaneleri (Gerekli CDN bağlantıları) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
  /*****************************************************************
   * Firebase Başlatma
   *****************************************************************/
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY_HERE",                // <-- Kendi API key’inizi ekleyin
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID",
    measurementId: "MEASUREMENT_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  /*****************************************************************
   * GLOBAL DEĞİŞKENLER ve Yardımcı Fonksiyonlar
   *****************************************************************/
  let localPlayerId = null;
  let currentRoomCode = null;
  let roomRef = null;
  let roomData = null;
  let selectedCountry = null;
  let map, geoJsonLayer = null;

  // Oyun içi renk seçenekleri
  const availableColors = [
    "red",
    "blue",
    "green",
    "yellow",
    "purple",
    "orange",
    "brown",
    "pink"
  ];
  let localPlayerColor = null;

  // Chat ve bildirim kontrolü
  let chatListenerAdded = false;
  let notificationsMuted = false; // Bildirimler açık/kapalı
  // Bilgi kartları kalıcı mı açık?
  let infoCardsPermanent = false;
  // Chat açık mı?
  let chatOpen = false;
  // Yeni mesaj sayısı (popup kapalıyken gelen mesajlar)
  let unreadMessages = 0;

  // Tur sayaç (60sn)
  let turnTimeRemaining = 60;
  let turnTimerInterval = null;

  // Oyun başlat geri sayım
  let startInterval = null;

  // Player ID oluşturma veya okuma
  function getOrCreateLocalPlayerId() {
    let pid = localStorage.getItem("playerId");
    if (!pid) {
      pid = Math.random().toString(36).substring(2, 9);
      localStorage.setItem("playerId", pid);
    }
    return pid;
  }

  // Bildirim göster (ekranda kısa süre)
  function showNotification(message, duration = 3000) {
    if (notificationsMuted) return; // Bildirimler kapalıysa gösterme

    const area = document.getElementById("notification-area");
    if (!area) return;

    const item = document.createElement("div");
    item.className = "notification-item";
    item.textContent = message;
    area.appendChild(item);

    setTimeout(() => {
      if (area.contains(item)) {
        area.removeChild(item);
      }
    }, duration + 800); // fadeOut animasyon tamamlansın diye + biraz ek süre
  }

  // Global (tüm oyunculara) bildirim
  function broadcastNotification(text) {
    if (!roomRef) return;
    roomRef.child("notifications").push({
      text: text,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
  }

  // Global bildirimleri ekrana bas
  function displayGlobalNotification(text) {
    if (notificationsMuted) return;
    const area = document.getElementById("notification-area");
    if (!area) return;
    const item = document.createElement("div");
    item.className = "notification-item";
    item.textContent = text;
    area.appendChild(item);

    setTimeout(() => {
      if (area.contains(item)) {
        area.removeChild(item);
      }
    }, 6500);
  }

  // Saldırmazlık paktı var mı?
  function hasActivePact(playerA, playerB) {
    if (!roomData || !roomData.pacts) return false;
    for (let pactId in roomData.pacts) {
      const pact = roomData.pacts[pactId];
      if (pact.active && roomData.round <= pact.expirationRound) {
        if (
          (pact.playerA === playerA && pact.playerB === playerB) ||
          (pact.playerA === playerB && pact.playerB === playerA)
        ) {
          return true;
        }
      }
    }
    return false;
  }

  // Tur kime ait?
  function isMyTurn() {
    if (!roomData || !roomData.playerOrder || roomData.gameState !== "started")
      return false;
    const currentTurnIndex = roomData.currentTurnIndex || 0;
    return roomData.playerOrder[currentTurnIndex] === localPlayerId;
  }

  // 60sn Turn sayacı başlat
  function startTurnTimer() {
    const timerEl = document.getElementById("turn-timer");
    turnTimeRemaining = 60;
    if (turnTimerInterval) clearInterval(turnTimerInterval);
    timerEl.textContent = turnTimeRemaining + "s";

    turnTimerInterval = setInterval(() => {
      turnTimeRemaining--;
      if (turnTimeRemaining <= 0) {
        clearInterval(turnTimerInterval);
        turnTimeRemaining = 0;
        timerEl.textContent = "0s";
        // Süre dolunca otomatik tur geç
        if (roomData && roomData.gameState === "started" && isMyTurn()) {
          nextTurn(true); // Otomatik end
        }
      } else {
        timerEl.textContent = turnTimeRemaining + "s";
      }
    }, 1000);
  }

  function stopTurnTimer() {
    if (turnTimerInterval) {
      clearInterval(turnTimerInterval);
      turnTimerInterval = null;
    }
    const timerEl = document.getElementById("turn-timer");
    if (timerEl) {
      timerEl.textContent = "60s";
    }
  }

  // Oda kodu oluştur (6 karakter)
  function generateRoomCode() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let code = "";
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  /*****************************************************************
   * DOMContentLoaded -> Lobi giriş
   *****************************************************************/
  document.addEventListener("DOMContentLoaded", () => {
    localPlayerId = getOrCreateLocalPlayerId();

    // Renk seçim butonları (Oda Oluşturma)
    const creatorColorDiv = document.getElementById("creator-color-options");
    availableColors.forEach((color) => {
      const btn = document.createElement("button");
      btn.className = "global-color-option";
      btn.style.backgroundColor = color;
      btn.dataset.color = color;
      btn.addEventListener("click", () => {
        creatorColorDiv
          .querySelectorAll(".global-color-option")
          .forEach((el) => el.classList.remove("selected"));
        btn.classList.add("selected");
        localPlayerColor = color;
      });
      creatorColorDiv.appendChild(btn);
    });

    // Renk seçim butonları (Odaya Katılma)
    const joinColorDiv = document.getElementById("join-color-options");
    availableColors.forEach((color) => {
      const btn = document.createElement("button");
      btn.className = "global-color-option";
      btn.style.backgroundColor = color;
      btn.dataset.color = color;
      btn.addEventListener("click", () => {
        joinColorDiv
          .querySelectorAll(".global-color-option")
          .forEach((el) => el.classList.remove("selected"));
        btn.classList.add("selected");
        localPlayerColor = color;
      });
      joinColorDiv.appendChild(btn);
    });

    // Oda Oluştur
    document.getElementById("create-room-btn").addEventListener("click", () => {
      const playerName = document
        .getElementById("creator-player-name")
        .value.trim();
      if (!playerName) {
        showNotification("Lütfen adınızı girin!");
        return;
      }
      if (!localPlayerColor) {
        showNotification("Lütfen bir renk seçin!");
        return;
      }

      // Oda kodu
      const roomCode = generateRoomCode();
      currentRoomCode = roomCode;
      roomRef = db.ref("rooms/" + roomCode);

      // Yeni oda verisi
      const newRoomData = {
        roomCode: roomCode,
        gameState: "waiting", // waiting -> starting -> started
        currentTurnIndex: 0,
        round: 1,
        playerOrder: [localPlayerId],
        players: {},
        countryData: {},
        createdAt: firebase.database.ServerValue.TIMESTAMP
      };
      newRoomData.players[localPlayerId] = {
        name: playerName,
        color: localPlayerColor,
        money: 1000,
        soldiers: 0,
        countries: [],
        petrol: 100, // başlangıç petrol
        wheat: 400,  // başlangıç buğday
        joinedAt: firebase.database.ServerValue.TIMESTAMP,
        isHost: true
      };

      // Odayı veritabanına yaz
      roomRef.set(newRoomData, (error) => {
        if (error) {
          showNotification("Oda oluşturulurken hata oluştu!");
        } else {
          showNotification("Oda oluşturuldu. Kodu: " + roomCode);
          localStorage.setItem("roomCode", roomCode);

          // Ülke verilerini sadece Host yüklesin
          loadAndInitializeGeoJson();

          // Odaya bağlan ve dinlemeyi başlat
          joinRoomAndListen();

          // Ekran geçişi
          document.body.classList.remove("lobby");
          document.getElementById("lobby-container").style.display = "none";
          document.getElementById("game-container").style.display = "block";
          document.getElementById("display-room-code").textContent = roomCode;
        }
      });
    });

    // Odaya Katıl
    document.getElementById("join-room-btn").addEventListener("click", () => {
      const playerName = document
        .getElementById("join-player-name")
        .value.trim();
      const roomCodeInput = document
        .getElementById("room-code")
        .value.trim()
        .toUpperCase();
      if (!playerName) {
        showNotification("Lütfen adınızı girin!");
        return;
      }
      if (!localPlayerColor) {
        showNotification("Lütfen bir renk seçin!");
        return;
      }
      if (!roomCodeInput) {
        showNotification("Lütfen oda kodu girin!");
        return;
      }
      currentRoomCode = roomCodeInput;
      roomRef = db.ref("rooms/" + roomCodeInput);

      // Odayı kontrol et
      roomRef.once("value", (snapshot) => {
        if (!snapshot.exists()) {
          showNotification("Böyle bir oda bulunamadı!");
          return;
        }
        const room = snapshot.val();

        // Oyun başlamışsa giriş yasak
        if (room.gameState === "started" || room.gameState === "starting") {
          showNotification("Oyun başlamış; katılamazsınız!");
          return;
        }

        // Katılma
        const updates = {};
        updates["players/" + localPlayerId] = {
          name: playerName,
          color: localPlayerColor,
          money: 1000,
          soldiers: 0,
          countries: [],
          petrol: 100,
          wheat: 400,
          joinedAt: firebase.database.ServerValue.TIMESTAMP,
          isHost: false
        };

        let arrOrder = room.playerOrder || [];
        arrOrder.push(localPlayerId);
        updates["playerOrder"] = arrOrder;

        roomRef.update(updates, (error) => {
          if (error) {
            showNotification("Odaya katılırken hata oluştu!");
          } else {
            showNotification("Odaya katıldınız!");
            localStorage.setItem("roomCode", roomCodeInput);

            // Odaya bağlan ve dinlemeyi başlat
            joinRoomAndListen();

            // Ekran geçişi
            document.body.classList.remove("lobby");
            document.getElementById("lobby-container").style.display = "none";
            document.getElementById("game-container").style.display = "block";
            document.getElementById("display-room-code").textContent =
              roomCodeInput;
          }
        });
      });
    });

    // Bilgi Kartları Toggle
    const toggleInfoButton = document.getElementById("toggle-info-cards");
    const icon = toggleInfoButton.querySelector("i");
    toggleInfoButton.addEventListener("click", () => {
      infoCardsPermanent = !infoCardsPermanent;
      updateTooltipsPermanent();
      icon.className = infoCardsPermanent ? "fas fa-eye" : "fas fa-eye-slash";
    });

    // Bildirim butonu
    document
      .getElementById("open-notifications-btn")
      .addEventListener("click", () => {
        notificationsMuted = !notificationsMuted;
        if (!notificationsMuted) {
          showNotification("Bildirimler açıldı.");
        } else {
          showNotification("Bildirimler kapatıldı.");
        }
      });
  });

  /*****************************************************************
   * GeoJSON & Ülke Verilerini (Sahipsiz) Yükleme -> Sadece Host
   *****************************************************************/
  function loadAndInitializeGeoJson() {
    fetch(
      "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json"
    )
      .then((res) => res.json())
      .then((geoData) => {
        const features = geoData.features;

        // 40-50 ülkeyi petrol zengini yapalım (random)
        const totalFeatures = features.length; // ~ 247 civarı
        let oilIndexes = [];
        const oilCount = 45; // Rastgele 45 ülke petrol üreten
        while (oilIndexes.length < oilCount) {
          const rnd = Math.floor(Math.random() * totalFeatures);
          if (!oilIndexes.includes(rnd)) {
            oilIndexes.push(rnd);
          }
        }

        // 60 ülkeyi buğday zengini yapalım (random)
        let wheatIndexes = [];
        const wheatCount = 60;
        while (wheatIndexes.length < wheatCount) {
          const rnd = Math.floor(Math.random() * totalFeatures);
          if (!wheatIndexes.includes(rnd)) {
            wheatIndexes.push(rnd);
          }
        }

        // Tüm ülke verilerini oluştur
        const countryDataInit = {};
        features.forEach((feature, idx) => {
          const cName = feature.properties.name;
          // Rastgele petrol üretimi
          let oilProduction = 0;
          if (oilIndexes.includes(idx)) {
            oilProduction =
              Math.floor(Math.random() * (500 - 150 + 1)) + 150; // 150-500
          }
          // Rastgele buğday üretimi
          let wheatProduction = 0;
          if (wheatIndexes.includes(idx)) {
            wheatProduction =
              Math.floor(Math.random() * (700 - 200 + 1)) + 200; // 200-700
          }

          countryDataInit[cName] = {
            income: Math.floor(Math.random() * 400) + 100, // 100-500 arası gelir
            soldiers: 0,
            owner: null,
            barracksCount: 0,
            factories: 0,
            refineries: 0,
            oilProduction: oilProduction,
            wheatProduction: wheatProduction,
            grainMills: 0,
            supporters: {},
            castleDefenseLevel: 0,
            castleNextUpgradeCost: null
          };
        });

        // Veritabanına yaz
        roomRef.child("countryData").set(countryDataInit);
      });
  }

  /*****************************************************************
   * Oda Verilerini Dinleme & UI Güncelleme
   *****************************************************************/
  function joinRoomAndListen() {
    if (!roomRef) return;

    // Oda genel verisini dinle
    roomRef.on("value", (snapshot) => {
      roomData = snapshot.val();
      if (!roomData) return;
      updateGameUI();
      displayPendingPactOffers();
      displayActivePacts();
      displayTradeOffers();
    });

    // Chat ve global notifications sadece 1 kez
    if (!chatListenerAdded) {
      // Chat dinle
      roomRef.child("chat").on("child_added", (snap) => {
        const message = snap.val();
        if (message) {
          appendChatMessage(message);
        }
      });

      // Global bildirimler dinle
      roomRef.child("notifications").on("child_added", (snap) => {
        const data = snap.val();
        if (data && data.text) {
          displayGlobalNotification(data.text);
        }
      });

      chatListenerAdded = true;
    }
  }

  function updateGameUI() {
    if (!roomData) return;

    // Round
    document.getElementById("current-round").textContent = roomData.round || 1;

    // Current Player
    if (roomData.playerOrder && roomData.players) {
      const cIndex = roomData.currentTurnIndex || 0;
      const cPlayerId = roomData.playerOrder[cIndex];
      if (roomData.players[cPlayerId]) {
        document.getElementById("current-player").textContent =
          roomData.players[cPlayerId].name;
      }
    }

    // Oyun Durumu
    handleGameState(roomData.gameState);

    // Oyuncu listesi (sol popup)
    const playersInfoDiv = document.getElementById("players-info");
    if (playersInfoDiv) {
      playersInfoDiv.innerHTML = "";
      if (roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          const pData = roomData.players[pid];
          if (!pData) return;
          const div = document.createElement("div");
          div.className = "player-info";
          div.id = "player-info-" + pid;
          div.innerHTML = `
            <p><strong>${pData.name}</strong></p>
            <p>Para: <span>${pData.money}</span>$</p>
            <p>Asker: <span>${pData.soldiers}</span></p>
            <p>Ülkeler: <span>${(pData.countries || []).length}</span></p>
            <p>Petrol: <span>${pData.petrol}</span> varil</p>
            <p>Buğday: <span>${pData.wheat}</span></p>
          `;
          playersInfoDiv.appendChild(div);
        });
      }
    }

    // Harita güncelle
    if (map && geoJsonLayer && roomData.countryData) {
      geoJsonLayer.eachLayer((layer) => {
        const cName = layer.feature.properties.name;
        const cData = roomData.countryData[cName];
        if (!cData) return;
        // Renk
        if (cData.owner && roomData.players[cData.owner]) {
          layer.setStyle({
            fillColor: roomData.players[cData.owner].color,
            fillOpacity: 0.7,
            color: "#555",
            weight: 1
          });
        } else {
          layer.setStyle({
            fillColor: "#ccc",
            fillOpacity: 0.7,
            color: "#555",
            weight: 1
          });
        }

        // Tooltip içeriği
        layer.setTooltipContent(getCountryPopupContent(cName, cData));
      });
    }

    // Selectler
    updateRecipientSelects();
    updatePrivateMessageRecipientSelect();
    updatePactRecipientSelect();
    updateEmbargoPlayersSelect();
    updateSupportRecipientSelect();

    // Turn Timer
    if (roomData.gameState === "started") {
      if (isMyTurn()) {
        startTurnTimer();
      } else {
        stopTurnTimer();
      }
    } else {
      stopTurnTimer();
    }
  }

  function handleGameState(state) {
    const startBtn = document.getElementById("start-game-btn");
    const countdownSpan = document.getElementById("start-countdown");
    if (!state) return;

    if (state === "waiting") {
      // Host ise buton göster
      if (
        roomData.players[localPlayerId] &&
        roomData.players[localPlayerId].isHost
      ) {
        startBtn.style.display = "block";
      } else {
        startBtn.style.display = "none";
      }
      countdownSpan.style.display = "none";
    } else if (state === "starting") {
      startBtn.style.display = "none";
      countdownSpan.style.display = "inline";
      startCountdownListener();
    } else if (state === "started") {
      startBtn.style.display = "none";
      countdownSpan.style.display = "none";
      clearInterval(startInterval);
      startInterval = null;
    }
  }

  // Oyunu Başlat (Host)
  document.getElementById("start-game-btn").addEventListener("click", () => {
    if (!roomData) return;
    if (!roomData.players[localPlayerId].isHost) return;
    if (roomData.gameState !== "waiting") return;

    const now = Date.now();
    const startTime = now + 30000; // 30 sn sonra başlasın
    roomRef.update({
      gameState: "starting",
      startTime: startTime
    });
  });

  function startCountdownListener() {
    if (!roomData || !roomData.startTime) return;
    const countdownSpan = document.getElementById("start-countdown");
    if (startInterval) clearInterval(startInterval);

    startInterval = setInterval(() => {
      if (!roomData) return;
      const now = Date.now();
      const diff = roomData.startTime - now;
      if (diff <= 0) {
        clearInterval(startInterval);
        startInterval = null;
        roomRef.update({ gameState: "started" });
        return;
      }
      const secondsLeft = Math.floor(diff / 1000);
      countdownSpan.textContent = secondsLeft;
    }, 1000);
  }

  /*****************************************************************
   * ÜLKE TOOLTIP
   *****************************************************************/
  function getCountryPopupContent(countryName, country) {
    if (!country) country = {};
    const ownerText =
      country.owner && roomData.players[country.owner]
        ? roomData.players[country.owner].name
        : "Yok";

    let effectiveIncome = country.income || 0;
    if (country.factories && country.factories > 0) {
      effectiveIncome = Math.floor(effectiveIncome * (1 + 0.2 * country.factories));
    }
    let effectiveOil = 0;
    if (country.oilProduction) {
      effectiveOil = Math.floor(country.oilProduction * (1 + 0.15 * (country.refineries || 0)));
    }
    let effectiveWheat = 0;
    if (country.wheatProduction) {
      effectiveWheat = Math.floor(
        country.wheatProduction * (1 + 0.20 * (country.grainMills || 0))
      );
    }

    // Kale yüzdesi
    const defensePercent = country.castleDefenseLevel * 5; // 5% per level
    return `
      <div class="country-popup">
        <p><i class="fas fa-money-bill-wave"></i> Gelir: ${effectiveIncome}$</p>
        <p><i class="fas fa-users"></i> Asker: ${country.soldiers || 0}</p>
        <p><i class="fas fa-fort-awesome"></i> Kışla: ${country.barracksCount || 0}</p>
        <p><i class="fas fa-industry"></i> Fabrika: ${country.factories || 0}</p>
        <p><i class="fas fa-oil-can"></i> Rafine: ${country.refineries || 0}</p>
        <p><i class="fas fa-oil-can"></i> Petrol Üretimi: ${effectiveOil} varil</p>
        <p><i class="fas fa-wheat-awn"></i> Değirmen: ${country.grainMills || 0}</p>
        <p><i class="fas fa-wheat-awn"></i> Buğday Üretimi: ${effectiveWheat}</p>
        <p><i class="fas fa-chess-rook"></i> Kale Gücü: ${
          defensePercent > 0 ? "%" + defensePercent : "-"
        }</p>
        <p><i class="fas fa-crown"></i> Sahip: ${ownerText}</p>
      </div>
    `;
  }

  function updateTooltipsPermanent() {
    if (!geoJsonLayer || !roomData) return;
    geoJsonLayer.eachLayer((layer) => {
      const cName = layer.feature.properties.name;
      const cData = roomData.countryData[cName];
      layer.unbindTooltip();
      layer.bindTooltip(getCountryPopupContent(cName, cData), {
        permanent: infoCardsPermanent,
        direction: "center",
        className: "country-popup-tooltip"
      });
    });
  }

  function selectCountry(countryName, layer) {
    selectedCountry = countryName;
    showNotification("Seçilen ülke: " + countryName, 1500);

    // Seçim highlight
    layer.setStyle({ weight: 4, color: "#FF4500" });
    setTimeout(() => {
      if (roomData && roomData.countryData && roomData.countryData[countryName]) {
        const ownerId = roomData.countryData[countryName].owner;
        if (ownerId && roomData.players[ownerId]) {
          layer.setStyle({
            fillColor: roomData.players[ownerId].color,
            fillOpacity: 0.7,
            color: "#555",
            weight: 1
          });
        } else {
          layer.setStyle({
            fillColor: "#ccc",
            fillOpacity: 0.7,
            color: "#555",
            weight: 1
          });
        }
      }
    }, 800);

    // Kale upgrade cost UI
    updateCastleUpgradeCostUI();
  }

  function updateCastleUpgradeCostUI() {
    const costSpan = document.getElementById("castle-upgrade-cost-text");
    if (!selectedCountry || !roomData || !roomData.countryData[selectedCountry]) {
      costSpan.textContent = "-";
      return;
    }
    const cData = roomData.countryData[selectedCountry];
    if (cData.castleDefenseLevel < 1) {
      costSpan.textContent = "Önce kale kurulmalı.";
      return;
    }
    if (cData.castleDefenseLevel >= 6) {
      costSpan.textContent = "Maksimum seviye (%30)!";
      return;
    }
    if (!cData.castleNextUpgradeCost) {
      costSpan.textContent = "-";
      return;
    }
    const cost = cData.castleNextUpgradeCost;
    costSpan.textContent = `${cost.money}$ + ${cost.petrol} Varil + ${cost.wheat} Buğday`;
  }

  /*****************************************************************
   * Oyuncu Seçim Listeleri (Kaynak Gönderme, PM, vb.)
   *****************************************************************/
  function updateRecipientSelects() {
    const moneySelect = document.getElementById("recipient-player");
    const petrolSelect = document.getElementById("recipient-player-petrol");
    const wheatSelect = document.getElementById("recipient-player-wheat");
    if (!moneySelect || !petrolSelect || !wheatSelect) return;
    moneySelect.innerHTML = "";
    petrolSelect.innerHTML = "";
    wheatSelect.innerHTML = "";

    if (!roomData || !roomData.playerOrder) return;
    roomData.playerOrder.forEach((pid) => {
      if (!roomData.players[pid]) return;
      // Kendimize gönderme engeli UI'da yapılabilir veya fonksiyonda kontrol
      const pName = roomData.players[pid].name;
      const opt1 = document.createElement("option");
      opt1.value = pid;
      opt1.textContent = pName;
      moneySelect.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = pid;
      opt2.textContent = pName;
      petrolSelect.appendChild(opt2);

      const opt3 = document.createElement("option");
      opt3.value = pid;
      opt3.textContent = pName;
      wheatSelect.appendChild(opt3);
    });
  }

  function updatePrivateMessageRecipientSelect() {
    const pmSelect = document.getElementById("private-message-recipient");
    if (!pmSelect) return;
    pmSelect.innerHTML = "";
    if (!roomData || !roomData.playerOrder) return;

    roomData.playerOrder.forEach((pid) => {
      if (pid === localPlayerId) return;
      if (roomData.players[pid]) {
        const opt = document.createElement("option");
        opt.value = pid;
        opt.textContent = roomData.players[pid].name;
        pmSelect.appendChild(opt);
      }
    });
  }

  function updatePactRecipientSelect() {
    const pactSelect = document.getElementById("pact-offer-recipient");
    if (!pactSelect) return;
    pactSelect.innerHTML = "";
    if (!roomData || !roomData.playerOrder) return;

    roomData.playerOrder.forEach((pid) => {
      if (pid === localPlayerId) return;
      const pName = roomData.players[pid]?.name;
      if (pName) {
        const opt = document.createElement("option");
        opt.value = pid;
        opt.textContent = pName;
        pactSelect.appendChild(opt);
      }
    });
  }

  function updateEmbargoPlayersSelect() {
    const embargoSelect = document.getElementById("embargo-players");
    if (!embargoSelect) return;
    embargoSelect.innerHTML = "";
    if (!roomData || !roomData.playerOrder) return;

    roomData.playerOrder.forEach((pid) => {
      if (pid === localPlayerId) return;
      const pName = roomData.players[pid]?.name;
      if (pName) {
        const opt = document.createElement("option");
        opt.value = pid;
        opt.textContent = pName;
        embargoSelect.appendChild(opt);
      }
    });
  }

  function updateSupportRecipientSelect() {
    const supportRecipient = document.getElementById("support-recipient");
    const supportRecipientCountry = document.getElementById(
      "support-recipient-country"
    );
    if (!supportRecipient || !supportRecipientCountry) return;
    supportRecipient.innerHTML = "";
    supportRecipientCountry.innerHTML = "";

    if (!roomData || !roomData.playerOrder) return;

    roomData.playerOrder.forEach((pid) => {
      if (pid === localPlayerId) return;
      if (roomData.players[pid]) {
        const opt = document.createElement("option");
        opt.value = pid;
        opt.textContent = roomData.players[pid].name;
        supportRecipient.appendChild(opt);
      }
    });

    // Ülkeler
    supportRecipientCountry.innerHTML = "<option value=''>--Ülke Seç--</option>";
    if (roomData.countryData) {
      Object.keys(roomData.countryData).forEach((cName) => {
        const option = document.createElement("option");
        option.value = cName;
        option.textContent = cName;
        supportRecipientCountry.appendChild(option);
      });
    }
  }

  /*****************************************************************
   * SALDIRMAZLIK PAKTI
   *****************************************************************/
  document
    .getElementById("send-pact-offer-btn")
    .addEventListener("click", () => {
      if (!isMyTurn()) {
        showNotification(
          "Saldırmazlık Paktı teklifini sadece kendi sıranızda gönderebilirsiniz!"
        );
        return;
      }

      const recipient = document.getElementById("pact-offer-recipient").value;
      const duration = parseInt(document.getElementById("pact-duration").value);
      const cost = parseInt(document.getElementById("pact-cost").value);

      if (!recipient) {
        showNotification("Lütfen bir oyuncu seçin!");
        return;
      }
      if (isNaN(duration) || duration <= 0) {
        showNotification("Geçerli tur sayısı girin!");
        return;
      }
      if (isNaN(cost) || cost < 0) {
        showNotification("Geçerli bir para miktarı girin (0 veya üstü)!");
        return;
      }

      if (hasActivePact(localPlayerId, recipient)) {
        showNotification("Bu oyuncuyla zaten aktif bir saldırmazlık paktınız var!");
        return;
      }

      const senderData = roomData.players[localPlayerId];
      if (!senderData) return;

      const offerRef = roomRef.child("pactOffers").push();
      const newOffer = {
        offerId: offerRef.key,
        senderId: localPlayerId,
        senderName: senderData.name,
        recipientId: recipient,
        duration: duration,
        cost: cost,
        status: "pending"
      };
      offerRef.set(newOffer);
      broadcastNotification(
        `Saldırmazlık Paktı Teklifi: ${senderData.name} → ${
          roomData.players[recipient].name
        } (Tur: ${duration}, Para: ${cost}$)`
      );
      showNotification("Pakt teklifi gönderildi!");
    });

  function displayPendingPactOffers() {
    const container = document.getElementById("pact-pending-offers");
    if (!container) return;
    container.innerHTML = "";
    if (!roomData || !roomData.pactOffers) return;

    Object.values(roomData.pactOffers).forEach((offer) => {
      if (offer.status === "pending" && offer.recipientId === localPlayerId) {
        const div = document.createElement("div");
        div.className = "pact-offer-item";
        div.dataset.offerId = offer.offerId;

        div.innerHTML = `
          <p><strong>${offer.senderName}</strong> size saldırmazlık pakti teklif ediyor.</p>
          <p>Tur sayısı: <strong>${offer.duration}</strong></p>
          <p>Para talebi: <strong>${offer.cost}$</strong></p>
          <button class="accept-btn" data-offer-id="${offer.offerId}">Kabul Et</button>
          <button class="reject-btn" data-offer-id="${offer.offerId}">Reddet</button>
        `;
        container.appendChild(div);
      }
    });
  }

  function displayActivePacts() {
    const container = document.getElementById("active-pacts-container");
    if (!container) return;
    container.innerHTML = "";
    if (!roomData || !roomData.pacts) return;

    for (let pactId in roomData.pacts) {
      const p = roomData.pacts[pactId];
      if (p.active && roomData.round <= p.expirationRound) {
        if (p.playerA === localPlayerId || p.playerB === localPlayerId) {
          const other = p.playerA === localPlayerId ? p.playerB : p.playerA;
          const otherName = roomData.players[other]?.name || "???";
          const left = p.expirationRound - roomData.round + 1;
          const div = document.createElement("div");
          div.className = "active-pact-item";
          div.innerHTML = `
            <p>Pakt: <strong>${otherName}</strong></p>
            <p>Kalan Tur: <strong>${left}</strong></p>
          `;
          container.appendChild(div);
        }
      }
    }
  }

  document
    .getElementById("pact-pending-offers")
    .addEventListener("click", (e) => {
      if (e.target.classList.contains("accept-btn")) {
        const offerId = e.target.getAttribute("data-offer-id");
        acceptPactOffer(offerId);
      } else if (e.target.classList.contains("reject-btn")) {
        const offerId = e.target.getAttribute("data-offer-id");
        rejectPactOffer(offerId);
      }
    });

  function acceptPactOffer(offerId) {
    const offer = roomData.pactOffers[offerId];
    if (!offer || offer.status !== "pending") return;

    if (hasActivePact(offer.senderId, offer.recipientId)) {
      showNotification("Zaten aktif bir pakt var!");
      roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
      return;
    }

    const sender = roomData.players[offer.senderId];
    const recipient = roomData.players[offer.recipientId];
    if (!sender || !recipient) {
      showNotification("Oyuncu verisi bulunamadı!");
      return;
    }
    if (sender.money < offer.cost) {
      showNotification("Teklifi gönderenin yeterli parası yok!");
      roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
      return;
    }

    const expirationRound = (roomData.round || 1) + offer.duration;
    const pactId = db.ref().push().key;
    const updates = {};

    updates[`pactOffers/${offerId}/status`] = "accepted";
    updates[`players/${offer.senderId}/money`] = sender.money - offer.cost;
    updates[`players/${offer.recipientId}/money`] = recipient.money + offer.cost;

    updates[`pacts/${pactId}`] = {
      playerA: offer.senderId,
      playerB: offer.recipientId,
      active: true,
      cost: offer.cost,
      duration: offer.duration,
      expirationRound: expirationRound
    };

    roomRef.update(updates);

    broadcastNotification(
      `Pakt Anlaşması: ${sender.name} & ${recipient.name} (Tur: ${offer.duration}, Para: ${offer.cost}$)`
    );
    showNotification("Pakt teklifi kabul edildi!");
  }

  function rejectPactOffer(offerId) {
    const offer = roomData.pactOffers[offerId];
    if (!offer || offer.status !== "pending") return;
    roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });

    broadcastNotification(
      `Pakt Reddedildi: ${offer.senderName} → Teklif reddedildi.`
    );
    showNotification("Teklif reddedildi.");
  }

  /*****************************************************************
   * ASKERİ İŞLEMLER
   *****************************************************************/
  // Saldırı
  document.getElementById("attack-btn").addEventListener("click", () => {
    if (!isMyTurn()) {
      showNotification("Şu anda sıranız değil!");
      return;
    }
    if (!selectedCountry) {
      showNotification("Bir ülke seçin!");
      return;
    }
    const soldiersToSend = parseInt(
      document.getElementById("attack-soldiers").value
    );
    if (isNaN(soldiersToSend) || soldiersToSend <= 0) {
      showNotification("Geçerli asker sayısı girin!");
      return;
    }

    const attacker = roomData.players[localPlayerId];
    if (attacker.petrol < soldiersToSend) {
      showNotification(
        `Askerleri göndermek için ${soldiersToSend} varil petrol lazım, yetersiz!`
      );
      return;
    }

    const target = roomData.countryData[selectedCountry];
    if (!target) return;

    // İlk 3 tur sadece sahipsiz
    if (roomData.round < 4 && target.owner && target.owner !== localPlayerId) {
      showNotification("İlk 3 tur sadece sahipsiz ülkelere saldırabilirsiniz!");
      return;
    }

    // Pakt var mı?
    if (target.owner && target.owner !== localPlayerId) {
      if (hasActivePact(localPlayerId, target.owner)) {
        showNotification("Bu oyuncuyla saldırmazlık paktınız var!");
        return;
      }
    }

    // Asker yeterliliği
    if (soldiersToSend > attacker.soldiers) {
      showNotification("Bu kadar askerin yok!");
      return;
    }

    const updates = {};
    // Petrol harcama
    updates[`players/${localPlayerId}/petrol`] = attacker.petrol - soldiersToSend;
    // Saldıran askeri rezervden düş
    updates[`players/${localPlayerId}/soldiers`] =
      attacker.soldiers - soldiersToSend;

    // Kendi toprağına yerleştirme
    if (target.owner === localPlayerId) {
      // Sadece asker yerleştir
      updates[`countryData/${selectedCountry}/soldiers`] =
        target.soldiers + soldiersToSend;
      broadcastNotification(
        `Asker Yerleştirme: ${attacker.name}, kendi ülkesine ${soldiersToSend} asker getirdi (${selectedCountry}).`
      );
      showNotification(
        `${selectedCountry} ülkesine ${soldiersToSend} asker yerleştirildi.`
      );
      roomRef.update(updates);
      return;
    }

    // Kale savunma etkisi
    let effectiveAttackers = soldiersToSend;
    if (target.castleDefenseLevel > 0) {
      const defPercent = target.castleDefenseLevel * 5; // %5-30
      const killedByCastle = Math.floor((defPercent / 100) * effectiveAttackers);
      effectiveAttackers -= killedByCastle;
      if (effectiveAttackers < 0) effectiveAttackers = 0;
      showNotification(
        `Kale savunması: ${killedByCastle} saldıran asker öldü!`
      );
    }

    let attackResult = "";
    if (effectiveAttackers > target.soldiers) {
      // Fethedildi
      const remain = effectiveAttackers - target.soldiers;
      updates[`countryData/${selectedCountry}/soldiers`] = remain;
      updates[`countryData/${selectedCountry}/owner`] = localPlayerId;
      updates[`countryData/${selectedCountry}/supporters`] = {};

      // (Opsiyonel) Kale'yi sıfırlamak isterseniz bu satırları açın:
      // updates[`countryData/${selectedCountry}/castleDefenseLevel`] = 0;
      // updates[`countryData/${selectedCountry}/castleNextUpgradeCost`] = null;

      // Savunandan ülkeyi çıkar
      if (target.owner && roomData.players[target.owner]) {
        const defCountries = roomData.players[target.owner].countries || [];
        const newDefCountries = defCountries.filter((cn) => cn !== selectedCountry);
        updates[`players/${target.owner}/countries`] = newDefCountries;
      }
      // Saldırana ekle
      const myCountries = attacker.countries || [];
      if (!myCountries.includes(selectedCountry)) {
        myCountries.push(selectedCountry);
      }
      updates[`players/${localPlayerId}/countries`] = myCountries;
      attackResult = `${selectedCountry} fethedildi! (${soldiersToSend} vs ${target.soldiers})`;
    } else {
      // Savunan kazandı
      updates[`countryData/${selectedCountry}/soldiers`] =
        target.soldiers - effectiveAttackers;
      attackResult = `${selectedCountry} savunuldu! (${soldiersToSend} vs ${target.soldiers})`;
    }

    roomRef.update(updates, () => {
      // Saldırı sonrası anlık petrol geliri (örnek)
      immediateOilReward(localPlayerId);
    });
    broadcastNotification(
      `Saldırı: ${attacker.name} → ${selectedCountry}. ${attackResult}`
    );
    showNotification(attackResult);

    // Tur geç
    nextTurn();
  });

  // Saldırı sonrası petrol ödülü (tartışmalı bir mekanik)
  function immediateOilReward(playerId) {
    const pData = roomData.players[playerId];
    if (!pData || !pData.countries) return;
    let totalGain = 0;
    pData.countries.forEach((cName) => {
      const c = roomData.countryData[cName];
      if (c && c.oilProduction) {
        const eff = Math.floor(
          c.oilProduction * (1 + 0.15 * (c.refineries || 0))
        );
        totalGain += eff;
      }
    });
    if (totalGain > 0) {
      const updates = {};
      updates[`players/${playerId}/petrol`] = pData.petrol + totalGain;
      roomRef.update(updates);
      showNotification(`Saldırı sonrası anlık petrol +${totalGain}`);
      broadcastNotification(
        `${pData.name}, saldırı sonrası ${totalGain} varil petrol kazandı!`
      );
    }
  }

  // Asker satın alma
  document
    .getElementById("buy-soldiers-btn")
    .addEventListener("click", () => {
      const count = parseInt(
        document.getElementById("soldiers-to-buy").value
      );
      if (isNaN(count) || count <= 0) {
        showNotification("Geçerli asker sayısı girin!");
        return;
      }
      const costMoney = 10 * count;
      const costWheat = 25 * count;

      const pData = roomData.players[localPlayerId];
      if (pData.money < costMoney) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (pData.wheat < costWheat) {
        showNotification("Yeterli buğdayınız yok!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = pData.money - costMoney;
      updates[`players/${localPlayerId}/wheat`] = pData.wheat - costWheat;
      updates[`players/${localPlayerId}/soldiers`] = pData.soldiers + count;

      roomRef.update(updates);
      broadcastNotification(`${pData.name}, ${count} asker satın aldı!`);
      showNotification(`${count} asker satın alındı.`);
    });

  // Asker çek
  document
    .getElementById("pull-soldiers-btn")
    .addEventListener("click", () => {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const target = roomData.countryData[selectedCountry];
      if (!target) return;
      const count = parseInt(
        document.getElementById("pull-soldiers-count").value
      );
      if (isNaN(count) || count <= 0) {
        showNotification("Geçerli asker sayısı girin!");
        return;
      }
      const player = roomData.players[localPlayerId];
      if (!player) return;

      const updates = {};
      // Eğer ülkenin sahibi biz isek -> oradaki kendi askerimizi çekiyoruz
      if (target.owner === localPlayerId) {
        // O ülkedeki destekçi askerleri hariç, bize ait asker = total - sum of supporters
        let totalSupport = 0;
        if (target.supporters) {
          Object.values(target.supporters).forEach((num) => {
            totalSupport += num;
          });
        }
        const occupant = target.soldiers - totalSupport;
        if (occupant < count) {
          showNotification("Ülkede bu kadar kendi askeriniz yok!");
          return;
        }
        updates[`countryData/${selectedCountry}/soldiers`] =
          target.soldiers - count;
        updates[`players/${localPlayerId}/soldiers`] = player.soldiers + count;
        broadcastNotification(
          `${player.name}, ${selectedCountry} ülkesinden ${count} asker çekti.`
        );
      } else {
        // Destek olarak gönderdiğimizi geri çekiyoruz
        let sup = 0;
        if (target.supporters && target.supporters[localPlayerId]) {
          sup = target.supporters[localPlayerId];
        }
        if (sup < count) {
          showNotification("Bu ülkede bu kadar destek askeriniz yok!");
          return;
        }
        // Ülkedeki toplam askeri de azaltmak gerekir
        if (target.soldiers < count) {
          showNotification("Veri tutarsızlığı: ülkedeki asker sayısı yetersiz!");
          return;
        }
        updates[`countryData/${selectedCountry}/soldiers`] =
          target.soldiers - count;
        const newSup = sup - count;
        if (newSup <= 0) {
          updates[`countryData/${selectedCountry}/supporters/${localPlayerId}`] =
            null;
        } else {
          updates[`countryData/${selectedCountry}/supporters/${localPlayerId}`] =
            newSup;
        }
        updates[`players/${localPlayerId}/soldiers`] =
          player.soldiers + count;
        broadcastNotification(
          `${player.name}, ${selectedCountry} ülkesine verdiği ${count} askeri geri çekti.`
        );
      }
      roomRef.update(updates);
      showNotification(`${count} asker çekildi.`);
    });

  // Askeri destek gönder
  document
    .getElementById("send-support-btn")
    .addEventListener("click", () => {
      const recipientId = document.getElementById("support-recipient").value;
      const cName = document.getElementById("support-recipient-country").value;
      const sCount = parseInt(
        document.getElementById("support-soldiers").value
      );
      if (!recipientId || !cName) {
        showNotification("Oyuncu ve ülke seçmelisiniz!");
        return;
      }
      if (isNaN(sCount) || sCount <= 0) {
        showNotification("Geçerli asker sayısı girin!");
        return;
      }
      const player = roomData.players[localPlayerId];
      if (player.soldiers < sCount) {
        showNotification("Yeterli askeriniz yok!");
        return;
      }
      const targetC = roomData.countryData[cName];
      if (!targetC) {
        showNotification("Seçilen ülke bulunamadı!");
        return;
      }
      if (targetC.owner !== recipientId) {
        showNotification("Bu ülke o oyuncuya ait değil!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/soldiers`] = player.soldiers - sCount;
      updates[`countryData/${cName}/soldiers`] = targetC.soldiers + sCount;

      const oldSup =
        (targetC.supporters && targetC.supporters[localPlayerId]) || 0;
      updates[`countryData/${cName}/supporters/${localPlayerId}`] =
        oldSup + sCount;

      roomRef.update(updates);
      broadcastNotification(
        `${player.name}, ${roomData.players[recipientId].name} (${cName}) ülkesine ${sCount} asker destek gönderdi.`
      );
      showNotification("Askeri destek gönderildi!");
    });

  /*****************************************************************
   * BİNA KURMA
   *****************************************************************/
  // Kışla Kur
  document
    .getElementById("buy-barracks-btn")
    .addEventListener("click", () => {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const qty = parseInt(document.getElementById("barracks-quantity").value);
      if (isNaN(qty) || qty <= 0) {
        showNotification("Geçerli bir adet girin!");
        return;
      }
      const cData = roomData.countryData[selectedCountry];
      if (!cData || cData.owner !== localPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      const player = roomData.players[localPlayerId];
      const totalMoney = 300 * qty;
      const totalPetrol = 50 * qty;
      const totalWheat = 120 * qty;
      if (
        player.money < totalMoney ||
        player.petrol < totalPetrol ||
        player.wheat < totalWheat
      ) {
        showNotification("Yeterli kaynağınız yok!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = player.money - totalMoney;
      updates[`players/${localPlayerId}/petrol`] = player.petrol - totalPetrol;
      updates[`players/${localPlayerId}/wheat`] = player.wheat - totalWheat;
      updates[`countryData/${selectedCountry}/barracksCount`] =
        cData.barracksCount + qty;

      roomRef.update(updates);
      broadcastNotification(
        `${player.name}, ${selectedCountry} ülkesine ${qty} kışla kurdu!`
      );
      showNotification(`${qty} kışla kuruldu.`);
    });

  // Fabrika Kur
  document
    .getElementById("build-factory-btn")
    .addEventListener("click", () => {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const qty = parseInt(document.getElementById("factory-quantity").value);
      if (isNaN(qty) || qty <= 0) {
        showNotification("Geçerli adet girin!");
        return;
      }
      const cData = roomData.countryData[selectedCountry];
      if (!cData || cData.owner !== localPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      const player = roomData.players[localPlayerId];
      const costMoney = 500 * qty;
      const costPetrol = 130 * qty;
      if (player.money < costMoney || player.petrol < costPetrol) {
        showNotification("Yeterli kaynağınız yok!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = player.money - costMoney;
      updates[`players/${localPlayerId}/petrol`] = player.petrol - costPetrol;
      updates[`countryData/${selectedCountry}/factories`] =
        cData.factories + qty;

      roomRef.update(updates);
      broadcastNotification(
        `${player.name}, ${selectedCountry} ülkesine ${qty} fabrika kurdu!`
      );
      showNotification(`${qty} fabrika kuruldu.`);
    });

  // Rafine Kur
  document
    .getElementById("build-refinery-btn")
    .addEventListener("click", () => {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const qty = parseInt(document.getElementById("refinery-quantity").value);
      if (isNaN(qty) || qty <= 0) {
        showNotification("Geçerli adet girin!");
        return;
      }
      const cData = roomData.countryData[selectedCountry];
      if (!cData || cData.owner !== localPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      const player = roomData.players[localPlayerId];
      const costMoney = 800 * qty;
      const costPetrol = 250 * qty;
      if (player.money < costMoney || player.petrol < costPetrol) {
        showNotification("Yeterli kaynağınız yok!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = player.money - costMoney;
      updates[`players/${localPlayerId}/petrol`] = player.petrol - costPetrol;
      updates[`countryData/${selectedCountry}/refineries`] =
        cData.refineries + qty;

      roomRef.update(updates);
      broadcastNotification(
        `${player.name}, ${selectedCountry} ülkesine ${qty} rafine kurdu!`
      );
      showNotification(`${qty} rafine kuruldu.`);
    });

  // Değirmen Kur
  document
    .getElementById("build-grainmill-btn")
    .addEventListener("click", () => {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const qty = parseInt(document.getElementById("grainmill-quantity").value);
      if (isNaN(qty) || qty <= 0) {
        showNotification("Geçerli adet girin!");
        return;
      }
      const cData = roomData.countryData[selectedCountry];
      if (!cData || cData.owner !== localPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      const player = roomData.players[localPlayerId];
      const costMoney = 200 * qty;
      const costPetrol = 100 * qty;
      if (player.money < costMoney || player.petrol < costPetrol) {
        showNotification("Yeterli kaynağınız yok!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = player.money - costMoney;
      updates[`players/${localPlayerId}/petrol`] = player.petrol - costPetrol;
      updates[`countryData/${selectedCountry}/grainMills`] =
        cData.grainMills + qty;

      roomRef.update(updates);
      broadcastNotification(
        `${player.name}, ${selectedCountry} ülkesine ${qty} değirmen kurdu!`
      );
      showNotification(`${qty} değirmen kuruldu.`);
    });

  // Kale Kur
  document.getElementById("build-castle-btn").addEventListener("click", () => {
    if (!selectedCountry) {
      showNotification("Bir ülke seçin!");
      return;
    }
    const cData = roomData.countryData[selectedCountry];
    if (!cData || cData.owner !== localPlayerId) {
      showNotification("Bu ülke size ait değil!");
      return;
    }
    if (cData.castleDefenseLevel > 0) {
      showNotification("Bu ülkede zaten kale var!");
      return;
    }
    const player = roomData.players[localPlayerId];
    if (player.money < 1000 || player.petrol < 1000 || player.wheat < 1000) {
      showNotification("Kale kurmak için yeterli kaynağınız yok!");
      return;
    }
    const updates = {};
    updates[`players/${localPlayerId}/money`] = player.money - 1000;
    updates[`players/${localPlayerId}/petrol`] = player.petrol - 1000;
    updates[`players/${localPlayerId}/wheat`] = player.wheat - 1000;
    updates[`countryData/${selectedCountry}/castleDefenseLevel`] = 1;
    // İlk upgrade maliyeti
    updates[`countryData/${selectedCountry}/castleNextUpgradeCost`] = {
      money: 1300,
      petrol: 1300,
      wheat: 1300
    };

    roomRef.update(updates);
    broadcastNotification(
      `${player.name}, ${selectedCountry} ülkesine kale kurdu! (Savunma %5)`
    );
    showNotification("Kale kuruldu (Savunma %5).");
  });

  // Kale güçlendir
  document
    .getElementById("upgrade-castle-btn")
    .addEventListener("click", () => {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const cData = roomData.countryData[selectedCountry];
      if (!cData || cData.owner !== localPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      if (cData.castleDefenseLevel < 1) {
        showNotification("Önce kale kurun!");
        return;
      }
      if (cData.castleDefenseLevel >= 6) {
        showNotification("Kale savunması maksimum (%30)!");
        return;
      }
      if (!cData.castleNextUpgradeCost) {
        showNotification("Kale yükseltme maliyeti verisi yok!");
        return;
      }

      const cost = cData.castleNextUpgradeCost;
      const player = roomData.players[localPlayerId];
      if (
        player.money < cost.money ||
        player.petrol < cost.petrol ||
        player.wheat < cost.wheat
      ) {
        showNotification("Yeterli kaynağınız yok!");
        return;
      }
      const updates = {};
      updates[`players/${localPlayerId}/money`] = player.money - cost.money;
      updates[`players/${localPlayerId}/petrol`] = player.petrol - cost.petrol;
      updates[`players/${localPlayerId}/wheat`] = player.wheat - cost.wheat;

      const newLevel = cData.castleDefenseLevel + 1;
      updates[`countryData/${selectedCountry}/castleDefenseLevel`] = newLevel;

      const newCost = {
        money: Math.floor(cost.money * 1.3),
        petrol: Math.floor(cost.petrol * 1.3),
        wheat: Math.floor(cost.wheat * 1.3)
      };
      updates[`countryData/${selectedCountry}/castleNextUpgradeCost`] = newCost;

      roomRef.update(updates, () => {
        updateCastleUpgradeCostUI();
      });
      broadcastNotification(
        `${player.name}, ${selectedCountry} kalesini güçlendirdi (Seviye ${newLevel}, Savunma %${
          newLevel * 5
        }).`
      );
      showNotification(
        `Kale güçlendirildi. Yeni savunma: %${newLevel * 5}.`
      );
    });

  /*****************************************************************
   * KAYNAK GÖNDERME
   *****************************************************************/
  document.getElementById("send-money-btn").addEventListener("click", () => {
    const amount = parseInt(document.getElementById("money-to-send").value);
    const recipId = document.getElementById("recipient-player").value;
    if (isNaN(amount) || amount <= 0) {
      showNotification("Geçerli miktar girin!");
      return;
    }
    if (recipId === localPlayerId) {
      showNotification("Kendinize kaynak gönderemezsiniz!");
      return;
    }
    const pData = roomData.players[localPlayerId];
    if (pData.money < amount) {
      showNotification("Yeterli paranız yok!");
      return;
    }
    const updates = {};
    updates[`players/${localPlayerId}/money`] = pData.money - amount;
    updates[`players/${recipId}/money`] =
      roomData.players[recipId].money + amount;
    roomRef.update(updates);
    broadcastNotification(
      `${pData.name}, ${roomData.players[recipId].name} adlı oyuncuya ${amount}$ gönderdi.`
    );
    showNotification(`${amount}$ gönderildi.`);
  });

  document.getElementById("send-petrol-btn").addEventListener("click", () => {
    const amount = parseInt(document.getElementById("petrol-to-send").value);
    const recipId = document.getElementById("recipient-player-petrol").value;
    if (isNaN(amount) || amount <= 0) {
      showNotification("Geçerli miktar girin!");
      return;
    }
    if (recipId === localPlayerId) {
      showNotification("Kendinize kaynak gönderemezsiniz!");
      return;
    }
    const pData = roomData.players[localPlayerId];
    if (pData.petrol < amount) {
      showNotification("Yeterli petrolünüz yok!");
      return;
    }
    const updates = {};
    updates[`players/${localPlayerId}/petrol`] = pData.petrol - amount;
    updates[`players/${recipId}/petrol`] =
      roomData.players[recipId].petrol + amount;
    roomRef.update(updates);
    broadcastNotification(
      `${pData.name}, ${roomData.players[recipId].name} adlı oyuncuya ${amount} varil petrol gönderdi.`
    );
    showNotification(`${amount} varil petrol gönderildi.`);
  });

  document.getElementById("send-wheat-btn").addEventListener("click", () => {
    const amount = parseInt(document.getElementById("wheat-to-send").value);
    const recipId = document.getElementById("recipient-player-wheat").value;
    if (isNaN(amount) || amount <= 0) {
      showNotification("Geçerli miktar girin!");
      return;
    }
    if (recipId === localPlayerId) {
      showNotification("Kendinize kaynak gönderemezsiniz!");
      return;
    }
    const pData = roomData.players[localPlayerId];
    if (pData.wheat < amount) {
      showNotification("Yeterli buğdayınız yok!");
      return;
    }
    const updates = {};
    updates[`players/${localPlayerId}/wheat`] = pData.wheat - amount;
    updates[`players/${recipId}/wheat`] =
      roomData.players[recipId].wheat + amount;
    roomRef.update(updates);
    broadcastNotification(
      `${pData.name}, ${roomData.players[recipId].name} adlı oyuncuya ${amount} buğday gönderdi.`
    );
    showNotification(`${amount} buğday gönderildi.`);
  });

  /*****************************************************************
   * TUR GEÇİŞİ
   *****************************************************************/
  function nextTurn(autoEnd = false) {
    if (!isMyTurn()) return;
    stopTurnTimer();

    const cIndex = roomData.currentTurnIndex || 0;
    const cPlayerId = roomData.playerOrder[cIndex];
    const pData = roomData.players[cPlayerId];
    if (!pData) return;

    const updates = {};

    // Tur gelir/üretim
    if (pData.countries && roomData.countryData) {
      let totalMoney = 0;
      let totalPetrol = 0;
      let totalWheat = 0;

      pData.countries.forEach((cn) => {
        const c = roomData.countryData[cn];
        if (!c) return;
        // Kışla asker üretimi
        if (c.barracksCount && c.barracksCount > 0) {
          const newSoldiers = (c.soldiers || 0) + 5 * c.barracksCount;
          updates[`countryData/${cn}/soldiers`] = newSoldiers;
        }
        // Para
        let effIncome = c.income || 0;
        if (c.factories && c.factories > 0) {
          effIncome = Math.floor(effIncome * (1 + 0.2 * c.factories));
        }
        totalMoney += effIncome;
        // Petrol
        if (c.oilProduction) {
          const effOil = Math.floor(
            c.oilProduction * (1 + 0.15 * (c.refineries || 0))
          );
          totalPetrol += effOil;
        }
        // Buğday
        if (c.wheatProduction) {
          const effWheat = Math.floor(
            c.wheatProduction * (1 + 0.2 * (c.grainMills || 0))
          );
          totalWheat += effWheat;
        }
      });

      updates[`players/${cPlayerId}/money`] = pData.money + totalMoney;
      updates[`players/${cPlayerId}/petrol`] = pData.petrol + totalPetrol;
      updates[`players/${cPlayerId}/wheat`] = pData.wheat + totalWheat;
    }

    // Sırayı ilerlet
    let newIndex = cIndex + 1;
    let newRound = roomData.round || 1;
    if (newIndex >= roomData.playerOrder.length) {
      newIndex = 0;
      newRound++;
      updates["round"] = newRound;
    }
    updates["currentTurnIndex"] = newIndex;

    roomRef.update(updates);

    const nextId = roomData.playerOrder[newIndex];
    let endText = `Sıra ${roomData.players[nextId].name} adlı oyuncuya geçti.`;
    if (autoEnd) {
      endText = `${pData.name} süresini doldurdu! ${endText}`;
    }
    broadcastNotification(endText);
    showNotification(endText, 1500);
  }
  document.getElementById("end-turn-btn").addEventListener("click", () => {
    nextTurn(false);
  });

  /*****************************************************************
   * ODADAN ÇIK
   *****************************************************************/
  document.getElementById("exit-room-btn").addEventListener("click", () => {
    if (!roomRef || !roomData) return;

    const newOrder = (roomData.playerOrder || []).filter(
      (id) => id !== localPlayerId
    );
    const updates = {};

    // Eğer sıra bizdeyse turnu devret
    if (isMyTurn()) {
      stopTurnTimer();
      let idx = roomData.currentTurnIndex || 0;
      idx++;
      let newRound = roomData.round || 1;
      if (idx >= newOrder.length) {
        idx = 0;
        newRound++;
      }
      updates["round"] = newRound;
      updates["currentTurnIndex"] = idx;
    }

    updates[`playerOrder`] = newOrder;
    updates[`players/${localPlayerId}`] = null;

    roomRef.update(updates);

    document.getElementById("game-container").style.display = "none";
    document.getElementById("lobby-container").style.display = "block";
    document.body.classList.add("lobby");

    localStorage.removeItem("roomCode");
    stopTurnTimer();
    clearInterval(startInterval);
    showNotification("Odadan çıktınız. Artık oyunda yoksunuz.");
  });

  /*****************************************************************
   * CHAT (Genel + Özel)
   *****************************************************************/
  function toggleChat(show) {
    const chatPopup = document.getElementById("chat-popup");
    chatPopup.style.display = show ? "flex" : "none";
    chatOpen = show;
    if (chatOpen) {
      unreadMessages = 0;
      updateChatBadge();
    }
  }

  document.getElementById("open-chat-btn").addEventListener("click", () => {
    toggleChat(!chatOpen);
  });
  document.getElementById("chat-popup-header").addEventListener("click", (e) => {
    if (e.target.id === "chat-popup-header") {
      toggleChat(false);
    }
  });
  document.getElementById("close-chat-btn").addEventListener("click", () => {
    toggleChat(false);
  });

  document.getElementById("send-chat-btn").addEventListener("click", () => {
    sendChatMessage();
  });
  document.getElementById("chat-input").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      sendChatMessage();
    }
  });

  function sendChatMessage() {
    const input = document.getElementById("chat-input");
    const txt = input.value.trim();
    if (!txt) return;
    let senderName = "Anon";
    if (roomData && roomData.players && roomData.players[localPlayerId]) {
      senderName = roomData.players[localPlayerId].name;
    }
    const msgObj = {
      sender: senderName,
      senderId: localPlayerId,
      text: txt,
      recipientId: "",
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child("chat").push(msgObj, (err) => {
      if (!err) {
        input.value = "";
      }
    });
  }

  document
    .getElementById("send-private-message-btn")
    .addEventListener("click", () => {
      const pmInput = document.getElementById("private-message-input");
      const pmRecip = document.getElementById("private-message-recipient").value;
      const pmText = pmInput.value.trim();
      if (!pmText || !pmRecip) return;

      let senderName = "Anon";
      if (roomData && roomData.players && roomData.players[localPlayerId]) {
        senderName = roomData.players[localPlayerId].name;
      }
      const msgObj = {
        sender: senderName,
        senderId: localPlayerId,
        text: pmText,
        recipientId: pmRecip,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.child("chat").push(msgObj, (err) => {
        if (!err) {
          pmInput.value = "";
          showNotification("Özel mesaj gönderildi!");
        }
      });
    });

  function appendChatMessage(message) {
    // Özel mesaj mı?
    if (message.recipientId && message.recipientId !== "") {
      // Bize mi geldi veya biz mi gönderdik?
      if (
        message.senderId !== localPlayerId &&
        message.recipientId !== localPlayerId
      ) {
        // İlgisiz PM
        return;
      }
    }
    const chatMsgDiv = document.getElementById("chat-messages");
    const div = document.createElement("div");
    if (message.recipientId && message.recipientId !== "") {
      // PM
      const targetName = roomData.players[message.recipientId]?.name || "???";
      if (message.senderId === localPlayerId) {
        // Biz gönderdik
        div.innerHTML = `<strong>[PM to ${targetName}]:</strong> ${message.text}`;
      } else {
        // Bize geldi
        div.innerHTML = `<strong>[PM from ${message.sender}]:</strong> ${message.text}`;
      }
      div.style.color = "#f39c12";
    } else {
      // Genel
      div.textContent = `${message.sender}: ${message.text}`;
    }
    chatMsgDiv.appendChild(div);
    chatMsgDiv.scrollTop = chatMsgDiv.scrollHeight;

    // Popup kapalıysa unread++
    if (!chatOpen && message.senderId !== localPlayerId) {
      unreadMessages++;
      updateChatBadge();
    }
  }

  function updateChatBadge() {
    const btn = document.getElementById("open-chat-btn");
    if (unreadMessages > 0) {
      btn.dataset.badge = unreadMessages;
    } else {
      btn.dataset.badge = "";
    }
  }

  /*****************************************************************
   * TİCARET (MARKET) SİSTEMİ
   *****************************************************************/
  document
    .getElementById("open-market-btn")
    .addEventListener("click", () => {
      const marketPopup = document.getElementById("market-popup");
      marketPopup.style.display =
        marketPopup.style.display === "flex" ? "none" : "flex";
    });
  document
    .getElementById("market-popup-header")
    .addEventListener("click", (e) => {
      if (e.target.id === "market-popup-header") {
        document.getElementById("market-popup").style.display = "none";
      }
    });
  document
    .getElementById("close-market-btn")
    .addEventListener("click", () => {
      document.getElementById("market-popup").style.display = "none";
    });

  document
    .getElementById("create-trade-offer-btn")
    .addEventListener("click", () => {
      createTradeOffer();
    });

  function createTradeOffer() {
    if (!roomData || !roomData.players[localPlayerId]) {
      showNotification("Oyun verisi geçersiz!");
      return;
    }
    const itemType = document.getElementById("trade-item-type").value;
    const quantity = parseInt(document.getElementById("trade-quantity").value);
    const price = parseInt(document.getElementById("trade-price").value);

    if (
      isNaN(quantity) ||
      quantity <= 0 ||
      isNaN(price) ||
      price <= 0
    ) {
      showNotification("Geçerli miktar/fiyat girin!");
      return;
    }
    const seller = roomData.players[localPlayerId];
    let enough = false;
    if (itemType === "petrol" && seller.petrol >= quantity) {
      enough = true;
    } else if (itemType === "wheat" && seller.wheat >= quantity) {
      enough = true;
    }
    if (!enough) {
      showNotification("Satacak yeterli miktarınız yok!");
      return;
    }

    // Ambargo listesi
    const embargoSelect = document.getElementById("embargo-players");
    let embargoList = [];
    for (let i = 0; i < embargoSelect.options.length; i++) {
      if (embargoSelect.options[i].selected) {
        embargoList.push(embargoSelect.options[i].value);
      }
    }

    const offerRef = roomRef.child("tradeOffers").push();
    const newOffer = {
      offerId: offerRef.key,
      sellerId: localPlayerId,
      sellerName: seller.name,
      itemType: itemType,
      quantity: quantity,
      price: price,
      status: "pending",
      embargo: embargoList
    };
    offerRef.set(newOffer);

    broadcastNotification(
      `${seller.name} bir ticaret teklifi oluşturdu (${itemType}, adet: ${quantity}, fiyat: ${price}$).`
    );
    showNotification("Ticaret teklifi oluşturuldu!");
  }

  function displayTradeOffers() {
    const listDiv = document.getElementById("trade-offers-list");
    if (!listDiv) return;
    listDiv.innerHTML = "";
    if (!roomData || !roomData.tradeOffers) return;

    const offers = Object.values(roomData.tradeOffers);
    offers.forEach((off) => {
      if (off.status === "pending") {
        // Embargo
        if (off.embargo && off.embargo.includes(localPlayerId)) {
          return; // Embargo uygulanan göremez
        }
        const div = document.createElement("div");
        div.className = "offer-item";

        let label = off.itemType === "petrol" ? "Petrol" : "Buğday";
        let html = `
          <p><strong>Satıcı:</strong> ${off.sellerName}</p>
          <p><strong>Ürün:</strong> ${label}</p>
          <p><strong>Mevcut Miktar:</strong> ${off.quantity}</p>
          <p><strong>Birim Fiyat:</strong> ${off.price} $</p>
        `;
        if (off.sellerId !== localPlayerId) {
          // Satın alma
          html += `
            <label style="font-size:14px;color:#ccc;">Almak istediğiniz miktar:</label>
            <input type="number" class="partial-buy-quantity" placeholder="Miktar" min="1" max="${off.quantity}"/>
            <button class="partial-buy-btn">Satın Al</button>
          `;
        } else {
          // İptal butonu
          html += `
            <button class="cancel-offer-btn" 
              style="background:linear-gradient(45deg, #c0392b, #e74c3c); margin-top:10px;">
              İptal
            </button>
          `;
        }
        if (off.embargo && off.embargo.length > 0) {
          const names = off.embargo.map((id) => roomData.players[id]?.name || "???");
          html += `<p style="color:red;"><strong>Ambargo:</strong> ${names.join(", ")}</p>`;
        }
        div.innerHTML = html;

        // Buton event
        const buyBtn = div.querySelector(".partial-buy-btn");
        if (buyBtn) {
          buyBtn.addEventListener("click", () => {
            const input = div.querySelector(".partial-buy-quantity");
            const amt = parseInt(input.value);
            if (isNaN(amt) || amt <= 0) {
              showNotification("Geçerli miktar girin!");
              return;
            }
            acceptTradeOffer(off.offerId, amt);
          });
        }
        const cancelBtn = div.querySelector(".cancel-offer-btn");
        if (cancelBtn) {
          cancelBtn.addEventListener("click", () => {
            cancelTradeOffer(off.offerId);
          });
        }

        listDiv.appendChild(div);
      }
    });
  }

  function acceptTradeOffer(offerId, buyAmount) {
    if (!roomData.tradeOffers || !roomData.tradeOffers[offerId]) {
      showNotification("Teklif bulunamadı!");
      return;
    }
    const off = roomData.tradeOffers[offerId];
    if (off.status !== "pending") {
      showNotification("Bu teklif aktif değil!");
      return;
    }
    const seller = roomData.players[off.sellerId];
    const buyer = roomData.players[localPlayerId];
    if (!seller || !buyer) {
      showNotification("Geçersiz satıcı/alıcı!");
      return;
    }
    if (buyAmount > off.quantity) {
      showNotification("Teklifte bu kadar ürün yok!");
      return;
    }
    const totalCost = off.price * buyAmount;
    if (buyer.money < totalCost) {
      showNotification("Yeterli paranız yok!");
      return;
    }

    let updates = {};
    if (off.itemType === "petrol") {
      // Satıcının deposu yeterli mi?
      if (seller.petrol < buyAmount) {
        showNotification("Satıcının yeterli petrolü kalmamış!");
        return;
      }
      updates[`players/${off.sellerId}/petrol`] = seller.petrol - buyAmount;
      updates[`players/${localPlayerId}/petrol`] = buyer.petrol + buyAmount;
    } else if (off.itemType === "wheat") {
      if (seller.wheat < buyAmount) {
        showNotification("Satıcının yeterli buğdayı kalmamış!");
        return;
      }
      updates[`players/${off.sellerId}/wheat`] = seller.wheat - buyAmount;
      updates[`players/${localPlayerId}/wheat`] = buyer.wheat + buyAmount;
    }

    // Para transfer
    updates[`players/${localPlayerId}/money`] = buyer.money - totalCost;
    updates[`players/${off.sellerId}/money`] = seller.money + totalCost;

    // Teklif güncelle
    let newQty = off.quantity - buyAmount;
    if (newQty <= 0) {
      updates[`tradeOffers/${offerId}/status`] = "completed";
    }
    updates[`tradeOffers/${offerId}/quantity`] = newQty;

    roomRef.update(updates, (err) => {
      if (!err) {
        broadcastNotification(
          `Ticaret Onaylandı: ${seller.name} -> ${buyer.name}, ${buyAmount} x ${off.itemType}`
        );
        showNotification("Satın alma başarılı!");
        // Chat'e de mesaj ekleyelim
        const chatMsg = {
          sender: "Sistem",
          senderId: "system",
          text: `Ticaret: ${seller.name} -> ${buyer.name}, ${buyAmount} x ${off.itemType}`,
          recipientId: "",
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        roomRef.child("chat").push(chatMsg);
      }
    });
  }

  function cancelTradeOffer(offerId) {
    if (!roomData.tradeOffers || !roomData.tradeOffers[offerId]) return;
    const off = roomData.tradeOffers[offerId];
    if (off.sellerId !== localPlayerId) {
      showNotification("Sadece kendi teklifinizi iptal edebilirsiniz!");
      return;
    }
    if (off.status !== "pending") {
      showNotification("Bu teklif zaten tamamlandı veya iptal edildi.");
      return;
    }
    roomRef.child("tradeOffers").child(offerId).update({ status: "cancelled" });
    broadcastNotification(`Ticaret teklifi iptal edildi: ${off.sellerName}.`);
    showNotification("Teklif iptal edildi.");
  }

  /*****************************************************************
   * LEAFLET HARİTA
   *****************************************************************/
  function initializeMap() {
    if (map) return;
    map = L.map("map").setView([20, 0], 2);

    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 12,
        attribution:
          'Tiles &copy; Esri &mdash; Source: Esri, GEBCO, NOAA, National Geographic, DeLorme, HERE, Geonames.org ' +
          "and other contributors"
      }
    ).addTo(map);

    fetch(
      "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json"
    )
      .then((res) => res.json())
      .then((geoData) => {
        geoJsonLayer = L.geoJson(geoData, {
          style: () => ({
            color: "#555",
            weight: 1,
            fillColor: "#ccc",
            fillOpacity: 0.7
          }),
          onEachFeature: (feature, layer) => {
            const cName = feature.properties.name;
            const cData = (roomData && roomData.countryData) ? roomData.countryData[cName] : null;
            const tooltipContent = getCountryPopupContent(cName, cData || {});
            layer.bindTooltip(tooltipContent, {
              permanent: infoCardsPermanent,
              direction: "center",
              className: "country-popup-tooltip"
            });
            layer.on("click", () => selectCountry(cName, layer));
          }
        }).addTo(map);
      });
  }

  // Gözlemci ile game-container açıldığında haritayı başlat
  const gameContainerObserver = new MutationObserver(() => {
    const gc = document.getElementById("game-container");
    if (gc.style.display !== "none") {
      initializeMap();
    }
  });
  gameContainerObserver.observe(document.getElementById("game-container"), {
    attributes: true,
    attributeFilter: ["style"]
  });
</script>
