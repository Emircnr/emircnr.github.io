<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Harita Fetih Oyunu - Online (Güncellenmiş)</title>
  
  <!-- External Kütüphaneler -->
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  
  <!-- Inline CSS -->
  <style>
    /* ==================================================
       Genel Sıfırlama ve Global Ayarlar
       ================================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #2a2a3d);
      color: #eee;
      overflow-x: hidden;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    
    /* ==================================================
       Bildirim (Popup) Alanı
       ================================================== */
    #notification-area {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      display: none;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      font-size: 14px;
    }
    
    /* ==================================================
       Lobby Ekranı (Oda Oluşturma & Katılma)
       ================================================== */
    #lobby-container {
      max-width: 500px;
      margin: 50px auto;
      padding: 20px;
      background: #2a2a3d;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    }
    #lobby-container h1, 
    #lobby-container h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #f1c40f;
    }
    #lobby-container input[type="text"],
    #lobby-container input[type="number"] {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    #lobby-container button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(45deg, #f39c12, #e67e22);
      border: none;
      border-radius: 6px;
      font-size: 16px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
      margin-bottom: 15px;
    }
    #lobby-container button:hover {
      background: linear-gradient(45deg, #e67e22, #d35400);
    }
    .color-options {
      margin-bottom: 15px;
      text-align: center;
    }
    .global-color-option {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      display: inline-block;
      margin: 0 5px;
      transition: transform 0.3s, border-color 0.3s;
    }
    .global-color-option:hover {
      transform: scale(1.1);
      border-color: #fff;
    }
    .global-color-option.selected {
      border-color: #f1c40f;
    }
    
    /* ==================================================
       Oyun Ekranı Stilleri
       ================================================== */
    #game-container {
      display: none; /* Oyun başlamadan görünmez */
      height: 100vh;
    }
    #main-content {
      display: flex;
      height: 100%;
    }
    /* Harita Bölgesi */
    #map-container {
      flex: 7;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    /* Sağ Panel */
    #side-panel {
      flex: 3;
      background: #1e1e2f;
      padding: 20px;
      overflow-y: auto;
      box-shadow: -4px 0 10px rgba(0, 0, 0, 0.4);
    }
    /* Üst Bilgi (Oyun Bilgileri) */
    #game-info {
      margin-bottom: 20px;
      background: #2a2a3d;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    #game-info h2 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #f1c40f;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    #game-info p {
      font-size: 14px;
      margin: 6px 0;
      color: #ddd;
    }
    /* Oyuncu Bilgileri */
    #player-info-section {
      margin-bottom: 20px;
    }
    #player-info-section h2 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #f1c40f;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    .player-info {
      background: #24243a;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      font-size: 14px;
    }
    .player-info p {
      margin: 4px 0;
      color: #ddd;
    }
    /* Ülke Detayları */
    #country-info-section {
      margin-bottom: 20px;
    }
    #country-info-section h2 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #f1c40f;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    #country-info p {
      font-size: 14px;
      margin: 6px 0;
      color: #ddd;
    }
    #country-info p span {
      font-weight: 600;
      color: #f39c12;
    }
    /* İşlem ve Market Bölümü */
    #market-section {
      margin-bottom: 20px;
    }
    #market-section h2 {
      margin-bottom: 10px;
      font-size: 20px;
      color: #f1c40f;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    .action-group {
      margin-bottom: 15px;
      background: #24243a;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
    }
    .action-group h3 {
      font-size: 16px;
      color: #ccc;
      margin-bottom: 8px;
    }
    .action-group input[type="number"],
    .action-group select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }
    .action-group button {
      width: 100%;
      padding: 10px;
      background: linear-gradient(45deg, #f39c12, #e67e22);
      border: none;
      border-radius: 4px;
      font-size: 14px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    .action-group button:hover {
      background: linear-gradient(45deg, #e67e22, #d35400);
    }
    .turn-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #ddd;
      margin-bottom: 10px;
    }
    .turn-info span {
      font-weight: 600;
      color: #f1c40f;
    }
    
    /* ==================================================
       Responsive Düzen
       ================================================== */
    @media (max-width: 768px) {
      #main-content {
        flex-direction: column;
      }
      #map-container,
      #side-panel {
        flex: unset;
        height: 50vh;
      }
      #side-panel {
        box-shadow: none;
        border-top: 1px solid #444;
      }
    }
    
    /* ==================================================
       Leaflet Tooltip & Ülke Popup
       ================================================== */
    .leaflet-tooltip {
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      padding: 4px 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
    }
    .country-popup-tooltip {
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      text-align: left;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
    }
    .country-popup-tooltip .emoji {
      margin-right: 4px;
    }
    
    /* ==================================================
       Buton Ripple Efekti
       ================================================== */
    .button-click-effect {
      position: relative;
      overflow: hidden;
    }
    .button-click-effect .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.6);
      transform: scale(0);
      animation: ripple-animation 0.6s linear;
    }
    @keyframes ripple-animation {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }
    
    /* ==================================================
       Saldırı Efekti (Attack Effect)
       ================================================== */
    .attack-effect {
      animation: attack-effect 0.6s;
    }
    @keyframes attack-effect {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.5;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    /* ==================================================
       CHAT ve Pakt Teklifi Stilleri
       ================================================== */
    .chat-popup {
      position: fixed;
      bottom: 70px;
      right: 20px;
      width: 300px;
      max-height: 400px;
      background: #2a2a3d;
      border: 1px solid #444;
      border-radius: 8px;
      display: none;
      flex-direction: column;
      z-index: 3000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .chat-header {
      background: #1e1e2f;
      padding: 10px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      color: #f1c40f;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-header button {
      background: transparent;
      border: none;
      color: #f1c40f;
      font-size: 20px;
      cursor: pointer;
    }
    .chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #2a2a3d;
      color: #eee;
      font-size: 14px;
    }
    .chat-input-container {
      display: flex;
      border-top: 1px solid #444;
    }
    .chat-input-container input[type="text"] {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
      background: #1e1e2f;
      color: #eee;
    }
    .chat-input-container button {
      padding: 10px;
      background: linear-gradient(45deg, #f39c12, #e67e22);
      border: none;
      cursor: pointer;
      color: #fff;
    }
    .open-chat-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(45deg, #f39c12, #e67e22);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      z-index: 3000;
    }
    /* Pakt teklifi formu */
    #pact-offer-form {
      display: none;
      padding: 10px;
      background: #1e1e2f;
      border-top: 1px solid #444;
    }
    #pact-offer-form input[type="number"],
    #pact-offer-form select {
      width: 48%;
      padding: 6px;
      margin: 4px 1%;
      border: none;
      border-radius: 4px;
      font-size: 13px;
    }
    #pact-offer-form button {
      width: 96%;
      padding: 8px;
      margin: 4px 2%;
      background: linear-gradient(45deg, #27ae60, #2ecc71);
      border: none;
      border-radius: 4px;
      font-size: 14px;
      color: #fff;
      cursor: pointer;
    }
    /* Stil: Pakt mesajları chat alanında (tarih gösterilmez) */
    .pact-message {
      background: #34495e;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .pact-message button {
      margin-right: 5px;
      padding: 4px 8px;
      background: #27ae60;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      color: #fff;
      cursor: pointer;
    }
    .pact-message button.reject {
      background: #c0392b;
    }
  </style>
</head>
<body>
  <!-- ===================== LOBBY (Oda Oluşturma & Katılma) ===================== -->
  <div id="lobby-container">
    <h1>Harita Fetih Oyunu</h1>
    <!-- Oda Oluşturma Bölümü -->
    <div id="create-room-section">
      <h2>Oda Oluştur</h2>
      <!-- Oda kodunu kurucu belirleyecek -->
      <input type="text" id="room-code-create" placeholder="Oda Kodu (Örn: MYROOM)" />
      <input type="text" id="creator-player-name" placeholder="Adınız" />
      <div class="color-options" id="creator-color-options"></div>
      <input type="number" id="max-players" placeholder="Oyuncu Sayısı (2-5)" min="2" max="5" />
      <button id="create-room-btn">Oda Oluştur</button>
    </div>
    <hr/>
    <!-- Odaya Katılma Bölümü -->
    <div id="join-room-section">
      <h2>Odaya Katıl</h2>
      <input type="text" id="join-player-name" placeholder="Adınız" />
      <div class="color-options" id="join-color-options"></div>
      <input type="text" id="room-code" placeholder="Oda Kodu (Örn: MYROOM)" />
      <button id="join-room-btn">Odaya Katıl</button>
    </div>
  </div>
  
  <!-- ===================== Bildirim Alanı ===================== -->
  <div id="notification-area"></div>
  
  <!-- ===================== OYUN EKRANI ===================== -->
  <div id="game-container">
    <div id="main-content">
      <!-- Harita Bölgesi -->
      <div id="map-container">
        <div id="map"></div>
      </div>
      <!-- Sağ Panel -->
      <div id="side-panel">
        <!-- Üst Bilgi: Tur ve Toplam Petrol -->
        <section id="game-info">
          <h2>Oyun Bilgileri</h2>
          <p>Tur: <span id="current-round">1</span></p>
          <p>Toplam Petrol: <span id="total-petrol">0</span> varil</p>
          <p>Sırada: <span id="current-player">Oyuncu Adı</span></p>
        </section>
        <!-- Oyuncu Bilgileri -->
        <section id="player-info-section">
          <h2>Oyuncular</h2>
          <div id="players-info">
            <!-- Oyuncu kartları dinamik olarak oluşturulacak -->
          </div>
        </section>
        <!-- Seçili Ülke Bilgileri -->
        <section id="country-info-section">
          <h2>Ülke Detayları</h2>
          <div id="country-info">
            <p>Ülke: <span id="selected-country-name">Yok</span></p>
            <p>Sahip: <span id="selected-country-owner">Yok</span></p>
            <p>Asker: <span id="selected-country-soldiers">0</span></p>
            <p>Gelir: <span id="selected-country-income">0</span>$</p>
            <p>Kışla: <span id="selected-country-barracks">0</span></p>
            <p>Fabrika: <span id="selected-country-factories">0</span></p>
            <p>Rafine: <span id="selected-country-refineries">0</span></p>
            <p>Üretim Kapasitesi: <span id="selected-country-oilProduction">0</span> varil</p>
          </div>
        </section>
        <!-- İşlem ve Market Bölümü -->
        <section id="market-section">
          <h2>İşlemler</h2>
          <!-- Saldırı İşlemi -->
          <div class="action-group">
            <h3>Saldırı</h3>
            <input type="number" id="attack-soldiers" placeholder="Asker sayısı" min="1" />
            <button id="attack-btn"><i class="fas fa-crosshairs"></i> Saldırı Yap</button>
          </div>
          <!-- Asker Satın Alma -->
          <div class="action-group">
            <h3>Asker Satın Alma</h3>
            <input type="number" id="soldiers-to-buy" placeholder="Adet" min="1" />
            <button id="buy-soldiers-btn"><i class="fas fa-user-plus"></i> Satın Al (10$/adet)</button>
          </div>
          <!-- Asker Kışlası Kurma -->
          <div class="action-group">
            <h3>Asker Kışlası Kur</h3>
            <button id="buy-barracks-btn"><i class="fas fa-fort-awesome"></i> Kışla Kur (130$ + 40 varil)</button>
          </div>
          <!-- Fabrika Kurma -->
          <div class="action-group">
            <h3>Fabrika Kur</h3>
            <button id="build-factory-btn"><i class="fas fa-industry"></i> Fabrika Kur (250$ + 90 varil)</button>
          </div>
          <!-- Rafine Kurma -->
          <div class="action-group">
            <h3>Rafine Kur</h3>
            <button id="build-refinery-btn"><i class="fas fa-oil-can"></i> Rafine Kur (250 varil + 800$)</button>
          </div>
          <!-- Asker Çekme -->
          <div class="action-group">
            <h3>Asker Çek</h3>
            <input type="number" id="pull-soldiers-count" placeholder="Asker sayısı" min="1" />
            <button id="pull-soldiers-btn"><i class="fas fa-running"></i> Asker Çek</button>
          </div>
          <!-- Para Gönderme -->
          <div class="action-group">
            <h3>Para Gönder</h3>
            <input type="number" id="money-to-send" placeholder="Miktar" min="1" />
            <select id="recipient-player">
              <!-- Dinamik oyuncu seçenekleri -->
            </select>
            <button id="send-money-btn"><i class="fas fa-hand-holding-usd"></i> Para Gönder</button>
          </div>
          <!-- Petrol Gönderme -->
          <div class="action-group">
            <h3>Petrol Gönder</h3>
            <input type="number" id="petrol-to-send" placeholder="Varil" min="1" />
            <select id="recipient-player-petrol">
              <!-- Dinamik oyuncu seçenekleri -->
            </select>
            <button id="send-petrol-btn"><i class="fas fa-gas-pump"></i> Petrol Gönder</button>
          </div>
          <!-- Tur Bilgisi ve Tur Sonu -->
          <div class="action-group">
            <h3>Tur</h3>
            <div class="turn-info">
              <p>Sıra: <span id="current-player">Oyuncu Adı</span></p>
              <button id="end-turn-btn"><i class="fas fa-forward"></i> Tur Sonu</button>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
  
  <!-- ===================== CHAT & PAKT TEKLİFİ ===================== -->
  <div id="chat-popup" class="chat-popup">
    <div class="chat-header">
      <span>Sohbet</span>
      <button id="close-chat-btn">&times;</button>
    </div>
    <div id="chat-messages" class="chat-messages">
      <!-- Chat ve pakt mesajları burada listelenecek (mesaj tarihleri gösterilmeyecek) -->
    </div>
    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Mesajınızı yazın..." />
      <button id="send-chat-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
    <!-- Pakt Teklifi Formu -->
    <div id="pact-offer-form">
      <select id="pact-recipient">
        <!-- Dinamik oyuncu seçenekleri (kendiniz hariç) -->
      </select>
      <input type="number" id="pact-turns" placeholder="Tur sayısı" min="1" />
      <input type="number" id="pact-amount" placeholder="Para miktarı" min="1" />
      <button id="send-pact-offer-btn">Pakt Teklifi Gönder</button>
    </div>
    <button id="toggle-pact-offer-btn" style="margin:5px; background: #2980b9; border: none; padding:6px; color:#fff; border-radius:4px; cursor:pointer;">Pakt Teklifi</button>
  </div>
  <button id="open-chat-btn" class="open-chat-btn"><i class="fas fa-comments"></i></button>
  
  <!-- ===================== Firebase & Diğer JS Kütüphaneleri ===================== -->
  <!-- Firebase App ve Database (compat sürümü) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  
  <!-- ===================== OYUN ve ONLINE İŞLEVSİYONLARI ===================== -->
  <script>
    /*****************************************************************
     * Firebase Başlatma
     *****************************************************************/
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
      measurementId: "YOUR_MEASUREMENT_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    /*****************************************************************
     * GLOBAL DEĞİŞKENLER ve Yardımcı Fonksiyonlar
     *****************************************************************/
    let currentRoomCode = null;
    let roomRef = null;
    let roomData = null; // Firebase’den alınan oda verileri
    const localPlayerId = Math.random().toString(36).substr(2, 9);
    let selectedCountry = null; // Yerel seçilen ülke
    let map, geoJsonLayer = null;
    const availableColors = ["red", "blue", "green", "yellow", "purple"];
    let localPlayerColor = null;
    
    // Basit popup bildirimleri
    function showNotification(message, duration = 3000) {
      const notificationArea = document.getElementById("notification-area");
      notificationArea.innerHTML = `<div class="popup">${message}</div>`;
      notificationArea.style.display = "flex";
      notificationArea.style.opacity = 0;
      notificationArea.style.transform = "translateY(-20px)";
      setTimeout(() => {
        notificationArea.style.transition = "opacity 0.5s, transform 0.5s";
        notificationArea.style.opacity = 1;
        notificationArea.style.transform = "translateY(0)";
      }, 10);
      setTimeout(() => {
        notificationArea.style.opacity = 0;
        notificationArea.style.transform = "translateY(-20px)";
        setTimeout(() => {
          notificationArea.style.display = "none";
        }, 500);
      }, duration);
    }
    
    // Animate.css animasyon fonksiyonu
    function animateWithAnimateCSS(element, animationName, callback) {
      element.classList.add("animate__animated", animationName);
      function handleAnimationEnd(event) {
        event.stopPropagation();
        element.classList.remove("animate__animated", animationName);
        element.removeEventListener("animationend", handleAnimationEnd);
        if (typeof callback === "function") callback();
      }
      element.addEventListener("animationend", handleAnimationEnd);
    }
    
    // Saldırıların pakt nedeniyle engellenip engellenmeyeceğini kontrol eden yardımcı fonksiyon
    function isAttackAllowed(attackerId, defenderId) {
      if (!roomData || !roomData.pacts) return true;
      const currentRound = roomData.round || 1;
      for (let pactKey in roomData.pacts) {
        const pact = roomData.pacts[pactKey];
        if (pact.status === "active" && currentRound < pact.expiryRound) {
          // İki tarafın kimlikleri kontrol ediliyor
          if ((pact.initiator === attackerId && pact.target === defenderId) ||
              (pact.initiator === defenderId && pact.target === attackerId)) {
            return false;
          }
        }
      }
      return true;
    }
    
    /*****************************************************************
     * DOMContentLoaded – Lobby Arayüzü ve Oda Oluştur/Katılma
     *****************************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      // Renk seçeneklerini dolduralım (oda oluşturma ve katılma bölümleri için)
      const creatorColorDiv = document.getElementById("creator-color-options");
      availableColors.forEach(color => {
        const btn = document.createElement("button");
        btn.className = "global-color-option";
        btn.style.background = color;
        btn.dataset.color = color;
        btn.addEventListener("click", function() {
          creatorColorDiv.querySelectorAll(".global-color-option").forEach(s => s.classList.remove("selected"));
          btn.classList.add("selected");
          localPlayerColor = color;
        });
        creatorColorDiv.appendChild(btn);
      });
      const joinColorDiv = document.getElementById("join-color-options");
      availableColors.forEach(color => {
        const btn = document.createElement("button");
        btn.className = "global-color-option";
        btn.style.background = color;
        btn.dataset.color = color;
        btn.addEventListener("click", function() {
          joinColorDiv.querySelectorAll(".global-color-option").forEach(s => s.classList.remove("selected"));
          btn.classList.add("selected");
          localPlayerColor = color;
        });
        joinColorDiv.appendChild(btn);
      });
      
      // Oda Oluşturma butonu
      document.getElementById("create-room-btn").addEventListener("click", () => {
        const roomCodeInput = document.getElementById("room-code-create").value.trim().toUpperCase();
        const playerName = document.getElementById("creator-player-name").value.trim();
        const maxPlayers = parseInt(document.getElementById("max-players").value);
        if (!roomCodeInput) {
          showNotification("Lütfen bir oda kodu girin!");
          return;
        }
        if (!playerName) {
          showNotification("Lütfen adınızı girin!");
          return;
        }
        if (!localPlayerColor) {
          showNotification("Lütfen bir renk seçin!");
          return;
        }
        if (isNaN(maxPlayers) || maxPlayers < 2 || maxPlayers > 5) {
          showNotification("Oyuncu sayısı 2 ile 5 arasında olmalıdır!");
          return;
        }
        currentRoomCode = roomCodeInput;
        roomRef = db.ref("rooms/" + currentRoomCode);
        // Oda kodunun kullanılmamış olduğunu kontrol edelim
        roomRef.once("value", snapshot => {
          if (snapshot.exists()) {
            showNotification("Bu oda kodu zaten kullanılıyor!");
          } else {
            // Oda başlangıç verilerini oluşturuyoruz
            const newRoomData = {
              roomCode: currentRoomCode,
              maxPlayers: maxPlayers,
              gameState: "waiting",
              currentTurnIndex: 0,
              round: 1,
              playerOrder: [localPlayerId],
              players: {},
              countryData: {},
              pacts: {},
              createdAt: firebase.database.ServerValue.TIMESTAMP
            };
            newRoomData.players[localPlayerId] = {
              name: playerName,
              color: localPlayerColor,
              money: 1000,
              soldiers: 0,
              countries: [],
              petrol: 0,
              joinedAt: firebase.database.ServerValue.TIMESTAMP
            };
            roomRef.set(newRoomData, (error) => {
              if (error) {
                showNotification("Oda oluşturulurken hata oluştu!");
              } else {
                showNotification("Oda oluşturuldu. Oda Kodu: " + currentRoomCode);
                joinRoomAndListen();
                loadAndInitializeGeoJson();
                document.getElementById("lobby-container").style.display = "none";
                document.getElementById("game-container").style.display = "block";
              }
            });
          }
        });
      });
      
      // Odaya Katılma butonu
      document.getElementById("join-room-btn").addEventListener("click", () => {
        const playerName = document.getElementById("join-player-name").value.trim();
        const roomCodeInput = document.getElementById("room-code").value.trim().toUpperCase();
        if (!playerName) {
          showNotification("Lütfen adınızı girin!");
          return;
        }
        if (!localPlayerColor) {
          showNotification("Lütfen bir renk seçin!");
          return;
        }
        if (!roomCodeInput) {
          showNotification("Lütfen oda kodu girin!");
          return;
        }
        currentRoomCode = roomCodeInput;
        roomRef = db.ref("rooms/" + roomCodeInput);
        roomRef.once("value", (snapshot) => {
          if (!snapshot.exists()) {
            showNotification("Böyle bir oda bulunamadı!");
            return;
          }
          const room = snapshot.val();
          if (room.gameState !== "waiting") {
            showNotification("Oyun zaten başladı!");
            return;
          }
          const playerCount = Object.keys(room.players || {}).length;
          if (playerCount >= room.maxPlayers) {
            showNotification("Oda dolu!");
            return;
          }
          const updates = {};
          updates["players/" + localPlayerId] = {
            name: playerName,
            color: localPlayerColor,
            money: 1000,
            soldiers: 0,
            countries: [],
            petrol: 0,
            joinedAt: firebase.database.ServerValue.TIMESTAMP
          };
          if (!room.playerOrder) room.playerOrder = [];
          room.playerOrder.push(localPlayerId);
          updates["playerOrder"] = room.playerOrder;
          roomRef.update(updates, (error) => {
            if (error) {
              showNotification("Odaya katılırken hata oluştu!");
            } else {
              showNotification("Odaya katıldınız!");
              joinRoomAndListen();
              document.getElementById("lobby-container").style.display = "none";
              document.getElementById("game-container").style.display = "block";
            }
          });
        });
      });
      
      // Chat aç/kapat
      document.getElementById("open-chat-btn").addEventListener("click", () => {
        toggleChat(true);
      });
      document.getElementById("close-chat-btn").addEventListener("click", () => {
        toggleChat(false);
      });
      
      // Chat mesaj gönderme
      document.getElementById("send-chat-btn").addEventListener("click", () => {
        sendChatMessage();
      });
      document.getElementById("chat-input").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendChatMessage();
        }
      });
      
      // Pakt Teklifi formu açma/kapatma
      document.getElementById("toggle-pact-offer-btn").addEventListener("click", () => {
        const form = document.getElementById("pact-offer-form");
        form.style.display = (form.style.display === "none" || form.style.display === "") ? "block" : "none";
        updatePactRecipientSelect();
      });
      document.getElementById("send-pact-offer-btn").addEventListener("click", () => {
        sendPactOffer();
      });
    });
    
    /*****************************************************************
     * GeoJSON ve Ülke Verilerini Odaya Yükleme (Sadece Oda Kurucusu İçin)
     *****************************************************************/
    function loadAndInitializeGeoJson() {
      // Eğer countryData zaten varsa yeniden yükleme yapmayalım
      roomRef.child("countryData").once("value", snapshot => {
        if (snapshot.exists()) return;
        fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
          .then(response => response.json())
          .then(geoJsonData => {
            const features = geoJsonData.features;
            let oilIndexes = [];
            if (features.length > 43) {
              while (oilIndexes.length < 43) {
                const randIdx = Math.floor(Math.random() * features.length);
                if (!oilIndexes.includes(randIdx)) {
                  oilIndexes.push(randIdx);
                }
              }
            }
            features.forEach((feature, idx) => {
              feature.properties._index = idx;
            });
            const countryDataInit = {};
            features.forEach(feature => {
              const countryName = feature.properties.name;
              let oilProduction = 0;
              if (oilIndexes.includes(feature.properties._index)) {
                oilProduction = Math.floor(Math.random() * (1000 - 250 + 1)) + 250;
              }
              countryDataInit[countryName] = {
                income: Math.floor(Math.random() * 500) + 100,
                soldiers: 0,
                owner: null,
                barracksCount: 0,
                factories: 0,
                refineries: 0,
                oilProduction: oilProduction
              };
            });
            roomRef.child("countryData").set(countryDataInit);
          });
      });
    }
    
    /*****************************************************************
     * Oda Verilerini Anlık Dinleme ve UI Güncelleme
     *****************************************************************/
    function joinRoomAndListen() {
      roomRef.on("value", (snapshot) => {
        roomData = snapshot.val();
        updateGameUI();
      });
      // Chat listener – sadece bir kez ekleniyor.
      roomRef.child("chat").on("child_added", (snapshot) => {
        const message = snapshot.val();
        appendChatMessage(message);
      });
      // Pakt teklifleri listener'ı
      roomRef.child("pacts").on("child_added", (snapshot) => {
        const pact = snapshot.val();
        appendPactMessage(snapshot.key, pact);
      });
    }
    
    // Oyun ekranındaki bilgileri Firebase verilerine göre güncelleyelim.
    function updateGameUI() {
      if (!roomData) return;
      document.getElementById("current-round").textContent = roomData.round || 1;
      let totalPetrol = 0;
      if (roomData.players) {
        Object.values(roomData.players).forEach(p => {
          totalPetrol += p.petrol || 0;
        });
      }
      document.getElementById("total-petrol").textContent = totalPetrol;
      if (roomData.playerOrder && roomData.players) {
        const currentTurnIndex = roomData.currentTurnIndex || 0;
        const currentPlayerId = roomData.playerOrder[currentTurnIndex];
        if (roomData.players[currentPlayerId]) {
          document.getElementById("current-player").textContent = roomData.players[currentPlayerId].name;
        }
      }
      // Oyuncu kartları
      const playersInfoDiv = document.getElementById("players-info");
      playersInfoDiv.innerHTML = "";
      if (roomData.playerOrder) {
        roomData.playerOrder.forEach(pid => {
          const player = roomData.players[pid];
          const playerDiv = document.createElement("div");
          playerDiv.className = "player-info";
          playerDiv.id = "player-info-" + pid;
          playerDiv.innerHTML = `
            <p><strong>${player.name}</strong></p>
            <p>Para: <span id="money-${pid}">${player.money}</span>$</p>
            <p>Asker: <span id="soldiers-${pid}">${player.soldiers}</span></p>
            <p>Ülkeler: <span id="countries-${pid}">${(player.countries && player.countries.length) || 0}</span></p>
            <p>Petrol: <span id="petrol-${pid}">${player.petrol}</span> varil</p>
          `;
          playersInfoDiv.appendChild(playerDiv);
        });
      }
      // Harita güncellemesi (varsa)
      if (map && roomData.countryData) {
        geoJsonLayer.eachLayer(layer => {
          const countryName = layer.feature.properties.name;
          const country = roomData.countryData[countryName];
          if (country) {
            if (country.owner && roomData.players && roomData.players[country.owner]) {
              layer.setStyle({ fillColor: roomData.players[country.owner].color || "#ccc", fillOpacity: 0.7 });
            } else {
              layer.setStyle({ fillColor: "#ccc", fillOpacity: 0.7 });
            }
            layer.setTooltipContent(getCountryPopupContent(countryName, country));
          }
        });
      }
      updateSelectedCountryInfo();
      updateRecipientSelects();
    }
    
    // Seçili ülke bilgilerini güncelleme
    function updateSelectedCountryInfo() {
      const infoElements = {
        name: document.getElementById("selected-country-name"),
        owner: document.getElementById("selected-country-owner"),
        soldiers: document.getElementById("selected-country-soldiers"),
        income: document.getElementById("selected-country-income"),
        barracks: document.getElementById("selected-country-barracks"),
        factories: document.getElementById("selected-country-factories"),
        refineries: document.getElementById("selected-country-refineries"),
        oilProduction: document.getElementById("selected-country-oilProduction")
      };
      if (selectedCountry && roomData && roomData.countryData && roomData.countryData[selectedCountry]) {
        const c = roomData.countryData[selectedCountry];
        infoElements.name.textContent = selectedCountry;
        infoElements.owner.textContent = (c.owner && roomData.players && roomData.players[c.owner]) ? roomData.players[c.owner].name : "Yok";
        infoElements.soldiers.textContent = c.soldiers || 0;
        let effectiveIncome = c.income || 0;
        if (c.factories) effectiveIncome = Math.floor(effectiveIncome * (1 + 0.25 * c.factories));
        infoElements.income.textContent = effectiveIncome;
        infoElements.barracks.textContent = c.barracksCount || 0;
        infoElements.factories.textContent = c.factories || 0;
        infoElements.refineries.textContent = c.refineries || 0;
        const effectiveProduction = c.oilProduction ? Math.floor(c.oilProduction * (1 + 0.20 * (c.refineries || 0))) : 0;
        infoElements.oilProduction.textContent = effectiveProduction;
      } else {
        infoElements.name.textContent = "Yok";
        infoElements.owner.textContent = "Yok";
        infoElements.soldiers.textContent = 0;
        infoElements.income.textContent = 0;
        infoElements.barracks.textContent = 0;
        infoElements.factories.textContent = 0;
        infoElements.refineries.textContent = 0;
        infoElements.oilProduction.textContent = 0;
      }
    }
    
    // Harita üzerindeki ülke tooltip şablonu
    function getCountryPopupContent(countryName, country) {
      if (!country) country = {};
      const ownerText = (country.owner && roomData && roomData.players && roomData.players[country.owner]) ? roomData.players[country.owner].name : "Yok";
      const effectiveIncome = country.factories ? Math.floor((country.income || 0) * (1 + 0.25 * country.factories)) : (country.income || 0);
      const effectiveProduction = country.oilProduction ? Math.floor(country.oilProduction * (1 + 0.20 * (country.refineries || 0))) : 0;
      return `
        <div class="country-popup">
          <p><span class="emoji"><i class="fas fa-money-bill-wave"></i></span> Gelir: ${effectiveIncome}$</p>
          <p><span class="emoji"><i class="fas fa-users"></i></span> Asker: ${country.soldiers || 0}</p>
          <p><span class="emoji"><i class="fas fa-fort-awesome"></i></span> Kışla: ${country.barracksCount || 0}</p>
          <p><span class="emoji"><i class="fas fa-industry"></i></span> Fabrika: ${country.factories || 0}</p>
          <p><span class="emoji"><i class="fas fa-oil-can"></i></span> Rafine: ${country.refineries || 0}</p>
          <p><span class="emoji"><i class="fas fa-gas-pump"></i></span> Üretim Kapasitesi: ${effectiveProduction} varil</p>
          <p><span class="emoji"><i class="fas fa-crown"></i></span> Sahip: ${ownerText}</p>
        </div>
      `;
    }
    
    // Ülke seçildiğinde (harita tıklama)
    function selectCountry(countryName, layer) {
      selectedCountry = countryName;
      showNotification("Seçilen ülke: " + countryName, 1500);
      layer.setStyle({ weight: 4, color: "#FF4500" });
      setTimeout(() => {
        const country = roomData.countryData ? roomData.countryData[countryName] : null;
        if (country && country.owner && roomData.players && roomData.players[country.owner]) {
          layer.setStyle({ fillColor: roomData.players[country.owner].color || "#ccc", fillOpacity: 0.7, weight: 1, color: "#555" });
        } else {
          layer.setStyle({ fillColor: "#ccc", fillOpacity: 0.7, weight: 1, color: "#555" });
        }
      }, 800);
      updateSelectedCountryInfo();
    }
    
    // Para ve Petrol gönderme için alıcı selectlerini güncelleyelim
    function updateRecipientSelects() {
      const moneySelect = document.getElementById("recipient-player");
      const petrolSelect = document.getElementById("recipient-player-petrol");
      moneySelect.innerHTML = "";
      petrolSelect.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach(pid => {
          const option = document.createElement("option");
          option.value = pid;
          option.textContent = roomData.players[pid].name;
          moneySelect.appendChild(option);
          const option2 = document.createElement("option");
          option2.value = pid;
          option2.textContent = roomData.players[pid].name;
          petrolSelect.appendChild(option2);
        });
      }
    }
    
    // Pakt teklifleri için alıcı select (kendini hariç)
    function updatePactRecipientSelect() {
      const pactSelect = document.getElementById("pact-recipient");
      pactSelect.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach(pid => {
          if (pid !== localPlayerId) {
            const option = document.createElement("option");
            option.value = pid;
            option.textContent = roomData.players[pid].name;
            pactSelect.appendChild(option);
          }
        });
      }
    }
    
    /*****************************************************************
     * OYUN İŞLEVLERİ (Firebase verisini güncelleyen fonksiyonlar)
     *****************************************************************/
    function attack() {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const soldiersToSend = parseInt(document.getElementById("attack-soldiers").value);
      if (isNaN(soldiersToSend) || soldiersToSend <= 0) {
        showNotification("Geçerli bir asker sayısı girin!");
        return;
      }
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      const currentPlayerData = roomData.players[currentPlayerId];
      const target = roomData.countryData[selectedCountry];
      // Eğer saldırı yapılacak ülkenin sahibi farklı ise pakt kontrolü
      if (target.owner && target.owner !== currentPlayerId) {
        if (!isAttackAllowed(currentPlayerId, target.owner)) {
          showNotification("Saldırı engellendi! Aranızda aktif saldırmazlık pakti bulunuyor.");
          return;
        }
      }
      const updates = {};
      if (target.owner === currentPlayerId) {
        updates["countryData/" + selectedCountry + "/soldiers"] = target.soldiers + soldiersToSend;
        updates["players/" + currentPlayerId + "/soldiers"] = currentPlayerData.soldiers - soldiersToSend;
        showNotification(selectedCountry + " ülkesine " + soldiersToSend + " asker ekleniyor.");
      } else {
        updates["players/" + currentPlayerId + "/soldiers"] = currentPlayerData.soldiers - soldiersToSend;
        if (soldiersToSend > target.soldiers) {
          const remaining = soldiersToSend - target.soldiers;
          updates["countryData/" + selectedCountry + "/soldiers"] = remaining;
          updates["countryData/" + selectedCountry + "/owner"] = currentPlayerId;
          let currentCountries = currentPlayerData.countries || [];
          if (!currentCountries.includes(selectedCountry)) {
            currentCountries.push(selectedCountry);
          }
          updates["players/" + currentPlayerId + "/countries"] = currentCountries;
          showNotification(selectedCountry + " fethedildi!");
        } else {
          updates["countryData/" + selectedCountry + "/soldiers"] = target.soldiers - soldiersToSend;
          showNotification(selectedCountry + " savunuldu!");
        }
        nextTurn();
      }
      roomRef.update(updates);
    }
    
    function buySoldiers() {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      const count = parseInt(document.getElementById("soldiers-to-buy").value);
      if (isNaN(count) || count <= 0) {
        showNotification("Geçerli bir asker sayısı girin!");
        return;
      }
      const cost = count * 10;
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      const currentPlayerData = roomData.players[currentPlayerId];
      if (currentPlayerData.money < cost) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      const updates = {};
      updates["players/" + currentPlayerId + "/money"] = currentPlayerData.money - cost;
      updates["players/" + currentPlayerId + "/soldiers"] = currentPlayerData.soldiers + count;
      roomRef.update(updates);
      showNotification(count + " asker satın alındı.");
    }
    
    function buyBarracks() {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        showNotification("Lütfen bir ülke seçin!");
        return;
      }
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      const currentPlayerData = roomData.players[currentPlayerId];
      const target = roomData.countryData[selectedCountry];
      if (target.owner !== currentPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      if (currentPlayerData.money < 130) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (currentPlayerData.petrol < 40) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      const updates = {};
      updates["players/" + currentPlayerId + "/money"] = currentPlayerData.money - 130;
      updates["players/" + currentPlayerId + "/petrol"] = currentPlayerData.petrol - 40;
      updates["countryData/" + selectedCountry + "/barracksCount"] = (target.barracksCount || 0) + 1;
      roomRef.update(updates);
      showNotification("Asker kışlası kuruldu.");
    }
    
    function buildFactory() {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        showNotification("Lütfen bir ülke seçin!");
        return;
      }
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      const currentPlayerData = roomData.players[currentPlayerId];
      const target = roomData.countryData[selectedCountry];
      if (target.owner !== currentPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      if (currentPlayerData.money < 250) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (currentPlayerData.petrol < 90) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      const updates = {};
      updates["players/" + currentPlayerId + "/money"] = currentPlayerData.money - 250;
      updates["players/" + currentPlayerId + "/petrol"] = currentPlayerData.petrol - 90;
      updates["countryData/" + selectedCountry + "/factories"] = (target.factories || 0) + 1;
      roomRef.update(updates);
      showNotification("Fabrika kuruldu.");
    }
    
    function buildRefinery() {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        showNotification("Lütfen bir ülke seçin!");
        return;
      }
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      const currentPlayerData = roomData.players[currentPlayerId];
      const target = roomData.countryData[selectedCountry];
      if (target.owner !== currentPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      if (!target.oilProduction) {
        showNotification("Bu ülkede üretim kapasitesi bulunmuyor!");
        return;
      }
      if (currentPlayerData.money < 800) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (currentPlayerData.petrol < 250) {
        showNotification("Yeterli petrolünüz yok! (250 varil gereklidir)");
        return;
      }
      const updates = {};
      updates["players/" + currentPlayerId + "/money"] = currentPlayerData.money - 800;
      updates["players/" + currentPlayerId + "/petrol"] = currentPlayerData.petrol - 250;
      updates["countryData/" + selectedCountry + "/refineries"] = (target.refineries || 0) + 1;
      roomRef.update(updates);
      showNotification("Rafine kuruldu. Üretim kapasitesi %20 arttı.");
    }
    
    function pullSoldiers() {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      const target = roomData.countryData[selectedCountry];
      if (target.owner !== currentPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      const count = parseInt(document.getElementById("pull-soldiers-count").value);
      if (isNaN(count) || count <= 0) {
        showNotification("Geçerli bir asker sayısı girin!");
        return;
      }
      if (target.soldiers < count) {
        showNotification("Bu ülkede yeterli asker yok!");
        return;
      }
      const updates = {};
      updates["countryData/" + selectedCountry + "/soldiers"] = target.soldiers - count;
      updates["players/" + currentPlayerId + "/soldiers"] = roomData.players[currentPlayerId].soldiers + count;
      roomRef.update(updates);
      showNotification(selectedCountry + " ülkesinden " + count + " asker çekildi.");
    }
    
    // Tur sonunda; oyuncuların ülkelerinde kışla, gelir ve petrol güncellemesi yapılıyor.
    function nextTurn() {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      const player = roomData.players[currentPlayerId];
      const updates = {};
      if (player.countries && roomData.countryData) {
        player.countries.forEach(cName => {
          const country = roomData.countryData[cName];
          if (country) {
            if (country.barracksCount) {
              updates["countryData/" + cName + "/soldiers"] = (country.soldiers || 0) + (5 * country.barracksCount);
            }
            let effectiveIncome = country.income || 0;
            if (country.factories) {
              effectiveIncome = Math.floor(effectiveIncome * (1 + 0.25 * country.factories));
            }
            updates["players/" + currentPlayerId + "/money"] = (player.money || 0) + effectiveIncome;
            if (country.oilProduction) {
              const effectiveProduction = Math.floor(country.oilProduction * (1 + 0.20 * (country.refineries || 0)));
              updates["players/" + currentPlayerId + "/petrol"] = (player.petrol || 0) + effectiveProduction;
            }
          }
        });
      }
      // Pakt sürelerinin kontrolü: aktif paktların süresi dolduysa kaldırıyoruz.
      if (roomData.pacts) {
        for (let pactKey in roomData.pacts) {
          const pact = roomData.pacts[pactKey];
          if (pact.status === "active" && (roomData.round || 1) >= pact.expiryRound) {
            updates["pacts/" + pactKey] = null;
          }
        }
      }
      let newTurnIndex = currentTurnIndex + 1;
      if (newTurnIndex >= roomData.playerOrder.length) {
        newTurnIndex = 0;
        updates["round"] = (roomData.round || 1) + 1;
      }
      updates["currentTurnIndex"] = newTurnIndex;
      roomRef.update(updates);
      showNotification("Sıra " + roomData.players[roomData.playerOrder[newTurnIndex]].name + " oyuncuya geçti.", 1500);
    }
    
    function sendMoney() {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      const amount = parseInt(document.getElementById("money-to-send").value);
      const recipientId = document.getElementById("recipient-player").value;
      if (isNaN(amount) || amount <= 0) {
        showNotification("Geçerli bir miktar girin!");
        return;
      }
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      const currentPlayerData = roomData.players[currentPlayerId];
      if (currentPlayerData.money < amount) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (recipientId === currentPlayerId) {
        showNotification("Kendinize para gönderemezsiniz!");
        return;
      }
      const updates = {};
      updates["players/" + currentPlayerId + "/money"] = currentPlayerData.money - amount;
      updates["players/" + recipientId + "/money"] = roomData.players[recipientId].money + amount;
      roomRef.update(updates);
      showNotification(amount + "$, " + roomData.players[recipientId].name + " oyuncusuna gönderildi.");
    }
    
    function sendPetrol() {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      const amount = parseInt(document.getElementById("petrol-to-send").value);
      const recipientId = document.getElementById("recipient-player-petrol").value;
      if (isNaN(amount) || amount <= 0) {
        showNotification("Geçerli bir miktar girin!");
        return;
      }
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      const currentPlayerData = roomData.players[currentPlayerId];
      if (currentPlayerData.petrol < amount) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      if (recipientId === currentPlayerId) {
        showNotification("Kendinize petrol gönderemezsiniz!");
        return;
      }
      const updates = {};
      updates["players/" + currentPlayerId + "/petrol"] = currentPlayerData.petrol - amount;
      updates["players/" + recipientId + "/petrol"] = roomData.players[recipientId].petrol + amount;
      roomRef.update(updates);
      showNotification(amount + " varil, " + roomData.players[recipientId].name + " oyuncusuna gönderildi.");
    }
    
    /*****************************************************************
     * PAKT TEKLİFİ ve Chat Sistemi
     *****************************************************************/
    // Chat popup aç/kapat işlevi
    function toggleChat(show) {
      const chatPopup = document.getElementById("chat-popup");
      if (show) {
        chatPopup.style.display = "flex";
      } else {
        chatPopup.style.display = "none";
      }
    }
    
    // Chat mesajı gönderimi (mesaj tarihini göstermiyoruz)
    function sendChatMessage() {
      const input = document.getElementById("chat-input");
      const messageText = input.value.trim();
      if (!messageText) return;
      if (!roomRef) {
        showNotification("Oda verisi yüklenmedi.");
        return;
      }
      const chatMessage = {
        sender: (roomData && roomData.players && roomData.players[localPlayerId] ? roomData.players[localPlayerId].name : "Anon"),
        text: messageText
      };
      roomRef.child("chat").push(chatMessage, (error) => {
        if (!error) {
          input.value = "";
        }
      });
    }
    
    // Chat mesajı ekleme (mesaj tarihi gösterilmeyecek)
    function appendChatMessage(message) {
      const chatMessagesDiv = document.getElementById("chat-messages");
      const messageDiv = document.createElement("div");
      messageDiv.innerHTML = `<strong>${message.sender}:</strong> ${message.text}`;
      chatMessagesDiv.appendChild(messageDiv);
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }
    
    // Pakt teklifi gönderme: Pakt teklifinde; hedef, tur sayısı ve para miktarı girilecek.
    function sendPactOffer() {
      const recipientId = document.getElementById("pact-recipient").value;
      const turns = parseInt(document.getElementById("pact-turns").value);
      const amount = parseInt(document.getElementById("pact-amount").value);
      if (!recipientId) {
        showNotification("Lütfen hedef oyuncuyu seçin!");
        return;
      }
      if (isNaN(turns) || turns <= 0) {
        showNotification("Geçerli bir tur sayısı girin!");
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        showNotification("Geçerli bir para miktarı girin!");
        return;
      }
      const pactOffer = {
        initiator: localPlayerId,
        target: recipientId,
        turns: turns,
        amount: amount,
        status: "pending"  // "pending", "active" veya "rejected"
      };
      roomRef.child("pacts").push(pactOffer, (error) => {
        if (!error) {
          showNotification("Pakt teklifi gönderildi.");
          // Formu sıfırla
          document.getElementById("pact-turns").value = "";
          document.getElementById("pact-amount").value = "";
          document.getElementById("pact-offer-form").style.display = "none";
        }
      });
    }
    
    // Pakt teklifi mesajı chat alanına ekleme
    function appendPactMessage(pactId, pact) {
      const chatMessagesDiv = document.getElementById("chat-messages");
      const pactDiv = document.createElement("div");
      pactDiv.className = "pact-message";
      let initiatorName = (roomData && roomData.players && roomData.players[pact.initiator]) ? roomData.players[pact.initiator].name : "Bilinmiyor";
      let targetName = (roomData && roomData.players && roomData.players[pact.target]) ? roomData.players[pact.target].name : "Bilinmiyor";
      pactDiv.innerHTML = `<strong>${initiatorName}</strong> adlı oyuncu, <strong>${targetName}</strong>'ya ${pact.turns} tur boyunca ${pact.amount}$ karşılığında saldırmazlık pakti teklif ediyor.`;
      
      // Eğer teklif hala beklemede ve bu oyuncu hedefse ve sırası geldiyse, onay/red butonları göster
      if (pact.status === "pending" && pact.target === localPlayerId && isMyTurn()) {
        const acceptBtn = document.createElement("button");
        acceptBtn.textContent = "Kabul Et";
        acceptBtn.addEventListener("click", () => {
          acceptPact(pactId, pact);
        });
        const rejectBtn = document.createElement("button");
        rejectBtn.textContent = "Reddet";
        rejectBtn.classList.add("reject");
        rejectBtn.addEventListener("click", () => {
          rejectPact(pactId);
        });
        pactDiv.appendChild(acceptBtn);
        pactDiv.appendChild(rejectBtn);
      }
      chatMessagesDiv.appendChild(pactDiv);
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }
    
    // Hedef oyuncunun pakt teklifini kabul etmesi
    function acceptPact(pactId, pact) {
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      // Sadece hedef oyuncu kabul edebilsin
      if (currentPlayerId !== pact.target) {
        showNotification("Pakt teklifini sadece hedef oyuncu kabul edebilir!");
        return;
      }
      const targetData = roomData.players[pact.target];
      if (targetData.money < pact.amount) {
        showNotification("Yeterli paranız yok, pakt teklifini kabul edemezsiniz!");
        // Teklifi reddedelim
        rejectPact(pactId);
        return;
      }
      // Para aktarımını yapalım: Hedeften pakt miktarı düşülsün, başlatana eklensin.
      const initiatorData = roomData.players[pact.initiator];
      const updates = {};
      updates["players/" + pact.target + "/money"] = targetData.money - pact.amount;
      updates["players/" + pact.initiator + "/money"] = initiatorData.money + pact.amount;
      // Pakt teklifini aktif yapalım: geçerlilik bitiş turu = mevcut tur + teklif edilen tur sayısı
      const expiryRound = (roomData.round || 1) + pact.turns;
      updates["pacts/" + pactId + "/status"] = "active";
      updates["pacts/" + pactId + "/expiryRound"] = expiryRound;
      roomRef.update(updates, (error) => {
        if (!error) {
          showNotification("Pakt teklifi kabul edildi. " + pact.turns + " tur boyunca saldırmazlık geçerli.");
        }
      });
    }
    
    // Pakt teklifini reddetme
    function rejectPact(pactId) {
      roomRef.child("pacts/" + pactId).update({ status: "rejected" });
      showNotification("Pakt teklifi reddedildi.");
    }
    
    // Yardımcı: Sırada olan oyuncu kontrolü
    function isMyTurn() {
      if (!roomData || !roomData.playerOrder) return false;
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      return roomData.playerOrder[currentTurnIndex] === localPlayerId;
    }
    
    /*****************************************************************
     * Harita ve Ülke İşlemleri
     *****************************************************************/
    function initializeMap() {
      if (map) return;
      map = L.map("map").setView([20, 0], 2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 18 }).addTo(map);
      fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
        .then(response => response.json())
        .then(geoJsonData => {
          geoJsonLayer = L.geoJson(geoJsonData, {
            style: () => ({
              color: "#555",
              weight: 1,
              fillColor: "#ccc",
              fillOpacity: 0.7,
            }),
            onEachFeature: (feature, layer) => {
              const countryName = feature.properties.name;
              layer.bindTooltip(getCountryPopupContent(countryName, (roomData && roomData.countryData ? roomData.countryData[countryName] : {})), {
                permanent: true,
                direction: "center",
                className: "country-popup-tooltip",
              });
              layer.on("click", () => selectCountry(countryName, layer));
            },
          }).addTo(map);
        });
    }
    
    // Harita gösterildiğinde initializeMap() çalışsın
    const gameContainerObserver = new MutationObserver((mutations) => {
      const gameContainer = document.getElementById("game-container");
      if (gameContainer.style.display !== "none") {
        initializeMap();
      }
    });
    gameContainerObserver.observe(document.getElementById("game-container"), { attributes: true, attributeFilter: ['style'] });
  </script>
</body>
</html>
