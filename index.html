<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Global Conquest - RTS</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #00f0ff;
      --secondary: #7b2cbf;
      --danger: #ff3366;
      --success: #00ff88;
      --warning: #ffaa00;
      --dark: #0a0a0f;
      --glass: rgba(255, 255, 255, 0.05);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--dark);
      color: white;
      overflow: hidden;
      user-select: none;
    }

    #auth-screen, #game-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }

    #auth-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
    }

    .auth-box {
      background: var(--glass);
      backdrop-filter: blur(20px);
      padding: 40px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      min-width: 400px;
    }

    .auth-box h1 {
      text-align: center;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 42px;
      margin-bottom: 30px;
    }

    .input {
      width: 100%;
      padding: 15px;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: white;
      font-size: 16px;
    }

    .input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 20px rgba(0,240,255,0.3);
    }

    .btn {
      width: 100%;
      padding: 15px;
      margin-top: 10px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0,240,255,0.5);
    }

    /* GAME SCREEN */
    #map {
      width: 100%;
      height: 100%;
    }

    /* TOP HUD */
    #top-hud {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--glass);
      backdrop-filter: blur(20px);
      padding: 15px 30px;
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      gap: 30px;
      z-index: 1000;
    }

    .hud-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
    }

    .hud-value {
      color: var(--primary);
      font-size: 18px;
    }

    /* UNITS PANEL */
    #units-panel {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--glass);
      backdrop-filter: blur(20px);
      padding: 15px;
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.1);
      display: flex;
      gap: 10px;
      z-index: 1000;
      max-width: 90%;
      overflow-x: auto;
    }

    .unit-btn {
      width: 80px;
      height: 80px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      position: relative;
    }

    .unit-btn:hover {
      border-color: var(--primary);
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,240,255,0.4);
    }

    .unit-btn.selected {
      border-color: var(--success);
      background: rgba(0,255,136,0.2);
    }

    .unit-cost {
      position: absolute;
      bottom: 5px;
      font-size: 11px;
      color: var(--warning);
    }

    /* BUILDINGS PANEL */
    #buildings-panel {
      position: fixed;
      top: 100px;
      right: 20px;
      background: var(--glass);
      backdrop-filter: blur(20px);
      padding: 15px;
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 1000;
      width: 250px;
    }

    .building-btn {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .building-btn:hover {
      border-color: var(--primary);
      transform: translateX(-5px);
    }

    .building-btn.selected {
      border-color: var(--success);
      background: rgba(0,255,136,0.2);
    }

    /* SELECTION INFO */
    #selection-info {
      position: fixed;
      top: 100px;
      left: 20px;
      background: var(--glass);
      backdrop-filter: blur(20px);
      padding: 15px;
      border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 1000;
      min-width: 250px;
      display: none;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 14px;
    }

    .info-label {
      color: var(--primary);
    }

    /* NOTIFICATIONS */
    #notifications {
      position: fixed;
      top: 100px;
      right: 290px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 300px;
    }

    .notification {
      background: var(--glass);
      backdrop-filter: blur(20px);
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid var(--primary);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* CONTEXT MENU */
    #context-menu {
      position: fixed;
      background: var(--glass);
      backdrop-filter: blur(20px);
      padding: 5px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 3000;
      display: none;
    }

    .context-item {
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.2s;
    }

    .context-item:hover {
      background: rgba(255,255,255,0.2);
    }

    /* MINIMAP */
    #minimap {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 200px;
      height: 200px;
      background: rgba(0,0,0,0.7);
      border: 2px solid var(--primary);
      border-radius: 10px;
      z-index: 1000;
    }

    /* LOADING */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      color: var(--primary);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    /* Health Bar */
    .health-bar {
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 4px;
      background: rgba(255,0,0,0.3);
      border-radius: 2px;
    }

    .health-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff3366, #00ff88);
      border-radius: 2px;
      transition: width 0.3s;
    }

    /* Range Circle */
    .range-circle {
      position: absolute;
      border: 2px solid var(--primary);
      border-radius: 50%;
      background: rgba(0,240,255,0.1);
      pointer-events: none;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }

    /* Attack Effect */
    .attack-line {
      position: absolute;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--danger), transparent);
      pointer-events: none;
      animation: attackFlash 0.3s ease;
    }

    @keyframes attackFlash {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }

    .explosion {
      position: absolute;
      width: 30px;
      height: 30px;
      background: radial-gradient(circle, var(--warning), transparent);
      border-radius: 50%;
      pointer-events: none;
      animation: explode 0.5s ease forwards;
    }

    @keyframes explode {
      0% { transform: scale(0); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }
  </style>
</head>
<body>
  <!-- AUTH SCREEN -->
  <div id="auth-screen">
    <div class="auth-box">
      <h1>GLOBAL CONQUEST</h1>
      <input type="text" id="player-name" class="input" placeholder="Komutan Adƒ±nƒ±z" />
      <input type="text" id="room-code" class="input" placeholder="Oda Kodu (Bo≈ü bƒ±rak = Yeni Oda)" />
      <button class="btn" onclick="startGame()">üöÄ SAVA≈ûA BA≈ûLA</button>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div id="game-screen">
    <div id="map"></div>

    <!-- TOP HUD -->
    <div id="top-hud">
      <div class="hud-item">
        <span>üí∞</span>
        <span class="hud-value" id="money">5000</span>
      </div>
      <div class="hud-item">
        <span>‚ö°</span>
        <span class="hud-value" id="energy">1000</span>
      </div>
      <div class="hud-item">
        <span>üõ¢Ô∏è</span>
        <span class="hud-value" id="oil">500</span>
      </div>
      <div class="hud-item">
        <span>üéØ</span>
        <span class="hud-value" id="selected-count">0</span>
      </div>
    </div>

    <!-- UNITS PANEL -->
    <div id="units-panel"></div>

    <!-- BUILDINGS PANEL -->
    <div id="buildings-panel">
      <h3 style="margin-bottom: 15px; color: var(--primary);">‚öíÔ∏è ƒ∞n≈üaat</h3>
      <div id="buildings-list"></div>
    </div>

    <!-- SELECTION INFO -->
    <div id="selection-info">
      <h3 style="margin-bottom: 10px; color: var(--primary);">üìä Se√ßili Birim</h3>
      <div id="info-content"></div>
    </div>

    <!-- NOTIFICATIONS -->
    <div id="notifications"></div>

    <!-- CONTEXT MENU -->
    <div id="context-menu">
      <div class="context-item" onclick="contextAttack()">‚öîÔ∏è Saldƒ±r</div>
      <div class="context-item" onclick="contextMove()">üèÉ Hareket</div>
      <div class="context-item" onclick="contextStop()">‚úã Dur</div>
    </div>

    <!-- MINIMAP -->
    <div id="minimap"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    // ==================== FIREBASE SETUP ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCINihMNGs-qRYIIBLzXyeaLnM_Lhp-iwg",
      authDomain: "warmapg-77acb.firebaseapp.com",
      databaseURL: "https://warmapg-77acb-default-rtdb.firebaseio.com",
      projectId: "warmapg-77acb",
      storageBucket: "warmapg-77acb.appspot.com",
      messagingSenderId: "895613631339",
      appId: "1:895613631339:web:a7ecc0cfd8ab3ae7e02a2e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ==================== GAME STATE ====================
    let map, playerId, roomCode, roomRef;
    let playerData = {
      name: '',
      color: '#00f0ff',
      money: 5000,
      energy: 1000,
      oil: 500,
      units: {},
      buildings: {}
    };

    let selectedUnits = [];
    let selectedUnitType = null;
    let selectedBuilding = null;
    let gameLoop;

    // ==================== UNIT TYPES ====================
    const UNIT_TYPES = {
      infantry: {
        name: 'Piyade',
        icon: 'ü™ñ',
        cost: 100,
        speed: 2,
        range: 50,
        attack: 10,
        health: 100,
        maxHealth: 100
      },
      tank: {
        name: 'Tank',
        icon: 'üöú',
        cost: 500,
        speed: 1.5,
        range: 150,
        attack: 50,
        health: 300,
        maxHealth: 300
      },
      artillery: {
        name: 'Top√ßu',
        icon: 'üéØ',
        cost: 800,
        speed: 1,
        range: 300,
        attack: 80,
        health: 150,
        maxHealth: 150
      },
      helicopter: {
        name: 'Helikopter',
        icon: 'üöÅ',
        cost: 1200,
        speed: 4,
        range: 200,
        attack: 40,
        health: 200,
        maxHealth: 200
      },
      fighter: {
        name: 'F-35',
        icon: '‚úàÔ∏è',
        cost: 2000,
        speed: 6,
        range: 400,
        attack: 100,
        health: 250,
        maxHealth: 250
      },
      bomber: {
        name: 'Bombardƒ±man',
        icon: 'üõ©Ô∏è',
        cost: 3000,
        speed: 5,
        range: 500,
        attack: 150,
        health: 300,
        maxHealth: 300
      },
      submarine: {
        name: 'Denizaltƒ±',
        icon: 'üö¢',
        cost: 1500,
        speed: 2,
        range: 250,
        attack: 70,
        health: 400,
        maxHealth: 400
      },
      destroyer: {
        name: 'Destroyƒ±r',
        icon: '‚õ¥Ô∏è',
        cost: 2500,
        speed: 2.5,
        range: 300,
        attack: 90,
        health: 500,
        maxHealth: 500
      },
      missile: {
        name: 'F√ºze Sistemi',
        icon: 'üöÄ',
        cost: 5000,
        speed: 0.5,
        range: 800,
        attack: 200,
        health: 100,
        maxHealth: 100
      },
      drone: {
        name: 'Drone',
        icon: 'üõ∏',
        cost: 600,
        speed: 5,
        range: 150,
        attack: 30,
        health: 80,
        maxHealth: 80
      },
      sniper: {
        name: 'Keskin Ni≈üancƒ±',
        icon: 'üéØ',
        cost: 400,
        speed: 1.5,
        range: 400,
        attack: 60,
        health: 80,
        maxHealth: 80
      },
      engineer: {
        name: 'M√ºhendis',
        icon: 'üë∑',
        cost: 200,
        speed: 2,
        range: 30,
        attack: 5,
        health: 100,
        maxHealth: 100
      },
      medic: {
        name: 'Saƒülƒ±k√ßƒ±',
        icon: '‚öïÔ∏è',
        cost: 300,
        speed: 2,
        range: 50,
        attack: 0,
        health: 100,
        maxHealth: 100
      },
      commando: {
        name: 'Komando',
        icon: 'ü•∑',
        cost: 700,
        speed: 3,
        range: 100,
        attack: 40,
        health: 150,
        maxHealth: 150
      },
      machinegun: {
        name: 'Aƒüƒ±r Makineli',
        icon: 'üî´',
        cost: 350,
        speed: 1.5,
        range: 120,
        attack: 25,
        health: 120,
        maxHealth: 120
      },
      mortar: {
        name: 'Havan Topu',
        icon: 'üí£',
        cost: 600,
        speed: 1,
        range: 250,
        attack: 65,
        health: 100,
        maxHealth: 100
      },
      rocket: {
        name: 'Roketatar',
        icon: 'üß®',
        cost: 900,
        speed: 1.5,
        range: 200,
        attack: 75,
        health: 130,
        maxHealth: 130
      },
      radar: {
        name: 'Radar',
        icon: 'üì°',
        cost: 1000,
        speed: 0,
        range: 600,
        attack: 0,
        health: 150,
        maxHealth: 150
      },
      sam: {
        name: 'Hava Savunma',
        icon: 'üéÜ',
        cost: 1800,
        speed: 0,
        range: 450,
        attack: 85,
        health: 200,
        maxHealth: 200
      },
      carrier: {
        name: 'U√ßak Gemisi',
        icon: 'üõ≥Ô∏è',
        cost: 10000,
        speed: 1,
        range: 100,
        attack: 20,
        health: 2000,
        maxHealth: 2000
      }
    };

    // ==================== BUILDING TYPES ====================
    const BUILDING_TYPES = {
      barracks: {
        name: 'Kƒ±≈üla',
        icon: 'üè∞',
        cost: 500
      },
      factory: {
        name: 'Fabrika',
        icon: 'üè≠',
        cost: 1000
      },
      airbase: {
        name: 'Hava √úss√º',
        icon: '‚úàÔ∏è',
        cost: 2000
      },
      naval: {
        name: 'Deniz √úss√º',
        icon: '‚öì',
        cost: 2500
      },
      power: {
        name: 'Enerji Santrali',
        icon: '‚ö°',
        cost: 1500
      },
      refinery: {
        name: 'Rafineri',
        icon: 'üõ¢Ô∏è',
        cost: 1200
      }
    };

    // ==================== AUDIO SYSTEM ====================
    const sounds = {
      click: () => playSound(1000, 0.1, 0.05),
      build: () => playSound(500, 0.2, 0.1),
      attack: () => playSound(200, 0.3, 0.05),
      explosion: () => playSound(100, 0.5, 0.1),
      move: () => playSound(800, 0.05, 0.02)
    };

    function playSound(freq, vol, dur) {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      oscillator.frequency.value = freq;
      oscillator.type = 'sine';
      gainNode.gain.value = vol;
      
      oscillator.start();
      setTimeout(() => oscillator.stop(), dur * 1000);
    }

    // ==================== START GAME ====================
    function startGame() {
      const nameInput = document.getElementById('player-name').value.trim();
      const roomInput = document.getElementById('room-code').value.trim();

      if (!nameInput) {
        alert('L√ºtfen bir komutan adƒ± girin!');
        return;
      }

      playerData.name = nameInput;
      playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      if (roomInput) {
        roomCode = roomInput.toUpperCase();
      } else {
        roomCode = generateRoomCode();
      }

      roomRef = db.ref('rooms/' + roomCode);
      
      roomRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          // Create new room
          roomRef.set({
            created: Date.now(),
            players: {}
          });
        }
        
        // Join room
        roomRef.child('players/' + playerId).set({
          name: playerData.name,
          color: playerData.color,
          money: playerData.money,
          energy: playerData.energy,
          oil: playerData.oil,
          lastUpdate: Date.now()
        });

        initGame();
      });
    }

    function generateRoomCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // ==================== INIT GAME ====================
    function initGame() {
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'block';

      // Init Google Maps
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 39.9334, lng: 32.8597 }, // Ankara
        zoom: 6,
        mapTypeId: 'satellite',
        disableDefaultUI: true,
        zoomControl: true,
        gestureHandling: 'greedy'
      });

      // Setup UI
      setupUnitsPanel();
      setupBuildingsPanel();
      setupEventListeners();
      
      // Start game loop
      gameLoop = setInterval(updateGame, 50); // 20 FPS

      // Listen to Firebase
      roomRef.child('units').on('child_changed', updateUnitFromServer);
      roomRef.child('units').on('child_added', addUnitFromServer);
      roomRef.child('units').on('child_removed', removeUnitFromServer);

      showNotification('üéÆ Oyuna katƒ±ldƒ±nƒ±z! Oda Kodu: ' + roomCode);
    }

    // ==================== SETUP UI ====================
    function setupUnitsPanel() {
      const panel = document.getElementById('units-panel');
      Object.keys(UNIT_TYPES).forEach(type => {
        const unit = UNIT_TYPES[type];
        const btn = document.createElement('div');
        btn.className = 'unit-btn';
        btn.innerHTML = `
          ${unit.icon}
          <div class="unit-cost">${unit.cost}$</div>
        `;
        btn.title = `${unit.name}\nüí∞ ${unit.cost}\n‚ö° Menzil: ${unit.range}m\n‚öîÔ∏è G√º√ß: ${unit.attack}\n‚ù§Ô∏è Can: ${unit.health}`;
        btn.onclick = () => selectUnitType(type);
        panel.appendChild(btn);
      });
    }

    function setupBuildingsPanel() {
      const list = document.getElementById('buildings-list');
      Object.keys(BUILDING_TYPES).forEach(type => {
        const building = BUILDING_TYPES[type];
        const btn = document.createElement('div');
        btn.className = 'building-btn';
        btn.innerHTML = `${building.icon} ${building.name} (${building.cost}$)`;
        btn.onclick = () => selectBuildingType(type);
        list.appendChild(btn);
      });
    }

    function setupEventListeners() {
      // Map click - spawn unit or place building
      map.addListener('click', (e) => {
        if (selectedUnitType) {
          spawnUnit(selectedUnitType, e.latLng);
        } else if (selectedBuilding) {
          placeBuilding(selectedBuilding, e.latLng);
        }
      });

      // Map right click - move selected units
      map.addListener('rightclick', (e) => {
        if (selectedUnits.length > 0) {
          selectedUnits.forEach(unit => {
            moveUnitTo(unit, e.latLng);
          });
          sounds.move();
        }
      });

      // Key bindings
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          clearSelection();
        } else if (e.key === 's') {
          selectedUnits.forEach(unit => unit.targetPosition = null);
        }
      });
    }

    // ==================== UNIT MANAGEMENT ====================
    function selectUnitType(type) {
      selectedUnitType = type;
      selectedBuilding = null;
      
      document.querySelectorAll('.unit-btn').forEach(btn => btn.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      
      showNotification(`${UNIT_TYPES[type].icon} ${UNIT_TYPES[type].name} se√ßildi`);
      sounds.click();
    }

    function spawnUnit(type, position) {
      const unitData = UNIT_TYPES[type];
      
      if (playerData.money < unitData.cost) {
        showNotification('‚ùå Yetersiz para!');
        return;
      }

      const unitId = 'unit_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      const unit = {
        id: unitId,
        type: type,
        owner: playerId,
        position: { lat: position.lat(), lng: position.lng() },
        health: unitData.health,
        maxHealth: unitData.maxHealth,
        targetPosition: null,
        targetUnit: null,
        lastAttack: 0
      };

      // Create marker
      const marker = new google.maps.Marker({
        position: unit.position,
        map: map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 10,
          fillColor: playerData.color,
          fillOpacity: 1,
          strokeColor: '#ffffff',
          strokeWeight: 2
        },
        label: {
          text: unitData.icon,
          fontSize: '20px'
        },
        draggable: false
      });

      marker.addListener('click', () => selectUnit(unit));
      marker.addListener('rightclick', (e) => {
        showContextMenu(e.domEvent.clientX, e.domEvent.clientY, unit);
      });

      unit.marker = marker;
      playerData.units[unitId] = unit;

      // Update Firebase
      roomRef.child('units/' + unitId).set({
        type: type,
        owner: playerId,
        position: unit.position,
        health: unit.health,
        maxHealth: unit.maxHealth,
        timestamp: Date.now()
      });

      playerData.money -= unitData.cost;
      updateHUD();
      
      showNotification(`‚úÖ ${unitData.name} olu≈üturuldu!`);
      sounds.build();
    }

    function selectUnit(unit) {
      if (selectedUnits.includes(unit)) {
        selectedUnits = selectedUnits.filter(u => u !== unit);
      } else {
        selectedUnits.push(unit);
      }
      
      updateSelectionInfo();
      sounds.click();
    }

    function clearSelection() {
      selectedUnits = [];
      selectedUnitType = null;
      selectedBuilding = null;
      
      document.querySelectorAll('.unit-btn, .building-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      updateSelectionInfo();
    }

    function moveUnitTo(unit, target) {
      unit.targetPosition = { lat: target.lat(), lng: target.lng() };
      unit.targetUnit = null;
      
      // Update Firebase
      roomRef.child('units/' + unit.id + '/targetPosition').set(unit.targetPosition);
    }

    // ==================== BUILDING MANAGEMENT ====================
    function selectBuildingType(type) {
      selectedBuilding = type;
      selectedUnitType = null;
      
      document.querySelectorAll('.building-btn').forEach(btn => btn.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      
      showNotification(`${BUILDING_TYPES[type].icon} ${BUILDING_TYPES[type].name} se√ßildi`);
      sounds.click();
    }

    function placeBuilding(type, position) {
      const buildingData = BUILDING_TYPES[type];
      
      if (playerData.money < buildingData.cost) {
        showNotification('‚ùå Yetersiz para!');
        return;
      }

      const buildingId = 'building_' + Date.now();
      
      const marker = new google.maps.Marker({
        position: { lat: position.lat(), lng: position.lng() },
        map: map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 15,
          fillColor: '#ffaa00',
          fillOpacity: 0.8,
          strokeColor: playerData.color,
          strokeWeight: 3
        },
        label: {
          text: buildingData.icon,
          fontSize: '24px'
        }
      });

      playerData.buildings[buildingId] = {
        type: type,
        position: { lat: position.lat(), lng: position.lng() },
        marker: marker
      };

      playerData.money -= buildingData.cost;
      updateHUD();
      
      showNotification(`‚úÖ ${buildingData.name} in≈üa edildi!`);
      sounds.build();
      
      selectedBuilding = null;
      document.querySelectorAll('.building-btn').forEach(btn => btn.classList.remove('selected'));
    }

    // ==================== GAME LOOP ====================
    function updateGame() {
      Object.values(playerData.units).forEach(unit => {
        const unitData = UNIT_TYPES[unit.type];
        
        // Move towards target
        if (unit.targetPosition) {
          const current = unit.marker.getPosition();
          const target = new google.maps.LatLng(unit.targetPosition.lat, unit.targetPosition.lng);
          const distance = google.maps.geometry.spherical.computeDistanceBetween(current, target);
          
          if (distance < 10) {
            unit.targetPosition = null;
          } else {
            const heading = google.maps.geometry.spherical.computeHeading(current, target);
            const newPos = google.maps.geometry.spherical.computeOffset(current, unitData.speed, heading);
            unit.marker.setPosition(newPos);
            unit.position = { lat: newPos.lat(), lng: newPos.lng() };
          }
        }

        // Auto-attack enemies in range
        const now = Date.now();
        if (now - unit.lastAttack > 1000) { // 1 second cooldown
          Object.values(playerData.units).forEach(enemy => {
            if (enemy.owner !== playerId) {
              const distance = google.maps.geometry.spherical.computeDistanceBetween(
                unit.marker.getPosition(),
                enemy.marker.getPosition()
              );
              
              if (distance <= unitData.range) {
                attackUnit(unit, enemy);
                unit.lastAttack = now;
              }
            }
          });
        }
      });

      // Resource generation
      if (Date.now() % 2000 < 50) { // Every 2 seconds
        playerData.money += Object.keys(playerData.buildings).length * 10;
        updateHUD();
      }
    }

    function attackUnit(attacker, target) {
      const attackerData = UNIT_TYPES[attacker.type];
      
      target.health -= attackerData.attack;
      
      // Visual effects
      createAttackLine(attacker.marker.getPosition(), target.marker.getPosition());
      createExplosion(target.marker.getPosition());
      sounds.attack();
      
      if (target.health <= 0) {
        // Unit destroyed
        target.marker.setMap(null);
        delete playerData.units[target.id];
        roomRef.child('units/' + target.id).remove();
        sounds.explosion();
        showNotification(`üí• D√º≈üman ${UNIT_TYPES[target.type].name} yok edildi!`);
      } else {
        // Update health
        roomRef.child('units/' + target.id + '/health').set(target.health);
      }
    }

    // ==================== VISUAL EFFECTS ====================
    function createAttackLine(from, to) {
      const overlay = new google.maps.Polyline({
        path: [from, to],
        strokeColor: '#ff3366',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        map: map
      });
      
      setTimeout(() => overlay.setMap(null), 300);
    }

    function createExplosion(position) {
      const explosion = new google.maps.Circle({
        center: position,
        radius: 10,
        fillColor: '#ffaa00',
        fillOpacity: 0.6,
        strokeWeight: 0,
        map: map
      });
      
      let radius = 10;
      const interval = setInterval(() => {
        radius += 5;
        explosion.setRadius(radius);
        explosion.setOptions({ fillOpacity: explosion.get('fillOpacity') * 0.9 });
        
        if (radius > 50) {
          clearInterval(interval);
          explosion.setMap(null);
        }
      }, 50);
    }

    // ==================== UI UPDATES ====================
    function updateHUD() {
      document.getElementById('money').textContent = Math.floor(playerData.money);
      document.getElementById('energy').textContent = Math.floor(playerData.energy);
      document.getElementById('oil').textContent = Math.floor(playerData.oil);
      document.getElementById('selected-count').textContent = selectedUnits.length;
    }

    function updateSelectionInfo() {
      const info = document.getElementById('selection-info');
      const content = document.getElementById('info-content');
      
      if (selectedUnits.length === 0) {
        info.style.display = 'none';
        return;
      }
      
      info.style.display = 'block';
      
      if (selectedUnits.length === 1) {
        const unit = selectedUnits[0];
        const unitData = UNIT_TYPES[unit.type];
        
        content.innerHTML = `
          <div class="info-row">
            <span class="info-label">Birim:</span>
            <span>${unitData.icon} ${unitData.name}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Can:</span>
            <span>${Math.floor(unit.health)}/${unit.maxHealth}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Saldƒ±rƒ±:</span>
            <span>${unitData.attack}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Menzil:</span>
            <span>${unitData.range}m</span>
          </div>
          <div class="info-row">
            <span class="info-label">Hƒ±z:</span>
            <span>${unitData.speed}m/s</span>
          </div>
        `;
      } else {
        content.innerHTML = `
          <div class="info-row">
            <span class="info-label">Se√ßili:</span>
            <span>${selectedUnits.length} birim</span>
          </div>
        `;
      }
    }

    function showNotification(message) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = message;
      
      document.getElementById('notifications').appendChild(notif);
      
      setTimeout(() => {
        notif.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    // ==================== CONTEXT MENU ====================
    function showContextMenu(x, y, unit) {
      const menu = document.getElementById('context-menu');
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.style.display = 'block';
      
      window.contextUnit = unit;
      
      document.addEventListener('click', () => {
        menu.style.display = 'none';
      }, { once: true });
    }

    function contextAttack() {
      showNotification('üéØ Hedef se√ßin...');
      // Implement attack targeting
    }

    function contextMove() {
      showNotification('üèÉ Hareket noktasƒ± se√ßin...');
      // Implement move command
    }

    function contextStop() {
      if (window.contextUnit) {
        window.contextUnit.targetPosition = null;
        window.contextUnit.targetUnit = null;
        showNotification('‚úã Birim durduruldu');
      }
    }

    // ==================== FIREBASE SYNC ====================
    function updateUnitFromServer(snapshot) {
      const unitId = snapshot.key;
      const data = snapshot.val();
      
      if (data.owner !== playerId && playerData.units[unitId]) {
        playerData.units[unitId].position = data.position;
        playerData.units[unitId].health = data.health;
        playerData.units[unitId].marker.setPosition(new google.maps.LatLng(data.position.lat, data.position.lng));
      }
    }

    function addUnitFromServer(snapshot) {
      const unitId = snapshot.key;
      const data = snapshot.val();
      
      if (data.owner !== playerId && !playerData.units[unitId]) {
        const unitData = UNIT_TYPES[data.type];
        
        const marker = new google.maps.Marker({
          position: new google.maps.LatLng(data.position.lat, data.position.lng),
          map: map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: '#ff3366',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2
          },
          label: {
            text: unitData.icon,
            fontSize: '20px'
          }
        });
        
        playerData.units[unitId] = {
          id: unitId,
          type: data.type,
          owner: data.owner,
          position: data.position,
          health: data.health,
          maxHealth: data.maxHealth,
          marker: marker
        };
      }
    }

    function removeUnitFromServer(snapshot) {
      const unitId = snapshot.key;
      if (playerData.units[unitId]) {
        playerData.units[unitId].marker.setMap(null);
        delete playerData.units[unitId];
      }
    }

    // Initialize
    updateHUD();
  </script>

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6I7QFuVIR4yYNu7aG1ngsGKsA_mauG8s&libraries=geometry"></script>
</body>
</html>

