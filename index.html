<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Global Conquest – Güncellenmiş Sürüm</title>
  <style>
    /* (Stilleriniz burada kalıyor – orijinal CSS kodlarınızı ekleyin) */
  </style>
</head>
<body>
  <!-- (HTML yapınız, lobby, oyun ekranı, pop-up’lar vb. orijinal kodunuzla aynı kalacak.) -->
  
  <!-- Örnek: Ticaret Pop-up kısmı; fabrikanın satışa sunulması kaldırılmıştır -->
  <div id="market-popup" class="market-popup modern-popup">
    <div class="market-header" id="market-popup-header">
      <h2>Ticaret Merkezi</h2>
      <button id="close-market-btn">&times;</button>
    </div>
    <div class="market-content">
      <!-- Teklif Oluşturma -->
      <div class="market-section">
        <h3>Yeni Teklif Oluştur</h3>
        <label style="font-size:14px;color:#ccc;">Satmak istediğiniz ürün:</label><br/>
        <select id="trade-item-type">
          <option value="petrol">Petrol</option>
          <option value="wheat">Buğday</option>
        </select>
        <br/><br/>
        <!-- Ülke seçimi sadece fabrikalar için gerekiyordu; bu kısım kaldırıldı -->
        <label style="font-size:14px;color:#ccc;">Miktar (adet/varil/buğday):</label>
        <input type="number" id="trade-quantity" placeholder="Miktar" min="1"/>
        <label style="font-size:14px;color:#ccc;">Birim Fiyat ($):</label>
        <input type="number" id="trade-price" placeholder="Birim Fiyat" min="1"/>
        <label style="font-size:14px;color:#ccc;">Ambargo (Oyuncular):</label><br/>
        <select id="embargo-players" multiple style="width:100%;min-height:50px;"></select>
        <small style="color:#ccc;">(Seçtiğiniz oyuncular bu teklifi satın alamaz)</small>
        <br/><br/>
        <button id="create-trade-offer-btn" style="font-size:15px;">
          Teklifi Oluştur
        </button>
      </div>
      <!-- Mevcut Teklifler -->
      <div class="market-section offer-list">
        <h3>Mevcut Teklifler</h3>
        <div id="trade-offers-list"></div>
      </div>
    </div>
  </div>
  
  <!-- Diğer HTML içerikleri (lobi, harita, pop-up’lar vb.) orijinal kodunuzla aynı kalabilir -->
  
  <!-- Firebase ve Diğer JS Kütüphaneleri -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <!-- Örneğin Leaflet, vs. -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    /*****************************************************************
     * Firebase Başlatma (Orijinal yapı korunuyor)
     *****************************************************************/
    const firebaseConfig = {
      apiKey: "API_KEY",
      authDomain: "your-app.firebaseapp.com",
      databaseURL: "https://your-app.firebaseio.com",
      projectId: "your-app",
      storageBucket: "your-app.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    /*****************************************************************
     * KOMŞULUK LİSTESİ – TÜM ÜLKELERİN KOMŞULUK İLİŞKİLERİNİ BURADA TANIMLAYIN
     * (Örnek: "Turkey" ülkesinin komşuları; kendi oyununuzdaki ülke isimlerine göre düzenleyin.)
     *****************************************************************/
    const countryNeighbors = {
      "Turkey": ["Greece", "Bulgaria", "Georgia", "Armenia", "Iran", "Iraq", "Syria"],
      "Greece": ["Turkey", "Bulgaria", "Albania", "North Macedonia"],
      // Diğer ülkeler için de benzer şekilde komşuluk ilişkilerini tanımlayın...
    };
    
    /*****************************************************************
     * GLOBAL DEĞİŞKENLER ve YARDIMCI FONKSİYONLAR
     *****************************************************************/
    let localPlayerId = null;
    let currentRoomCode = null;
    let roomRef = null;
    let roomData = null;
    let selectedCountry = null;
    let map, geoJsonLayer = null;
    const availableColors = ["red","blue","green","yellow","purple","orange","brown","pink"];
    let localPlayerColor = null;
    let chatListenerAdded = false;
    let infoCardsPermanent = false;
    let unreadMessages = 0;
    let chatOpen = false;
    let persistentNotifications = [];
    const popupStates = {
      "military": false,
      "building": false,
      "resource": false,
      "players": false,
      "chat": false,
      "pact": false,
      "market": false
    };
    let turnTimeRemaining = 60;
    let turnTimerInterval = null;
    let startInterval = null;
    
    /*****************************************************************
     * BİLDİRİM FONKSİYONLARI
     *****************************************************************/
    function showNotification(message, duration = 3000) {
      const existing = document.getElementById("notification-area");
      if (!existing) return;
      const item = document.createElement("div");
      item.className = "notification-item";
      item.textContent = message;
      existing.appendChild(item);
      setTimeout(() => {
        if (existing.contains(item)) {
          existing.removeChild(item);
        }
      }, duration + 800);
    }
    
    function broadcastNotification(text) {
      if (!roomRef) return;
      roomRef.child("notifications").push({
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }
    
    function displayGlobalNotification(text) {
      const nArea = document.getElementById("notification-area");
      if (nArea) {
        const item = document.createElement("div");
        item.className = "notification-item";
        item.textContent = text;
        nArea.appendChild(item);
        setTimeout(() => {
          if (nArea.contains(item)) {
            nArea.removeChild(item);
          }
        }, 6500);
      }
      persistentNotifications.push(text);
    }
    
    function generateRoomCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }
    
    function hasActivePact(playerA, playerB) {
      if (!roomData || !roomData.pacts) return false;
      for (let pactId in roomData.pacts) {
        const pact = roomData.pacts[pactId];
        if (pact.active && roomData.round <= pact.expirationRound) {
          if (
            (pact.playerA === playerA && pact.playerB === playerB) ||
            (pact.playerA === playerB && pact.playerB === playerA)
          ) {
            return true;
          }
        }
      }
      return false;
    }
    
    function autoReconnect() {
      const savedRoomCode = localStorage.getItem("roomCode");
      if (savedRoomCode) {
        const refCheck = db.ref("rooms/" + savedRoomCode);
        refCheck.once("value", (snapshot) => {
          if (!snapshot.exists()) return;
          const savedRoomData = snapshot.val();
          if (!savedRoomData.players || !savedRoomData.players[localPlayerId]) return;
          currentRoomCode = savedRoomCode;
          roomRef = refCheck;
          joinRoomAndListen();
          document.body.classList.remove("lobby");
          document.getElementById("lobby-container").style.display = "none";
          document.getElementById("game-container").style.display = "block";
          document.getElementById("display-room-code").textContent = savedRoomCode;
        });
      }
    }
    
    function isMyTurn() {
      if (!roomData || !roomData.playerOrder) return false;
      if (roomData.gameState !== "started") return false;
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      return roomData.playerOrder[currentTurnIndex] === localPlayerId;
    }
    
    /*****************************************************************
     * 60 SANIYE SAYAÇ FONKSİYONLARI
     *****************************************************************/
    function startTurnTimer() {
      const timerEl = document.getElementById("turn-timer");
      turnTimeRemaining = 60;
      if (turnTimerInterval) clearInterval(turnTimerInterval);
      timerEl.textContent = turnTimeRemaining + "s";
      turnTimerInterval = setInterval(() => {
        turnTimeRemaining--;
        if (turnTimeRemaining <= 0) {
          clearInterval(turnTimerInterval);
          turnTimeRemaining = 0;
          timerEl.textContent = "0s";
          if (roomData && roomData.gameState === "started" && isMyTurn()) {
            nextTurn(true);
          }
        } else {
          timerEl.textContent = turnTimeRemaining + "s";
        }
      }, 1000);
    }
    
    function stopTurnTimer() {
      if (turnTimerInterval) {
        clearInterval(turnTimerInterval);
      }
      const timerEl = document.getElementById("turn-timer");
      if (timerEl) {
        timerEl.textContent = "60s";
      }
    }
    
    /*****************************************************************
     * DOMContentLoaded – Lobi & Otomatik Bağlanma
     *****************************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      if (!localStorage.getItem("playerId")) {
        localStorage.setItem("playerId", Math.random().toString(36).substr(2, 9));
      }
      localPlayerId = localStorage.getItem("playerId");
      
      // Renk butonları (Oda Oluştur ve Odaya Katılma bölümleri – orijinal kodunuzdan alınmıştır)
      const creatorColorDiv = document.getElementById("creator-color-options");
      availableColors.forEach((color) => {
        const btn = document.createElement("button");
        btn.className = "global-color-option";
        btn.style.background = color;
        btn.dataset.color = color;
        btn.addEventListener("click", function () {
          creatorColorDiv.querySelectorAll(".global-color-option").forEach((s) => s.classList.remove("selected"));
          btn.classList.add("selected");
          localPlayerColor = color;
        });
        creatorColorDiv.appendChild(btn);
      });
      
      const joinColorDiv = document.getElementById("join-color-options");
      availableColors.forEach((color) => {
        const btn = document.createElement("button");
        btn.className = "global-color-option";
        btn.style.background = color;
        btn.dataset.color = color;
        btn.addEventListener("click", function () {
          joinColorDiv.querySelectorAll(".global-color-option").forEach((s) => s.classList.remove("selected"));
          btn.classList.add("selected");
          localPlayerColor = color;
        });
        joinColorDiv.appendChild(btn);
      });
      
      // Oda Oluşturma
      document.getElementById("create-room-btn").addEventListener("click", () => {
        const playerName = document.getElementById("creator-player-name").value.trim();
        const maxPlayers = parseInt(document.getElementById("max-players").value);
        if (!playerName) {
          showNotification("Lütfen adınızı girin!");
          return;
        }
        if (!localPlayerColor) {
          showNotification("Lütfen bir renk seçin!");
          return;
        }
        if (isNaN(maxPlayers) || maxPlayers < 2 || maxPlayers > 8) {
          showNotification("Oyuncu sayısı 2 ile 8 arasında olmalıdır!");
          return;
        }
        const roomCode = generateRoomCode();
        currentRoomCode = roomCode;
        roomRef = db.ref("rooms/" + roomCode);
        const newRoomData = {
          roomCode: roomCode,
          maxPlayers: maxPlayers,
          gameState: "waiting",
          currentTurnIndex: 0,
          round: 1,
          playerOrder: [localPlayerId],
          players: {},
          countryData: {},
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        newRoomData.players[localPlayerId] = {
          name: playerName,
          color: localPlayerColor,
          money: 1000,
          soldiers: 0,
          countries: [],
          petrol: 0,
          wheat: 400,
          joinedAt: firebase.database.ServerValue.TIMESTAMP,
          isHost: true
        };
        roomRef.set(newRoomData, (error) => {
          if (error) {
            showNotification("Oda oluşturulurken hata oluştu!");
          } else {
            showNotification("Oda oluşturuldu. Oda Kodu: " + roomCode);
            localStorage.setItem("roomCode", roomCode);
            loadAndInitializeGeoJson();
            joinRoomAndListen();
            document.body.classList.remove("lobby");
            document.getElementById("lobby-container").style.display = "none";
            document.getElementById("game-container").style.display = "block";
            document.getElementById("display-room-code").textContent = roomCode;
          }
        });
      });
      
      // Odaya Katılma
      document.getElementById("join-room-btn").addEventListener("click", () => {
        const playerName = document.getElementById("join-player-name").value.trim();
        const roomCodeInput = document.getElementById("room-code").value.trim().toUpperCase();
        if (!playerName) {
          showNotification("Lütfen adınızı girin!");
          return;
        }
        if (!localPlayerColor) {
          showNotification("Lütfen bir renk seçin!");
          return;
        }
        if (!roomCodeInput) {
          showNotification("Lütfen oda kodu girin!");
          return;
        }
        currentRoomCode = roomCodeInput;
        roomRef = db.ref("rooms/" + roomCodeInput);
        roomRef.once("value", (snapshot) => {
          if (!snapshot.exists()) {
            showNotification("Böyle bir oda bulunamadı!");
            return;
          }
          const room = snapshot.val();
          if (room.gameState !== "waiting") {
            showNotification("Oyun zaten başladı veya başlamak üzere!");
            return;
          }
          const playerCount = Object.keys(room.players || {}).length;
          if (playerCount >= room.maxPlayers) {
            showNotification("Oda dolu!");
            return;
          }
          const updates = {};
          updates["players/" + localPlayerId] = {
            name: playerName,
            color: localPlayerColor,
            money: 1000,
            soldiers: 0,
            countries: [],
            petrol: 0,
            wheat: 400,
            joinedAt: firebase.database.ServerValue.TIMESTAMP,
            isHost: false
          };
          if (!room.playerOrder) room.playerOrder = [];
          room.playerOrder.push(localPlayerId);
          updates["playerOrder"] = room.playerOrder;
          roomRef.update(updates, (error) => {
            if (error) {
              showNotification("Odaya katılırken hata oluştu!");
            } else {
              showNotification("Odaya katıldınız!");
              localStorage.setItem("roomCode", roomCodeInput);
              joinRoomAndListen();
              document.body.classList.remove("lobby");
              document.getElementById("lobby-container").style.display = "none";
              document.getElementById("game-container").style.display = "block";
              document.getElementById("display-room-code").textContent = roomCodeInput;
            }
          });
        });
      });
      
      autoReconnect();
      
      const toggleInfoButton = document.getElementById("toggle-info-cards");
      const icon = toggleInfoButton.querySelector("i");
      toggleInfoButton.addEventListener("click", () => {
        infoCardsPermanent = !infoCardsPermanent;
        updateTooltipsPermanent();
        icon.className = infoCardsPermanent ? "fas fa-eye" : "fas fa-eye-slash";
      });
    });
    
    /*****************************************************************
     * GeoJSON ve Ülke Verilerini Yükleme (Sadece Oda Kurucusu)
     *****************************************************************/
    function loadAndInitializeGeoJson() {
      fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
        .then((response) => response.json())
        .then((geoJsonData) => {
          const features = geoJsonData.features;
          let oilIndexes = [];
          if (features.length > 43) {
            while (oilIndexes.length < 43) {
              const randIdx = Math.floor(Math.random() * features.length);
              if (!oilIndexes.includes(randIdx)) {
                oilIndexes.push(randIdx);
              }
            }
          }
          let wheatIndexes = [];
          if (features.length > 60) {
            while (wheatIndexes.length < 60) {
              const randIdx = Math.floor(Math.random() * features.length);
              if (!wheatIndexes.includes(randIdx)) {
                wheatIndexes.push(randIdx);
              }
            }
          }
          features.forEach((feature, idx) => {
            feature.properties._index = idx;
          });
          const countryDataInit = {};
          features.forEach((feature) => {
            const countryName = feature.properties.name;
            let oilProduction = 0;
            if (oilIndexes.includes(feature.properties._index)) {
              oilProduction = Math.floor(Math.random() * (500 - 150 + 1)) + 150;
            }
            let wheatProduction = 0;
            if (wheatIndexes.includes(feature.properties._index)) {
              wheatProduction = Math.floor(Math.random() * (700 - 200 + 1)) + 200;
            }
            countryDataInit[countryName] = {
              income: Math.floor(Math.random() * 500) + 100,
              soldiers: 0,
              owner: null,
              barracksCount: 0,
              factories: 0,
              refineries: 0,
              oilProduction: oilProduction,
              wheatProduction: wheatProduction,
              grainMills: 0,
              supporters: {}
            };
          });
          roomRef.child("countryData").set(countryDataInit);
        });
    }
    
    /*****************************************************************
     * Oda Verilerini Dinleme & UI Güncelleme
     *****************************************************************/
    function joinRoomAndListen() {
      if (!roomRef) return;
      roomRef.on("value", (snapshot) => {
        roomData = snapshot.val();
        updateGameUI();
        displayPendingPactOffers();
        displayTradeOffers();
        updateActivePactsList();
      });
      if (!chatListenerAdded) {
        roomRef.child("chat").on("child_added", (snapshot) => {
          const message = snapshot.val();
          appendChatMessage(message);
        });
        roomRef.child("notifications").on("child_added", (snap) => {
          const data = snap.val();
          if (data && data.text) {
            displayGlobalNotification(data.text);
          }
        });
        chatListenerAdded = true;
      }
    }
    
    function updateGameUI() {
      if (!roomData) return;
      document.getElementById("current-round").textContent = roomData.round || 1;
      if (roomData.playerOrder && roomData.players) {
        const currentTurnIndex = roomData.currentTurnIndex || 0;
        const currentPlayerId = roomData.playerOrder[currentTurnIndex];
        if (roomData.players[currentPlayerId]) {
          document.getElementById("current-player").textContent =
            roomData.players[currentPlayerId].name;
        }
      }
      handleGameState(roomData.gameState);
      const playersInfoDiv = document.getElementById("players-info");
      if (playersInfoDiv) {
        playersInfoDiv.innerHTML = "";
        if (roomData.playerOrder) {
          roomData.playerOrder.forEach((pid) => {
            if (roomData.players[pid]) {
              const player = roomData.players[pid];
              const playerDiv = document.createElement("div");
              playerDiv.className = "player-info";
              playerDiv.id = "player-info-" + pid;
              playerDiv.innerHTML =
                `<p><strong>${player.name}</strong></p>` +
                `<p>Para: <span>${player.money}</span>$</p>` +
                `<p>Asker: <span>${player.soldiers}</span></p>` +
                `<p>Ülkeler: <span>${(player.countries && player.countries.length) || 0}</span></p>` +
                `<p>Petrol: <span>${player.petrol}</span> varil</p>` +
                `<p>Buğday: <span>${player.wheat}</span></p>`;
              playersInfoDiv.appendChild(playerDiv);
            }
          });
        }
      }
      if (map && roomData.countryData && geoJsonLayer) {
        geoJsonLayer.eachLayer((layer) => {
          const countryName = layer.feature.properties.name;
          const country = roomData.countryData[countryName];
          if (country) {
            if (country.owner && roomData.players && roomData.players[country.owner]) {
              layer.setStyle({
                fillColor: roomData.players[country.owner].color || "#ccc",
                fillOpacity: 0.7
              });
            } else {
              layer.setStyle({ fillColor: "#ccc", fillOpacity: 0.7 });
            }
            layer.setTooltipContent(getCountryPopupContent(countryName, country));
          }
        });
      }
      updateRecipientSelects();
      updatePactRecipientSelect();
      updatePrivateMessageRecipientSelect();
      updateEmbargoPlayersSelect();
      updateSupportRecipientSelect();
      if (roomData.gameState === "started") {
        if (isMyTurn()) {
          startTurnTimer();
        } else {
          stopTurnTimer();
        }
      } else {
        stopTurnTimer();
      }
    }
    
    function handleGameState(state) {
      const startBtn = document.getElementById("start-game-btn");
      const countdownSpan = document.getElementById("start-countdown");
      if (!state) return;
      if (state === "waiting") {
        if (roomData.players[localPlayerId] && roomData.players[localPlayerId].isHost) {
          startBtn.style.display = "block";
        } else {
          startBtn.style.display = "none";
        }
        countdownSpan.style.display = "none";
      } else if (state === "starting") {
        startBtn.style.display = "none";
        countdownSpan.style.display = "inline";
        startCountdownListener();
      } else if (state === "started") {
        startBtn.style.display = "none";
        countdownSpan.style.display = "none";
        clearInterval(startInterval);
        startInterval = null;
      }
    }
    
    document.getElementById("start-game-btn").addEventListener("click", () => {
      if (!roomData || !roomData.players[localPlayerId].isHost) return;
      if (roomData.gameState !== "waiting") return;
      const now = Date.now();
      const startTime = now + 30000;
      roomRef.update({
        gameState: "starting",
        startTime: startTime
      });
    });
    
    function startCountdownListener() {
      if (!roomData || !roomData.startTime) return;
      const countdownSpan = document.getElementById("start-countdown");
      if (startInterval) clearInterval(startInterval);
      startInterval = setInterval(() => {
        if (!roomData) return;
        const now = Date.now();
        const diff = roomData.startTime - now;
        if (diff <= 0) {
          clearInterval(startInterval);
          startInterval = null;
          roomRef.update({ gameState: "started" });
          return;
        }
        const secondsLeft = Math.floor(diff / 1000);
        countdownSpan.textContent = secondsLeft;
      }, 1000);
    }
    
    function getCountryPopupContent(countryName, country) {
      if (!country) country = {};
      const ownerText =
        country.owner && roomData && roomData.players && roomData.players[country.owner]
          ? roomData.players[country.owner].name
          : "Yok";
      let effectiveIncome = country.income || 0;
      if (country.factories) {
        effectiveIncome = Math.floor(effectiveIncome * (1 + 0.20 * country.factories));
      }
      const effectiveOil = country.oilProduction
        ? Math.floor(country.oilProduction * (1 + 0.15 * (country.refineries || 0)))
        : 0;
      const effectiveWheat = country.wheatProduction
        ? Math.floor(country.wheatProduction * (1 + 0.20 * (country.grainMills || 0)))
        : 0;
      return (
        `<div class="country-popup">
          <p><i class="fas fa-money-bill-wave"></i> Gelir: $${effectiveIncome}$</p>
          <p><i class="fas fa-users"></i> Asker: ${country.soldiers || 0}</p>
          <p><i class="fas fa-fort-awesome"></i> Kışla: ${country.barracksCount || 0}</p>
          <p><i class="fas fa-industry"></i> Fabrika: ${country.factories || 0}</p>
          <p><i class="fas fa-oil-can"></i> Rafine: ${country.refineries || 0}</p>
          <p><i class="fas fa-oil-can"></i> Petrol Üretimi: ${effectiveOil} varil</p>
          <p><i class="fas fa-wheat-awn"></i> Değirmen: ${country.grainMills || 0}</p>
          <p><i class="fas fa-wheat-awn"></i> Buğday Üretimi: ${effectiveWheat}</p>
          <p><i class="fas fa-crown"></i> Sahip: ${ownerText}</p>
        </div>`
      );
    }
    
    function updateTooltipsPermanent() {
      if (!geoJsonLayer) return;
      geoJsonLayer.eachLayer((layer) => {
        layer.unbindTooltip();
        const countryName = layer.feature.properties.name;
        const tooltipContent = getCountryPopupContent(
          countryName,
          roomData && roomData.countryData ? roomData.countryData[countryName] : {}
        );
        layer.bindTooltip(tooltipContent, {
          permanent: infoCardsPermanent,
          direction: "center",
          className: "country-popup-tooltip"
        });
      });
    }
    
    function selectCountry(countryName, layer) {
      selectedCountry = countryName;
      showNotification("Seçilen ülke: " + countryName, 1500);
      layer.setStyle({ weight: 4, color: "#FF4500" });
      setTimeout(() => {
        const country = roomData.countryData ? roomData.countryData[countryName] : null;
        if (country && country.owner && roomData.players && roomData.players[country.owner]) {
          layer.setStyle({
            fillColor: roomData.players[country.owner].color || "#ccc",
            fillOpacity: 0.7,
            weight: 1,
            color: "#555"
          });
        } else {
          layer.setStyle({
            fillColor: "#ccc",
            fillOpacity: 0.7,
            weight: 1,
            color: "#555"
          });
        }
      }, 800);
    }
    
    function updateRecipientSelects() {
      const moneySelect = document.getElementById("recipient-player");
      const petrolSelect = document.getElementById("recipient-player-petrol");
      const wheatSelect = document.getElementById("recipient-player-wheat");
      if (!moneySelect || !petrolSelect || !wheatSelect) return;
      moneySelect.innerHTML = "";
      petrolSelect.innerHTML = "";
      wheatSelect.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (roomData.players[pid]) {
            const option1 = document.createElement("option");
            option1.value = pid;
            option1.textContent = roomData.players[pid].name;
            moneySelect.appendChild(option1);
            const option2 = document.createElement("option");
            option2.value = pid;
            option2.textContent = roomData.players[pid].name;
            petrolSelect.appendChild(option2);
            const option3 = document.createElement("option");
            option3.value = pid;
            option3.textContent = roomData.players[pid].name;
            wheatSelect.appendChild(option3);
          }
        });
      }
    }
    
    function updatePrivateMessageRecipientSelect() {
      const privateSelect = document.getElementById("private-message-recipient");
      if (!privateSelect) return;
      privateSelect.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (pid !== localPlayerId && roomData.players[pid]) {
            const option = document.createElement("option");
            option.value = pid;
            option.textContent = roomData.players[pid].name;
            privateSelect.appendChild(option);
          }
        });
      }
    }
    
    function updateEmbargoPlayersSelect() {
      const embargoSelect = document.getElementById("embargo-players");
      if (!embargoSelect) return;
      embargoSelect.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (pid !== localPlayerId && roomData.players[pid]) {
            const option = document.createElement("option");
            option.value = pid;
            option.textContent = roomData.players[pid].name;
            embargoSelect.appendChild(option);
          }
        });
      }
    }
    
    function updateSupportRecipientSelect() {
      const supportRecipient = document.getElementById("support-recipient");
      const supportRecipientCountry = document.getElementById("support-recipient-country");
      if (!supportRecipient || !supportRecipientCountry) return;
      supportRecipient.innerHTML = "";
      supportRecipientCountry.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (pid !== localPlayerId && roomData.players[pid]) {
            const option = document.createElement("option");
            option.value = pid;
            option.textContent = roomData.players[pid].name;
            supportRecipient.appendChild(option);
          }
        });
        supportRecipientCountry.innerHTML = "<option value=''>--Ülke Seç--</option>";
        if (roomData.countryData) {
          Object.keys(roomData.countryData).forEach((cName) => {
            const c = roomData.countryData[cName];
            const op = document.createElement("option");
            op.value = cName;
            op.textContent = cName;
            supportRecipientCountry.appendChild(op);
          });
        }
      }
    }
    
    function updatePactRecipientSelect() {
      const pactRecipientSelect = document.getElementById("pact-offer-recipient");
      if (!pactRecipientSelect) return;
      pactRecipientSelect.innerHTML = "";
      if (roomData && roomData.playerOrder) {
        roomData.playerOrder.forEach((pid) => {
          if (pid !== localPlayerId && roomData.players[pid]) {
            const option = document.createElement("option");
            option.value = pid;
            option.textContent = roomData.players[pid].name;
            pactRecipientSelect.appendChild(option);
          }
        });
      }
    }
    
    /*****************************************************************
     * SALDIRMAZLIK PAKTI (Event Delegation ile Kabul Et)
     *****************************************************************/
    document.getElementById("send-pact-offer-btn").addEventListener("click", () => {
      if (!isMyTurn()) {
        showNotification("Saldırmazlık Paktı teklifini sadece kendi sıranızda gönderebilirsiniz!");
        return;
      }
      const recipient = document.getElementById("pact-offer-recipient").value;
      const duration = parseInt(document.getElementById("pact-duration").value);
      const cost = parseInt(document.getElementById("pact-cost").value);
      if (!recipient || recipient === localPlayerId) {
        showNotification("Lütfen geçerli bir oyuncu seçin!");
        return;
      }
      if (isNaN(duration) || duration <= 0) {
        showNotification("Geçerli tur sayısı girin!");
        return;
      }
      if (isNaN(cost) || cost < 0) {
        showNotification("Geçerli bir para miktarı girin (0 veya üstü)!");
        return;
      }
      if (hasActivePact(localPlayerId, recipient)) {
        showNotification("Bu oyuncuyla zaten aktif bir saldırmazlık paktınız var!");
        return;
      }
      const senderData = roomData.players[localPlayerId];
      if (!senderData) return;
      const pactOfferRef = roomRef.child("pactOffers").push();
      const newOffer = {
        offerId: pactOfferRef.key,
        senderId: localPlayerId,
        senderName: senderData.name,
        recipientId: recipient,
        duration: duration,
        cost: cost,
        status: "pending"
      };
      pactOfferRef.set(newOffer);
      broadcastNotification(`Saldırmazlık Paktı Teklifi: ${senderData.name} → ${roomData.players[recipient].name} (Tur: ${duration}, Para: ${cost}$)`);
      showNotification("Pakt teklifi gönderildi!");
    });
    
    function displayPendingPactOffers() {
      const container = document.getElementById("pact-pending-offers");
      if (!container) return;
      container.innerHTML = "";
      if (!roomData || !roomData.pactOffers) return;
      Object.values(roomData.pactOffers).forEach((offer) => {
        if (offer.status === "pending" && offer.recipientId === localPlayerId) {
          const div = document.createElement("div");
          div.className = "pact-offer-item";
          div.setAttribute("data-offer-id", offer.offerId);
          div.innerHTML = 
            `<p><strong>${offer.senderName}</strong> size saldırmazlık pakti teklif ediyor.</p>
             <p>Tur sayısı: <strong>${offer.duration}</strong></p>
             <p>Para talebi: <strong>${offer.cost}$</strong> (Gönderen ödeyecek, siz alacaksınız)</p>
             <button class="accept-btn" data-offer-id="${offer.offerId}">Kabul Et</button>
             <button class="reject-btn" data-offer-id="${offer.offerId}">Reddet</button>`;
          container.appendChild(div);
        }
      });
    }
    
    document.getElementById("pact-pending-offers").addEventListener("click", function(e) {
      if (e.target.classList.contains("accept-btn")) {
        const offerId = e.target.getAttribute("data-offer-id");
        acceptPactOffer(offerId);
      } else if (e.target.classList.contains("reject-btn")) {
        const offerId = e.target.getAttribute("data-offer-id");
        rejectPactOffer(offerId);
      }
    });
    
    function acceptPactOffer(offerId) {
      const offer = roomData.pactOffers[offerId];
      if (!offer || offer.status !== "pending") return;
      if (hasActivePact(offer.senderId, offer.recipientId)) {
        showNotification("Bu oyuncuyla zaten aktif bir paktınız var!");
        roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
        return;
      }
      const sender = roomData.players[offer.senderId];
      const recipient = roomData.players[offer.recipientId];
      if (!sender || !recipient) {
        showNotification("Teklifteki oyuncular bulunamadı!");
        return;
      }
      if (sender.money < offer.cost) {
        showNotification("Teklifi gönderenin yeterli parası kalmamış! Teklif geçersiz.");
        roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
        return;
      }
      const expirationRound = (roomData.round || 1) + offer.duration;
      const pactId = db.ref().push().key;
      const updates = {};
      updates[`pactOffers/${offerId}/status`] = "accepted";
      updates[`players/${offer.senderId}/money`] = sender.money - offer.cost;
      updates[`players/${offer.recipientId}/money`] = recipient.money + offer.cost;
      updates[`pacts/${pactId}`] = {
        playerA: offer.senderId,
        playerB: offer.recipientId,
        active: true,
        cost: offer.cost,
        duration: offer.duration,
        expirationRound: expirationRound
      };
      roomRef.update(updates);
      broadcastNotification(`Pakt Anlaşması: ${sender.name} & ${recipient.name} (${offer.duration} tur, ${offer.cost}$)`);
      showNotification("Pakt teklifi kabul edildi!");
    }
    
    function rejectPactOffer(offerId) {
      const offer = roomData.pactOffers[offerId];
      if (!offer || offer.status !== "pending") return;
      roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
      broadcastNotification(`Pakt Reddedildi: ${offer.senderName} → Teklif reddedildi.`);
      showNotification("Pakt teklifi reddedildi.");
    }
    
    function updateActivePactsList() {
      const container = document.getElementById("pact-active-list");
      if (!container) return;
      container.innerHTML = "";
      if (!roomData || !roomData.pacts) return;
      const currentRound = roomData.round || 1;
      Object.values(roomData.pacts).forEach((pact) => {
        if (pact.active && currentRound <= pact.expirationRound) {
          if (pact.playerA === localPlayerId || pact.playerB === localPlayerId) {
            const otherId = (pact.playerA === localPlayerId) ? pact.playerB : pact.playerA;
            const otherName = roomData.players[otherId]?.name || "???";
            const turnsLeft = pact.expirationRound - currentRound + 1;
            const div = document.createElement("div");
            div.textContent = `Pakt: ${otherName}, kalan tur: ${turnsLeft}`;
            container.appendChild(div);
          }
        }
      });
    }
    
    /*****************************************************************
     * OYUN İŞLEVLERİ
     *****************************************************************/
    // SALDIRI – Aşağıdaki fonksiyonda 2. turdan sonra “komşu” kuralı eklendi
    function attack() {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const soldiersToSend = parseInt(document.getElementById("attack-soldiers").value);
      if (isNaN(soldiersToSend) || soldiersToSend <= 0) {
        showNotification("Geçerli bir asker sayısı girin!");
        return;
      }
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      const currentPlayerData = roomData.players[currentPlayerId];
      if (soldiersToSend > currentPlayerData.soldiers) {
        showNotification("Yeterli askeriniz yok!");
        return;
      }
      const target = roomData.countryData[selectedCountry];
      if (!target) return;
      if (roomData.round < 4) {
        if (target.owner) {
          showNotification("İlk 3 tur yalnızca sahipsiz topraklara saldırabilirsiniz!");
          return;
        }
      }
      // 2. Turdan sonra, saldırının yapılabilmesi için; 
      // saldırılan ülke, saldıran oyuncunun sahip olduğu en az bir ülkenin komşusu olmalıdır.
      if (roomData.round > 2) {
        const ownedCountries = currentPlayerData.countries || [];
        let neighborAllowed = false;
        for (let owned of ownedCountries) {
          if (countryNeighbors[owned] && countryNeighbors[owned].includes(selectedCountry)) {
            neighborAllowed = true;
            break;
          }
        }
        if (!neighborAllowed) {
          showNotification("2. Turdan sonra sadece komşu ülkelere saldırabilirsiniz!");
          return;
        }
      }
      const updates = {};
      let attackResult = "";
      if (target.owner === currentPlayerId) {
        updates["countryData/" + selectedCountry + "/soldiers"] =
          target.soldiers + soldiersToSend;
        updates["players/" + currentPlayerId + "/soldiers"] =
          currentPlayerData.soldiers - soldiersToSend;
        attackResult = selectedCountry + " ülkesine " + soldiersToSend + " asker yerleştirildi.";
      } else {
        updates["players/" + currentPlayerId + "/soldiers"] =
          currentPlayerData.soldiers - soldiersToSend;
        if (soldiersToSend > target.soldiers) {
          const remaining = soldiersToSend - target.soldiers;
          updates["countryData/" + selectedCountry + "/soldiers"] = remaining;
          updates["countryData/" + selectedCountry + "/owner"] = currentPlayerId;
          updates["countryData/" + selectedCountry + "/supporters"] = {};
          let currentCountries = currentPlayerData.countries || [];
          if (!currentCountries.includes(selectedCountry)) {
            currentCountries.push(selectedCountry);
          }
          updates["players/" + currentPlayerId + "/countries"] = currentCountries;
          if (target.owner && roomData.players[target.owner]) {
            let defenderCountries = roomData.players[target.owner].countries || [];
            defenderCountries = defenderCountries.filter((c) => c !== selectedCountry);
            updates["players/" + target.owner + "/countries"] = defenderCountries;
          }
          attackResult = selectedCountry + " fethedildi! (" + soldiersToSend + " vs " + target.soldiers + ")";
        } else {
          updates["countryData/" + selectedCountry + "/soldiers"] =
            target.soldiers - soldiersToSend;
          attackResult = selectedCountry + " savunuldu! (" + soldiersToSend + " vs " + target.soldiers + ")";
        }
        nextTurn();
      }
      roomRef.update(updates);
      broadcastNotification("Saldırı: " + roomData.players[currentPlayerId].name + " → " + selectedCountry + ". " + attackResult);
      showNotification(attackResult);
    }
    
    // ASKER SATIN ALMA
    function buySoldiers() {
      const count = parseInt(document.getElementById("soldiers-to-buy").value);
      if (isNaN(count) || count <= 0) {
        showNotification("Geçerli bir asker sayısı girin!");
        return;
      }
      const costMoney = 10 * count;
      const costWheat = 25 * count;
      const currentPlayerData = roomData.players[localPlayerId];
      if (currentPlayerData.money < costMoney) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (currentPlayerData.wheat < costWheat) {
        showNotification("Yeterli buğdayınız yok!");
        return;
      }
      const updates = {};
      updates["players/" + localPlayerId + "/money"] = currentPlayerData.money - costMoney;
      updates["players/" + localPlayerId + "/wheat"] = currentPlayerData.wheat - costWheat;
      updates["players/" + localPlayerId + "/soldiers"] = currentPlayerData.soldiers + count;
      roomRef.update(updates);
      broadcastNotification(currentPlayerData.name + " " + count + " asker satın aldı.");
      showNotification(count + " asker satın alındı.");
    }
    
    // BİNA KURMALAR (buyBarracks, buildFactory, buildRefinery, buildGrainmill) – orijinal mantık korunuyor.
    function buyBarracks() {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const quantity = parseInt(document.getElementById("barracks-quantity").value);
      if (isNaN(quantity) || quantity <= 0) {
        showNotification("Geçerli bir kışla adedi girin!");
        return;
      }
      const currentPlayerData = roomData.players[localPlayerId];
      const target = roomData.countryData[selectedCountry];
      if (target.owner !== localPlayerId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      const totalMoney = 140 * quantity;
      const totalPetrol = 40 * quantity;
      const totalWheat = 90 * quantity;
      if (currentPlayerData.money < totalMoney) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (currentPlayerData.petrol < totalPetrol) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      if (currentPlayerData.wheat < totalWheat) {
        showNotification("Yeterli buğdayınız yok!");
        return;
      }
      const updates = {};
      updates["players/" + localPlayerId + "/money"] = currentPlayerData.money - totalMoney;
      updates["players/" + localPlayerId + "/petrol"] = currentPlayerData.petrol - totalPetrol;
      updates["players/" + localPlayerId + "/wheat"] = currentPlayerData.wheat - totalWheat;
      updates["countryData/" + selectedCountry + "/barracksCount"] = (target.barracksCount || 0) + quantity;
      roomRef.update(updates);
      broadcastNotification(`${currentPlayerData.name} ${quantity} adet kışla kurdu (${selectedCountry})`);
      showNotification(quantity + " adet kışla kuruldu.");
    }
    
    function buildFactory() {
      // Fabrika kurma işlemi ticaret merkezinden kaldırıldığı için bu fonksiyon çalıştırılmayacaktır.
    }
    
    function buildRefinery() {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const quantity = parseInt(document.getElementById("refinery-quantity").value);
      if (isNaN(quantity) || quantity <= 0) {
        showNotification("Geçerli bir rafine adedi girin!");
        return;
      }
      const currentPlayerData = roomData.players[localPlayerId];
      const target = roomData.countryData[selectedCountry];
      if (!target.oilProduction) {
        showNotification("Bu ülkede petrol üretim kapasitesi yok!");
        return;
      }
      const totalMoney = 800 * quantity;
      const totalPetrol = 250 * quantity;
      if (currentPlayerData.money < totalMoney) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (currentPlayerData.petrol < totalPetrol) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      const updates = {};
      updates["players/" + localPlayerId + "/money"] = currentPlayerData.money - totalMoney;
      updates["players/" + localPlayerId + "/petrol"] = currentPlayerData.petrol - totalPetrol;
      updates["countryData/" + selectedCountry + "/refineries"] = (target.refineries || 0) + quantity;
      roomRef.update(updates);
      broadcastNotification(`${currentPlayerData.name} ${quantity} adet rafine kurdu (${selectedCountry})`);
      showNotification(quantity + " adet rafine kuruldu. Üretim kapasitesi arttı.");
    }
    
    function buildGrainmill() {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const quantity = parseInt(document.getElementById("grainmill-quantity").value);
      if (isNaN(quantity) || quantity <= 0) {
        showNotification("Geçerli bir değirmen adedi girin!");
        return;
      }
      const currentPlayerData = roomData.players[localPlayerId];
      const target = roomData.countryData[selectedCountry];
      if (!target.wheatProduction) {
        showNotification("Bu ülkede buğday üretim kapasitesi yok!");
        return;
      }
      const totalMoney = 200 * quantity;
      const totalPetrol = 100 * quantity;
      if (currentPlayerData.money < totalMoney) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (currentPlayerData.petrol < totalPetrol) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      const updates = {};
      updates["players/" + localPlayerId + "/money"] = currentPlayerData.money - totalMoney;
      updates["players/" + localPlayerId + "/petrol"] = currentPlayerData.petrol - totalPetrol;
      updates["countryData/" + selectedCountry + "/grainMills"] = (target.grainMills || 0) + quantity;
      roomRef.update(updates);
      broadcastNotification(`${currentPlayerData.name} ${quantity} adet değirmen kurdu (${selectedCountry})`);
      showNotification(quantity + " adet değirmen kuruldu. Buğday üretimi arttı.");
    }
    
    // ASKER ÇEK
    function pullSoldiers() {
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const target = roomData.countryData[selectedCountry];
      if (!target) return;
      const count = parseInt(document.getElementById("pull-soldiers-count").value);
      if (isNaN(count) || count <= 0) {
        showNotification("Geçerli bir asker sayısı girin!");
        return;
      }
      const currentPlayerData = roomData.players[localPlayerId];
      if (!currentPlayerData) return;
      const updates = {};
      if (target.owner === localPlayerId) {
        let totalSupporters = 0;
        if (target.supporters) {
          for (let supId in target.supporters) {
            totalSupporters += target.supporters[supId];
          }
        }
        const occupantSoldiers = target.soldiers - totalSupporters;
        if (occupantSoldiers < count) {
          showNotification("Bu ülkede çekebileceğiniz kadar kendi askeri yok!");
          return;
        }
        updates["countryData/" + selectedCountry + "/soldiers"] = target.soldiers - count;
        updates["players/" + localPlayerId + "/soldiers"] = currentPlayerData.soldiers + count;
        broadcastNotification(`${currentPlayerData.name} ${selectedCountry} ülkesinden ${count} asker çekti.`);
      } else {
        const supportAmount = target.supporters && target.supporters[localPlayerId]
          ? target.supporters[localPlayerId]
          : 0;
        if (supportAmount < count) {
          showNotification("Bu ülkede bu kadar destek askeriniz yok!");
          return;
        }
        if (target.soldiers < count) {
          showNotification("Veri tutarsızlığı: ülkedeki toplam asker sayısı sorunu!");
          return;
        }
        updates["countryData/" + selectedCountry + "/soldiers"] = target.soldiers - count;
        const newSup = supportAmount - count;
        if (newSup <= 0) {
          updates["countryData/" + selectedCountry + "/supporters/" + localPlayerId] = null;
        } else {
          updates["countryData/" + selectedCountry + "/supporters/" + localPlayerId] = newSup;
        }
        updates["players/" + localPlayerId + "/soldiers"] = currentPlayerData.soldiers + count;
        broadcastNotification(`${currentPlayerData.name}, ${selectedCountry} ülkesine verdiği ${count} askeri geri çekti.`);
      }
      roomRef.update(updates);
      showNotification(`${selectedCountry} ülkesinden ${count} asker çekildi.`);
    }
    
    // ASKERİ DESTEK
    function sendSupport() {
      const recipient = document.getElementById("support-recipient").value;
      const countryName = document.getElementById("support-recipient-country").value;
      const soldiersToSend = parseInt(document.getElementById("support-soldiers").value);
      if (!recipient || !countryName) {
        showNotification("Oyuncu ve ülke seçmelisiniz!");
        return;
      }
      if (isNaN(soldiersToSend) || soldiersToSend <= 0) {
        showNotification("Geçerli bir asker sayısı girin!");
        return;
      }
      const currentPlayerData = roomData.players[localPlayerId];
      if (currentPlayerData.soldiers < soldiersToSend) {
        showNotification("Yeterli askeriniz yok!");
        return;
      }
      const targetCountry = roomData.countryData[countryName];
      if (!targetCountry) {
        showNotification("Seçilen ülke bulunamadı!");
        return;
      }
      if (targetCountry.owner !== recipient) {
        showNotification("Bu ülke, seçtiğiniz oyuncuya ait değil!");
        return;
      }
      const updates = {};
      updates["players/" + localPlayerId + "/soldiers"] = currentPlayerData.soldiers - soldiersToSend;
      updates["countryData/" + countryName + "/soldiers"] = targetCountry.soldiers + soldiersToSend;
      const oldSupport = targetCountry.supporters && targetCountry.supporters[localPlayerId]
        ? targetCountry.supporters[localPlayerId]
        : 0;
      updates["countryData/" + countryName + "/supporters/" + localPlayerId] = oldSupport + soldiersToSend;
      roomRef.update(updates);
      broadcastNotification(`${currentPlayerData.name}, ${roomData.players[recipient].name} (${countryName}) ülkesine ${soldiersToSend} asker destek gönderdi.`);
      showNotification("Askeri destek gönderildi!");
    }
    document.getElementById("send-support-btn").addEventListener("click", sendSupport);
    
    // KAYNAK GÖNDERME
    function sendMoney() {
      const amount = parseInt(document.getElementById("money-to-send").value);
      const recipientId = document.getElementById("recipient-player").value;
      if (isNaN(amount) || amount <= 0) {
        showNotification("Geçerli bir miktar girin!");
        return;
      }
      const currentPlayerData = roomData.players[localPlayerId];
      if (currentPlayerData.money < amount) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (recipientId === localPlayerId) {
        showNotification("Kendinize para gönderemezsiniz!");
        return;
      }
      const updates = {};
      updates["players/" + localPlayerId + "/money"] = currentPlayerData.money - amount;
      updates["players/" + recipientId + "/money"] = roomData.players[recipientId].money + amount;
      roomRef.update(updates);
      broadcastNotification(`${currentPlayerData.name} → ${roomData.players[recipientId].name} için ${amount}$ gönderdi.`);
      showNotification(`${amount}$, ${roomData.players[recipientId].name} oyuncusuna gönderildi.`);
    }
    
    function sendPetrol() {
      const amount = parseInt(document.getElementById("petrol-to-send").value);
      const recipientId = document.getElementById("recipient-player-petrol").value;
      if (isNaN(amount) || amount <= 0) {
        showNotification("Geçerli bir miktar girin!");
        return;
      }
      const currentPlayerData = roomData.players[localPlayerId];
      if (currentPlayerData.petrol < amount) {
        showNotification("Yeterli petrolünüz yok!");
        return;
      }
      if (recipientId === localPlayerId) {
        showNotification("Kendinize petrol gönderemezsiniz!");
        return;
      }
      const updates = {};
      updates["players/" + localPlayerId + "/petrol"] = currentPlayerData.petrol - amount;
      updates["players/" + recipientId + "/petrol"] = roomData.players[recipientId].petrol + amount;
      roomRef.update(updates);
      broadcastNotification(`${currentPlayerData.name} → ${roomData.players[recipientId].name} için ${amount} varil petrol gönderdi.`);
      showNotification(`${amount} varil, ${roomData.players[recipientId].name} oyuncusuna gönderildi.`);
    }
    
    function sendWheat() {
      const amount = parseInt(document.getElementById("wheat-to-send").value);
      const recipientId = document.getElementById("recipient-player-wheat").value;
      if (isNaN(amount) || amount <= 0) {
        showNotification("Geçerli bir miktar girin!");
        return;
      }
      const currentPlayerData = roomData.players[localPlayerId];
      if (currentPlayerData.wheat < amount) {
        showNotification("Yeterli buğdayınız yok!");
        return;
      }
      if (recipientId === localPlayerId) {
        showNotification("Kendinize buğday gönderemezsiniz!");
        return;
      }
      const updates = {};
      updates["players/" + localPlayerId + "/wheat"] = currentPlayerData.wheat - amount;
      updates["players/" + recipientId + "/wheat"] = roomData.players[recipientId].wheat + amount;
      roomRef.update(updates);
      broadcastNotification(`${currentPlayerData.name} → ${roomData.players[recipientId].name} için ${amount} buğday gönderdi.`);
      showNotification(`${amount} buğday, ${roomData.players[recipientId].name} oyuncusuna gönderildi.`);
    }
    
    // TUR GEÇİŞİ
    function nextTurn(autoEnd = false) {
      if (!isMyTurn()) {
        showNotification("Sıranız değil!");
        return;
      }
      stopTurnTimer();
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      const currentPlayerId = roomData.playerOrder[currentTurnIndex];
      const player = roomData.players[currentPlayerId];
      if (!player) return;
      const updates = {};
      if (player.countries && roomData.countryData) {
        let totalMoneyGained = 0;
        let totalPetrolGained = 0;
        let totalWheatGained = 0;
        player.countries.forEach((cName) => {
          const country = roomData.countryData[cName];
          if (country) {
            if (country.barracksCount) {
              updates["countryData/" + cName + "/soldiers"] = (country.soldiers || 0) + 5 * country.barracksCount;
            }
            let effectiveIncome = country.income || 0;
            if (country.factories) {
              effectiveIncome = Math.floor(effectiveIncome * (1 + 0.20 * country.factories));
            }
            totalMoneyGained += effectiveIncome;
            if (country.oilProduction) {
              const effectiveOil = Math.floor(country.oilProduction * (1 + 0.15 * (country.refineries || 0)));
              totalPetrolGained += effectiveOil;
            }
            if (country.wheatProduction) {
              const effectiveWheat = Math.floor(country.wheatProduction * (1 + 0.20 * (country.grainMills || 0)));
              totalWheatGained += effectiveWheat;
            }
          }
        });
        updates["players/" + currentPlayerId + "/money"] = (player.money || 0) + totalMoneyGained;
        updates["players/" + currentPlayerId + "/petrol"] = (player.petrol || 0) + totalPetrolGained;
        updates["players/" + currentPlayerId + "/wheat"] = (player.wheat || 0) + totalWheatGained;
      }
      let newTurnIndex = currentTurnIndex + 1;
      if (newTurnIndex >= roomData.playerOrder.length) {
        newTurnIndex = 0;
        updates["round"] = (roomData.round || 1) + 1;
      }
      updates["currentTurnIndex"] = newTurnIndex;
      roomRef.update(updates);
      const nextPlayerId = roomData.playerOrder[newTurnIndex];
      let endText = "Sıra " + (roomData.players[nextPlayerId]?.name || "?") + " adlı oyuncuya geçti.";
      if (autoEnd) {
        endText = player.name + " süresini doldurdu! " + endText;
      }
      broadcastNotification(endText);
      showNotification(endText, 1500);
    }
    
    /*****************************************************************
     * CHAT SISTEMİ (GENEL + ÖZEL)
     *****************************************************************/
    function toggleChat(show) {
      const chatPopup = document.getElementById("chat-popup");
      chatPopup.style.display = show ? "flex" : "none";
      chatOpen = show;
      if (chatOpen) {
        unreadMessages = 0;
        updateChatBadge();
      }
    }
    
    document.getElementById("open-chat-btn").addEventListener("click", () => {
      popupStates.chat = !popupStates.chat;
      toggleChat(popupStates.chat);
    });
    document.getElementById("chat-popup-header").addEventListener("click", (e) => {
      if (e.target.id === "chat-popup-header") {
        popupStates.chat = false;
        toggleChat(false);
      }
    });
    document.getElementById("close-chat-btn").addEventListener("click", () => {
      popupStates.chat = false;
      toggleChat(false);
    });
    document.getElementById("send-chat-btn").addEventListener("click", () => {
      sendChatMessage();
    });
    document.getElementById("chat-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendChatMessage();
      }
    });
    
    function sendChatMessage() {
      const input = document.getElementById("chat-input");
      const messageText = input.value.trim();
      if (!messageText) return;
      if (!roomRef) {
        showNotification("Oda verisi yüklenmedi.");
        return;
      }
      let senderName = "Anon";
      if (roomData && roomData.players && roomData.players[localPlayerId]) {
        senderName = roomData.players[localPlayerId].name;
      }
      const chatMessage = {
        sender: senderName,
        senderId: localPlayerId,
        text: messageText,
        recipientId: "",
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.child("chat").push(chatMessage, (error) => {
        if (!error) {
          input.value = "";
        }
      });
    }
    
    document.getElementById("send-private-message-btn").addEventListener("click", () => {
      const privateInput = document.getElementById("private-message-input");
      const recipientSelect = document.getElementById("private-message-recipient");
      const msg = privateInput.value.trim();
      const recipientId = recipientSelect.value;
      if (!msg || !recipientId) return;
      let senderName = "Anon";
      if (roomData && roomData.players && roomData.players[localPlayerId]) {
        senderName = roomData.players[localPlayerId].name;
      }
      const chatMessage = {
        sender: senderName,
        senderId: localPlayerId,
        text: msg,
        recipientId: recipientId,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.child("chat").push(chatMessage, (error) => {
        if (!error) {
          privateInput.value = "";
          showNotification("Özel mesaj gönderildi!");
        }
      });
    });
    
    function appendChatMessage(message) {
      if (message.recipientId && message.recipientId !== "") {
        if (message.senderId !== localPlayerId && message.recipientId !== localPlayerId) {
          return;
        }
      }
      const chatMessagesDiv = document.getElementById("chat-messages");
      const messageDiv = document.createElement("div");
      if (message.recipientId && message.recipientId !== "") {
        const targetName = (roomData.players[message.recipientId] || {}).name || "Bilinmeyen";
        if (message.senderId === localPlayerId) {
          messageDiv.innerHTML = "<strong>[PM to " + targetName + "]:</strong> " + message.text;
        } else {
          messageDiv.innerHTML = "<strong>[PM from " + message.sender + "]:</strong> " + message.text;
        }
        messageDiv.style.color = "#f39c12";
      } else {
        messageDiv.textContent = message.sender + ": " + message.text;
      }
      chatMessagesDiv.appendChild(messageDiv);
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
      if (!chatOpen && message.senderId !== localPlayerId) {
        unreadMessages++;
        updateChatBadge();
      }
    }
    
    function updateChatBadge() {
      const openChatBtn = document.getElementById("open-chat-btn");
      if (unreadMessages > 0) {
        openChatBtn.dataset.badge = unreadMessages;
      } else {
        openChatBtn.dataset.badge = "";
      }
    }
    
    /*****************************************************************
     * TİCARET (MARKET) SİSTEMİ – FABRİKA SEÇENEKLERİ KALDIRILMIŞTIR
     *****************************************************************/
    // (trade-country select ve itemType değişikliğine dair event listener kaldırıldı.)
    document.getElementById("create-trade-offer-btn").addEventListener("click", createTradeOffer);
    
    function createTradeOffer() {
      if (!roomData || !roomData.players[localPlayerId]) {
        showNotification("Oyun verileri yüklenmedi veya geçersiz oyuncu!");
        return;
      }
      const itemType = document.getElementById("trade-item-type").value;
      const quantity = parseInt(document.getElementById("trade-quantity").value);
      const price = parseInt(document.getElementById("trade-price").value);
      if (isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
        showNotification("Geçerli adet ve fiyat girin!");
        return;
      }
      const seller = roomData.players[localPlayerId];
      let enough = false;
      if (itemType === "petrol") {
        if (seller.petrol >= quantity) enough = true;
      } else if (itemType === "wheat") {
        if (seller.wheat >= quantity) enough = true;
      }
      if (!enough) {
        showNotification("Satacak yeterli miktarınız yok!");
        return;
      }
      const embargoSelect = document.getElementById("embargo-players");
      let embargoList = [];
      for (let i = 0; i < embargoSelect.options.length; i++) {
        if (embargoSelect.options[i].selected) {
          embargoList.push(embargoSelect.options[i].value);
        }
      }
      const tradeOfferRef = roomRef.child("tradeOffers").push();
      const newOffer = {
        offerId: tradeOfferRef.key,
        sellerId: localPlayerId,
        sellerName: seller.name,
        itemType: itemType,
        quantity: quantity,
        price: price,
        status: "pending",
        embargo: embargoList
      };
      tradeOfferRef.set(newOffer);
      broadcastNotification(`${seller.name} bir ticaret teklifi oluşturdu (${itemType}, adet: ${quantity}, fiyat: ${price}$)`);
      showNotification("Ticaret teklifi başarıyla oluşturuldu!");
    }
    
    function displayTradeOffers() {
      const tradeOffersDiv = document.getElementById("trade-offers-list");
      if (!tradeOffersDiv) return;
      tradeOffersDiv.innerHTML = "";
      if (!roomData || !roomData.tradeOffers) return;
      const offersArray = Object.values(roomData.tradeOffers);
      offersArray.forEach((offer) => {
        if (offer.status === "pending") {
          if (offer.embargo && offer.embargo.includes(localPlayerId)) {
            return;
          }
          const offerDiv = document.createElement("div");
          offerDiv.className = "offer-item";
          let itemLabel = "";
          if (offer.itemType === "petrol") itemLabel = "Petrol";
          else if (offer.itemType === "wheat") itemLabel = "Buğday";
          let html = `<p><strong>Satıcı:</strong> ${offer.sellerName}</p>`;
          html += `<p><strong>Ürün:</strong> ${itemLabel}</p>`;
          html += `<p><strong>Mevcut Miktar:</strong> ${offer.quantity}</p>`;
          html += `<p><strong>Birim Fiyat:</strong> ${offer.price} $</p>`;
          html += `<p style="color:red;"><strong>Ambargo Uygulanan Oyuncular:</strong> ${offer.embargo && offer.embargo.length > 0 ? offer.embargo.map(e => roomData.players[e]?.name || "???").join(", ") : ""}</p>`;
          if (offer.sellerId !== localPlayerId) {
            html += `<label style="font-size:14px;color:#ccc;">Almak istediğiniz miktar:</label>
                     <input type="number" class="partial-buy-quantity" placeholder="Miktar" min="1" max="${offer.quantity}"/>
                     <button class="partial-buy-btn">Satın Al</button>`;
          } else {
            html += `<button class="cancel-offer-btn" style="background:linear-gradient(45deg, #c0392b, #e74c3c); margin-top:10px;">İptal</button>`;
          }
          offerDiv.innerHTML = html;
          const partialBuyBtn = offerDiv.querySelector(".partial-buy-btn");
          if (partialBuyBtn) {
            partialBuyBtn.addEventListener("click", () => {
              const input = offerDiv.querySelector(".partial-buy-quantity");
              const buyAmt = parseInt(input.value);
              if (isNaN(buyAmt) || buyAmt <= 0) {
                showNotification("Geçerli miktar girin!");
                return;
              }
              acceptTradeOffer(offer.offerId, buyAmt);
            });
          }
          const cancelBtn = offerDiv.querySelector(".cancel-offer-btn");
          if (cancelBtn) {
            cancelBtn.addEventListener("click", () => cancelTradeOffer(offer.offerId));
          }
          tradeOffersDiv.appendChild(offerDiv);
        }
      });
    }
    
    function acceptTradeOffer(offerId, buyAmount) {
      if (!roomData || !roomData.tradeOffers || !roomData.tradeOffers[offerId]) {
        showNotification("Teklif bulunamadı!");
        return;
      }
      const offer = roomData.tradeOffers[offerId];
      if (offer.status !== "pending") {
        showNotification("Bu teklif artık geçerli değil!");
        return;
      }
      const seller = roomData.players[offer.sellerId];
      const buyer = roomData.players[localPlayerId];
      if (!seller || !buyer) {
        showNotification("Geçersiz satıcı/alıcı!");
        return;
      }
      if (buyAmount > offer.quantity) {
        showNotification("Teklifte yeterli miktar yok!");
        return;
      }
      const totalCost = offer.price * buyAmount;
      if (buyer.money < totalCost) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      let updates = {};
      let hasEnough = false;
      if (offer.itemType === "petrol") {
        if (seller.petrol >= buyAmount) {
          hasEnough = true;
          updates["players/" + offer.sellerId + "/petrol"] = seller.petrol - buyAmount;
          updates["players/" + localPlayerId + "/petrol"] = buyer.petrol + buyAmount;
        }
      } else if (offer.itemType === "wheat") {
        if (seller.wheat >= buyAmount) {
          hasEnough = true;
          updates["players/" + offer.sellerId + "/wheat"] = seller.wheat - buyAmount;
          updates["players/" + localPlayerId + "/wheat"] = buyer.wheat + buyAmount;
        }
      }
      if (!hasEnough) {
        showNotification("Satıcının yeterli miktarı kalmamış!");
        return;
      }
      updates["players/" + localPlayerId + "/money"] = buyer.money - totalCost;
      updates["players/" + offer.sellerId + "/money"] = seller.money + totalCost;
      let newQuantity = offer.quantity - buyAmount;
      if (newQuantity <= 0) {
        updates["tradeOffers/" + offerId + "/status"] = "completed";
      }
      updates["tradeOffers/" + offerId + "/quantity"] = newQuantity;
      roomRef.update(updates, (error) => {
        if (!error) {
          broadcastNotification(`Ticaret Onaylandı: ${seller.name} -> ${buyer.name} (${buyAmount} adet "${offer.itemType}")`);
          showNotification("Ticaret başarıyla gerçekleşti!");
          const chatMessage = {
            sender: "Sistem",
            senderId: "system",
            text: `Ticaret Onaylandı: ${seller.name} -> ${buyer.name}, ${buyAmount} x ${offer.itemType}`,
            recipientId: "",
            timestamp: firebase.database.ServerValue.TIMESTAMP
          };
          roomRef.child("chat").push(chatMessage);
        }
      });
    }
    
    function cancelTradeOffer(offerId) {
      if (!roomData || !roomData.tradeOffers || !roomData.tradeOffers[offerId]) return;
      const offer = roomData.tradeOffers[offerId];
      if (offer.sellerId !== localPlayerId) {
        showNotification("Sadece kendi teklifinizi iptal edebilirsiniz.");
        return;
      }
      if (offer.status !== "pending") {
        showNotification("Bu teklif zaten tamamlanmış veya iptal edilmiş.");
        return;
      }
      roomRef.child("tradeOffers").child(offerId).update({ status: "cancelled" });
      broadcastNotification("Ticaret teklifi iptal edildi: " + offer.sellerName);
      showNotification("Teklif iptal edildi.");
    }
    
    /*****************************************************************
     * ODADAN ÇIKIŞ ve diğer pop-up kontrol kodları (orijinal haliyle)
     *****************************************************************/
    document.getElementById("exit-room-btn").addEventListener("click", () => {
      if (!roomRef || !roomData) return;
      roomRef.child("players/" + localPlayerId).remove();
      const newOrder = (roomData.playerOrder || []).filter((id) => id !== localPlayerId);
      if (isMyTurn()) {
        stopTurnTimer();
        let idx = roomData.currentTurnIndex || 0;
        if (idx >= newOrder.length) {
          idx = 0;
          let newRound = (roomData.round || 1) + 1;
          roomRef.update({ round: newRound });
        }
        roomRef.update({ currentTurnIndex: idx });
      }
      roomRef.update({ playerOrder: newOrder });
      document.getElementById("game-container").style.display = "none";
      document.getElementById("lobby-container").style.display = "block";
      document.body.classList.add("lobby");
      localStorage.removeItem("roomCode");
      stopTurnTimer();
      clearInterval(startInterval);
      showNotification("Odadan çıktınız. Artık oyunda yoksunuz.");
    });
    
    // Pop-up aç/kapa butonları için diğer event listener’lar (military, building, resource, players, pact) orijinal haliyle...
    
    /*****************************************************************
     * HARİTA (Leaflet) KURULUMU
     *****************************************************************/
    function initializeMap() {
      if (map) return;
      map = L.map("map").setView([20, 0], 2);
      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 12,
          attribution:
            'Tiles &copy; Esri &mdash; Source: Esri, GEBCO, NOAA, National Geographic, DeLorme, HERE, Geonames.org and other contributors'
        }
      ).addTo(map);
      fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
        .then((response) => response.json())
        .then((geoJsonData) => {
          geoJsonLayer = L.geoJson(geoJsonData, {
            style: () => ({
              color: "#555",
              weight: 1,
              fillColor: "#ccc",
              fillOpacity: 0.7
            }),
            onEachFeature: (feature, layer) => {
              const countryName = feature.properties.name;
              layer.bindTooltip(
                getCountryPopupContent(
                  countryName,
                  roomData && roomData.countryData ? roomData.countryData[countryName] : {}
                ),
                {
                  permanent: infoCardsPermanent,
                  direction: "center",
                  className: "country-popup-tooltip"
                }
              );
              layer.on("click", () => selectCountry(countryName, layer));
            }
          }).addTo(map);
        });
    }
    
    const gameContainerObserver = new MutationObserver(() => {
      const gameContainer = document.getElementById("game-container");
      if (gameContainer.style.display !== "none") {
        initializeMap();
      }
    });
    gameContainerObserver.observe(document.getElementById("game-container"), {
      attributes: true,
      attributeFilter: ["style"]
    });
    
    const bellBtn = document.getElementById("notifications-bell");
    bellBtn.addEventListener("click", () => {
      // Zil butonu işlevi kaldırıldı.
    });
  </script>
</body>
</html>
