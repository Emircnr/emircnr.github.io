<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Global Conquest - Online (Örnek Düzenlenmiş)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* =============== GENEL SIFIRLAMA =============== */
    * {
      margin: 0; padding: 0; box-sizing: border-box;
    }
    body {
      font-family: "Cinzel", serif;
      color: #eee;
      background: linear-gradient(180deg, #0a1f44 0%, #0b2a63 35%, #0b3553 100%);
      background-attachment: fixed;
      background-size: cover;
      overflow-x: hidden;
    }
    a { text-decoration: none; color: inherit; }

    /* =============== LOBI ALANI =============== */
    #lobby-container {
      width: 90%;
      max-width: 500px;
      margin: 50px auto;
      padding: 20px;
      background: rgba(0, 0, 0, 0.65);
      border: 2px solid #1abc9c;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.8);
    }
    #lobby-container h1 {
      color: #1abc9c;
      margin-bottom: 10px;
      font-size: 36px;
      letter-spacing: 2px;
    }
    #lobby-container h2 {
      color: #aef7f2;
      margin: 20px 0 10px;
      font-size: 20px;
    }
    #lobby-container input {
      width: 80%;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #1abc9c;
      outline: none;
      font-size: 15px;
      color: #333;
    }
    #lobby-container button {
      width: 80%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 20px;
    }
    #lobby-container button:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }
    .color-options {
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .global-color-option {
      width: 24px; height: 24px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
    }
    .global-color-option:hover { transform: scale(1.1); }
    .global-color-option.selected { border-color: #f1c40f; }

    /* =============== OYUN ALANI =============== */
    #game-container {
      display: none;
      height: 100vh;
      position: relative;
    }
    /* Üst Bilgi (Tur, Sıra, Oda) */
    #top-info {
      position: fixed;
      top: 10px;
      left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      padding: 8px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    #top-info p { font-size: 14px; margin: 0; }
    #end-turn-btn {
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none; border-radius: 6px;
      color: #fff; font-size: 14px; cursor: pointer;
      padding: 5px 10px;
    }
    #end-turn-btn:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }

    /* Harita */
    #map-container {
      width: 100%; height: 100%;
    }
    #map { width: 100%; height: 100%; }

    /* Odadan Çık */
    #exit-room-btn {
      position: fixed;
      bottom: 20px; right: 20px;
      background: linear-gradient(45deg, #c0392b, #e74c3c);
      border: none; border-radius: 6px;
      color: #fff; font-size: 14px;
      padding: 8px 14px; cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      z-index: 2000;
    }
    #exit-room-btn:hover {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
    }

    /* Alt İkonlar */
    #bottom-icons {
      position: fixed;
      bottom: 20px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 15px;
      z-index: 2000;
    }
    .bottom-icon-btn {
      width: 45px; height: 45px;
      border-radius: 50%;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none; color: #fff;
      cursor: pointer; font-size: 18px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      position: relative;
    }
    .bottom-icon-btn:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }
    /* Chat Badge */
    .bottom-icon-btn[data-badge]:after {
      content: attr(data-badge);
      position: absolute;
      top: -6px; right: -6px;
      background: red; color: white;
      border-radius: 50%;
      min-width: 18px; height: 18px;
      font-size: 12px; text-align: center;
      line-height: 18px;
    }

    /* =============== GLOBAL BILDIRIM ALANI =============== */
    #notification-area {
      position: fixed; top: 20px; right: 20px;
      display: flex; flex-direction: column; gap: 10px;
      z-index: 3000; width: auto;
    }
    .notification-item {
      min-width: 200px; max-width: 350px;
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 12px 18px;
      border-radius: 6px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.7);
      font-size: 14px; line-height: 1.4;
      opacity: 0; transform: translateX(100%);
      animation: slideIn 0.5s forwards, fadeOut 0.5s 5s forwards;
    }
    @keyframes slideIn {
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeOut {
      to { opacity: 0; transform: translateX(100%); }
    }

    /* =============== POPUP GENEL STİL =============== */
    .modern-popup {
      position: fixed;
      bottom: 80px; right: 20px;
      width: 400px; max-height: 70vh;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      display: none;
      flex-direction: column;
      z-index: 2500;
      box-shadow: 0 8px 20px rgba(0,0,0,0.7);
    }
    .modern-popup .popup-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 12px 15px;
      border-top-left-radius: 10px; border-top-right-radius: 10px;
      color: #fff; font-size: 16px; font-weight: bold;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer;
    }
    .modern-popup .popup-header button {
      background: transparent; border: none;
      color: #fff; font-size: 20px; cursor: pointer;
    }
    .modern-popup .popup-content {
      padding: 15px;
      overflow-y: auto; flex: 1;
      color: #eee; font-size: 14px;
    }
    .modern-popup .popup-content input,
    .modern-popup .popup-content select {
      width: 100%; padding: 8px;
      margin-bottom: 8px; border-radius: 4px; border: 1px solid #999;
      outline: none; color: #333;
    }
    .modern-popup .popup-content button {
      width: 100%;
      padding: 10px; margin-bottom: 10px;
      background: linear-gradient(45deg, #16a085, #1abc9c);
      border: none; border-radius: 6px;
      font-size: 15px; color: #fff; cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    .modern-popup .popup-content button:hover {
      background: linear-gradient(45deg, #1abc9c, #16a085);
    }

    /* CHAT POPUP */
    #chat-popup {
      bottom: 80px; right: 20px;
      width: 400px; max-height: 70vh;
      display: none; flex-direction: column;
    }
    #chat-popup .chat-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 12px 15px;
      border-top-left-radius: 10px; border-top-right-radius: 10px;
      color: #fff; font-size: 16px; font-weight: bold;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer;
    }
    #chat-popup .chat-header button {
      background: transparent; border: none;
      color: #fff; font-size: 20px; cursor: pointer;
    }
    #chat-messages {
      flex: 1; padding: 10px;
      overflow-y: auto; background: rgba(0,0,0,0.3);
      color: #eee; font-size: 14px;
    }
    .chat-input-container {
      display: flex; border-top: 1px solid #444;
    }
    .chat-input-container input {
      flex: 1; padding: 10px;
      border: none; outline: none; background: #1e1e2f;
      color: #eee; font-size: 14px;
    }
    .chat-input-container button {
      width: 60px; background: #1abc9c;
      border: none; color: #fff; font-size: 16px;
      cursor: pointer;
    }
    .chat-private-container {
      border-top: 1px solid #444; padding: 10px;
      background: rgba(0,0,0,0.3);
    }
    .chat-private-container h4 { margin-bottom: 6px; }
    .chat-private-container select,
    .chat-private-container input {
      width: 100%; margin-bottom: 8px; padding: 8px;
      border-radius: 4px; border: 1px solid #999; outline: none;
      background: #1e1e2f; color: #eee;
    }
    .chat-private-container button {
      background: #16a085; border: none;
      color: #fff; cursor: pointer; font-size: 14px;
      width: 100%; padding: 8px; border-radius: 4px;
    }

    /* =============== PLAYERS POPUP =============== */
    #players-popup {
      position: fixed; bottom: 80px; left: 20px;
      width: 350px; max-height: 70vh;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      display: none; flex-direction: column; z-index: 2500;
      box-shadow: 0 8px 20px rgba(0,0,0,0.7);
    }
    #players-popup .popup-header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      padding: 12px 15px; border-top-left-radius: 10px; border-top-right-radius: 10px;
      color: #fff; font-size: 16px; font-weight: bold;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer;
    }
    #players-popup .popup-content {
      padding: 10px; overflow-y: auto; flex: 1;
    }
    .player-info {
      background: rgba(0,0,0,0.4);
      padding: 8px; margin-bottom: 6px;
      border-radius: 4px; font-size: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    /* =============== PACT POPUP =============== */
    #pact-popup {
      bottom: 80px; right: 20px; width: 400px; max-height: 70vh;
      display: none; flex-direction: column;
    }
    #pact-offers-container {
      margin-top: 10px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px;
    }
    .pact-offer-item {
      background: rgba(0,0,0,0.4);
      margin-bottom: 6px; padding: 6px;
      border-radius: 4px;
    }

    /* =============== MARKET POPUP (TİCARET) =============== */
    #market-popup {
      bottom: 80px; right: 20px; width: 450px; max-height: 75vh;
      display: none; flex-direction: column;
    }
    .offer-item {
      background: rgba(0,0,0,0.4);
      margin-bottom: 10px;
      padding: 10px; border-radius: 4px;
    }

    /* =============== HARİTA TOOLTIP =============== */
    .leaflet-tooltip {
      background: transparent; border: none;
    }
    .country-popup-tooltip {
      background: rgba(0, 0, 0, 0.7) !important;
      color: #fff !important;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 12px;
    }

    /* =============== RESPONSIVE =============== */
    @media (max-width: 768px) {
      #lobby-container { width: 95%; }
      .modern-popup,
      #chat-popup,
      #players-popup,
      #pact-popup,
      #market-popup {
        width: 90% !important; left: 5% !important; right: auto !important;
      }
      #top-info { left: 50%; transform: translateX(-50%); }
    }
  </style>
</head>
<body>
  <!-- ========== LOBI ========== -->
  <div id="lobby-container">
    <h1>GLOBAL CONQUEST</h1>
    <!-- Oda Oluşturma -->
    <div>
      <h2>Oda Oluştur</h2>
      <input type="text" id="creator-player-name" placeholder="Adınız..." />
      <div class="color-options" id="creator-color-options"></div>
      <input type="number" id="max-players" placeholder="Oyuncu Sayısı (2-5)" min="2" max="5" />
      <button id="create-room-btn">Oda Oluştur</button>
    </div>
    <hr style="border:1px solid #333;margin:10px 0;" />
    <!-- Odaya Katılma -->
    <div>
      <h2>Odaya Katıl</h2>
      <input type="text" id="join-player-name" placeholder="Adınız..." />
      <div class="color-options" id="join-color-options"></div>
      <input type="text" id="room-code" placeholder="Oda Kodu (Ör: AB12CD)" />
      <button id="join-room-btn">Odaya Katıl</button>
    </div>
  </div>

  <!-- ========== BİLDİRİM ALANI ========== -->
  <div id="notification-area"></div>

  <!-- ========== OYUN ALANI ========== -->
  <div id="game-container">
    <!-- ÜST BİLGİ -->
    <div id="top-info">
      <p>Oda Kodu: <span id="display-room-code">-</span></p>
      <p>Tur: <span id="current-round">1</span></p>
      <p>Sıra: <span id="current-player">-</span></p>
      <button id="end-turn-btn"><i class="fas fa-forward"></i> Tur Sonu</button>
    </div>

    <!-- HARİTA -->
    <div id="map-container">
      <div id="map"></div>
    </div>

    <!-- ODADAN ÇIKIŞ -->
    <button id="exit-room-btn">Odadan Çık</button>

    <!-- ALT İKONLAR -->
    <div id="bottom-icons">
      <button id="open-players-btn" class="bottom-icon-btn" title="Oyuncular">
        <i class="fas fa-users"></i>
      </button>
      <button id="open-military-btn" class="bottom-icon-btn" title="Asker İşlemleri">
        <i class="fas fa-shield-alt"></i>
      </button>
      <button id="open-building-btn" class="bottom-icon-btn" title="Bina Kurma">
        <i class="fas fa-building"></i>
      </button>
      <button id="open-resource-btn" class="bottom-icon-btn" title="Kaynak Gönderme">
        <i class="fas fa-hand-holding-usd"></i>
      </button>
      <button id="open-market-btn" class="bottom-icon-btn" title="Ticaret Merkezi">
        <i class="fas fa-store"></i>
      </button>
      <button id="open-pact-btn" class="bottom-icon-btn" title="Saldırmazlık Pakti">
        <i class="fas fa-handshake"></i>
      </button>
      <button id="open-chat-btn" class="bottom-icon-btn" data-badge="" title="Sohbet">
        <i class="fas fa-comments"></i>
      </button>
    </div>
  </div>

  <!-- ========== OYUNCULAR POPUP ========== -->
  <div id="players-popup">
    <div class="popup-header" id="players-popup-header">
      <span>Oyuncu Bilgileri</span>
      <button id="close-players-btn">&times;</button>
    </div>
    <div class="popup-content" id="players-info">
      <!-- Oyuncu listesi buraya gelecek -->
    </div>
  </div>

  <!-- ========== ASKER POPUP ========== -->
  <div id="military-popup" class="modern-popup">
    <div class="popup-header" id="military-popup-header">
      <span>Asker İşlemleri</span>
      <button id="close-military-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Saldırı</h3>
      <input type="number" id="attack-soldiers" placeholder="Gönderilecek asker sayısı" min="1" />
      <button id="attack-btn">Saldır</button>

      <h3>Asker Satın Al</h3>
      <p style="font-size:13px;color:#bbb;">1 Asker = 10$ + 15 Buğday</p>
      <input type="number" id="soldiers-to-buy" placeholder="Kaç asker?" min="1" />
      <button id="buy-soldiers-btn">Satın Al</button>

      <h3>Asker Çek</h3>
      <input type="number" id="pull-soldiers-count" placeholder="Çekilecek asker sayısı" min="1" />
      <button id="pull-soldiers-btn">Asker Çek</button>
    </div>
  </div>

  <!-- ========== BİNA POPUP ========== -->
  <div id="building-popup" class="modern-popup">
    <div class="popup-header" id="building-popup-header">
      <span>Bina Kurma</span>
      <button id="close-building-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Kışla</h3>
      <p style="font-size:13px;color:#bbb;">(130$ + 40 Petrol / adet)</p>
      <input type="number" id="barracks-quantity" placeholder="Adet" min="1" />
      <button id="buy-barracks-btn">Kışla Kur</button>

      <h3>Fabrika</h3>
      <p style="font-size:13px;color:#bbb;">(250$ + 90 Petrol / adet)</p>
      <input type="number" id="factory-quantity" placeholder="Adet" min="1" />
      <button id="build-factory-btn">Fabrika Kur</button>

      <h3>Rafine</h3>
      <p style="font-size:13px;color:#bbb;">(800$ + 250 Petrol / adet)</p>
      <input type="number" id="refinery-quantity" placeholder="Adet" min="1" />
      <button id="build-refinery-btn">Rafine Kur</button>

      <h3>Değirmen</h3>
      <p style="font-size:13px;color:#bbb;">(200$ + 100 Petrol / adet)</p>
      <input type="number" id="grainmill-quantity" placeholder="Adet" min="1" />
      <button id="build-grainmill-btn">Değirmen Kur</button>
    </div>
  </div>

  <!-- ========== KAYNAK GÖNDER POPUP ========== -->
  <div id="resource-popup" class="modern-popup">
    <div class="popup-header" id="resource-popup-header">
      <span>Kaynak Gönder</span>
      <button id="close-resource-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Para Gönder</h3>
      <input type="number" id="money-to-send" placeholder="Miktar ($)" min="1" />
      <select id="recipient-player"></select>
      <button id="send-money-btn">Gönder</button>

      <h3>Petrol Gönder</h3>
      <input type="number" id="petrol-to-send" placeholder="Miktar (varil)" min="1" />
      <select id="recipient-player-petrol"></select>
      <button id="send-petrol-btn">Gönder</button>

      <h3>Buğday Gönder</h3>
      <input type="number" id="wheat-to-send" placeholder="Miktar (buğday)" min="1" />
      <select id="recipient-player-wheat"></select>
      <button id="send-wheat-btn">Gönder</button>
    </div>
  </div>

  <!-- ========== CHAT POPUP ========== -->
  <div id="chat-popup">
    <div class="chat-header" id="chat-popup-header">
      <span>Sohbet</span>
      <button id="close-chat-btn">&times;</button>
    </div>
    <div id="chat-messages"></div>
    <!-- Genel Sohbet -->
    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Mesaj..." />
      <button id="send-chat-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
    <!-- Özel Mesaj -->
    <div class="chat-private-container">
      <h4>Özel Mesaj</h4>
      <select id="private-message-recipient"></select>
      <input type="text" id="private-message-input" placeholder="Özel mesaj..." />
      <button id="send-private-message-btn"><i class="fas fa-user-secret"></i> Gönder</button>
    </div>
  </div>

  <!-- ========== PAKT POPUP ========== -->
  <div id="pact-popup" class="modern-popup">
    <div class="popup-header" id="pact-popup-header">
      <span>Saldırmazlık Pakti</span>
      <button id="close-pact-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Pakt Teklifi Oluştur</h3>
      <input type="number" id="pact-turns" placeholder="Tur (kaç tur)" min="1" />
      <input type="number" id="pact-cost" placeholder="Ücret ($)" min="1" />
      <select id="pact-recipient"></select>
      <button id="send-pact-btn">Teklif Gönder</button>

      <div id="pact-offers-container" style="margin-top:10px;">
        <h3>Gelen Pakt Teklifleri</h3>
        <div id="pact-offers-list"></div>
      </div>
    </div>
  </div>

  <!-- ========== MARKET (TİCARET) POPUP ========== -->
  <div id="market-popup" class="modern-popup">
    <div class="popup-header" id="market-popup-header">
      <span>Ticaret Merkezi</span>
      <button id="close-market-btn">&times;</button>
    </div>
    <div class="popup-content">
      <h3>Yeni Teklif Oluştur</h3>
      <label>Ürün Tipi:</label>
      <select id="trade-item-type">
        <option value="petrol">Petrol</option>
        <option value="barracks">Kışla</option>
        <option value="factory">Fabrika</option>
        <option value="refinery">Rafine</option>
        <option value="grainmill">Değirmen</option>
        <option value="wheat">Buğday</option>
      </select>
      <label>Ülke (bina satıyorsanız seçin):</label>
      <select id="trade-country" style="display:none;"></select>

      <label>Miktar:</label>
      <input type="number" id="trade-quantity" placeholder="Miktar" min="1" />

      <label>Birim Fiyat ($):</label>
      <input type="number" id="trade-price" placeholder="Birim Fiyat" min="1" />

      <label>Ambargo (Oyuncular, seçilebilen):</label>
      <select id="embargo-players" multiple style="width:100%;"></select>
      <small style="color:#ccc;">(Seçtiğiniz oyuncular bu teklifi göremez)</small>

      <button id="create-trade-offer-btn">Teklifi Oluştur</button>

      <hr style="margin:10px 0;border:1px solid #333;" />

      <h3>Mevcut Teklifler</h3>
      <div id="trade-offers-list"></div>
    </div>
  </div>

  <!-- ========== Firebase & Leaflet & JS ========== -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    /********************************************************
     * 1) Firebase AYARLARI
     ********************************************************/
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abc123",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /********************************************************
     * 2) GLOBAL DEĞİŞKENLER
     ********************************************************/
    let localPlayerId = null;
    let localPlayerColor = null;
    let currentRoomCode = null;
    let roomRef = null;
    let roomData = null; // Firebase'den gelen anlık oda verileri
    let selectedCountry = null; // Harita üzerinden seçilen ülke
    let geoJsonLayer = null;
    let map = null;
    let chatOpen = false;
    let unreadMessages = 0;
    const availableColors = ["red","blue","green","yellow","purple"];
    const popupStates = {
      players: false,
      military: false,
      building: false,
      resource: false,
      chat: false,
      pact: false,
      market: false
    };

    // -> Oyun içi "info cards" kalıcı gösterim gibi ekstra bir ayar varsa eklenebilir.
    // Bu örnekte yok, isterseniz benzer mantıkla ekleyebilirsiniz.

    /********************************************************
     * 3) KULLANIŞLI FONKSİYONLAR
     ********************************************************/
    function showNotification(message, duration=4000) {
      console.log("Local Notification:", message);
      const nArea = document.getElementById("notification-area");
      const item = document.createElement("div");
      item.className = "notification-item";
      item.textContent = message;
      nArea.appendChild(item);
      setTimeout(() => {
        if (nArea.contains(item)) {
          nArea.removeChild(item);
        }
      }, duration+800);
    }

    // Tüm oyunculara iletilecek bildirim (veritabanına yazılır, her client'ta görünecek)
    function broadcastNotification(text) {
      if (!roomRef) return;
      roomRef.child("notifications").push({
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
    }

    // Global bildirimleri ekranda göster
    function displayGlobalNotification(text) {
      const nArea = document.getElementById("notification-area");
      const item = document.createElement("div");
      item.className = "notification-item";
      item.textContent = text;
      nArea.appendChild(item);
      setTimeout(() => {
        if (nArea.contains(item)) {
          nArea.removeChild(item);
        }
      }, 6500);
    }

    // Oyun sırası
    function isMyTurn() {
      if (!roomData || !roomData.playerOrder) return false;
      const currentTurnIndex = roomData.currentTurnIndex || 0;
      return (roomData.playerOrder[currentTurnIndex] === localPlayerId);
    }

    // Rastgele oda kodu
    function generateRoomCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i=0; i<6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Saldırmazlık paktı var mı?
    function hasActivePact(pA, pB) {
      if (!roomData || !roomData.pacts) return false;
      const currentRound = roomData.round || 1;
      for (let pactId in roomData.pacts) {
        const pact = roomData.pacts[pactId];
        if (pact.players.includes(pA) && pact.players.includes(pB)) {
          if (currentRound <= pact.endRound) {
            return true; // hâlâ geçerli
          }
        }
      }
      return false;
    }

    /********************************************************
     * 4) SAYFA YÜKLENDİĞİNDE LOBI VE RENK SEÇENEKLERİ
     ********************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      if (!localStorage.getItem("playerId")) {
        localStorage.setItem("playerId", Math.random().toString(36).substr(2,9));
      }
      localPlayerId = localStorage.getItem("playerId");

      // Oda oluşturma renk seçimi
      const creatorColorDiv = document.getElementById("creator-color-options");
      availableColors.forEach(color => {
        const btn = document.createElement("div");
        btn.className = "global-color-option";
        btn.style.backgroundColor = color;
        btn.addEventListener("click", () => {
          creatorColorDiv.querySelectorAll(".global-color-option").forEach(el => el.classList.remove("selected"));
          btn.classList.add("selected");
          localPlayerColor = color;
        });
        creatorColorDiv.appendChild(btn);
      });

      // Odaya katılma renk seçimi
      const joinColorDiv = document.getElementById("join-color-options");
      availableColors.forEach(color => {
        const btn = document.createElement("div");
        btn.className = "global-color-option";
        btn.style.backgroundColor = color;
        btn.addEventListener("click", () => {
          joinColorDiv.querySelectorAll(".global-color-option").forEach(el => el.classList.remove("selected"));
          btn.classList.add("selected");
          localPlayerColor = color;
        });
        joinColorDiv.appendChild(btn);
      });

      // Oda Oluştur
      document.getElementById("create-room-btn").addEventListener("click", createRoom);
      // Odaya Katıl
      document.getElementById("join-room-btn").addEventListener("click", joinRoom);

      // Otomatik reconnect (LocalStorage oda varsa)
      autoReconnect();
    });

    function createRoom() {
      const playerName = document.getElementById("creator-player-name").value.trim();
      const maxPlayers = parseInt(document.getElementById("max-players").value);
      if (!playerName) {
        showNotification("Lütfen adınızı girin!");
        return;
      }
      if (!localPlayerColor) {
        showNotification("Lütfen bir renk seçin!");
        return;
      }
      if (isNaN(maxPlayers) || maxPlayers < 2 || maxPlayers > 5) {
        showNotification("Oyuncu sayısı 2-5 arası olmalı!");
        return;
      }
      const roomCode = generateRoomCode();
      currentRoomCode = roomCode;
      roomRef = db.ref("rooms/"+roomCode);
      const newRoomData = {
        roomCode: roomCode,
        maxPlayers: maxPlayers,
        gameState: "waiting",
        currentTurnIndex: 0,
        round: 1,
        playerOrder: [localPlayerId],
        players: {},
        countryData: {},
        createdAt: firebase.database.ServerValue.TIMESTAMP
      };
      newRoomData.players[localPlayerId] = {
        name: playerName,
        color: localPlayerColor,
        money: 1000,
        soldiers: 0,
        countries: [],
        petrol: 0,
        wheat: 400,
        joinedAt: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.set(newRoomData, error => {
        if (error) {
          showNotification("Oda oluşturulurken hata oluştu!");
        } else {
          showNotification("Oda oluşturuldu: "+roomCode);
          localStorage.setItem("roomCode", roomCode);
          // Sadece oda kurucusu, GeoJSON yükleme (örnek)
          loadAndInitializeGeoJson();
          joinRoomAndListen();
          switchToGameUI(roomCode);
        }
      });
    }

    function joinRoom() {
      const playerName = document.getElementById("join-player-name").value.trim();
      const rCode = document.getElementById("room-code").value.trim().toUpperCase();
      if (!playerName) {
        showNotification("Lütfen adınızı girin!");
        return;
      }
      if (!localPlayerColor) {
        showNotification("Lütfen bir renk seçin!");
        return;
      }
      if (!rCode) {
        showNotification("Oda kodu girin!");
        return;
      }
      currentRoomCode = rCode;
      roomRef = db.ref("rooms/"+rCode);
      roomRef.once("value", snapshot => {
        if (!snapshot.exists()) {
          showNotification("Oda bulunamadı!");
          return;
        }
        const data = snapshot.val();
        if (data.gameState !== "waiting") {
          showNotification("Oyun zaten başlamış!");
          return;
        }
        const pCount = Object.keys(data.players || {}).length;
        if (pCount >= data.maxPlayers) {
          showNotification("Oda dolu!");
          return;
        }
        // Katılım
        const updates = {};
        updates["players/"+localPlayerId] = {
          name: playerName,
          color: localPlayerColor,
          money: 1000,
          soldiers: 0,
          countries: [],
          petrol: 0,
          wheat: 400,
          joinedAt: firebase.database.ServerValue.TIMESTAMP
        };
        let order = data.playerOrder || [];
        order.push(localPlayerId);
        updates["playerOrder"] = order;
        roomRef.update(updates, err => {
          if (err) {
            showNotification("Odaya katılırken hata oluştu!");
          } else {
            showNotification("Odaya katıldınız!");
            localStorage.setItem("roomCode", rCode);
            joinRoomAndListen();
            switchToGameUI(rCode);
          }
        });
      });
    }

    // Odaya otomatik bağlanma (yeniden yükleme)
    function autoReconnect() {
      const savedRoom = localStorage.getItem("roomCode");
      if (savedRoom) {
        const refCheck = db.ref("rooms/"+savedRoom);
        refCheck.once("value", snap => {
          if (!snap.exists()) return;
          const d = snap.val();
          if (!d.players || !d.players[localPlayerId]) return;
          currentRoomCode = savedRoom;
          roomRef = refCheck;
          joinRoomAndListen();
          switchToGameUI(savedRoom);
        });
      }
    }

    function switchToGameUI(roomCode) {
      document.getElementById("lobby-container").style.display = "none";
      document.getElementById("game-container").style.display = "block";
      document.getElementById("display-room-code").textContent = roomCode;
    }

    /********************************************************
     * 5) GEOJSON YÜKLEME (Sadece Oda Kurucusu)
     ********************************************************/
    function loadAndInitializeGeoJson() {
      fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
      .then(r => r.json())
      .then(geoData => {
        let countryDataInit = {};
        geoData.features.forEach((f) => {
          const cName = f.properties.name;
          // Rastgele gelir / üretim örneği
          const randomIncome = Math.floor(Math.random()*400)+100;
          // Petrol kapasitesi (örnek 0-500)
          const randomPetrol = Math.random()>0.7 ? Math.floor(Math.random()*400)+100 : 0;
          // Buğday kapasitesi (örnek 0-700)
          const randomWheat = Math.random()>0.5 ? Math.floor(Math.random()*600)+100 : 0;
          countryDataInit[cName] = {
            income: randomIncome,
            soldiers: 0,
            owner: null,
            barracksCount: 0,
            factories: 0,
            refineries: 0,
            oilProduction: randomPetrol,
            wheatProduction: randomWheat,
            grainMills: 0
          };
        });
        roomRef.child("countryData").set(countryDataInit);
      });
    }

    /********************************************************
     * 6) ODA VERİLERİNİ DİNLEME, GÜNCELLEME
     ********************************************************/
    let chatListenerAdded = false;
    function joinRoomAndListen() {
      if (!roomRef) return;
      roomRef.on("value", snapshot => {
        roomData = snapshot.val() || {};
        updateGameUI();
        displayPendingPactOffers();
        displayTradeOffers();
      });
      // CHAT
      if (!chatListenerAdded) {
        roomRef.child("chat").on("child_added", snap => {
          const msg = snap.val();
          appendChatMessage(msg);
        });
        // Global notifications
        roomRef.child("notifications").on("child_added", snap => {
          const n = snap.val();
          if (n && n.text) displayGlobalNotification(n.text);
        });
        chatListenerAdded = true;
      }
    }

    function updateGameUI() {
      if (!roomData) return;
      // Tur
      document.getElementById("current-round").textContent = roomData.round || 1;
      // Sıra
      const cIndex = roomData.currentTurnIndex || 0;
      if (roomData.playerOrder && roomData.players) {
        const currentPlayerId = roomData.playerOrder[cIndex];
        const p = roomData.players[currentPlayerId];
        if (p) {
          document.getElementById("current-player").textContent = p.name;
        }
      }
      // Oyuncu listesi
      updatePlayersPopup();
      // Harita boyaması
      if (map && geoJsonLayer && roomData.countryData) {
        geoJsonLayer.eachLayer(layer => {
          const cName = layer.feature.properties.name;
          const cd = roomData.countryData[cName];
          if (cd) {
            // Renk
            if (cd.owner && roomData.players[cd.owner]) {
              layer.setStyle({ fillColor: roomData.players[cd.owner].color, fillOpacity: 0.7 });
            } else {
              layer.setStyle({ fillColor: "#ccc", fillOpacity: 0.7 });
            }
            // Tooltip
            layer.setTooltipContent(getCountryTooltip(cName, cd));
          }
        });
      }
      // Kaynak gönderim select
      updateResourceSelects();
      // Pakt select
      updatePactRecipientSelect();
      // Chat private select
      updatePrivateMessageRecipientSelect();
      // Ticaret -> ülke select
      updateTradeCountrySelect();
      // Ticaret -> ambargo list
      updateEmbargoPlayersSelect();
    }

    function getCountryTooltip(cName, cd) {
      if (!cd) return cName;
      const ownerText = (cd.owner && roomData.players[cd.owner]) ? roomData.players[cd.owner].name : "Yok";
      // Fabrika -> +%20
      let effectiveIncome = cd.income || 0;
      if (cd.factories > 0) effectiveIncome = Math.floor(effectiveIncome*(1+0.2*cd.factories));
      // Rafine -> +%15
      let effectiveOil = cd.oilProduction || 0;
      if (cd.refineries>0) effectiveOil = Math.floor(effectiveOil*(1+0.15*cd.refineries));
      // Değirmen -> +%20
      let effectiveWheat = cd.wheatProduction || 0;
      if (cd.grainMills>0) effectiveWheat = Math.floor(effectiveWheat*(1+0.2*cd.grainMills));

      return `
        <div style="text-align:center;">
          <p><strong>${cName}</strong></p>
          <p>Gelir: ${effectiveIncome}$</p>
          <p>Asker: ${cd.soldiers||0}</p>
          <p>Kışla: ${cd.barracksCount||0}</p>
          <p>Fabrika: ${cd.factories||0}</p>
          <p>Rafine: ${cd.refineries||0}</p>
          <p>Petrol Üretimi: ${effectiveOil}</p>
          <p>Değirmen: ${cd.grainMills||0}</p>
          <p>Buğday Üretimi: ${effectiveWheat}</p>
          <p>Sahip: ${ownerText}</p>
        </div>
      `;
    }

    // Oyuncu bilgileri popup
    function updatePlayersPopup() {
      const container = document.getElementById("players-info");
      if (!container) return;
      container.innerHTML = "";
      if (roomData.playerOrder) {
        roomData.playerOrder.forEach(pid => {
          const p = roomData.players[pid];
          const div = document.createElement("div");
          div.className = "player-info";
          div.innerHTML = `
            <p><strong>${p.name}</strong></p>
            <p>Para: ${p.money}$</p>
            <p>Asker: ${p.soldiers}</p>
            <p>Ülkeler: ${(p.countries||[]).length}</p>
            <p>Petrol: ${p.petrol}</p>
            <p>Buğday: ${p.wheat}</p>
          `;
          container.appendChild(div);
        });
      }
    }

    /********************************************************
     * 7) HARİTA (Leaflet) KURULUMU
     ********************************************************/
    function initializeMap() {
      if (map) return;
      map = L.map("map").setView([20,0], 2);
      L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 12,
          attribution: "Tiles &copy; Esri &mdash; Source: Esri, GEBCO, NOAA ..."
        }
      ).addTo(map);

      fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
      .then(r=>r.json())
      .then(geoData => {
        geoJsonLayer = L.geoJson(geoData, {
          style: () => ({
            color: "#555", weight: 1, fillColor: "#ccc", fillOpacity: 0.7
          }),
          onEachFeature: (feature, layer) => {
            const cName = feature.properties.name;
            const cTooltip = roomData && roomData.countryData ? getCountryTooltip(cName, roomData.countryData[cName]) : cName;
            layer.bindTooltip(cTooltip, {
              permanent: false,
              direction: "center",
              className: "country-popup-tooltip"
            });
            layer.on("click", () => selectCountryOnMap(cName, layer));
          }
        }).addTo(map);
      });
    }

    function selectCountryOnMap(cName, layer) {
      selectedCountry = cName;
      showNotification("Seçilen ülke: "+cName, 1500);
      // Kısa süreli vurgu
      layer.setStyle({ color: "#FF4500", weight: 3 });
      setTimeout(()=>{
        // Sahibi varsa onun rengine dön
        const cd = roomData?.countryData?.[cName];
        if (cd && cd.owner && roomData.players[cd.owner]) {
          layer.setStyle({ color: "#555", weight: 1, fillColor: roomData.players[cd.owner].color });
        } else {
          layer.setStyle({ color: "#555", weight: 1, fillColor: "#ccc" });
        }
      }, 700);
    }

    // Harita için game-container gözlenmesi
    const observer = new MutationObserver(()=>{
      const gc = document.getElementById("game-container");
      if (gc.style.display!=="none") {
        initializeMap();
      }
    });
    observer.observe(document.getElementById("game-container"), {attributes:true,attributeFilter:["style"]});

    /********************************************************
     * 8) ASKER İŞLEMLERİ (Saldırı, Satın Alma, Çekme)
     ********************************************************/
    function attack() {
      if (!isMyTurn()) {
        showNotification("Sıra sizde değil!");
        return;
      }
      if ((roomData.round||1)<=3) {
        showNotification("İlk 3 tur saldırı yapılamaz!");
        return;
      }
      if (!selectedCountry) {
        showNotification("Bir ülke seçin!");
        return;
      }
      const amt = parseInt(document.getElementById("attack-soldiers").value);
      if (isNaN(amt) || amt<=0) {
        showNotification("Geçerli asker sayısı girin!");
        return;
      }
      const cIndex = roomData.currentTurnIndex||0;
      const atkPlayerId = roomData.playerOrder[cIndex];
      const atkPlayer = roomData.players[atkPlayerId];
      if (amt>atkPlayer.soldiers) {
        showNotification("Yeterli askeriniz yok!");
        return;
      }
      const target = roomData.countryData[selectedCountry];
      if (!target) return;

      // Pakt varsa engelle
      if (target.owner && target.owner!==atkPlayerId) {
        if (hasActivePact(atkPlayerId, target.owner)) {
          showNotification("Bu oyuncu ile saldırmazlık paktınız var!");
          return;
        }
      }

      const updates = {};
      let attackResult = "";
      // Kendi ülkesine asker yollamak
      if (target.owner===atkPlayerId) {
        updates[`countryData/${selectedCountry}/soldiers`] = (target.soldiers||0)+amt;
        updates[`players/${atkPlayerId}/soldiers`] = atkPlayer.soldiers - amt;
        attackResult = selectedCountry+" ülkesine "+amt+" asker konuşlandırdınız.";
      } else {
        // Gerçek saldırı
        updates[`players/${atkPlayerId}/soldiers`] = atkPlayer.soldiers - amt;
        if (amt> target.soldiers) {
          // Ülke ele geçer
          const remain = amt - target.soldiers;
          updates[`countryData/${selectedCountry}/soldiers`] = remain;
          updates[`countryData/${selectedCountry}/owner`] = atkPlayerId;
          // Saldıran ülke listesi
          let arr = atkPlayer.countries||[];
          if (!arr.includes(selectedCountry)) arr.push(selectedCountry);
          updates[`players/${atkPlayerId}/countries`] = arr;
          // Savunanın ülke listesinden çıkar
          if (target.owner && roomData.players[target.owner]) {
            let defArr = roomData.players[target.owner].countries||[];
            defArr = defArr.filter(c=>c!==selectedCountry);
            updates[`players/${target.owner}/countries`] = defArr;
          }
          attackResult = selectedCountry+" ülkesini fethettiniz! ("+amt+" vs "+target.soldiers+")";
        } else {
          // Savunma kazanır
          updates[`countryData/${selectedCountry}/soldiers`] = target.soldiers - amt;
          attackResult = selectedCountry+" savunuldu! ("+amt+" vs "+target.soldiers+")";
        }
        nextTurn(); // saldırı bitince tur geçiyor
      }
      roomRef.update(updates);
      broadcastNotification(`Saldırı: ${atkPlayer.name} -> ${selectedCountry}. Sonuç: ${attackResult}`);
      showNotification(attackResult);
    }

    function buySoldiers() {
      if (!isMyTurn()) {
        showNotification("Sıra sizde değil!");
        return;
      }
      const amt = parseInt(document.getElementById("soldiers-to-buy").value);
      if (isNaN(amt) || amt<=0) {
        showNotification("Geçerli asker sayısı girin!");
        return;
      }
      const costMoney = 10*amt;
      const costWheat = 15*amt;
      const cIndex = roomData.currentTurnIndex||0;
      const pId = roomData.playerOrder[cIndex];
      const pd = roomData.players[pId];
      if (pd.money<costMoney) {
        showNotification("Yeterli paranız yok!");
        return;
      }
      if (pd.wheat<costWheat) {
        showNotification("Yeterli buğdayınız yok!");
        return;
      }
      const updates = {};
      updates[`players/${pId}/money`] = pd.money - costMoney;
      updates[`players/${pId}/wheat`] = pd.wheat - costWheat;
      updates[`players/${pId}/soldiers`] = pd.soldiers + amt;
      roomRef.update(updates);
      broadcastNotification(`${pd.name}, ${amt} asker satın aldı.`);
      showNotification(amt+" asker satın aldınız.");
    }

    function pullSoldiers() {
      if (!isMyTurn()) { showNotification("Sıra sizde değil!"); return; }
      if (!selectedCountry) { showNotification("Bir ülke seçin!"); return; }
      const amt = parseInt(document.getElementById("pull-soldiers-count").value);
      if (isNaN(amt) || amt<=0) {
        showNotification("Geçerli sayı girin!");
        return;
      }
      const target = roomData.countryData[selectedCountry];
      const cIndex = roomData.currentTurnIndex||0;
      const pId = roomData.playerOrder[cIndex];
      if (target.owner!==pId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      if (target.soldiers<amt) {
        showNotification("Ülkede yeterli asker yok!");
        return;
      }
      const updates = {};
      updates[`countryData/${selectedCountry}/soldiers`] = target.soldiers - amt;
      updates[`players/${pId}/soldiers`] = roomData.players[pId].soldiers + amt;
      roomRef.update(updates);
      broadcastNotification(`${roomData.players[pId].name}, ${selectedCountry} ülkesinden ${amt} asker çekti.`);
      showNotification(`${selectedCountry} ülkesinden ${amt} asker çektiniz.`);
    }

    /********************************************************
     * 9) BİNA İŞLEMLERİ
     ********************************************************/
    function buyBarracks() {
      if (!isMyTurn()) { showNotification("Sıra sizde değil!"); return; }
      if (!selectedCountry) { showNotification("Ülke seçin!"); return; }
      const q = parseInt(document.getElementById("barracks-quantity").value);
      if (isNaN(q) || q<=0) { showNotification("Geçersiz adet!"); return; }
      const cIndex = roomData.currentTurnIndex||0;
      const pId = roomData.playerOrder[cIndex];
      const pData = roomData.players[pId];
      const cd = roomData.countryData[selectedCountry];
      if (cd.owner!==pId) {
        showNotification("Bu ülke size ait değil!");
        return;
      }
      const costMoney = 130*q; const costOil = 40*q;
      if (pData.money<costMoney) {
        showNotification("Yeterli para yok!");
        return;
      }
      if (pData.petrol<costOil) {
        showNotification("Yeterli petrol yok!");
        return;
      }
      const updates = {};
      updates[`players/${pId}/money`] = pData.money - costMoney;
      updates[`players/${pId}/petrol`] = pData.petrol - costOil;
      updates[`countryData/${selectedCountry}/barracksCount`] = (cd.barracksCount||0)+q;
      roomRef.update(updates);
      broadcastNotification(`${pData.name} -> ${selectedCountry} ülkesine ${q} kışla kurdu.`);
      showNotification(`${q} kışla kurdunuz.`);
    }

    function buildFactory() {
      if (!isMyTurn()) return;
      if (!selectedCountry) { showNotification("Ülke seçin!");return;}
      const q = parseInt(document.getElementById("factory-quantity").value);
      if (isNaN(q) || q<=0) { showNotification("Geçersiz adet!");return;}
      const cIndex = roomData.currentTurnIndex||0;
      const pId = roomData.playerOrder[cIndex];
      const pData = roomData.players[pId];
      const cd = roomData.countryData[selectedCountry];
      if (cd.owner!==pId) { showNotification("Ülke size ait değil!"); return; }
      const costM = 250*q; const costO=90*q;
      if (pData.money<costM) { showNotification("Yetersiz para!"); return;}
      if (pData.petrol<costO){ showNotification("Yetersiz petrol!");return;}
      const updates = {};
      updates[`players/${pId}/money`] = pData.money - costM;
      updates[`players/${pId}/petrol`] = pData.petrol - costO;
      updates[`countryData/${selectedCountry}/factories`] = (cd.factories||0)+q;
      roomRef.update(updates);
      broadcastNotification(`${pData.name}, ${selectedCountry} ülkesine ${q} fabrika kurdu.`);
      showNotification(`${q} fabrika kurdunuz.`);
    }

    function buildRefinery() {
      if (!isMyTurn()) return;
      if (!selectedCountry) { showNotification("Ülke seçin!");return;}
      const q = parseInt(document.getElementById("refinery-quantity").value);
      if (isNaN(q) || q<=0) { showNotification("Geçersiz adet!");return;}
      const cIndex = roomData.currentTurnIndex||0;
      const pId = roomData.playerOrder[cIndex];
      const pData = roomData.players[pId];
      const cd = roomData.countryData[selectedCountry];
      // Petrol üretimi 0 ise rafine kurmak mantıksız -> engelle
      if (!cd.oilProduction) {
        showNotification("Bu ülkede petrol üretim kapasitesi yok!");
        return;
      }
      const costM = 800*q; const costO=250*q;
      if (pData.money<costM) { showNotification("Yetersiz para!");return;}
      if (pData.petrol<costO) { showNotification("Yetersiz petrol!");return;}
      const updates = {};
      updates[`players/${pId}/money`] = pData.money-costM;
      updates[`players/${pId}/petrol`] = pData.petrol-costO;
      updates[`countryData/${selectedCountry}/refineries`] = (cd.refineries||0)+q;
      roomRef.update(updates);
      broadcastNotification(`${pData.name}, ${selectedCountry} ülkesine ${q} rafine kurdu.`);
      showNotification(`${q} rafine kurdunuz, petrol üretimi artacak.`);
    }

    function buildGrainmill() {
      if (!isMyTurn()) return;
      if (!selectedCountry) { showNotification("Ülke seçin!");return;}
      const q = parseInt(document.getElementById("grainmill-quantity").value);
      if (isNaN(q)||q<=0){ showNotification("Geçersiz adet!"); return;}
      const cIndex = roomData.currentTurnIndex||0;
      const pId=roomData.playerOrder[cIndex];
      const pData=roomData.players[pId];
      const cd=roomData.countryData[selectedCountry];
      if (!cd.wheatProduction) {
        showNotification("Bu ülkede buğday üretimi yok!");
        return;
      }
      const costM=200*q; const costO=100*q;
      if (pData.money<costM) { showNotification("Yetersiz para!"); return;}
      if (pData.petrol<costO){ showNotification("Yetersiz petrol!"); return;}
      const updates = {};
      updates[`players/${pId}/money`] = pData.money - costM;
      updates[`players/${pId}/petrol`] = pData.petrol - costO;
      updates[`countryData/${selectedCountry}/grainMills`] = (cd.grainMills||0)+q;
      roomRef.update(updates);
      broadcastNotification(`${pData.name}, ${selectedCountry} ülkesine ${q} değirmen kurdu.`);
      showNotification(`${q} değirmen kurdunuz, buğday üretimi artacak.`);
    }

    /********************************************************
     * 10) KAYNAK GÖNDERME
     ********************************************************/
    function updateResourceSelects() {
      const spMoney = document.getElementById("recipient-player");
      const spPetrol = document.getElementById("recipient-player-petrol");
      const spWheat = document.getElementById("recipient-player-wheat");
      [spMoney, spPetrol, spWheat].forEach(sel => sel.innerHTML="");
      if (!roomData || !roomData.playerOrder) return;
      roomData.playerOrder.forEach(pid => {
        const pName = roomData.players[pid].name;
        const o1 = new Option(pName, pid);
        const o2 = new Option(pName, pid);
        const o3 = new Option(pName, pid);
        spMoney.appendChild(o1);
        spPetrol.appendChild(o2);
        spWheat.appendChild(o3);
      });
    }

    function sendMoney() {
      if (!isMyTurn()) return;
      const amt = parseInt(document.getElementById("money-to-send").value);
      const recId = document.getElementById("recipient-player").value;
      if (isNaN(amt)||amt<=0) { showNotification("Geçerli miktar girin!");return;}
      if (recId===localPlayerId) { showNotification("Kendinize gönderemezsiniz!");return;}
      const cIndex=roomData.currentTurnIndex||0;
      const pId=roomData.playerOrder[cIndex];
      const pd=roomData.players[pId];
      if (pd.money<amt) { showNotification("Yetersiz paranız var!");return;}
      const updates={};
      updates[`players/${pId}/money`] = pd.money-amt;
      updates[`players/${recId}/money`] = (roomData.players[recId].money||0)+amt;
      roomRef.update(updates);
      broadcastNotification(`${pd.name} -> ${roomData.players[recId].name} : ${amt}$ gönderildi.`);
      showNotification(`${amt}$ gönderdiniz.`);
    }

    function sendPetrol() {
      if (!isMyTurn()) return;
      const amt = parseInt(document.getElementById("petrol-to-send").value);
      const recId = document.getElementById("recipient-player-petrol").value;
      if (isNaN(amt)||amt<=0){ showNotification("Geçerli miktar girin!");return;}
      if (recId===localPlayerId){ showNotification("Kendinize gönderemezsiniz!");return;}
      const cIndex=roomData.currentTurnIndex||0;
      const pId=roomData.playerOrder[cIndex];
      const pd=roomData.players[pId];
      if (pd.petrol<amt){ showNotification("Yetersiz petrol!");return;}
      const updates={};
      updates[`players/${pId}/petrol`] = pd.petrol-amt;
      updates[`players/${recId}/petrol`] = (roomData.players[recId].petrol||0)+amt;
      roomRef.update(updates);
      broadcastNotification(`${pd.name} -> ${roomData.players[recId].name} : ${amt} varil petrol gönderildi.`);
      showNotification(`${amt} varil petrol gönderdiniz.`);
    }

    function sendWheat() {
      if (!isMyTurn()) return;
      const amt = parseInt(document.getElementById("wheat-to-send").value);
      const recId = document.getElementById("recipient-player-wheat").value;
      if (isNaN(amt)||amt<=0){ showNotification("Geçerli miktar girin!");return;}
      if (recId===localPlayerId){ showNotification("Kendinize gönderemezsiniz!");return;}
      const cIndex=roomData.currentTurnIndex||0;
      const pId=roomData.playerOrder[cIndex];
      const pd=roomData.players[pId];
      if (pd.wheat<amt){ showNotification("Yetersiz buğday!");return;}
      const updates={};
      updates[`players/${pId}/wheat`] = pd.wheat-amt;
      updates[`players/${recId}/wheat`] = (roomData.players[recId].wheat||0)+amt;
      roomRef.update(updates);
      broadcastNotification(`${pd.name} -> ${roomData.players[recId].name} : ${amt} buğday gönderildi.`);
      showNotification(`${amt} buğday gönderdiniz.`);
    }

    /********************************************************
     * 11) TUR SONU İŞLEMİ (Gelir, Üretim, vb.)
     ********************************************************/
    function nextTurn() {
      if (!isMyTurn()) { showNotification("Sıra sizde değil!"); return; }
      const cIndex = roomData.currentTurnIndex||0;
      const pId = roomData.playerOrder[cIndex];
      const pData = roomData.players[pId];
      const updates={};

      // Gelir/üretim toplama
      if (pData.countries && roomData.countryData) {
        let totalMoney=0, totalOil=0, totalWheat=0;
        pData.countries.forEach(cName=>{
          const cd=roomData.countryData[cName];
          if (cd) {
            // Kışla -> +5 asker
            if (cd.barracksCount>0) {
              updates[`countryData/${cName}/soldiers`] = (cd.soldiers||0)+(cd.barracksCount*5);
            }
            // Fabrika -> +%20
            let eIncome = cd.income||0;
            if (cd.factories>0) eIncome = Math.floor(eIncome*(1+0.2*cd.factories));
            totalMoney += eIncome;

            // Rafine -> +%15
            let eOil = cd.oilProduction||0;
            if (cd.refineries>0) eOil = Math.floor(eOil*(1+0.15*cd.refineries));
            totalOil += eOil;

            // Değirmen -> +%20
            let eWheat = cd.wheatProduction||0;
            if (cd.grainMills>0) eWheat = Math.floor(eWheat*(1+0.2*cd.grainMills));
            totalWheat += eWheat;
          }
        });
        updates[`players/${pId}/money`] = pData.money + totalMoney;
        updates[`players/${pId}/petrol`] = pData.petrol + totalOil;
        updates[`players/${pId}/wheat`] = pData.wheat + totalWheat;
      }

      // Tur döngüsü
      let newIndex = cIndex+1;
      if (newIndex>=roomData.playerOrder.length) {
        newIndex=0;
        updates["round"] = (roomData.round||1)+1;
      }
      updates["currentTurnIndex"] = newIndex;
      roomRef.update(updates);
      // Bildirim
      const nextP = roomData.playerOrder[newIndex];
      broadcastNotification(`Sıra ${roomData.players[nextP].name} adlı oyuncuya geçti.`);
    }

    /********************************************************
     * 12) PAKT (Saldırmazlık)
     ********************************************************/
    function updatePactRecipientSelect() {
      const sel = document.getElementById("pact-recipient");
      sel.innerHTML="";
      if (!roomData||!roomData.playerOrder) return;
      roomData.playerOrder.forEach(pid=>{
        if (pid!==localPlayerId) {
          const op = new Option(roomData.players[pid].name, pid);
          sel.appendChild(op);
        }
      });
    }

    function sendPactOffer() {
      if (!isMyTurn()) { showNotification("Sıra sizde değil!"); return; }
      const turns = parseInt(document.getElementById("pact-turns").value);
      const cost = parseInt(document.getElementById("pact-cost").value);
      const rec = document.getElementById("pact-recipient").value;
      if (isNaN(turns)||turns<=0||isNaN(cost)||cost<=0) {
        showNotification("Geçerli tur & ücret girin!");
        return;
      }
      if (!rec||rec===localPlayerId) {
        showNotification("Geçerli alıcı seçin!");
        return;
      }
      const cIndex=roomData.currentTurnIndex||0;
      const pId=roomData.playerOrder[cIndex];
      const pd=roomData.players[pId];
      if (pd.money<cost) {
        showNotification("Bu teklifi yapmak için yeterli paranız yok!");
        return;
      }
      const pactRef = roomRef.child("pactOffers").push();
      const newOffer={
        offerId: pactRef.key,
        senderId: pId,
        senderName: pd.name,
        recipientId: rec,
        turns: turns,
        cost: cost,
        status: "pending",
        createdRound: roomData.round || 1
      };
      pactRef.set(newOffer);
      const chatMessage={
        sender:"Sistem",
        senderId:"system",
        text:`${pd.name} -> ${roomData.players[rec].name} : Saldırmazlık Pakti Teklifi (${turns} tur, ${cost}$)`,
        recipientId:"",
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.child("chat").push(chatMessage);
      broadcastNotification(`${pd.name}, ${roomData.players[rec].name} oyuncusuna pakt teklifi gönderdi.`);
      showNotification("Pakt teklifi gönderildi.");
    }

    function displayPendingPactOffers() {
      const listDiv = document.getElementById("pact-offers-list");
      if (!listDiv) return;
      listDiv.innerHTML="";
      if (!roomData||!roomData.pactOffers) return;
      let hasOffer=false;
      Object.values(roomData.pactOffers).forEach(off=>{
        if (off.recipientId===localPlayerId && off.status==="pending") {
          hasOffer=true;
          const div=document.createElement("div");
          div.className="pact-offer-item";
          div.innerHTML=`
            <p><strong>${off.senderName}</strong> -> ${off.turns} tur boyunca, ${off.cost}$ karşılığında pakt teklifi yaptı.</p>
            <button class="accept-btn">Kabul</button>
            <button class="reject-btn">Reddet</button>
          `;
          div.querySelector(".accept-btn").addEventListener("click", ()=>acceptPactOffer(off.offerId));
          div.querySelector(".reject-btn").addEventListener("click", ()=>rejectPactOffer(off.offerId));
          listDiv.appendChild(div);
        }
      });
      document.getElementById("pact-offers-container").style.display = hasOffer?"block":"none";
    }

    function acceptPactOffer(offerId) {
      const off = roomData.pactOffers[offerId];
      if (!off||off.status!=="pending") return;
      const curRound = roomData.round||1;
      const endRound = curRound + off.turns -1;
      const sData=roomData.players[off.senderId];
      const rData=roomData.players[off.recipientId];
      if (sData.money<off.cost) {
        showNotification("Teklifi yapanın parası kalmamış! Teklif geçersiz.");
        roomRef.child("pactOffers/"+offerId).update({status:"rejected"});
        return;
      }
      const updates={};
      updates[`pactOffers/${offerId}/status`]="accepted";
      updates[`players/${off.senderId}/money`]=sData.money-off.cost;
      updates[`players/${off.recipientId}/money`]=rData.money+off.cost;
      if (!roomData.pacts) updates["pacts"]={};
      updates[`pacts/${offerId}`]={
        players:[off.senderId, off.recipientId],
        endRound: endRound
      };
      roomRef.update(updates);
      broadcastNotification(`Pakt kabul: ${sData.name} & ${rData.name} (${off.turns} tur)`);
      showNotification("Pakt teklifi kabul edildi!");
    }

    function rejectPactOffer(offerId) {
      const off=roomData.pactOffers[offerId];
      if (!off||off.status!=="pending") return;
      roomRef.child(`pactOffers/${offerId}`).update({status:"rejected"});
      broadcastNotification(`Pakt reddedildi: ${off.senderName} -> ${roomData.players[off.recipientId].name}`);
      showNotification("Teklif reddedildi.");
    }

    /********************************************************
     * 13) CHAT SİSTEMİ
     ********************************************************/
    function toggleChat(show) {
      const cPop=document.getElementById("chat-popup");
      cPop.style.display=show?"flex":"none";
      chatOpen=show;
      if (chatOpen) {
        unreadMessages=0;
        updateChatBadge();
      }
    }
    function appendChatMessage(msg) {
      // Özel mesaj ise, sadece alıcı ve gönderen görsün
      if (msg.recipientId && msg.recipientId!=="" && msg.recipientId!==localPlayerId && msg.senderId!==localPlayerId) {
        return;
      }
      const cDiv=document.getElementById("chat-messages");
      const line=document.createElement("div");
      if (msg.recipientId && msg.recipientId!=="") {
        // private
        const targetName= (roomData.players[msg.recipientId]||{}).name||"Bilinmeyen";
        if (msg.senderId===localPlayerId) {
          line.innerHTML=`<strong>[PM to ${targetName}]:</strong> ${msg.text}`;
        } else {
          line.innerHTML=`<strong>[PM from ${msg.sender}]:</strong> ${msg.text}`;
        }
        line.style.color="#f39c12";
      } else {
        // public
        line.textContent=`${msg.sender}: ${msg.text}`;
      }
      cDiv.appendChild(line);
      cDiv.scrollTop=cDiv.scrollHeight;
      if (!chatOpen && msg.senderId!==localPlayerId) {
        unreadMessages++;
        updateChatBadge();
      }
    }
    function updateChatBadge() {
      const btn=document.getElementById("open-chat-btn");
      if (unreadMessages>0) btn.dataset.badge=unreadMessages;
      else btn.dataset.badge="";
    }

    function sendChatMessage() {
      if (!roomRef) return;
      const input=document.getElementById("chat-input");
      const txt=input.value.trim();
      if (!txt) return;
      let senderName="Anon";
      if (roomData && roomData.players && roomData.players[localPlayerId]) {
        senderName= roomData.players[localPlayerId].name;
      }
      const newMsg={
        sender: senderName,
        senderId: localPlayerId,
        text: txt,
        recipientId:"",
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.child("chat").push(newMsg);
      input.value="";
    }

    function sendPrivateMessage() {
      const pmInput=document.getElementById("private-message-input");
      const pmRec=document.getElementById("private-message-recipient").value;
      const txt=pmInput.value.trim();
      if (!txt||!pmRec) return;
      let sName="Anon";
      if (roomData&&roomData.players&&roomData.players[localPlayerId]) {
        sName=roomData.players[localPlayerId].name;
      }
      const pm={
        sender:sName,
        senderId:localPlayerId,
        text:txt,
        recipientId:pmRec,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      roomRef.child("chat").push(pm);
      pmInput.value="";
      showNotification("Özel mesaj gönderildi!");
    }

    function updatePrivateMessageRecipientSelect() {
      const sel=document.getElementById("private-message-recipient");
      sel.innerHTML="";
      if (!roomData||!roomData.playerOrder) return;
      roomData.playerOrder.forEach(pid=>{
        if (pid!==localPlayerId) {
          const o=new Option(roomData.players[pid].name, pid);
          sel.appendChild(o);
        }
      });
    }

    /********************************************************
     * 14) TİCARET (MARKET) SİSTEMİ
     ********************************************************/
    function updateTradeCountrySelect() {
      const sel=document.getElementById("trade-country");
      sel.innerHTML="";
      if (!roomData||!roomData.players||!roomData.players[localPlayerId]) return;
      const myC=roomData.players[localPlayerId].countries||[];
      myC.forEach(cName=>{
        const op=new Option(cName,cName);
        sel.appendChild(op);
      });
    }
    function updateEmbargoPlayersSelect() {
      const sel=document.getElementById("embargo-players");
      sel.innerHTML="";
      if (!roomData||!roomData.playerOrder) return;
      roomData.playerOrder.forEach(pid=>{
        if (pid!==localPlayerId) {
          const o=new Option(roomData.players[pid].name, pid);
          sel.appendChild(o);
        }
      });
    }

    document.getElementById("trade-item-type").addEventListener("change", e=>{
      const val=e.target.value;
      const tradeCountry=document.getElementById("trade-country");
      if (val==="petrol"||val==="wheat") {
        tradeCountry.style.display="none";
      } else {
        tradeCountry.style.display="block";
      }
    });

    function createTradeOffer() {
      if (!roomData||!roomData.players[localPlayerId]) return;
      const itemType=document.getElementById("trade-item-type").value;
      const qty=parseInt(document.getElementById("trade-quantity").value);
      const price=parseInt(document.getElementById("trade-price").value);
      let cName=null;
      if (["barracks","factory","refinery","grainmill"].includes(itemType)) {
        cName=document.getElementById("trade-country").value;
      }
      if (isNaN(qty)||qty<=0||isNaN(price)||price<=0) {
        showNotification("Geçerli adet/fiyat girin!");
        return;
      }
      // Satıcının elinde var mı?
      const seller=roomData.players[localPlayerId];
      let enough=false;
      if (itemType==="petrol") {
        if (seller.petrol>=qty) enough=true;
      } else if (itemType==="wheat") {
        if (seller.wheat>=qty) enough=true;
      } else {
        // bina
        if (!cName) { showNotification("Ülke seçin!");return;}
        const cd=roomData.countryData[cName];
        if (!cd||cd.owner!==localPlayerId) { showNotification("Ülke size ait değil!");return;}
        if (itemType==="barracks"&&cd.barracksCount>=qty) enough=true;
        else if (itemType==="factory"&&cd.factories>=qty) enough=true;
        else if (itemType==="refinery"&&cd.refineries>=qty) enough=true;
        else if (itemType==="grainmill"&&cd.grainMills>=qty) enough=true;
      }
      if (!enough) {
        showNotification("Satacak yeterli miktar yok!");
        return;
      }
      // Ambargo
      const embSel=document.getElementById("embargo-players");
      let embList=[];
      for(let i=0; i<embSel.options.length;i++){
        if (embSel.options[i].selected) {
          embList.push(embSel.options[i].value);
        }
      }
      const toRef=roomRef.child("tradeOffers").push();
      const newOffer={
        offerId: toRef.key,
        sellerId: localPlayerId,
        sellerName: seller.name,
        itemType: itemType,
        countryName: cName||null,
        quantity: qty,
        price: price,
        status: "pending",
        embargo: embList
      };
      toRef.set(newOffer);
      broadcastNotification(`${seller.name}, ticaret teklifi oluşturdu (${itemType}, adet:${qty}, fiyat:${price}$).`);
      showNotification("Ticaret teklifi oluşturuldu.");
    }

    function displayTradeOffers() {
      const list=document.getElementById("trade-offers-list");
      if (!list) return;
      list.innerHTML="";
      if (!roomData||!roomData.tradeOffers) return;
      Object.values(roomData.tradeOffers).forEach(off=>{
        if (off.status==="pending") {
          const d=document.createElement("div");
          d.className="offer-item";
          let label="";
          switch(off.itemType) {
            case "petrol": label="Petrol";break;
            case "barracks": label="Kışla";break;
            case "factory": label="Fabrika";break;
            case "refinery": label="Rafine";break;
            case "grainmill": label="Değirmen";break;
            case "wheat": label="Buğday";break;
          }
          let html=`
            <p><strong>Satıcı:</strong> ${off.sellerName}</p>
            <p><strong>Ürün:</strong> ${label}</p>
            <p><strong>Miktar:</strong> ${off.quantity}</p>
            <p><strong>Birim Fiyat:</strong> ${off.price}$</p>
          `;
          if (off.countryName) html+=`<p><strong>Ülke:</strong> ${off.countryName}</p>`;
          if (off.embargo&&off.embargo.length>0) {
            let names=off.embargo.map(e=>roomData.players[e]?.name||"?").join(", ");
            html+=`<p style="color:red;">Ambargo: ${names}</p>`;
          }
          // Satın al / iptal
          if (off.sellerId!==localPlayerId) {
            // Ambargo check
            if (off.embargo&&off.embargo.includes(localPlayerId)) {
              html+=`<p style="color:red;">Ambargo nedeniyle satın alamazsınız.</p>`;
            } else {
              html+=`
                <input type="number" class="partial-buy-quantity" placeholder="Alınacak miktar" min="1" max="${off.quantity}" />
                <button class="partial-buy-btn">Satın Al</button>
              `;
            }
          } else {
            // iptal
            html+=`<button class="cancel-offer-btn" style="background:linear-gradient(45deg,#c0392b,#e74c3c);">İptal</button>`;
          }
          d.innerHTML=html;
          // events
          const buyBtn=d.querySelector(".partial-buy-btn");
          if (buyBtn) {
            buyBtn.addEventListener("click", ()=>{
              const input=d.querySelector(".partial-buy-quantity");
              const amt=parseInt(input.value);
              if (isNaN(amt)||amt<=0) { showNotification("Geçerli miktar girin!");return;}
              acceptTradeOffer(off.offerId, amt);
            });
          }
          const cancelBtn=d.querySelector(".cancel-offer-btn");
          if (cancelBtn) {
            cancelBtn.addEventListener("click", ()=>cancelTradeOffer(off.offerId));
          }
          list.appendChild(d);
        }
      });
    }

    function acceptTradeOffer(offerId, buyAmount) {
      const off=roomData.tradeOffers[offerId];
      if (!off||off.status!=="pending") { showNotification("Teklif geçerli değil!");return;}
      const seller=roomData.players[off.sellerId];
      const buyer=roomData.players[localPlayerId];
      if (!seller||!buyer) { showNotification("Geçersiz satıcı/alıcı!");return;}
      if (buyAmount>off.quantity) {
        showNotification("Teklifte o kadar miktar yok!");
        return;
      }
      const totalCost=off.price*buyAmount;
      if (buyer.money<totalCost) {
        showNotification("Yetersiz paranız var!");
        return;
      }
      let hasEnough=false;
      const updates={};

      if (off.itemType==="petrol") {
        if (seller.petrol>=buyAmount) {
          hasEnough=true;
          updates[`players/${off.sellerId}/petrol`]=seller.petrol-buyAmount;
          updates[`players/${localPlayerId}/petrol`]=buyer.petrol+buyAmount;
        }
      } else if (off.itemType==="wheat") {
        if (seller.wheat>=buyAmount) {
          hasEnough=true;
          updates[`players/${off.sellerId}/wheat`]=seller.wheat-buyAmount;
          updates[`players/${localPlayerId}/wheat`]=buyer.wheat+buyAmount;
        }
      } else {
        // bina
        const c=roomData.countryData[off.countryName];
        if (!c||c.owner!==off.sellerId) {
          showNotification("Satıcının bu ülke üzerinde hakkı yok!");
          return;
        }
        if (off.itemType==="barracks" && c.barracksCount>=buyAmount) {
          hasEnough=true;
          updates[`countryData/${off.countryName}/barracksCount`]=c.barracksCount-buyAmount;
        }
        else if (off.itemType==="factory" && c.factories>=buyAmount) {
          hasEnough=true;
          updates[`countryData/${off.countryName}/factories`]=c.factories-buyAmount;
        }
        else if (off.itemType==="refinery" && c.refineries>=buyAmount) {
          hasEnough=true;
          updates[`countryData/${off.countryName}/refineries`]=c.refineries-buyAmount;
        }
        else if (off.itemType==="grainmill" && c.grainMills>=buyAmount) {
          hasEnough=true;
          updates[`countryData/${off.countryName}/grainMills`]=c.grainMills-buyAmount;
        }
      }
      if (!hasEnough) {
        showNotification("Satıcının yeterli miktarı kalmamış!");
        return;
      }
      // Para
      updates[`players/${localPlayerId}/money`]=buyer.money-totalCost;
      updates[`players/${off.sellerId}/money`]=seller.money+totalCost;
      // Teklif güncelle
      let newQty=off.quantity-buyAmount;
      if (newQty<=0) {
        updates[`tradeOffers/${offerId}/status`]="completed";
      }
      updates[`tradeOffers/${offerId}/quantity`]=newQty;
      roomRef.update(updates, err=>{
        if (!err) {
          broadcastNotification(`Ticaret: ${seller.name} -> ${buyer.name} (${buyAmount} adet "${off.itemType}")`);
          showNotification("Ticaret başarıyla yapıldı.");
        }
      });
    }

    function cancelTradeOffer(offerId) {
      const off=roomData.tradeOffers[offerId];
      if (!off) return;
      if (off.sellerId!==localPlayerId) {
        showNotification("Kendi teklifinizi iptal edebilirsiniz.");
        return;
      }
      if (off.status!=="pending") {
        showNotification("Bu teklif zaten tamamlanmış/iptal edilmiş.");
        return;
      }
      roomRef.child("tradeOffers").child(offerId).update({status:"cancelled"});
      broadcastNotification("Ticaret teklifi iptal edildi: "+off.sellerName);
      showNotification("Teklif iptal edildi.");
    }

    /********************************************************
     * 15) EVENTLER
     ********************************************************/
    // Asker
    document.getElementById("attack-btn").addEventListener("click", attack);
    document.getElementById("buy-soldiers-btn").addEventListener("click", buySoldiers);
    document.getElementById("pull-soldiers-btn").addEventListener("click", pullSoldiers);

    // Bina
    document.getElementById("buy-barracks-btn").addEventListener("click", buyBarracks);
    document.getElementById("build-factory-btn").addEventListener("click", buildFactory);
    document.getElementById("build-refinery-btn").addEventListener("click", buildRefinery);
    document.getElementById("build-grainmill-btn").addEventListener("click", buildGrainmill);

    // Kaynak Gönder
    document.getElementById("send-money-btn").addEventListener("click", sendMoney);
    document.getElementById("send-petrol-btn").addEventListener("click", sendPetrol);
    document.getElementById("send-wheat-btn").addEventListener("click", sendWheat);

    // Tur Sonu
    document.getElementById("end-turn-btn").addEventListener("click", nextTurn);

    // Odadan Çık
    document.getElementById("exit-room-btn").addEventListener("click", ()=>{
      localStorage.removeItem("roomCode");
      document.getElementById("lobby-container").style.display="block";
      document.getElementById("game-container").style.display="none";
    });

    // Players Popup
    document.getElementById("open-players-btn").addEventListener("click", ()=>{
      popupStates.players=!popupStates.players;
      const pPop=document.getElementById("players-popup");
      pPop.style.display=popupStates.players?"flex":"none";
    });
    document.getElementById("players-popup-header").addEventListener("click", e=>{
      if (e.target.id==="players-popup-header") {
        popupStates.players=false;
        document.getElementById("players-popup").style.display="none";
      }
    });
    document.getElementById("close-players-btn").addEventListener("click", ()=>{
      popupStates.players=false;
      document.getElementById("players-popup").style.display="none";
    });

    // Military Popup
    document.getElementById("open-military-btn").addEventListener("click", ()=>{
      popupStates.military=!popupStates.military;
      const mp=document.getElementById("military-popup");
      mp.style.display=popupStates.military?"flex":"none";
    });
    document.getElementById("close-military-btn").addEventListener("click", ()=>{
      popupStates.military=false;
      document.getElementById("military-popup").style.display="none";
    });

    // Building Popup
    document.getElementById("open-building-btn").addEventListener("click", ()=>{
      popupStates.building=!popupStates.building;
      document.getElementById("building-popup").style.display=popupStates.building?"flex":"none";
    });
    document.getElementById("close-building-btn").addEventListener("click", ()=>{
      popupStates.building=false;
      document.getElementById("building-popup").style.display="none";
    });

    // Resource Popup
    document.getElementById("open-resource-btn").addEventListener("click", ()=>{
      popupStates.resource=!popupStates.resource;
      document.getElementById("resource-popup").style.display=popupStates.resource?"flex":"none";
    });
    document.getElementById("close-resource-btn").addEventListener("click", ()=>{
      popupStates.resource=false;
      document.getElementById("resource-popup").style.display="none";
    });

    // Pact Popup
    document.getElementById("open-pact-btn").addEventListener("click", ()=>{
      popupStates.pact=!popupStates.pact;
      document.getElementById("pact-popup").style.display=popupStates.pact?"flex":"none";
    });
    document.getElementById("close-pact-btn").addEventListener("click", ()=>{
      popupStates.pact=false;
      document.getElementById("pact-popup").style.display="none";
    });
    document.getElementById("send-pact-btn").addEventListener("click", sendPactOffer);

    // Market Popup
    document.getElementById("open-market-btn").addEventListener("click", ()=>{
      popupStates.market=!popupStates.market;
      document.getElementById("market-popup").style.display=popupStates.market?"flex":"none";
    });
    document.getElementById("close-market-btn").addEventListener("click", ()=>{
      popupStates.market=false;
      document.getElementById("market-popup").style.display="none";
    });
    document.getElementById("create-trade-offer-btn").addEventListener("click", createTradeOffer);

    // Chat Popup
    document.getElementById("open-chat-btn").addEventListener("click", ()=>{
      popupStates.chat=!popupStates.chat;
      toggleChat(popupStates.chat);
    });
    document.getElementById("chat-popup-header").addEventListener("click", e=>{
      if (e.target.id==="chat-popup-header") {
        popupStates.chat=false;
        toggleChat(false);
      }
    });
    document.getElementById("close-chat-btn").addEventListener("click", ()=>{
      popupStates.chat=false;
      toggleChat(false);
    });
    document.getElementById("send-chat-btn").addEventListener("click", sendChatMessage);
    document.getElementById("chat-input").addEventListener("keypress", e=>{
      if (e.key==="Enter") sendChatMessage();
    });
    document.getElementById("send-private-message-btn").addEventListener("click", sendPrivateMessage);
  </script>
</body>
</html>
