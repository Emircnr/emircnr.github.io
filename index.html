<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <title>Global Conquest – 3D Düzen</title>
    <!-- Cesium CSS & JS -->
    <link
      href="https://cesium.com/downloads/cesiumjs/releases/1.100/Build/Cesium/Widgets/widgets.css"
      rel="stylesheet"
    />
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.100/Build/Cesium/Cesium.js"></script>
    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-papN9oC+R+sQw6wct+eZaJbI3s7ZyU3xgK0z0p6+0v+9G84T7F6wXw/h4Z5K5N5ZtnH4hGTZZdLq4z7pV+I1/A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      /* Genel Reset & Temel Stiller */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: 'Arial', sans-serif;
        background: #111;
        color: #eee;
        overflow-x: hidden;
      }
      a {
        text-decoration: none;
        color: inherit;
      }
      /* Lobi & Oyun Panelleri – Modern Glassmorphism */
      .panel {
        background: rgba(20, 20, 20, 0.8);
        backdrop-filter: blur(6px);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
        margin: 20px auto;
        max-width: 500px;
      }
      h1,
      h2,
      h3 {
        text-align: center;
        margin-bottom: 15px;
        color: #1abc9c;
      }
      input,
      select,
      button {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: none;
        border-radius: 6px;
        font-size: 16px;
      }
      input:focus,
      select:focus {
        outline: none;
        box-shadow: 0 0 10px #1abc9c;
      }
      button {
        background: linear-gradient(45deg, #16a085, #1abc9c);
        color: #fff;
        cursor: pointer;
        transition: transform 0.3s, background 0.3s;
      }
      button:hover {
        transform: scale(1.02);
        background: linear-gradient(45deg, #1abc9c, #16a085);
      }
      .color-options {
        text-align: center;
        margin-bottom: 10px;
      }
      .global-color-option {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        border: 2px solid transparent;
        cursor: pointer;
        display: inline-block;
        margin: 0 5px;
        transition: transform 0.3s, border-color 0.3s;
      }
      .global-color-option:hover {
        transform: scale(1.2);
        border-color: #fff;
      }
      .global-color-option.selected {
        border-color: #f1c40f;
      }
      /* Oyun ekranı */
      #game-container {
        display: none;
        height: 100vh;
        position: relative;
      }
      /* 3D Harita Konteyneri (Cesium) */
      #map {
        width: 100%;
        height: 100%;
      }
      /* Üst Bilgi Barı */
      #top-info {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 8px;
        z-index: 3000;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      #top-info p {
        font-size: 16px;
      }
      #top-info p span {
        font-weight: bold;
        color: #f39c12;
      }
      /* Alt ikon butonları */
      #bottom-icons {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 3000;
      }
      .bottom-icon-btn {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(45deg, #16a085, #1abc9c);
        color: #fff;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        transition: transform 0.3s, background 0.3s;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }
      .bottom-icon-btn:hover {
        transform: scale(1.05);
        background: linear-gradient(45deg, #1abc9c, #16a085);
      }
      .bottom-icon-btn[data-badge]:after {
        content: attr(data-badge);
        position: absolute;
        top: -5px;
        right: -5px;
        background: red;
        color: white;
        border-radius: 50%;
        min-width: 20px;
        min-height: 20px;
        padding: 2px 6px;
        font-size: 12px;
        text-align: center;
      }
      /* Genel Popup stili */
      .modern-popup {
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 450px;
        max-height: 70vh;
        background: rgba(20, 20, 20, 0.85);
        backdrop-filter: blur(8px);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        display: none;
        flex-direction: column;
        z-index: 3002;
        animation: fadeInPopup 0.5s ease forwards;
      }
      @keyframes fadeInPopup {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .popup-header {
        background: linear-gradient(45deg, #2c3e50, #34495e);
        padding: 15px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 18px;
        cursor: pointer;
      }
      .popup-header button {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
      }
      .popup-content {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        color: #eee;
        font-size: 15px;
      }
      /* Mobil uyum */
      @media screen and (max-width: 768px) {
        .panel {
          width: 90%;
          padding: 15px;
        }
        #top-info {
          flex-direction: column;
          gap: 5px;
        }
        .modern-popup {
          width: 90% !important;
          right: 5% !important;
          left: auto !important;
          bottom: 90px;
        }
      }
    </style>
  </head>
  <body class="lobby">
    <!-- Lobi: Oda Oluşturma & Katılma -->
    <div id="lobby-container" class="panel">
      <h1>GLOBAL CONQUEST</h1>
      <!-- Oda Oluşturma -->
      <div id="create-room-section">
        <h2>Oda Oluştur</h2>
        <input type="text" id="creator-player-name" placeholder="Adınız" />
        <div class="color-options" id="creator-color-options"></div>
        <input
          type="number"
          id="max-players"
          placeholder="Oyuncu Sayısı (2-8)"
          min="2"
          max="8"
        />
        <button id="create-room-btn">Oda Oluştur</button>
      </div>
      <hr />
      <!-- Odaya Katılma -->
      <div id="join-room-section">
        <h2>Odaya Katıl</h2>
        <input type="text" id="join-player-name" placeholder="Adınız" />
        <div class="color-options" id="join-color-options"></div>
        <input
          type="text"
          id="room-code"
          placeholder="Oda Kodu (Örn: AB12CD)"
        />
        <button id="join-room-btn">Odaya Katıl</button>
      </div>
    </div>

    <!-- Bildirim Alanı -->
    <div id="notification-area"></div>

    <!-- Bildirim (Zil) Paneli – (Kaldırıldı, sadece ikon gösteriliyor) -->
    <div id="notifications-container">
      <button id="notifications-bell">
        <i class="fas fa-bell"></i>
      </button>
    </div>

    <!-- Oyun Ekranı -->
    <div id="game-container">
      <!-- Üst Bilgi -->
      <div id="top-info">
        <p>
          Oda Kodu: <span id="display-room-code">-</span> | Tur:
          <span id="current-round">1</span> | Sıra:
          <span id="current-player">Oyuncu Adı</span>
        </p>
        <button id="end-turn-btn">
          <i class="fas fa-forward"></i> Tur Sonu
          <span id="turn-timer">60s</span>
        </button>
        <button id="start-game-btn">Oyunu Başlat</button>
        <span id="start-countdown">30</span>
      </div>
      <!-- 3D Harita (Cesium) -->
      <div id="map"></div>
      <!-- Odadan Çık Butonu -->
      <button id="exit-room-btn">Odadan Çık</button>
      <!-- Alt İkonlar -->
      <div id="bottom-icons">
        <button id="open-players-btn" class="bottom-icon-btn" title="Oyuncular">
          <i class="fas fa-users"></i>
        </button>
        <button
          id="open-military-btn"
          class="bottom-icon-btn"
          title="Asker İşlemleri"
        >
          <i class="fas fa-shield-alt"></i>
        </button>
        <button
          id="open-building-btn"
          class="bottom-icon-btn"
          title="Bina Kurma"
        >
          <i class="fas fa-building"></i>
        </button>
        <button
          id="open-resource-btn"
          class="bottom-icon-btn"
          title="Kaynak Gönderme"
        >
          <i class="fas fa-hand-holding-usd"></i>
        </button>
        <!-- Ticaret Merkezi: Fabrika satışı kaldırıldı, sadece petrol ve buğday ticareti -->
        <button
          id="open-market-btn"
          class="bottom-icon-btn"
          data-badge=""
          title="Ticaret Merkezi"
        >
          <i class="fas fa-store"></i>
        </button>
        <button id="open-pact-btn" class="bottom-icon-btn" title="Saldırmazlık Pakti">
          <i class="fas fa-handshake"></i>
        </button>
        <button
          id="open-chat-btn"
          class="bottom-icon-btn"
          data-badge=""
          title="Sohbet"
        >
          <i class="fas fa-comments"></i>
        </button>
      </div>
    </div>

    <!-- MODERN POPUP/PANEL ÖRNEKLERİ (Asker İşlemleri, Bina Kurma, Kaynak Gönderme, Oyuncular, Chat, Pakt, Ticaret) -->
    <!-- Asker İşlemleri Popup -->
    <div id="military-popup" class="modern-popup">
      <div class="popup-header" id="military-popup-header">
        <span>Asker İşlemleri</span>
        <button id="close-military-btn">&times;</button>
      </div>
      <div class="popup-content">
        <h3>Saldırı (Sadece Sırada)</h3>
        <input
          type="number"
          id="attack-soldiers"
          placeholder="Asker sayısı"
          min="1"
        />
        <button id="attack-btn">
          <i class="fas fa-crosshairs"></i> Saldırı Yap
        </button>
        <h3>Asker Satın Alma (Her Zaman)</h3>
        <p style="font-size:14px; color:#ccc;">(1 Asker = 10$ + 25 Buğday)</p>
        <input
          type="number"
          id="soldiers-to-buy"
          placeholder="Adet"
          min="1"
        />
        <button id="buy-soldiers-btn">
          <i class="fas fa-user-plus"></i> Satın Al
        </button>
        <h3>Asker Çekme</h3>
        <input
          type="number"
          id="pull-soldiers-count"
          placeholder="Asker sayısı"
          min="1"
        />
        <button id="pull-soldiers-btn">
          <i class="fas fa-running"></i> Asker Çek
        </button>
        <h3>Askeri Destek Gönderme</h3>
        <p style="font-size:14px; color:#ccc;">
          Seçilen oyuncunun ülkesine asker desteği
        </p>
        <select id="support-recipient"></select>
        <select id="support-recipient-country"></select>
        <input
          type="number"
          id="support-soldiers"
          placeholder="Asker sayısı"
          min="1"
        />
        <button id="send-support-btn">
          <i class="fas fa-hands-helping"></i> Destek Gönder
        </button>
      </div>
    </div>

    <!-- Bina Kurma Popup -->
    <div id="building-popup" class="modern-popup">
      <div class="popup-header" id="building-popup-header">
        <span>Bina Kurma</span>
        <button id="close-building-btn">&times;</button>
      </div>
      <div class="popup-content">
        <h3>Kışla Kur (Her Zaman)</h3>
        <p style="font-size:14px; color:#ccc;">
          (1 Kışla = 300$ + 50 varil petrol + 120 Buğday)
        </p>
        <input
          type="number"
          id="barracks-quantity"
          placeholder="Adet"
          min="1"
        />
        <button id="buy-barracks-btn">
          <i class="fas fa-fort-awesome"></i> Kışla Kur
        </button>
        <h3>Fabrika Kur (Her Zaman)</h3>
        <p style="font-size:14px; color:#ccc;">
          (1 Fabrika = 500$ + 100 varil petrol)
        </p>
        <input
          type="number"
          id="factory-quantity"
          placeholder="Adet"
          min="1"
        />
        <button id="build-factory-btn">
          <i class="fas fa-industry"></i> Fabrika Kur
        </button>
        <h3>Rafine Kur (Her Zaman)</h3>
        <input
          type="number"
          id="refinery-quantity"
          placeholder="Adet (800$ + 250 varil/adet)"
          min="1"
        />
        <button id="build-refinery-btn">
          <i class="fas fa-oil-can"></i> Rafine Kur
        </button>
        <h3>Değirmen Kur (Her Zaman)</h3>
        <p style="font-size:14px; color:#ccc;">(1 Değirmen = 200$ + 100 varil petrol)</p>
        <input
          type="number"
          id="grainmill-quantity"
          placeholder="Adet"
          min="1"
        />
        <button id="build-grainmill-btn">
          <i class="fas fa-wheat-awn"></i> Değirmen Kur
        </button>
      </div>
    </div>

    <!-- Kaynak Gönderme Popup -->
    <div id="resource-popup" class="modern-popup">
      <div class="popup-header" id="resource-popup-header">
        <span>Kaynak Gönderme</span>
        <button id="close-resource-btn">&times;</button>
      </div>
      <div class="popup-content">
        <h3>Para Gönder</h3>
        <input
          type="number"
          id="money-to-send"
          placeholder="Miktar ($)"
          min="1"
        />
        <select id="recipient-player"></select>
        <button id="send-money-btn">
          <i class="fas fa-hand-holding-usd"></i> Gönder
        </button>
        <h3>Petrol Gönder</h3>
        <input
          type="number"
          id="petrol-to-send"
          placeholder="Varil"
          min="1"
        />
        <select id="recipient-player-petrol"></select>
        <button id="send-petrol-btn">
          <i class="fas fa-gas-pump"></i> Gönder
        </button>
        <h3>Buğday Gönder</h3>
        <input
          type="number"
          id="wheat-to-send"
          placeholder="Buğday"
          min="1"
        />
        <select id="recipient-player-wheat"></select>
        <button id="send-wheat-btn">
          <i class="fas fa-wheat-awn"></i> Gönder
        </button>
      </div>
    </div>

    <!-- Oyuncular Popup -->
    <div id="players-popup" class="modern-popup">
      <div class="popup-header" id="players-popup-header">
        <span>Oyuncu Bilgileri</span>
        <button id="close-players-btn">&times;</button>
      </div>
      <div class="popup-content" id="players-info">
        <!-- Oyuncu listesi dinamik olarak buraya eklenecek -->
      </div>
    </div>

    <!-- Chat Popup -->
    <div id="chat-popup" class="modern-popup" style="display: none; flex-direction: column;">
      <div class="popup-header" id="chat-popup-header">
        <span>Sohbet</span>
        <button id="close-chat-btn">&times;</button>
      </div>
      <div id="chat-messages" style="flex:1; padding:15px; overflow-y:auto; background: rgba(0,0,0,0.3); color:#eee;"></div>
      <div style="display: flex; border-top: 1px solid #444;">
        <input type="text" id="chat-input" placeholder="Mesajınızı yazın..." style="flex:1; padding:15px; border:none; outline:none; background:#1e1e2f; color:#eee; font-size:15px;" />
        <button id="send-chat-btn" style="padding:15px; background: linear-gradient(45deg, #16a085, #1abc9c); border:none; color:#fff; font-size:18px;">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
      <div style="border-top: 1px solid #444; background: rgba(0,0,0,0.4); padding:15px; display: flex; flex-direction: column; gap:10px;">
        <h4>Özel Mesaj</h4>
        <select id="private-message-recipient"></select>
        <input type="text" id="private-message-input" placeholder="Özel mesajınız..." />
        <button id="send-private-message-btn">
          <i class="fas fa-user-secret"></i> Gönder
        </button>
      </div>
    </div>

    <!-- Saldırmazlık Pakti Popup -->
    <div id="pact-popup" class="modern-popup">
      <div class="popup-header" id="pact-popup-header">
        <span>Saldırmazlık Pakti</span>
        <button id="close-pact-btn">&times;</button>
      </div>
      <div class="popup-content">
        <h3>Yeni Pakt Teklifi Gönder</h3>
        <select id="pact-offer-recipient"></select>
        <input type="number" id="pact-duration" placeholder="Tur sayısı (örn: 3)" />
        <input type="number" id="pact-cost" placeholder="Tek seferlik para ($)" />
        <button id="send-pact-offer-btn" style="margin-bottom:15px;">Teklif Gönder</button>
        <h3>Gelen Teklifler</h3>
        <div id="pact-pending-offers"></div>
        <div style="margin-top:15px;">
          <h3>Aktif Paktlarım</h3>
          <div id="pact-active-list"></div>
        </div>
      </div>
    </div>

    <!-- Ticaret Popup (Fabrika seçeneği kaldırıldı, yalnızca petrol ve buğday) -->
    <div id="market-popup" class="modern-popup">
      <div class="popup-header" id="market-popup-header">
        <h2>Ticaret Merkezi</h2>
        <button id="close-market-btn">&times;</button>
      </div>
      <div class="popup-content">
        <div class="market-section">
          <h3>Yeni Teklif Oluştur</h3>
          <label style="font-size:14px;color:#ccc;">Satmak istediğiniz ürün:</label><br />
          <select id="trade-item-type">
            <option value="petrol">Petrol</option>
            <option value="wheat">Buğday</option>
          </select>
          <br /><br />
          <label style="font-size:14px;color:#ccc;">Miktar (varil/buğday):</label>
          <input type="number" id="trade-quantity" placeholder="Miktar" min="1" />
          <label style="font-size:14px;color:#ccc;">Birim Fiyat ($):</label>
          <input type="number" id="trade-price" placeholder="Birim Fiyat" min="1" />
          <label style="font-size:14px;color:#ccc;">Ambargo (Oyuncular):</label><br />
          <select id="embargo-players" multiple style="width:100%;min-height:50px;"></select>
          <small style="color:#ccc;">(Seçtiğiniz oyuncular bu teklifi satın alamaz)</small>
          <br /><br />
          <button id="create-trade-offer-btn" style="font-size:15px;">
            Teklifi Oluştur
          </button>
        </div>
        <div class="market-section offer-list">
          <h3>Mevcut Teklifler</h3>
          <div id="trade-offers-list"></div>
        </div>
      </div>
    </div>

    <!-- Firebase & Diğer JS Kütüphaneleri -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
      /*****************************************************************
       * Firebase Başlatma
       *****************************************************************/
      const firebaseConfig = {
        apiKey: "AIzaSyCINihMNGs-qRYIIBLzXyeaLnM_Lhp-iwg",
        authDomain: "warmapg-77acb.firebaseapp.com",
        databaseURL: "https://warmapg-77acb-default-rtdb.firebaseio.com",
        projectId: "warmapg-77acb",
        storageBucket: "warmapg-77acb.appspot.com",
        messagingSenderId: "895613631339",
        appId: "1:895613631339:web:a7ecc0cfd8ab3ae7e02a2e",
        measurementId: "G-6SJVLLVDCF"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      /*****************************************************************
       * GLOBAL DEĞİŞKENLER ve Yardımcı Fonksiyonlar
       *****************************************************************/
      let localPlayerId = null;
      let currentRoomCode = null;
      let roomRef = null;
      let roomData = null;
      let selectedCountry = null;
      // 8 adet renk seçeneği
      const availableColors = [
        "red",
        "blue",
        "green",
        "yellow",
        "purple",
        "orange",
        "brown",
        "pink"
      ];
      let localPlayerColor = null;
      let chatListenerAdded = false;
      let infoCardsPermanent = false;
      let unreadMessages = 0;
      let chatOpen = false;
      let persistentNotifications = [];
      const popupStates = {
        military: false,
        building: false,
        resource: false,
        players: false,
        chat: false,
        pact: false,
        market: false
      };
      let turnTimeRemaining = 60;
      let turnTimerInterval = null;
      let startInterval = null;

      // Cesium global değişkenleri
      let viewer = null;
      let geoJsonDataSource = null;

      /*****************************************************************
       * Bildirim Fonksiyonları
       *****************************************************************/
      function showNotification(message, duration = 3000) {
        const nArea = document.getElementById("notification-area");
        if (!nArea) return;
        const item = document.createElement("div");
        item.className = "notification-item";
        item.style.background = "rgba(0,0,0,0.8)";
        item.style.color = "#fff";
        item.style.padding = "10px 15px";
        item.style.borderRadius = "6px";
        item.style.marginBottom = "10px";
        item.textContent = message;
        nArea.appendChild(item);
        setTimeout(() => {
          if (nArea.contains(item)) nArea.removeChild(item);
        }, duration + 800);
      }

      function broadcastNotification(text) {
        if (!roomRef) return;
        roomRef.child("notifications").push({
          text: text,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }

      function displayGlobalNotification(text) {
        showNotification(text, 6500);
        persistentNotifications.push(text);
      }

      function generateRoomCode() {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let code = "";
        for (let i = 0; i < 6; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
      }

      function hasActivePact(playerA, playerB) {
        if (!roomData || !roomData.pacts) return false;
        for (let pactId in roomData.pacts) {
          const pact = roomData.pacts[pactId];
          if (pact.active && (roomData.round || 1) <= pact.expirationRound) {
            if (
              (pact.playerA === playerA && pact.playerB === playerB) ||
              (pact.playerA === playerB && pact.playerB === playerA)
            ) {
              return true;
            }
          }
        }
        return false;
      }

      function autoReconnect() {
        const savedRoomCode = localStorage.getItem("roomCode");
        if (savedRoomCode) {
          const refCheck = db.ref("rooms/" + savedRoomCode);
          refCheck.once("value", (snapshot) => {
            if (!snapshot.exists()) return;
            const savedRoomData = snapshot.val();
            if (!savedRoomData.players || !savedRoomData.players[localPlayerId])
              return;
            currentRoomCode = savedRoomCode;
            roomRef = refCheck;
            joinRoomAndListen();
            document.body.classList.remove("lobby");
            document.getElementById("lobby-container").style.display = "none";
            document.getElementById("game-container").style.display = "block";
            document.getElementById("display-room-code").textContent =
              savedRoomCode;
          });
        }
      }

      function isMyTurn() {
        if (!roomData || !roomData.playerOrder) return false;
        if (roomData.gameState !== "started") return false;
        const currentTurnIndex = roomData.currentTurnIndex || 0;
        return roomData.playerOrder[currentTurnIndex] === localPlayerId;
      }

      /*****************************************************************
       * 60 Saniye Sayaç Fonksiyonları
       *****************************************************************/
      function startTurnTimer() {
        const timerEl = document.getElementById("turn-timer");
        turnTimeRemaining = 60;
        if (turnTimerInterval) clearInterval(turnTimerInterval);
        timerEl.textContent = turnTimeRemaining + "s";
        turnTimerInterval = setInterval(() => {
          turnTimeRemaining--;
          if (turnTimeRemaining <= 0) {
            clearInterval(turnTimerInterval);
            turnTimeRemaining = 0;
            timerEl.textContent = "0s";
            if (roomData && roomData.gameState === "started" && isMyTurn()) {
              nextTurn(true);
            }
          } else {
            timerEl.textContent = turnTimeRemaining + "s";
          }
        }, 1000);
      }

      function stopTurnTimer() {
        if (turnTimerInterval) clearInterval(turnTimerInterval);
        const timerEl = document.getElementById("turn-timer");
        if (timerEl) timerEl.textContent = "60s";
      }

      /*****************************************************************
       * DOMContentLoaded – Lobi & Otomatik Bağlanma
       *****************************************************************/
      document.addEventListener("DOMContentLoaded", () => {
        if (!localStorage.getItem("playerId")) {
          localStorage.setItem(
            "playerId",
            Math.random().toString(36).substr(2, 9)
          );
        }
        localPlayerId = localStorage.getItem("playerId");

        // Renk butonları (Oda Oluştur)
        const creatorColorDiv = document.getElementById("creator-color-options");
        availableColors.forEach((color) => {
          const btn = document.createElement("button");
          btn.className = "global-color-option";
          btn.style.background = color;
          btn.dataset.color = color;
          btn.addEventListener("click", function () {
            creatorColorDiv
              .querySelectorAll(".global-color-option")
              .forEach((s) => s.classList.remove("selected"));
            btn.classList.add("selected");
            localPlayerColor = color;
          });
          creatorColorDiv.appendChild(btn);
        });

        // Renk butonları (Odaya Katıl)
        const joinColorDiv = document.getElementById("join-color-options");
        availableColors.forEach((color) => {
          const btn = document.createElement("button");
          btn.className = "global-color-option";
          btn.style.background = color;
          btn.dataset.color = color;
          btn.addEventListener("click", function () {
            joinColorDiv
              .querySelectorAll(".global-color-option")
              .forEach((s) => s.classList.remove("selected"));
            btn.classList.add("selected");
            localPlayerColor = color;
          });
          joinColorDiv.appendChild(btn);
        });

        // Oda Oluşturma
        document.getElementById("create-room-btn").addEventListener("click", () => {
          const playerName = document
            .getElementById("creator-player-name")
            .value.trim();
          const maxPlayers = parseInt(document.getElementById("max-players").value);
          if (!playerName) {
            showNotification("Lütfen adınızı girin!");
            return;
          }
          if (!localPlayerColor) {
            showNotification("Lütfen bir renk seçin!");
            return;
          }
          if (isNaN(maxPlayers) || maxPlayers < 2 || maxPlayers > 8) {
            showNotification("Oyuncu sayısı 2 ile 8 arasında olmalıdır!");
            return;
          }
          const roomCode = generateRoomCode();
          currentRoomCode = roomCode;
          roomRef = db.ref("rooms/" + roomCode);
          const newRoomData = {
            roomCode: roomCode,
            maxPlayers: maxPlayers,
            gameState: "waiting",
            currentTurnIndex: 0,
            round: 1,
            playerOrder: [localPlayerId],
            players: {},
            countryData: {},
            createdAt: firebase.database.ServerValue.TIMESTAMP
          };
          newRoomData.players[localPlayerId] = {
            name: playerName,
            color: localPlayerColor,
            money: 1000,
            soldiers: 0,
            countries: [],
            petrol: 0,
            wheat: 400,
            joinedAt: firebase.database.ServerValue.TIMESTAMP,
            isHost: true
          };
          roomRef.set(newRoomData, (error) => {
            if (error) {
              showNotification("Oda oluşturulurken hata oluştu!");
            } else {
              showNotification("Oda oluşturuldu. Oda Kodu: " + roomCode);
              localStorage.setItem("roomCode", roomCode);
              loadAndInitializeGeoJson();
              joinRoomAndListen();
              document.body.classList.remove("lobby");
              document.getElementById("lobby-container").style.display = "none";
              document.getElementById("game-container").style.display = "block";
              document.getElementById("display-room-code").textContent = roomCode;
            }
          });
        });

        // Odaya Katılma
        document.getElementById("join-room-btn").addEventListener("click", () => {
          const playerName = document
            .getElementById("join-player-name")
            .value.trim();
          const roomCodeInput = document
            .getElementById("room-code")
            .value.trim()
            .toUpperCase();
          if (!playerName) {
            showNotification("Lütfen adınızı girin!");
            return;
          }
          if (!localPlayerColor) {
            showNotification("Lütfen bir renk seçin!");
            return;
          }
          if (!roomCodeInput) {
            showNotification("Lütfen oda kodu girin!");
            return;
          }
          currentRoomCode = roomCodeInput;
          roomRef = db.ref("rooms/" + roomCodeInput);
          roomRef.once("value", (snapshot) => {
            if (!snapshot.exists()) {
              showNotification("Böyle bir oda bulunamadı!");
              return;
            }
            const room = snapshot.val();
            if (room.gameState !== "waiting") {
              showNotification("Oyun zaten başladı veya başlamak üzere!");
              return;
            }
            const playerCount = Object.keys(room.players || {}).length;
            if (playerCount >= room.maxPlayers) {
              showNotification("Oda dolu!");
              return;
            }
            const updates = {};
            updates["players/" + localPlayerId] = {
              name: playerName,
              color: localPlayerColor,
              money: 1000,
              soldiers: 0,
              countries: [],
              petrol: 0,
              wheat: 400,
              joinedAt: firebase.database.ServerValue.TIMESTAMP,
              isHost: false
            };
            if (!room.playerOrder) room.playerOrder = [];
            room.playerOrder.push(localPlayerId);
            updates["playerOrder"] = room.playerOrder;
            roomRef.update(updates, (error) => {
              if (error) {
                showNotification("Odaya katılırken hata oluştu!");
              } else {
                showNotification("Odaya katıldınız!");
                localStorage.setItem("roomCode", roomCodeInput);
                joinRoomAndListen();
                document.body.classList.remove("lobby");
                document.getElementById("lobby-container").style.display = "none";
                document.getElementById("game-container").style.display = "block";
                document.getElementById("display-room-code").textContent = roomCodeInput;
              }
            });
          });
        });

        autoReconnect();

        // Bilgi kartları toggle
        const toggleInfoButton = document.getElementById("toggle-info-cards");
        // (Cesium’de tooltip kalıcılığı için ek fonksiyon kullanılıyor)
      });

      /*****************************************************************
       * GeoJSON ve Ülke Verilerini Yükleme (Sadece Oda Kurucusu)
       *****************************************************************/
      function loadAndInitializeGeoJson() {
        // Eğer ülke verileri henüz yüklenmemişse, cesium ile 3D harita üzerinde yükle
        fetch("https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
          .then((response) => response.json())
          .then((geoJsonData) => {
            // Her ülkeye bir _index ekleyelim (rastgele üretim kapasitesi için)
            geoJsonData.features.forEach((feature, idx) => {
              feature.properties._index = idx;
            });
            // Başlangıç ülke verileri
            const countryDataInit = {};
            geoJsonData.features.forEach((feature) => {
              const countryName = feature.properties.name;
              // Rastgele üretim değerleri
              countryDataInit[countryName] = {
                income: Math.floor(Math.random() * 500) + 100,
                soldiers: 0,
                owner: null,
                barracksCount: 0,
                factories: 0,
                refineries: 0,
                oilProduction: Math.floor(Math.random() * (500 - 150 + 1)) + 150,
                wheatProduction: Math.floor(Math.random() * (700 - 200 + 1)) + 200,
                grainMills: 0,
                supporters: {}
              };
            });
            roomRef.child("countryData").set(countryDataInit);
            // Cesium haritasını yükle
            initializeMap(geoJsonData);
          });
      }

      /*****************************************************************
       * Cesium ile 3D Haritanın Kurulumu ve Güncellenmesi
       *****************************************************************/
      function initializeMap(geoJsonData) {
        if (viewer) return;
        viewer = new Cesium.Viewer("map", {
          terrainProvider: Cesium.createWorldTerrain(),
          animation: false,
          timeline: false,
          baseLayerPicker: false
        });
        // GeoJSON verisini yükleyip dataSource olarak ekleyin
        Cesium.GeoJsonDataSource.load(geoJsonData, {
          clampToGround: true
        }).then(function (dataSource) {
          geoJsonDataSource = dataSource;
          viewer.dataSources.add(dataSource);
          viewer.zoomTo(dataSource);
          // Her ülke için stil ve tooltip ayarı
          dataSource.entities.values.forEach((entity) => {
            const countryName = entity.properties.name.getValue();
            // İlk renk: sahipsiz ise gri
            entity.polygon.material = Cesium.Color.fromCssColorString("#ccc").withAlpha(0.7);
            entity.description = getCountryPopupContent(countryName, {});
          });
        });
        // Tıklamayla ülke seçimi
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(function (movement) {
          const pickedObject = viewer.scene.pick(movement.position);
          if (
            Cesium.defined(pickedObject) &&
            Cesium.defined(pickedObject.id) &&
            pickedObject.id.properties &&
            pickedObject.id.properties.name
          ) {
            const countryName = pickedObject.id.properties.name.getValue();
            selectedCountry = countryName;
            showNotification("Seçilen ülke: " + countryName, 1500);
          }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
      }

      /*****************************************************************
       * Oda Verilerini Dinleme & UI Güncelleme
       *****************************************************************/
      function joinRoomAndListen() {
        if (!roomRef) return;
        roomRef.on("value", (snapshot) => {
          roomData = snapshot.val();
          updateGameUI();
          displayPendingPactOffers();
          displayTradeOffers();
          updateActivePactsList();
        });
        if (!chatListenerAdded) {
          roomRef.child("chat").on("child_added", (snapshot) => {
            const message = snapshot.val();
            appendChatMessage(message);
          });
          roomRef.child("notifications").on("child_added", (snap) => {
            const data = snap.val();
            if (data && data.text) {
              displayGlobalNotification(data.text);
            }
          });
          chatListenerAdded = true;
        }
      }

      function updateGameUI() {
        if (!roomData) return;
        document.getElementById("current-round").textContent = roomData.round || 1;
        if (roomData.playerOrder && roomData.players) {
          const currentTurnIndex = roomData.currentTurnIndex || 0;
          const currentPlayerId = roomData.playerOrder[currentTurnIndex];
          if (roomData.players[currentPlayerId]) {
            document.getElementById("current-player").textContent =
              roomData.players[currentPlayerId].name;
          }
        }
        handleGameState(roomData.gameState);
        // Oyuncu Listesi Güncelleme
        const playersInfoDiv = document.getElementById("players-info");
        if (playersInfoDiv) {
          playersInfoDiv.innerHTML = "";
          if (roomData.playerOrder) {
            roomData.playerOrder.forEach((pid) => {
              if (roomData.players[pid]) {
                const player = roomData.players[pid];
                const playerDiv = document.createElement("div");
                playerDiv.className = "player-info";
                playerDiv.id = "player-info-" + pid;
                playerDiv.innerHTML =
                  "<p><strong>" +
                  player.name +
                  "</strong></p>" +
                  "<p>Para: <span>" +
                  player.money +
                  "</span>$</p>" +
                  "<p>Asker: <span>" +
                  player.soldiers +
                  "</span></p>" +
                  "<p>Ülkeler: <span>" +
                  ((player.countries && player.countries.length) || 0) +
                  "</span></p>" +
                  "<p>Petrol: <span>" +
                  player.petrol +
                  "</span> varil</p>" +
                  "<p>Buğday: <span>" +
                  player.wheat +
                  "</span></p>";
                playersInfoDiv.appendChild(playerDiv);
              }
            });
          }
        }
        // Harita Güncellemesi: Cesium üzerinden ülkelerin stillerini güncelleyin
        if (viewer && geoJsonDataSource && roomData.countryData) {
          geoJsonDataSource.entities.values.forEach((entity) => {
            const countryName = entity.properties.name.getValue();
            const country = roomData.countryData[countryName];
            if (country) {
              if (country.owner && roomData.players && roomData.players[country.owner]) {
                entity.polygon.material = Cesium.Color.fromCssColorString(
                  roomData.players[country.owner].color || "#ccc"
                ).withAlpha(0.7);
              } else {
                entity.polygon.material = Cesium.Color.fromCssColorString("#ccc").withAlpha(0.7);
              }
              entity.description = getCountryPopupContent(countryName, country);
            }
          });
        }
        updateRecipientSelects();
        updatePactRecipientSelect();
        updatePrivateMessageRecipientSelect();
        updateEmbargoPlayersSelect();
        updateSupportRecipientSelect();
        if (roomData.gameState === "started") {
          if (isMyTurn()) startTurnTimer();
          else stopTurnTimer();
        } else {
          stopTurnTimer();
        }
      }

      function handleGameState(state) {
        const startBtn = document.getElementById("start-game-btn");
        const countdownSpan = document.getElementById("start-countdown");
        if (!state) return;
        if (state === "waiting") {
          if (roomData.players[localPlayerId] && roomData.players[localPlayerId].isHost)
            startBtn.style.display = "block";
          else startBtn.style.display = "none";
          countdownSpan.style.display = "none";
        } else if (state === "starting") {
          startBtn.style.display = "none";
          countdownSpan.style.display = "inline";
          startCountdownListener();
        } else if (state === "started") {
          startBtn.style.display = "none";
          countdownSpan.style.display = "none";
          clearInterval(startInterval);
          startInterval = null;
        }
      }

      document.getElementById("start-game-btn").addEventListener("click", () => {
        if (!roomData || !roomData.players[localPlayerId].isHost) return;
        if (roomData.gameState !== "waiting") return;
        const now = Date.now();
        const startTime = now + 30000;
        roomRef.update({
          gameState: "starting",
          startTime: startTime
        });
      });

      function startCountdownListener() {
        if (!roomData || !roomData.startTime) return;
        const countdownSpan = document.getElementById("start-countdown");
        if (startInterval) clearInterval(startInterval);
        startInterval = setInterval(() => {
          if (!roomData) return;
          const now = Date.now();
          const diff = roomData.startTime - now;
          if (diff <= 0) {
            clearInterval(startInterval);
            startInterval = null;
            roomRef.update({ gameState: "started" });
            return;
          }
          const secondsLeft = Math.floor(diff / 1000);
          countdownSpan.textContent = secondsLeft;
        }, 1000);
      }

      function getCountryPopupContent(countryName, country) {
        if (!country) country = {};
        const ownerText =
          country.owner && roomData && roomData.players && roomData.players[country.owner]
            ? roomData.players[country.owner].name
            : "Yok";
        let effectiveIncome = country.income || 0;
        if (country.factories) {
          effectiveIncome = Math.floor(effectiveIncome * (1 + 0.20 * country.factories));
        }
        const effectiveOil = country.oilProduction
          ? Math.floor(country.oilProduction * (1 + 0.15 * (country.refineries || 0)))
          : 0;
        const effectiveWheat = country.wheatProduction
          ? Math.floor(country.wheatProduction * (1 + 0.20 * (country.grainMills || 0)))
          : 0;
        return (
          "<div class='country-popup'>" +
          "<p><i class='fas fa-money-bill-wave'></i> Gelir: $" + effectiveIncome + "</p>" +
          "<p><i class='fas fa-users'></i> Asker: " + (country.soldiers || 0) + "</p>" +
          "<p><i class='fas fa-fort-awesome'></i> Kışla: " + (country.barracksCount || 0) + "</p>" +
          "<p><i class='fas fa-industry'></i> Fabrika: " + (country.factories || 0) + "</p>" +
          "<p><i class='fas fa-oil-can'></i> Rafine: " + (country.refineries || 0) + "</p>" +
          "<p><i class='fas fa-oil-can'></i> Petrol Üretimi: " + effectiveOil + " varil</p>" +
          "<p><i class='fas fa-wheat-awn'></i> Değirmen: " + (country.grainMills || 0) + "</p>" +
          "<p><i class='fas fa-wheat-awn'></i> Buğday Üretimi: " + effectiveWheat + "</p>" +
          "<p><i class='fas fa-crown'></i> Sahip: " + ownerText + "</p>" +
          "</div>"
        );
      }

      function updateRecipientSelects() {
        const moneySelect = document.getElementById("recipient-player");
        const petrolSelect = document.getElementById("recipient-player-petrol");
        const wheatSelect = document.getElementById("recipient-player-wheat");
        if (!moneySelect || !petrolSelect || !wheatSelect) return;
        moneySelect.innerHTML = "";
        petrolSelect.innerHTML = "";
        wheatSelect.innerHTML = "";
        if (roomData && roomData.playerOrder) {
          roomData.playerOrder.forEach((pid) => {
            if (roomData.players[pid]) {
              const option1 = document.createElement("option");
              option1.value = pid;
              option1.textContent = roomData.players[pid].name;
              moneySelect.appendChild(option1);
              const option2 = document.createElement("option");
              option2.value = pid;
              option2.textContent = roomData.players[pid].name;
              petrolSelect.appendChild(option2);
              const option3 = document.createElement("option");
              option3.value = pid;
              option3.textContent = roomData.players[pid].name;
              wheatSelect.appendChild(option3);
            }
          });
        }
      }

      function updatePrivateMessageRecipientSelect() {
        const privateSelect = document.getElementById("private-message-recipient");
        if (!privateSelect) return;
        privateSelect.innerHTML = "";
        if (roomData && roomData.playerOrder) {
          roomData.playerOrder.forEach((pid) => {
            if (pid !== localPlayerId && roomData.players[pid]) {
              const option = document.createElement("option");
              option.value = pid;
              option.textContent = roomData.players[pid].name;
              privateSelect.appendChild(option);
            }
          });
        }
      }

      function updateEmbargoPlayersSelect() {
        const embargoSelect = document.getElementById("embargo-players");
        if (!embargoSelect) return;
        embargoSelect.innerHTML = "";
        if (roomData && roomData.playerOrder) {
          roomData.playerOrder.forEach((pid) => {
            if (pid !== localPlayerId && roomData.players[pid]) {
              const option = document.createElement("option");
              option.value = pid;
              option.textContent = roomData.players[pid].name;
              embargoSelect.appendChild(option);
            }
          });
        }
      }

      function updateSupportRecipientSelect() {
        const supportRecipient = document.getElementById("support-recipient");
        const supportRecipientCountry = document.getElementById("support-recipient-country");
        if (!supportRecipient || !supportRecipientCountry) return;
        supportRecipient.innerHTML = "";
        supportRecipientCountry.innerHTML = "<option value=''>--Ülke Seç--</option>";
        if (roomData && roomData.playerOrder) {
          roomData.playerOrder.forEach((pid) => {
            if (pid !== localPlayerId && roomData.players[pid]) {
              const option = document.createElement("option");
              option.value = pid;
              option.textContent = roomData.players[pid].name;
              supportRecipient.appendChild(option);
            }
          });
          if (roomData.countryData) {
            Object.keys(roomData.countryData).forEach((cName) => {
              const op = document.createElement("option");
              op.value = cName;
              op.textContent = cName;
              supportRecipientCountry.appendChild(op);
            });
          }
        }
      }

      function updatePactRecipientSelect() {
        const pactRecipientSelect = document.getElementById("pact-offer-recipient");
        if (!pactRecipientSelect) return;
        pactRecipientSelect.innerHTML = "";
        if (roomData && roomData.playerOrder) {
          roomData.playerOrder.forEach((pid) => {
            if (pid !== localPlayerId && roomData.players[pid]) {
              const option = document.createElement("option");
              option.value = pid;
              option.textContent = roomData.players[pid].name;
              pactRecipientSelect.appendChild(option);
            }
          });
        }
      }

      /*****************************************************************
       * SALDIRMAZLIK PAKTI İŞLEMLERİ
       *****************************************************************/
      document.getElementById("send-pact-offer-btn").addEventListener("click", () => {
        if (!isMyTurn()) {
          showNotification("Saldırmazlık paktı teklifini sadece kendi sıranızda gönderebilirsiniz!");
          return;
        }
        const recipient = document.getElementById("pact-offer-recipient").value;
        const duration = parseInt(document.getElementById("pact-duration").value);
        const cost = parseInt(document.getElementById("pact-cost").value);
        if (!recipient || recipient === localPlayerId) {
          showNotification("Lütfen geçerli bir oyuncu seçin!");
          return;
        }
        if (isNaN(duration) || duration <= 0) {
          showNotification("Geçerli tur sayısı girin!");
          return;
        }
        if (isNaN(cost) || cost < 0) {
          showNotification("Geçerli bir para miktarı girin!");
          return;
        }
        if (hasActivePact(localPlayerId, recipient)) {
          showNotification("Bu oyuncuyla zaten aktif bir saldırmazlık paktınız var!");
          return;
        }
        const senderData = roomData.players[localPlayerId];
        if (!senderData) return;
        const pactOfferRef = roomRef.child("pactOffers").push();
        const newOffer = {
          offerId: pactOfferRef.key,
          senderId: localPlayerId,
          senderName: senderData.name,
          recipientId: recipient,
          duration: duration,
          cost: cost,
          status: "pending"
        };
        pactOfferRef.set(newOffer);
        broadcastNotification(
          "Saldırmazlık Paktı Teklifi: " +
            senderData.name +
            " → " +
            roomData.players[recipient].name +
            " (Tur: " +
            duration +
            ", Para: " +
            cost +
            "$)"
        );
        showNotification("Pakt teklifi gönderildi!");
      });

      function displayPendingPactOffers() {
        const container = document.getElementById("pact-pending-offers");
        if (!container) return;
        container.innerHTML = "";
        if (!roomData || !roomData.pactOffers) return;
        Object.values(roomData.pactOffers).forEach((offer) => {
          if (offer.status === "pending" && offer.recipientId === localPlayerId) {
            const div = document.createElement("div");
            div.className = "pact-offer-item";
            div.setAttribute("data-offer-id", offer.offerId);
            div.innerHTML =
              "<p><strong>" + offer.senderName + "</strong> size saldırmazlık pakti teklif ediyor.</p>" +
              "<p>Tur sayısı: <strong>" + offer.duration + "</strong></p>" +
              "<p>Para talebi: <strong>" + offer.cost + "$</strong> (Gönderen ödeyecek, siz alacaksınız)</p>" +
              "<button class='accept-btn' data-offer-id='" + offer.offerId + "'>Kabul Et</button>" +
              "<button class='reject-btn' data-offer-id='" + offer.offerId + "'>Reddet</button>";
            container.appendChild(div);
          }
        });
      }

      document.getElementById("pact-pending-offers").addEventListener("click", function(e) {
        if (e.target.classList.contains("accept-btn")) {
          const offerId = e.target.getAttribute("data-offer-id");
          acceptPactOffer(offerId);
        } else if (e.target.classList.contains("reject-btn")) {
          const offerId = e.target.getAttribute("data-offer-id");
          rejectPactOffer(offerId);
        }
      });

      function acceptPactOffer(offerId) {
        const offer = roomData.pactOffers[offerId];
        if (!offer || offer.status !== "pending") return;
        if (hasActivePact(offer.senderId, offer.recipientId)) {
          showNotification("Bu oyuncuyla zaten aktif bir paktınız var!");
          roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
          return;
        }
        const sender = roomData.players[offer.senderId];
        const recipient = roomData.players[offer.recipientId];
        if (!sender || !recipient) {
          showNotification("Teklifteki oyuncular bulunamadı!");
          return;
        }
        if (sender.money < offer.cost) {
          showNotification("Teklifi gönderenin yeterli parası kalmamış! Teklif geçersiz.");
          roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
          return;
        }
        const expirationRound = (roomData.round || 1) + offer.duration;
        const pactId = db.ref().push().key;
        const updates = {};
        updates["pactOffers/" + offerId + "/status"] = "accepted";
        updates["players/" + offer.senderId + "/money"] = sender.money - offer.cost;
        updates["players/" + offer.recipientId + "/money"] = recipient.money + offer.cost;
        updates["pacts/" + pactId] = {
          playerA: offer.senderId,
          playerB: offer.recipientId,
          active: true,
          cost: offer.cost,
          duration: offer.duration,
          expirationRound: expirationRound
        };
        roomRef.update(updates);
        broadcastNotification(
          "Pakt Anlaşması: " +
            sender.name +
            " & " +
            recipient.name +
            " (" +
            offer.duration +
            " tur, " +
            offer.cost +
            "$)"
        );
        showNotification("Pakt teklifi kabul edildi!");
      }

      function rejectPactOffer(offerId) {
        const offer = roomData.pactOffers[offerId];
        if (!offer || offer.status !== "pending") return;
        roomRef.child("pactOffers").child(offerId).update({ status: "rejected" });
        broadcastNotification("Pakt Reddedildi: " + offer.senderName + " → Teklif reddedildi.");
        showNotification("Pakt teklifi reddedildi.");
      }

      function updateActivePactsList() {
        const container = document.getElementById("pact-active-list");
        if (!container) return;
        container.innerHTML = "";
        if (!roomData || !roomData.pacts) return;
        const currentRound = roomData.round || 1;
        Object.values(roomData.pacts).forEach((pact) => {
          if (pact.active && currentRound <= pact.expirationRound) {
            if (pact.playerA === localPlayerId || pact.playerB === localPlayerId) {
              const otherId = pact.playerA === localPlayerId ? pact.playerB : pact.playerA;
              const otherName = roomData.players[otherId]?.name || "???";
              const turnsLeft = pact.expirationRound - currentRound + 1;
              const div = document.createElement("div");
              div.textContent = "Pakt: " + otherName + ", kalan tur: " + turnsLeft;
              container.appendChild(div);
            }
          }
        });
      }

      /*****************************************************************
       * OYUN İŞLEVLERİ
       *****************************************************************/
      function attack() {
        if (!isMyTurn()) {
          showNotification("Sıranız değil!");
          return;
        }
        if (!selectedCountry) {
          showNotification("Bir ülke seçin!");
          return;
        }
        const soldiersToSend = parseInt(document.getElementById("attack-soldiers").value);
        if (isNaN(soldiersToSend) || soldiersToSend <= 0) {
          showNotification("Geçerli bir asker sayısı girin!");
          return;
        }
        const currentTurnIndex = roomData.currentTurnIndex || 0;
        const currentPlayerId = roomData.playerOrder[currentTurnIndex];
        const currentPlayerData = roomData.players[currentPlayerId];
        if (soldiersToSend > currentPlayerData.soldiers) {
          showNotification("Yeterli askeriniz yok!");
          return;
        }
        const target = roomData.countryData[selectedCountry];
        if (!target) return;
        if (roomData.round < 4) {
          if (target.owner) {
            showNotification("İlk 3 tur yalnızca sahipsiz topraklara saldırabilirsiniz!");
            return;
          }
        }
        if (target.owner && target.owner !== currentPlayerId) {
          if (hasActivePact(currentPlayerId, target.owner)) {
            showNotification("Bu oyuncuyla saldırmazlık paktınız var! Saldıramazsınız.");
            return;
          }
        }
        const updates = {};
        let attackResult = "";
        if (target.owner === currentPlayerId) {
          updates["countryData/" + selectedCountry + "/soldiers"] =
            target.soldiers + soldiersToSend;
          updates["players/" + currentPlayerId + "/soldiers"] =
            currentPlayerData.soldiers - soldiersToSend;
          attackResult = selectedCountry + " ülkesine " + soldiersToSend + " asker yerleştirildi.";
        } else {
          updates["players/" + currentPlayerId + "/soldiers"] =
            currentPlayerData.soldiers - soldiersToSend;
          if (soldiersToSend > target.soldiers) {
            const remaining = soldiersToSend - target.soldiers;
            updates["countryData/" + selectedCountry + "/soldiers"] = remaining;
            updates["countryData/" + selectedCountry + "/owner"] = currentPlayerId;
            updates["countryData/" + selectedCountry + "/supporters"] = {};
            let currentCountries = currentPlayerData.countries || [];
            if (!currentCountries.includes(selectedCountry)) {
              currentCountries.push(selectedCountry);
            }
            updates["players/" + currentPlayerId + "/countries"] = currentCountries;
            if (target.owner && roomData.players[target.owner]) {
              let defenderCountries = roomData.players[target.owner].countries || [];
              defenderCountries = defenderCountries.filter((c) => c !== selectedCountry);
              updates["players/" + target.owner + "/countries"] = defenderCountries;
            }
            attackResult = selectedCountry + " fethedildi! (" + soldiersToSend + " vs " + target.soldiers + ")";
          } else {
            updates["countryData/" + selectedCountry + "/soldiers"] =
              target.soldiers - soldiersToSend;
            attackResult = selectedCountry + " savunuldu! (" + soldiersToSend + " vs " + target.soldiers + ")";
          }
          nextTurn();
        }
        roomRef.update(updates);
        broadcastNotification("Saldırı: " + roomData.players[currentPlayerId].name + " → " + selectedCountry + ". " + attackResult);
        showNotification(attackResult);
      }

      function buySoldiers() {
        const count = parseInt(document.getElementById("soldiers-to-buy").value);
        if (isNaN(count) || count <= 0) {
          showNotification("Geçerli bir asker sayısı girin!");
          return;
        }
        const costMoney = 10 * count;
        const costWheat = 25 * count;
        const currentPlayerData = roomData.players[localPlayerId];
        if (currentPlayerData.money < costMoney) {
          showNotification("Yeterli paranız yok!");
          return;
        }
        if (currentPlayerData.wheat < costWheat) {
          showNotification("Yeterli buğdayınız yok!");
          return;
        }
        const updates = {};
        updates["players/" + localPlayerId + "/money"] = currentPlayerData.money - costMoney;
        updates["players/" + localPlayerId + "/wheat"] = currentPlayerData.wheat - costWheat;
        updates["players/" + localPlayerId + "/soldiers"] = currentPlayerData.soldiers + count;
        roomRef.update(updates);
        broadcastNotification(currentPlayerData.name + " " + count + " asker satın aldı.");
        showNotification(count + " asker satın alındı.");
      }

      function buyBarracks() {
        if (!selectedCountry) {
          showNotification("Bir ülke seçin!");
          return;
        }
        const quantity = parseInt(document.getElementById("barracks-quantity").value);
        if (isNaN(quantity) || quantity <= 0) {
          showNotification("Geçerli bir kışla adedi girin!");
          return;
        }
        const currentPlayerData = roomData.players[localPlayerId];
        const target = roomData.countryData[selectedCountry];
        if (target.owner !== localPlayerId) {
          showNotification("Bu ülke size ait değil!");
          return;
        }
        // Güncellenmiş kışla fiyatı: 300$ + 50 varil petrol + 120 buğday
        const totalMoney = 300 * quantity;
        const totalPetrol = 50 * quantity;
        const totalWheat = 120 * quantity;
        if (currentPlayerData.money < totalMoney) {
          showNotification("Yeterli paranız yok!");
          return;
        }
        if (currentPlayerData.petrol < totalPetrol) {
          showNotification("Yeterli petrolünüz yok!");
          return;
        }
        if (currentPlayerData.wheat < totalWheat) {
          showNotification("Yeterli buğdayınız yok!");
          return;
        }
        const updates = {};
        updates["players/" + localPlayerId + "/money"] = currentPlayerData.money - totalMoney;
        updates["players/" + localPlayerId + "/petrol"] = currentPlayerData.petrol - totalPetrol;
        updates["players/" + localPlayerId + "/wheat"] = currentPlayerData.wheat - totalWheat;
        updates["countryData/" + selectedCountry + "/barracksCount"] =
          (target.barracksCount || 0) + quantity;
        roomRef.update(updates);
        broadcastNotification(currentPlayerData.name + " " + quantity + " adet kışla kurdu (" + selectedCountry + ")");
        showNotification(quantity + " adet kışla kuruldu.");
      }

      function buildFactory() {
        if (!selectedCountry) {
          showNotification("Bir ülke seçin!");
          return;
        }
        const quantity = parseInt(document.getElementById("factory-quantity").value);
        if (isNaN(quantity) || quantity <= 0) {
          showNotification("Geçerli bir fabrika adedi girin!");
          return;
        }
        const currentPlayerData = roomData.players[localPlayerId];
        const target = roomData.countryData[selectedCountry];
        if (target.owner !== localPlayerId) {
          showNotification("Bu ülke size ait değil!");
          return;
        }
        const totalMoney = 500 * quantity;
        const totalPetrol = 100 * quantity;
        if (currentPlayerData.money < totalMoney) {
          showNotification("Yeterli paranız yok!");
          return;
        }
        if (currentPlayerData.petrol < totalPetrol) {
          showNotification("Yeterli petrolünüz yok!");
          return;
        }
        const updates = {};
        updates["players/" + localPlayerId + "/money"] = currentPlayerData.money - totalMoney;
        updates["players/" + localPlayerId + "/petrol"] = currentPlayerData.petrol - totalPetrol;
        updates["countryData/" + selectedCountry + "/factories"] = (target.factories || 0) + quantity;
        roomRef.update(updates);
        broadcastNotification(currentPlayerData.name + " " + quantity + " adet fabrika kurdu (" + selectedCountry + ")");
        showNotification(quantity + " adet fabrika kuruldu.");
      }

      function buildRefinery() {
        if (!selectedCountry) {
          showNotification("Bir ülke seçin!");
          return;
        }
        const quantity = parseInt(document.getElementById("refinery-quantity").value);
        if (isNaN(quantity) || quantity <= 0) {
          showNotification("Geçerli bir rafine adedi girin!");
          return;
        }
        const currentPlayerData = roomData.players[localPlayerId];
        const target = roomData.countryData[selectedCountry];
        if (!target.oilProduction) {
          showNotification("Bu ülkede petrol üretim kapasitesi yok!");
          return;
        }
        const totalMoney = 800 * quantity;
        const totalPetrol = 250 * quantity;
        if (currentPlayerData.money < totalMoney) {
          showNotification("Yeterli paranız yok!");
          return;
        }
        if (currentPlayerData.petrol < totalPetrol) {
          showNotification("Yeterli petrolünüz yok!");
          return;
        }
        const updates = {};
        updates["players/" + localPlayerId + "/money"] = currentPlayerData.money - totalMoney;
        updates["players/" + localPlayerId + "/petrol"] = currentPlayerData.petrol - totalPetrol;
        updates["countryData/" + selectedCountry + "/refineries"] = (target.refineries || 0) + quantity;
        roomRef.update(updates);
        broadcastNotification(currentPlayerData.name + " " + quantity + " adet rafine kurdu (" + selectedCountry + ")");
        showNotification(quantity + " adet rafine kuruldu. Üretim kapasitesi arttı.");
      }

      function buildGrainmill() {
        if (!selectedCountry) {
          showNotification("Bir ülke seçin!");
          return;
        }
        const quantity = parseInt(document.getElementById("grainmill-quantity").value);
        if (isNaN(quantity) || quantity <= 0) {
          showNotification("Geçerli bir değirmen adedi girin!");
          return;
        }
        const currentPlayerData = roomData.players[localPlayerId];
        const target = roomData.countryData[selectedCountry];
        if (!target.wheatProduction) {
          showNotification("Bu ülkede buğday üretim kapasitesi yok!");
          return;
        }
        const totalMoney = 200 * quantity;
        const totalPetrol = 100 * quantity;
        if (currentPlayerData.money < totalMoney) {
          showNotification("Yeterli paranız yok!");
          return;
        }
        if (currentPlayerData.petrol < totalPetrol) {
          showNotification("Yeterli petrolünüz yok!");
          return;
        }
        const updates = {};
        updates["players/" + localPlayerId + "/money"] = currentPlayerData.money - totalMoney;
        updates["players/" + localPlayerId + "/petrol"] = currentPlayerData.petrol - totalPetrol;
        updates["countryData/" + selectedCountry + "/grainMills"] = (target.grainMills || 0) + quantity;
        roomRef.update(updates);
        broadcastNotification(currentPlayerData.name + " " + quantity + " adet değirmen kurdu (" + selectedCountry + ")");
        showNotification(quantity + " adet değirmen kuruldu. Buğday üretimi arttı.");
      }

      function pullSoldiers() {
        if (!selectedCountry) {
          showNotification("Bir ülke seçin!");
          return;
        }
        const target = roomData.countryData[selectedCountry];
        if (!target) return;
        const count = parseInt(document.getElementById("pull-soldiers-count").value);
        if (isNaN(count) || count <= 0) {
          showNotification("Geçerli bir asker sayısı girin!");
          return;
        }
        const currentPlayerData = roomData.players[localPlayerId];
        if (!currentPlayerData) return;
        const updates = {};
        if (target.owner === localPlayerId) {
          let totalSupporters = 0;
          if (target.supporters) {
            for (let supId in target.supporters) {
              totalSupporters += target.supporters[supId];
            }
          }
          const occupantSoldiers = target.soldiers - totalSupporters;
          if (occupantSoldiers < count) {
            showNotification("Bu ülkede çekebileceğiniz kadar asker yok!");
            return;
          }
          updates["countryData/" + selectedCountry + "/soldiers"] = target.soldiers - count;
          updates["players/" + localPlayerId + "/soldiers"] = currentPlayerData.soldiers + count;
          broadcastNotification(currentPlayerData.name + " " + selectedCountry + " ülkesinden " + count + " asker çekti.");
        } else {
          const supportAmount = (target.supporters && target.supporters[localPlayerId]) || 0;
          if (supportAmount < count) {
            showNotification("Bu ülkede bu kadar destek askeriniz yok!");
            return;
          }
          if (target.soldiers < count) {
            showNotification("Veri tutarsızlığı: ülkedeki asker sayısı sorunlu!");
            return;
          }
          updates["countryData/" + selectedCountry + "/soldiers"] = target.soldiers - count;
          const newSup = supportAmount - count;
          if (newSup <= 0) {
            updates["countryData/" + selectedCountry + "/supporters/" + localPlayerId] = null;
          } else {
            updates["countryData/" + selectedCountry + "/supporters/" + localPlayerId] = newSup;
          }
          updates["players/" + localPlayerId + "/soldiers"] = currentPlayerData.soldiers + count;
          broadcastNotification(currentPlayerData.name + " " + selectedCountry + " ülkesine verdiği " + count + " asker geri çekti.");
        }
        roomRef.update(updates);
        showNotification(selectedCountry + " ülkesinden " + count + " asker çekildi.");
      }

      function sendSupport() {
        const recipient = document.getElementById("support-recipient").value;
        const countryName = document.getElementById("support-recipient-country").value;
        const soldiersToSend = parseInt(document.getElementById("support-soldiers").value);
        if (!recipient || !countryName) {
          showNotification("Oyuncu ve ülke seçmelisiniz!");
          return;
        }
        if (isNaN(soldiersToSend) || soldiersToSend <= 0) {
          showNotification("Geçerli bir asker sayısı girin!");
          return;
        }
        const currentPlayerData = roomData.players[localPlayerId];
        if (currentPlayerData.soldiers < soldiersToSend) {
          showNotification("Yeterli askeriniz yok!");
          return;
        }
        const targetCountry = roomData.countryData[countryName];
        if (!targetCountry) {
          showNotification("Seçilen ülke bulunamadı!");
          return;
        }
        if (targetCountry.owner !== recipient) {
          showNotification("Bu ülke, seçtiğiniz oyuncuya ait değil!");
          return;
        }
        const updates = {};
        updates["players/" + localPlayerId + "/soldiers"] = currentPlayerData.soldiers - soldiersToSend;
        updates["countryData/" + countryName + "/soldiers"] = targetCountry.soldiers + soldiersToSend;
        const oldSupport = (targetCountry.supporters && targetCountry.supporters[localPlayerId]) || 0;
        updates["countryData/" + countryName + "/supporters/" + localPlayerId] = oldSupport + soldiersToSend;
        roomRef.update(updates);
        broadcastNotification(currentPlayerData.name + " " + roomData.players[recipient].name + " (" + countryName + ") ülkesine " + soldiersToSend + " asker destek gönderdi.");
        showNotification("Askeri destek gönderildi!");
      }
      document.getElementById("send-support-btn").addEventListener("click", sendSupport);

      function sendMoney() {
        const amount = parseInt(document.getElementById("money-to-send").value);
        const recipientId = document.getElementById("recipient-player").value;
        if (isNaN(amount) || amount <= 0) {
          showNotification("Geçerli bir miktar girin!");
          return;
        }
        const currentPlayerData = roomData.players[localPlayerId];
        if (currentPlayerData.money < amount) {
          showNotification("Yeterli paranız yok!");
          return;
        }
        if (recipientId === localPlayerId) {
          showNotification("Kendinize para gönderemezsiniz!");
          return;
        }
        const updates = {};
        updates["players/" + localPlayerId + "/money"] = currentPlayerData.money - amount;
        updates["players/" + recipientId + "/money"] = roomData.players[recipientId].money + amount;
        roomRef.update(updates);
        broadcastNotification(currentPlayerData.name + " → " + roomData.players[recipientId].name + " için " + amount + "$ gönderdi.");
        showNotification(amount + "$, " + roomData.players[recipientId].name + " oyuncusuna gönderildi.");
      }

      function sendPetrol() {
        const amount = parseInt(document.getElementById("petrol-to-send").value);
        const recipientId = document.getElementById("recipient-player-petrol").value;
        if (isNaN(amount) || amount <= 0) {
          showNotification("Geçerli bir miktar girin!");
          return;
        }
        const currentPlayerData = roomData.players[localPlayerId];
        if (currentPlayerData.petrol < amount) {
          showNotification("Yeterli petrolünüz yok!");
          return;
        }
        if (recipientId === localPlayerId) {
          showNotification("Kendinize petrol gönderemezsiniz!");
          return;
        }
        const updates = {};
        updates["players/" + localPlayerId + "/petrol"] = currentPlayerData.petrol - amount;
        updates["players/" + recipientId + "/petrol"] = roomData.players[recipientId].petrol + amount;
        roomRef.update(updates);
        broadcastNotification(currentPlayerData.name + " → " + roomData.players[recipientId].name + " için " + amount + " varil petrol gönderdi.");
        showNotification(amount + " varil, " + roomData.players[recipientId].name + " oyuncusuna gönderildi.");
      }

      function sendWheat() {
        const amount = parseInt(document.getElementById("wheat-to-send").value);
        const recipientId = document.getElementById("recipient-player-wheat").value;
        if (isNaN(amount) || amount <= 0) {
          showNotification("Geçerli bir miktar girin!");
          return;
        }
        const currentPlayerData = roomData.players[localPlayerId];
        if (currentPlayerData.wheat < amount) {
          showNotification("Yeterli buğdayınız yok!");
          return;
        }
        if (recipientId === localPlayerId) {
          showNotification("Kendinize buğday gönderemezsiniz!");
          return;
        }
        const updates = {};
        updates["players/" + localPlayerId + "/wheat"] = currentPlayerData.wheat - amount;
        updates["players/" + recipientId + "/wheat"] = roomData.players[recipientId].wheat + amount;
        roomRef.update(updates);
        broadcastNotification(currentPlayerData.name + " → " + roomData.players[recipientId].name + " için " + amount + " buğday gönderdi.");
        showNotification(amount + " buğday, " + roomData.players[recipientId].name + " oyuncusuna gönderildi.");
      }

      function nextTurn(autoEnd = false) {
        if (!isMyTurn()) {
          showNotification("Sıranız değil!");
          return;
        }
        stopTurnTimer();
        const currentTurnIndex = roomData.currentTurnIndex || 0;
        const currentPlayerId = roomData.playerOrder[currentTurnIndex];
        const player = roomData.players[currentPlayerId];
        if (!player) return;
        const updates = {};
        if (player.countries && roomData.countryData) {
          let totalMoneyGained = 0;
          let totalPetrolGained = 0;
          let totalWheatGained = 0;
          player.countries.forEach((cName) => {
            const country = roomData.countryData[cName];
            if (country) {
              if (country.barracksCount) {
                updates["countryData/" + cName + "/soldiers"] = (country.soldiers || 0) + 5 * country.barracksCount;
              }
              let effectiveIncome = country.income || 0;
              if (country.factories) {
                effectiveIncome = Math.floor(effectiveIncome * (1 + 0.20 * country.factories));
              }
              totalMoneyGained += effectiveIncome;
              if (country.oilProduction) {
                const effectiveOil = Math.floor(country.oilProduction * (1 + 0.15 * (country.refineries || 0)));
                totalPetrolGained += effectiveOil;
              }
              if (country.wheatProduction) {
                const effectiveWheat = Math.floor(country.wheatProduction * (1 + 0.20 * (country.grainMills || 0)));
                totalWheatGained += effectiveWheat;
              }
            }
          });
          updates["players/" + currentPlayerId + "/money"] = (player.money || 0) + totalMoneyGained;
          updates["players/" + currentPlayerId + "/petrol"] = (player.petrol || 0) + totalPetrolGained;
          updates["players/" + currentPlayerId + "/wheat"] = (player.wheat || 0) + totalWheatGained;
        }
        let newTurnIndex = currentTurnIndex + 1;
        if (newTurnIndex >= roomData.playerOrder.length) {
          newTurnIndex = 0;
          updates["round"] = (roomData.round || 1) + 1;
        }
        updates["currentTurnIndex"] = newTurnIndex;
        roomRef.update(updates);
        const nextPlayerId = roomData.playerOrder[newTurnIndex];
        let endText = "Sıra " + (roomData.players[nextPlayerId]?.name || "?") + " adlı oyuncuya geçti.";
        if (autoEnd) {
          endText = player.name + " süresini doldurdu! " + endText;
        }
        broadcastNotification(endText);
        showNotification(endText, 1500);
      }

      /*****************************************************************
       * CHAT SISTEMİ
       *****************************************************************/
      function toggleChat(show) {
        const chatPopup = document.getElementById("chat-popup");
        chatPopup.style.display = show ? "flex" : "none";
        chatOpen = show;
        if (chatOpen) {
          unreadMessages = 0;
          updateChatBadge();
        }
      }

      document.getElementById("open-chat-btn").addEventListener("click", () => {
        popupStates.chat = !popupStates.chat;
        toggleChat(popupStates.chat);
      });
      document.getElementById("chat-popup-header").addEventListener("click", (e) => {
        if (e.target.id === "chat-popup-header") {
          popupStates.chat = false;
          toggleChat(false);
        }
      });
      document.getElementById("close-chat-btn").addEventListener("click", () => {
        popupStates.chat = false;
        toggleChat(false);
      });
      document.getElementById("send-chat-btn").addEventListener("click", sendChatMessage);
      document.getElementById("chat-input").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendChatMessage();
      });

      function sendChatMessage() {
        const input = document.getElementById("chat-input");
        const messageText = input.value.trim();
        if (!messageText) return;
        if (!roomRef) {
          showNotification("Oda verisi yüklenmedi.");
          return;
        }
        let senderName = "Anon";
        if (roomData && roomData.players && roomData.players[localPlayerId]) {
          senderName = roomData.players[localPlayerId].name;
        }
        const chatMessage = {
          sender: senderName,
          senderId: localPlayerId,
          text: messageText,
          recipientId: "",
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        roomRef.child("chat").push(chatMessage, (error) => {
          if (!error) input.value = "";
        });
      }

      document.getElementById("send-private-message-btn").addEventListener("click", () => {
        const privateInput = document.getElementById("private-message-input");
        const recipientSelect = document.getElementById("private-message-recipient");
        const msg = privateInput.value.trim();
        const recipientId = recipientSelect.value;
        if (!msg || !recipientId) return;
        let senderName = "Anon";
        if (roomData && roomData.players && roomData.players[localPlayerId]) {
          senderName = roomData.players[localPlayerId].name;
        }
        const chatMessage = {
          sender: senderName,
          senderId: localPlayerId,
          text: msg,
          recipientId: recipientId,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        roomRef.child("chat").push(chatMessage, (error) => {
          if (!error) {
            privateInput.value = "";
            showNotification("Özel mesaj gönderildi!");
          }
        });
      });

      function appendChatMessage(message) {
        if (message.recipientId && message.recipientId !== "") {
          if (message.senderId !== localPlayerId && message.recipientId !== localPlayerId) return;
        }
        const chatMessagesDiv = document.getElementById("chat-messages");
        const messageDiv = document.createElement("div");
        if (message.recipientId && message.recipientId !== "") {
          const targetName = (roomData.players[message.recipientId] || {}).name || "Bilinmeyen";
          if (message.senderId === localPlayerId) {
            messageDiv.innerHTML = "<strong>[PM to " + targetName + "]:</strong> " + message.text;
          } else {
            messageDiv.innerHTML = "<strong>[PM from " + message.sender + "]:</strong> " + message.text;
          }
          messageDiv.style.color = "#f39c12";
        } else {
          messageDiv.textContent = message.sender + ": " + message.text;
        }
        chatMessagesDiv.appendChild(messageDiv);
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        if (!chatOpen && message.senderId !== localPlayerId) {
          unreadMessages++;
          updateChatBadge();
        }
      }

      function updateChatBadge() {
        const openChatBtn = document.getElementById("open-chat-btn");
        openChatBtn.dataset.badge = unreadMessages > 0 ? unreadMessages : "";
      }

      /*****************************************************************
       * TİCARET (MARKET) SISTEMİ (Fabrika seçeneği kaldırıldı, yalnızca petrol ve buğday)
       *****************************************************************/
      document.getElementById("open-market-btn").addEventListener("click", () => {
        popupStates.market = !popupStates.market;
        const marketPopup = document.getElementById("market-popup");
        marketPopup.style.display = popupStates.market ? "flex" : "none";
      });
      document.getElementById("market-popup-header").addEventListener("click", (e) => {
        if (e.target.id === "market-popup-header") {
          popupStates.market = false;
          document.getElementById("market-popup").style.display = "none";
        }
      });
      document.getElementById("close-market-btn").addEventListener("click", () => {
        popupStates.market = false;
        document.getElementById("market-popup").style.display = "none";
      });
      document.getElementById("create-trade-offer-btn").addEventListener("click", createTradeOffer);

      function createTradeOffer() {
        if (!roomData || !roomData.players[localPlayerId]) {
          showNotification("Oyun verileri yüklenmedi veya geçersiz oyuncu!");
          return;
        }
        const itemType = document.getElementById("trade-item-type").value;
        const quantity = parseInt(document.getElementById("trade-quantity").value);
        const price = parseInt(document.getElementById("trade-price").value);
        if (isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
          showNotification("Geçerli adet ve fiyat girin!");
          return;
        }
        const seller = roomData.players[localPlayerId];
        let enough = false;
        if (itemType === "petrol") {
          if (seller.petrol >= quantity) enough = true;
        } else if (itemType === "wheat") {
          if (seller.wheat >= quantity) enough = true;
        }
        if (!enough) {
          showNotification("Satacak yeterli miktarınız yok!");
          return;
        }
        const embargoSelect = document.getElementById("embargo-players");
        let embargoList = [];
        for (let i = 0; i < embargoSelect.options.length; i++) {
          if (embargoSelect.options[i].selected) {
            embargoList.push(embargoSelect.options[i].value);
          }
        }
        const tradeOfferRef = roomRef.child("tradeOffers").push();
        const newOffer = {
          offerId: tradeOfferRef.key,
          sellerId: localPlayerId,
          sellerName: seller.name,
          itemType: itemType,
          quantity: quantity,
          price: price,
          status: "pending",
          embargo: embargoList
        };
        tradeOfferRef.set(newOffer);
        broadcastNotification(seller.name + " bir ticaret teklifi oluşturdu (" + itemType + ", adet: " + quantity + ", fiyat: " + price + "$)");
        showNotification("Ticaret teklifi başarıyla oluşturuldu!");
      }

      function displayTradeOffers() {
        const tradeOffersDiv = document.getElementById("trade-offers-list");
        if (!tradeOffersDiv) return;
        tradeOffersDiv.innerHTML = "";
        if (!roomData || !roomData.tradeOffers) return;
        const offersArray = Object.values(roomData.tradeOffers);
        offersArray.forEach((offer) => {
          if (offer.status === "pending") {
            if (offer.embargo && offer.embargo.includes(localPlayerId)) return;
            const offerDiv = document.createElement("div");
            offerDiv.className = "offer-item";
            let itemLabel = offer.itemType === "petrol" ? "Petrol" : "Buğday";
            let html = "<p><strong>Satıcı:</strong> " + offer.sellerName + "</p>";
            html += "<p><strong>Ürün:</strong> " + itemLabel + "</p>";
            html += "<p><strong>Mevcut Miktar:</strong> " + offer.quantity + "</p>";
            html += "<p><strong>Birim Fiyat:</strong> " + offer.price + " $</p>";
            if (offer.embargo && offer.embargo.length > 0) {
              const embUsers = offer.embargo
                .map((e) => roomData.players[e]?.name || "???")
                .join(", ");
              html += "<p style='color:red;'><strong>Ambargo:</strong> " + embUsers + "</p>";
            }
            if (offer.sellerId !== localPlayerId) {
              html += "<label style='font-size:14px;color:#ccc;'>Almak istediğiniz miktar:</label>" +
                "<input type='number' class='partial-buy-quantity' placeholder='Miktar' min='1' max='" + offer.quantity + "'/>";
              html += "<button class='partial-buy-btn'>Satın Al</button>";
            } else {
              html += "<button class='cancel-offer-btn' style='background:linear-gradient(45deg, #c0392b, #e74c3c); margin-top:10px;'>İptal</button>";
            }
            offerDiv.innerHTML = html;
            const partialBuyBtn = offerDiv.querySelector(".partial-buy-btn");
            if (partialBuyBtn) {
              partialBuyBtn.addEventListener("click", () => {
                const input = offerDiv.querySelector(".partial-buy-quantity");
                const buyAmt = parseInt(input.value);
                if (isNaN(buyAmt) || buyAmt <= 0) {
                  showNotification("Geçerli miktar girin!");
                  return;
                }
                acceptTradeOffer(offer.offerId, buyAmt);
              });
            }
            const cancelBtn = offerDiv.querySelector(".cancel-offer-btn");
            if (cancelBtn) {
              cancelBtn.addEventListener("click", () => cancelTradeOffer(offer.offerId));
            }
            tradeOffersDiv.appendChild(offerDiv);
          }
        });
      }

      function acceptTradeOffer(offerId, buyAmount) {
        if (!roomData || !roomData.tradeOffers || !roomData.tradeOffers[offerId]) {
          showNotification("Teklif bulunamadı!");
          return;
        }
        const offer = roomData.tradeOffers[offerId];
        if (offer.status !== "pending") {
          showNotification("Bu teklif artık geçerli değil!");
          return;
        }
        const seller = roomData.players[offer.sellerId];
        const buyer = roomData.players[localPlayerId];
        if (!seller || !buyer) {
          showNotification("Geçersiz satıcı/alıcı!");
          return;
        }
        if (buyAmount > offer.quantity) {
          showNotification("Teklifte yeterli miktar yok!");
          return;
        }
        const totalCost = offer.price * buyAmount;
        if (buyer.money < totalCost) {
          showNotification("Yeterli paranız yok!");
          return;
        }
        let updates = {};
        let hasEnough = false;
        if (offer.itemType === "petrol") {
          if (seller.petrol >= buyAmount) {
            hasEnough = true;
            updates["players/" + offer.sellerId + "/petrol"] = seller.petrol - buyAmount;
            updates["players/" + localPlayerId + "/petrol"] = buyer.petrol + buyAmount;
          }
        } else if (offer.itemType === "wheat") {
          if (seller.wheat >= buyAmount) {
            hasEnough = true;
            updates["players/" + offer.sellerId + "/wheat"] = seller.wheat - buyAmount;
            updates["players/" + localPlayerId + "/wheat"] = buyer.wheat + buyAmount;
          }
        }
        if (!hasEnough) {
          showNotification("Satıcının yeterli miktarı kalmamış!");
          return;
        }
        updates["players/" + localPlayerId + "/money"] = buyer.money - totalCost;
        updates["players/" + offer.sellerId + "/money"] = seller.money + totalCost;
        let newQuantity = offer.quantity - buyAmount;
        if (newQuantity <= 0) {
          updates["tradeOffers/" + offerId + "/status"] = "completed";
        }
        updates["tradeOffers/" + offerId + "/quantity"] = newQuantity;
        roomRef.update(updates, (error) => {
          if (!error) {
            broadcastNotification("Ticaret Onaylandı: " + seller.name + " -> " + buyer.name + " (" + buyAmount + " adet \"" + offer.itemType + "\")");
            showNotification("Ticaret başarıyla gerçekleşti!");
            const chatMessage = {
              sender: "Sistem",
              senderId: "system",
              text: "Ticaret Onaylandı: " + seller.name + " -> " + buyer.name + ", " + buyAmount + " x " + offer.itemType,
              recipientId: "",
              timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            roomRef.child("chat").push(chatMessage);
          }
        });
      }

      function cancelTradeOffer(offerId) {
        if (!roomData || !roomData.tradeOffers || !roomData.tradeOffers[offerId]) return;
        const offer = roomData.tradeOffers[offerId];
        if (offer.sellerId !== localPlayerId) {
          showNotification("Sadece kendi teklifinizi iptal edebilirsiniz.");
          return;
        }
        if (offer.status !== "pending") {
          showNotification("Bu teklif zaten tamamlanmış veya iptal edilmiş.");
          return;
        }
        roomRef.child("tradeOffers").child(offerId).update({ status: "cancelled" });
        broadcastNotification("Ticaret teklifi iptal edildi: " + offer.sellerName);
        showNotification("Teklif iptal edildi.");
      }

      /*****************************************************************
       * ODADAN ÇIKIŞ
       *****************************************************************/
      document.getElementById("exit-room-btn").addEventListener("click", () => {
        if (!roomRef || !roomData) return;
        roomRef.child("players/" + localPlayerId).remove();
        const newOrder = (roomData.playerOrder || []).filter((id) => id !== localPlayerId);
        if (isMyTurn()) {
          stopTurnTimer();
          let idx = roomData.currentTurnIndex || 0;
          if (idx >= newOrder.length) {
            idx = 0;
            roomRef.update({ round: (roomData.round || 1) + 1 });
          }
          roomRef.update({ currentTurnIndex: idx });
        }
        roomRef.update({ playerOrder: newOrder });
        document.getElementById("game-container").style.display = "none";
        document.getElementById("lobby-container").style.display = "block";
        document.body.classList.add("lobby");
        localStorage.removeItem("roomCode");
        stopTurnTimer();
        clearInterval(startInterval);
        showNotification("Odadan çıktınız. Artık oyunda yoksunuz.");
      });

      // Popup toggle event listener’ları (military, building, resource, players, pact)
      document.getElementById("open-military-btn").addEventListener("click", () => {
        popupStates.military = !popupStates.military;
        document.getElementById("military-popup").style.display = popupStates.military ? "flex" : "none";
      });
      document.getElementById("military-popup-header").addEventListener("click", () => {
        popupStates.military = false;
        document.getElementById("military-popup").style.display = "none";
      });
      document.getElementById("close-military-btn").addEventListener("click", () => {
        popupStates.military = false;
        document.getElementById("military-popup").style.display = "none";
      });
      document.getElementById("open-building-btn").addEventListener("click", () => {
        popupStates.building = !popupStates.building;
        document.getElementById("building-popup").style.display = popupStates.building ? "flex" : "none";
      });
      document.getElementById("building-popup-header").addEventListener("click", () => {
        popupStates.building = false;
        document.getElementById("building-popup").style.display = "none";
      });
      document.getElementById("close-building-btn").addEventListener("click", () => {
        popupStates.building = false;
        document.getElementById("building-popup").style.display = "none";
      });
      document.getElementById("open-resource-btn").addEventListener("click", () => {
        popupStates.resource = !popupStates.resource;
        document.getElementById("resource-popup").style.display = popupStates.resource ? "flex" : "none";
      });
      document.getElementById("resource-popup-header").addEventListener("click", () => {
        popupStates.resource = false;
        document.getElementById("resource-popup").style.display = "none";
      });
      document.getElementById("close-resource-btn").addEventListener("click", () => {
        popupStates.resource = false;
        document.getElementById("resource-popup").style.display = "none";
      });
      document.getElementById("open-players-btn").addEventListener("click", () => {
        popupStates.players = !popupStates.players;
        document.getElementById("players-popup").style.display = popupStates.players ? "flex" : "none";
      });
      document.getElementById("players-popup-header").addEventListener("click", () => {
        popupStates.players = false;
        document.getElementById("players-popup").style.display = "none";
      });
      document.getElementById("close-players-btn").addEventListener("click", () => {
        popupStates.players = false;
        document.getElementById("players-popup").style.display = "none";
      });
      document.getElementById("open-pact-btn").addEventListener("click", () => {
        popupStates.pact = !popupStates.pact;
        document.getElementById("pact-popup").style.display = popupStates.pact ? "flex" : "none";
      });
      document.getElementById("pact-popup-header").addEventListener("click", () => {
        popupStates.pact = false;
        document.getElementById("pact-popup").style.display = "none";
      });
      document.getElementById("close-pact-btn").addEventListener("click", () => {
        popupStates.pact = false;
        document.getElementById("pact-popup").style.display = "none";
      });
    </script>
  </body>
</html>
